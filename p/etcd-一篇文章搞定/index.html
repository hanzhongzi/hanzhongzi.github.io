<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='ETCD ÂéüÁêÜ„ÄÅÂÆâË£ÖÈÉ®ÁΩ≤„ÄÅÊìç‰Ωú'>
<title>Etcd ‰∏ÄÁØáÊñáÁ´†ÊêûÂÆö</title>

<link rel='canonical' href='https://hanzhongzi.github.io/p/etcd-%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%90%9E%E5%AE%9A/'>

<link rel="stylesheet" href="/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css"><meta property='og:title' content='Etcd ‰∏ÄÁØáÊñáÁ´†ÊêûÂÆö'>
<meta property='og:description' content='ETCD ÂéüÁêÜ„ÄÅÂÆâË£ÖÈÉ®ÁΩ≤„ÄÅÊìç‰Ωú'>
<meta property='og:url' content='https://hanzhongzi.github.io/p/etcd-%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%90%9E%E5%AE%9A/'>
<meta property='og:site_name' content='ÁÄö‰∏≠Â≠êÁöÑ‰∏™‰∫∫ÁΩëÁ´ô'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='etcd' /><meta property='article:published_time' content='2024-01-02T16:55:17&#43;08:00'/><meta property='article:modified_time' content='2024-01-02T16:55:17&#43;08:00'/>
<meta name="twitter:title" content="Etcd ‰∏ÄÁØáÊñáÁ´†ÊêûÂÆö">
<meta name="twitter:description" content="ETCD ÂéüÁêÜ„ÄÅÂÆâË£ÖÈÉ®ÁΩ≤„ÄÅÊìç‰Ωú">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="ÂàáÊç¢ËèúÂçï">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu190e528798e90195d3cefef01f0a2d44_410_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">üç•</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">ÁÄö‰∏≠Â≠êÁöÑ‰∏™‰∫∫ÁΩëÁ´ô</a></h1>
            <h2 class="site-description">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://hanzhongzi.github.io/" selected>‰∏≠Êñá</option>
                        
                            <option value="https://hanzhongzi.github.io/en/" >English</option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>ÊöóËâ≤Ê®°Âºè</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ÁõÆÂΩï</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li>
      <ol>
        <li><a href="#Âü∫Á°ÄÁØá">Âü∫Á°ÄÁØá</a></li>
        <li><a href="#ÂÆûË∑µÁØá">ÂÆûË∑µÁØá</a></li>
        <li><a href="#‰∏∫‰ªÄ‰πàkubernetes‰ΩøÁî®ÁöÑÊòØetcd">‰∏∫‰ªÄ‰πàkubernetes‰ΩøÁî®ÁöÑÊòØetcd</a>
          <ol>
            <li><a href="#Êï∞ÊçÆ‰∏ÄËá¥ÊÄß‰øùËØÅ">Êï∞ÊçÆ‰∏ÄËá¥ÊÄß‰øùËØÅ</a></li>
          </ol>
        </li>
        <li><a href="#etcd-v2ÁöÑÈóÆÈ¢ò">etcd v2ÁöÑÈóÆÈ¢ò</a></li>
        <li><a href="#etcd-v3-Â∞±ÊòØ‰∏∫‰∫ÜËß£ÂÜ≥‰ª•‰∏äÁ®≥ÂÆöÊÄßÊâ©Â±ïÊÄßÊÄßËÉΩÈóÆÈ¢òËÄåËØûÁîüÁöÑ">etcd v3 Â∞±ÊòØ‰∏∫‰∫ÜËß£ÂÜ≥‰ª•‰∏äÁ®≥ÂÆöÊÄß„ÄÅÊâ©Â±ïÊÄß„ÄÅÊÄßËÉΩÈóÆÈ¢òËÄåËØûÁîüÁöÑ„ÄÇ</a></li>
        <li><a href="#etc-ËØªËØ∑Ê±ÇÊòØÂ¶Ç‰ΩïÊâßË°åÁöÑ">etc ËØªËØ∑Ê±ÇÊòØÂ¶Ç‰ΩïÊâßË°åÁöÑ</a>
          <ol>
            <li><a href="#‰ªÄ‰πàÊòØÁ∫øÊÄßËØªÂë¢">‰ªÄ‰πàÊòØÁ∫øÊÄßËØªÂë¢?</a></li>
          </ol>
        </li>
        <li><a href="#etcd‰∏Ä‰∏™ÂÜôËØ∑Ê±ÇÊòØÂ¶Ç‰ΩïÊâßË°åÁöÑ">etcd‰∏Ä‰∏™ÂÜôËØ∑Ê±ÇÊòØÂ¶Ç‰ΩïÊâßË°åÁöÑ</a></li>
        <li><a href="#etcdÁöÑÈ´òÂèØÁî®ÂíåÊï∞ÊçÆ‰∏ÄËá¥ÊÄßraft-ÂçèËÆÆ">etcdÁöÑÈ´òÂèØÁî®ÂíåÊï∞ÊçÆ‰∏ÄËá¥ÊÄß(raft ÂçèËÆÆ)</a></li>
        <li><a href="#Èâ¥ÊùÉ-Â¶Ç‰Ωï‰øùÊä§‰Ω†ÁöÑÊï∞ÊçÆÂÆâÂÖ®">Èâ¥ÊùÉ Â¶Ç‰Ωï‰øùÊä§‰Ω†ÁöÑÊï∞ÊçÆÂÆâÂÖ®</a>
          <ol>
            <li><a href="#Êï¥‰ΩìÊû∂ÊûÑ">Êï¥‰ΩìÊû∂ÊûÑ</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#ËøôÈáåÈúÄË¶ÅË°•ÂÖÖ‰∏Ä‰∏™etcdÁöÑÁî®Êà∑ÁÆ°ÁêÜÊìç‰ΩúÂõûÂ§çÁöÑ">ËøôÈáåÈúÄË¶ÅË°•ÂÖÖ‰∏Ä‰∏™etcdÁöÑÁî®Êà∑ÁÆ°ÁêÜÊìç‰ΩúÔºàÂõûÂ§çÁöÑÔºâ</a></li>
    <li><a href="#etcdÁßüÁ∫¶-lease">etcdÁßüÁ∫¶ lease</a>
      <ol>
        <li><a href="#mvccÂ¶Ç‰ΩïÂÆûÁé∞Â§öÁâàÊú¨Âπ∂ÂèëÊéßÂà∂ÁöÑ">MVCCÂ¶Ç‰ΩïÂÆûÁé∞Â§öÁâàÊú¨Âπ∂ÂèëÊéßÂà∂ÁöÑ</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/linux-operator/" >
                Linux operator
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/etcd-%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%90%9E%E5%AE%9A/">Etcd ‰∏ÄÁØáÊñáÁ´†ÊêûÂÆö</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            ETCD ÂéüÁêÜ„ÄÅÂÆâË£ÖÈÉ®ÁΩ≤„ÄÅÊìç‰Ωú
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 29, 2019</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    ÈòÖËØªÊó∂Èïø: 26 ÂàÜÈíü
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="etcd">etcd</h1>
<p>ÂÆÉÁöÑÂ∫îÁî®Âú∫ÊôØÁõ∏ÂΩìÂπøÊ≥õÔºå‰ªéÊúçÂä°ÂèëÁé∞Âà∞ÂàÜÂ∏ÉÂºèÈîÅÔºå‰ªéÈÖçÁΩÆÂ≠òÂÇ®Âà∞ÂàÜÂ∏ÉÂºèÂçèË∞ÉÁ≠âÁ≠â„ÄÇ</p>
<p>etcd Â∑≤ÁªèÊàê‰∏∫‰∫Ü‰∫ëÂéüÁîüÂíåÂàÜÂ∏ÉÂºèÁ≥ªÁªüÁöÑÂ≠òÂÇ®Âü∫Áü≥„ÄÇ</p>
<p>Âè¶Â§ñÔºåetcd ‰Ωú‰∏∫ÊúÄÁÉ≠Èó®ÁöÑ‰∫ëÂéüÁîüÂ≠òÂÇ®‰πã‰∏ÄÔºåÂú®ËÖæËÆØ„ÄÅÈòøÈáå„ÄÅGoogle„ÄÅAWS„ÄÅÁæéÂõ¢„ÄÅÂ≠óËäÇË∑≥Âä®„ÄÅÊãºÂ§öÂ§ö„ÄÅShopee„ÄÅÊòéÊ∫ê‰∫ëÁ≠âÂÖ¨Âè∏ÈÉΩÊúâÂ§ßÈáèÁöÑÂ∫îÁî®ÔºåË¶ÜÁõñÁöÑ‰∏öÂä°ÂèØ‰∏ç‰ªÖ‰ªÖÊòØ Kubernetes Áõ∏ÂÖ≥ÁöÑÂêÑÁ±ªÂÆπÂô®‰∫ßÂìÅÔºåÊõ¥ÊúâËßÜÈ¢ë„ÄÅÊé®Ëçê„ÄÅÂÆâÂÖ®„ÄÅÊ∏∏Êàè„ÄÅÂ≠òÂÇ®„ÄÅÈõÜÁæ§Ë∞ÉÂ∫¶Á≠âÊ†∏ÂøÉ‰∏öÂä°„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">etcd Watch Êú∫Âà∂ËÉΩ‰øùËØÅ‰∫ã‰ª∂‰∏ç‰∏¢ÂêóÔºüÔºàÂéüÁêÜÁ±ªÔºâ
</span></span><span class="line"><span class="cl">Âì™‰∫õÂõ†Á¥†‰ºöÂØºËá¥‰Ω†ÁöÑÈõÜÁæ§ Leader ÂèëÁîüÂàáÊç¢? ÔºàÁ®≥ÂÆöÊÄßÁ±ªÔºâ
</span></span><span class="line"><span class="cl">‰∏∫‰ªÄ‰πàÂü∫‰∫é Raft ÂÆûÁé∞ÁöÑ etcd ËøòÂèØËÉΩ‰ºöÂá∫Áé∞Êï∞ÊçÆ‰∏ç‰∏ÄËá¥ÔºüÔºà‰∏ÄËá¥ÊÄßÁ±ªÔºâ
</span></span><span class="line"><span class="cl">‰∏∫‰ªÄ‰πà‰Ω†Âà†Èô§‰∫ÜÂ§ßÈáèÊï∞ÊçÆÔºådb Â§ßÂ∞è‰∏çÂáèÂ∞ëÔºü‰∏∫‰Ωï etcd Á§æÂå∫Âª∫ËÆÆ db Â§ßÂ∞è‰∏çË¶ÅË∂ÖËøá 8GÔºüÔºàdb Â§ßÂ∞èÁ±ªÔºâ
</span></span><span class="line"><span class="cl">‰∏∫‰ªÄ‰πàÈõÜÁæ§ÂêÑËäÇÁÇπÁ£ÅÁõò I/O Âª∂Êó∂Âæà‰ΩéÔºåÂÜôËØ∑Ê±Ç‰πü‰ºöË∂ÖÊó∂ÔºüÔºàÂª∂Êó∂Á±ªÔºâ
</span></span><span class="line"><span class="cl">‰∏∫‰ªÄ‰πà‰Ω†Âè™Â≠òÂÇ®‰∫Ü 1 ‰∏™Âá†Áôæ KB ÁöÑ key/valueÔºå etcd ËøõÁ®ãÂç¥ÂèØËÉΩËÄóË¥πÊï∞ G ÂÜÖÂ≠ò? ÔºàÂÜÖÂ≠òÁ±ªÔºâ
</span></span><span class="line"><span class="cl">ÂΩì‰Ω†Âú®‰∏Ä‰∏™ namespace ‰∏ãÂàõÂª∫‰∫ÜÊï∞‰∏á‰∏™ Pod/CRD ËµÑÊ∫êÊó∂ÔºåÂêåÊó∂È¢ëÁπÅÈÄöËøáÊ†áÁ≠æÂéªÊü•ËØ¢ÊåáÂÆö Pod/CRD ËµÑÊ∫êÊó∂ÔºåAPIServer Âíå etcd ‰∏∫‰ªÄ‰πàÊâõ‰∏ç‰Ωè?ÔºàÊúÄ‰Ω≥ÂÆûË∑µÁ±ªÔºâ
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÊÄùÁª¥ÂØºÂõæ</p>
<p>![](./img/etcd ÊÄùÁª¥ÂØºÂõæ.webp)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">È¶ñÂÖàÔºå‰Ω†ËÉΩÁü•ÈÅì‰ªÄ‰πàÊòØ etcdÔºå‰∫ÜËß£ÂÆÉÁöÑÂü∫Êú¨ËØªÂÜôÂéüÁêÜ„ÄÅÊ†∏ÂøÉÁâπÊÄßÂíåËÉΩËß£ÂÜ≥‰ªÄ‰πàÈóÆÈ¢ò„ÄÇ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ÁÑ∂ÂêéÔºåÂú®‰ΩøÁî® etcd Ëß£ÂÜ≥ÂêÑÁ±ª‰∏öÂä°Âú∫ÊôØÈúÄÊ±ÇÊó∂ÔºåËÉΩÁã¨Á´ãÂà§Êñ≠ etcd ÊòØÂê¶ÈÄÇÂêà‰Ω†ÁöÑ‰∏öÂä°Âú∫ÊôØÔºåÂπ∂ËÉΩËÆæËÆ°Âá∫ËâØÂ•ΩÁöÑÂ≠òÂÇ®ÁªìÊûÑÔºåÈÅøÂÖç expensive request„ÄÇ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ÂÖ∂Ê¨°ÔºåÂú®‰ΩøÁî® Kubernetes ÁöÑËøáÁ®ã‰∏≠Ôºå‰Ω†ËÉΩÊ∏ÖÊô∞Âú∞Áü•ÈÅì‰Ω†ÁöÑÊØè‰∏™Êìç‰ΩúËÉåÂêéÁöÑ etcd ÊòØÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑÔºåÂπ∂ÈÅµÂæ™ Kubernetes/etcd ÊúÄ‰Ω≥ÂÆûË∑µÔºåËÆ©‰Ω†ÁöÑ Kubernetes ÈõÜÁæ§Ë∑ëÂæóÊõ¥Âø´Êõ¥Á®≥„ÄÇ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Êé•ÁùÄÔºåÂú®ËøêÁª¥ etcd ÈõÜÁæ§ÁöÑÊó∂ÂÄôÔºå‰Ω†ËÉΩÁü•ÈÅì etcd ÈõÜÁæ§Ê†∏ÂøÉÁõëÊéßÊåáÊ†áÔºå‰∫ÜËß£Â∏∏ËßÅÁöÑÂùëÔºåÂà∂ÂÆöËâØÂ•ΩÁöÑÂ∑°Ê£Ä„ÄÅÁõëÊéßÁ≠ñÁï•ÔºåÂèäÊó∂ÂèëÁé∞„ÄÅËßÑÈÅøÈóÆÈ¢òÔºåÈÅøÂÖç‰∫ãÊïÖÁöÑ‰∫ßÁîü„ÄÇ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ÊúÄÂêéÔºåÂΩì‰Ω†ÈÅáÂà∞ etcd ÈóÆÈ¢òÊó∂ÔºåËÉΩËá™Â∑±ÂàÜÊûê‰∏∫‰ªÄ‰πà‰ºöÂá∫Áé∞ËøôÊ†∑ÁöÑÈîôËØØÔºåÂπ∂Áü•ÈÅìÂ¶Ç‰ΩïËß£ÂÜ≥ÔºåÁîöËá≥ÁªôÁ§æÂå∫Êèê PR ‰ºòÂåñÔºåÂÅöÂà∞Áü•ÂÖ∂ÁÑ∂Áü•ÂÖ∂ÊâÄ‰ª•ÁÑ∂„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="Âü∫Á°ÄÁØá">Âü∫Á°ÄÁØá</h3>
<p>Â≠¶‰π†ÁõÆÊ†á</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">etcd Âü∫Á°ÄÊû∂ÊûÑ„ÄÇÈÄöËøá‰∏∫‰Ω†Ê¢≥ÁêÜ etcd Ââç‰∏ñ‰ªäÁîü„ÄÅÂàÜÊûê etcd ËØªÂÜôÊµÅÁ®ãÔºåÂ∏ÆÂä©‰Ω†Âª∫Á´ãËµ∑ÂØπ etcd ÁöÑÊï¥‰ΩìËÆ§Áü•Ôºå‰∫ÜËß£‰∏Ä‰∏™ÂàÜÂ∏ÉÂºèÂ≠òÂÇ®Á≥ªÁªüÁöÑÂü∫Êú¨Ê®°Âûã„ÄÅËÆæËÆ°ÊÄùÊÉ≥„ÄÇ
</span></span><span class="line"><span class="cl">Raft ÁÆóÊ≥ï„ÄÇÈÄöËøá‰∏∫‰Ω†‰ªãÁªç Raft ÁÆóÊ≥ïÂú® etcd ‰∏≠ÊòØÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑÔºåÂ∏ÆÂä©‰Ω†‰∫ÜËß£ etcd È´òÂèØÁî®„ÄÅÈ´òÂèØÈù†ËÉåÂêéÁöÑÊ†∏ÂøÉÂéüÁêÜ„ÄÇ
</span></span><span class="line"><span class="cl">Èâ¥ÊùÉÊ®°Âùó„ÄÇÈÄöËøá‰ªãÁªç etcd ÁöÑÈâ¥ÊùÉ„ÄÅÊéàÊùÉ‰ΩìÁ≥ªÔºåÂ∏¶‰Ω†‰∫ÜËß£ etcd ÊòØÂ¶Ç‰Ωï‰øùÊä§‰Ω†ÁöÑÊï∞ÊçÆÂÆâÂÖ®Ôºå‰ª•ÂèäÂêÑ‰∏™Èâ¥ÊùÉÊú∫Âà∂ÁöÑ‰ºòÁº∫ÁÇπ„ÄÇ
</span></span><span class="line"><span class="cl">ÁßüÁ∫¶Ê®°Âùó„ÄÇ
</span></span><span class="line"><span class="cl">‰ªãÁªç etcd ÁßüÁ∫¶ÁâπÊÄßÁöÑÂÆûÁé∞ÔºåÂ∏ÆÂä©‰Ω†ÊêûÊáÇÂ¶Ç‰ΩïÊ£ÄÊµã‰∏Ä‰∏™ËøõÁ®ãÁöÑÂ≠òÊ¥ªÊÄßÔºå‰∏∫‰ªÄ‰πàÂÆÉÂèØ‰ª•Áî®‰∫é Leader ÈÄâ‰∏æ‰∏≠„ÄÇ
</span></span><span class="line"><span class="cl">MVCC/Watch Ê®°Âùó„ÄÇÈÄöËøáËøô‰∏§‰∏™Ê®°ÂùóÂ∏ÆÂä©‰Ω†ÊêûÊáÇ Kubernetes ÊéßÂà∂Âô®ÁºñÁ®ãÊ®°ÂûãËÉåÂêéÁöÑÂéüÁêÜ„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><p>Âü∫Á°ÄÁØáÊÄùÁª¥ÂØºÂõæ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e5%9f%ba%e7%a1%80%e7%af%87%e6%80%9d%e7%bb%b4%e5%af%bc%e5%9b%be.webp"
	
	
	
	loading="lazy"
	
		alt="etcdÂü∫Á°ÄÁØáÊÄùÁª¥ÂØºÂõæ"
	
	
></p>
<p>ÂàÜÂ∏ÉÂºèÁ≥ªÁªüÂ≠òÂÇ®Á≥ªÁªüÁöÑÊ†∏ÂøÉÊäÄÊúØÈöæÁÇπÊòØ‰ªÄ‰πàÔºåÂ∏∏ËßÅÁöÑËß£ÂÜ≥ÊñπÊ°àÊúâÂì™‰∫õÔºå‰ª•Âèä‰∏∫‰ªÄ‰πà etcd Ë¶ÅËøôÊ†∑ËÆæËÆ°„ÄÅÂÆûÁé∞„ÄÇËÆ©‰Ω†ÂØπÊï¥‰∏™ÂàÜÂ∏ÉÂºèÁ≥ªÁªüÊúâÊõ¥Ê∑±Â±ÇÊ¨°ÁöÑÁêÜËß£ÔºåÊòéÁôΩ‰∏çÂêåÂ≠òÂÇ®Á≥ªÁªüÂè™ÊòØÂú®Èù¢ÂØπÂêÑËá™ÁöÑ‰∏öÂä°Âú∫ÊôØÁöÑÊó∂ÂÄôÔºåÈÄâÊã©‰∫ÜÂêàÈÄÇÁöÑÊäÄÊúØÊñπÊ°àÔºåËÆ©‰Ω†‰ªéÊú¨Ë¥®‰∏äÂéªÁêÜËß£ÂàÜÂ∏ÉÂºèÂ≠òÂÇ®Á≥ªÁªüË¶ÅËß£ÂÜ≥ÁöÑÊ†∏ÂøÉÈóÆÈ¢òÂü∫Êú¨ÊòØ‰∏ÄËá¥ÁöÑ„ÄÇ</p>
<h3 id="ÂÆûË∑µÁØá">ÂÆûË∑µÁØá</h3>
<p>Â≠¶‰π†ÁõÆÊ†á</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ÈóÆÈ¢òÁØá„ÄÇ‰∏∫‰Ω†ÂàÜÊûê etcd ‰ΩøÁî®ËøáÁ®ã‰∏≠ÁöÑÂêÑÁ±ªÂÖ∏ÂûãÈóÆÈ¢òÔºåÂíå‰Ω†ÁªÜËÅäÂêÑÁßçÂºÇÂ∏∏Áé∞Ë±°ËÉåÂêéÁöÑÂéüÁêÜ„ÄÅÊúÄ‰Ω≥ÂÆûË∑µ„ÄÇ
</span></span><span class="line"><span class="cl">ÊÄßËÉΩ‰ºòÂåñÁØá„ÄÇÈÄöËøáËØªÂÜôÈìæË∑ØÁöÑÂàÜÊûêÔºå‰∏∫‰Ω†Ê¢≥ÁêÜÂèØËÉΩÂΩ±Âìç etcd ÊÄßËÉΩÁöÑÊØè‰∏Ä‰∏™Áì∂È¢à„ÄÇ
</span></span><span class="line"><span class="cl">ÂÆûÊàòÁØá„ÄÇÂ∏¶‰Ω†‰ªé 0 Âà∞ 1 ‰∫≤ÊâãÂèÇ‰∏éÊûÑÂª∫‰∏Ä‰∏™ÁÆÄÊòìÁöÑÂàÜÂ∏ÉÂºè KV Êï∞ÊçÆÂ∫ìÔºåËøõ‰∏ÄÊ≠•ÊèêÂçá‰Ω†ÂØπÂàÜÂ∏ÉÂºèÂ≠òÂÇ®Á≥ªÁªüÁöÑËÆ§Áü•„ÄÇKubernetes ÂÆûË∑µÁØá„ÄÇ‰∏∫‰Ω†ÂàÜÊûê etcd Âú® Kubernetes ‰∏≠ÁöÑÂ∫îÁî®ÔºåËÆ©‰Ω†ÂØπ Kubernetes ÂéüÁêÜÊúâÊõ¥Ê∑±Â±ÇÊ¨°ÁöÑÁêÜËß£„ÄÇ
</span></span><span class="line"><span class="cl">etcd Â∫îÁî®ÁØá„ÄÇ‰ªãÁªç etcd Âú®ÂàÜÂ∏ÉÂºèÈîÅ„ÄÅÈÖçÁΩÆÁ≥ªÁªü„ÄÅÊúçÂä°ÂèëÁé∞Âú∫ÊôØ‰∏≠ÁöÑÂ∫îÁî®„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÊÄùÁª¥ÂØºÂõæ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e5%ae%9e%e8%b7%b5%e7%af%87%e6%80%9d%e7%bb%b4%e5%af%bc%e5%9b%be.webp"
	
	
	
	loading="lazy"
	
	
></p>
<h3 id="‰∏∫‰ªÄ‰πàkubernetes‰ΩøÁî®ÁöÑÊòØetcd">‰∏∫‰ªÄ‰πàkubernetes‰ΩøÁî®ÁöÑÊòØetcd</h3>
<p>ÂºÄÂèëÈÄâÂûãÁöÑËßíÂ∫¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ÂèØÁî®ÊÄßËßíÂ∫¶ÔºöÈ´òÂèØÁî®„ÄÇÂçèË∞ÉÊúçÂä°‰Ωú‰∏∫ÈõÜÁæ§ÁöÑÊéßÂà∂Èù¢Â≠òÂÇ®ÔºåÂÆÉ‰øùÂ≠ò‰∫ÜÂêÑ‰∏™ÊúçÂä°ÁöÑÈÉ®ÁΩ≤„ÄÅËøêË°å‰ø°ÊÅØ„ÄÇËã•ÂÆÉÊïÖÈöúÔºåÂèØËÉΩ‰ºöÂØºËá¥ÈõÜÁæ§Êó†Ê≥ïÂèòÊõ¥„ÄÅÊúçÂä°ÂâØÊú¨Êï∞Êó†Ê≥ïÂçèË∞É„ÄÇ‰∏öÂä°ÊúçÂä°Ëã•Ê≠§Êó∂Âá∫Áé∞ÊïÖÈöúÔºåÊó†Ê≥ïÂàõÂª∫Êñ∞ÁöÑÂâØÊú¨ÔºåÂèØËÉΩ‰ºöÂΩ±ÂìçÁî®Êà∑Êï∞ÊçÆÈù¢„ÄÇ
</span></span><span class="line"><span class="cl">Êï∞ÊçÆ‰∏ÄËá¥ÊÄßËßíÂ∫¶ÔºöÊèê‰æõËØªÂèñ‚ÄúÊúÄÊñ∞‚ÄùÊï∞ÊçÆÁöÑÊú∫Âà∂„ÄÇÊó¢ÁÑ∂ÂçèË∞ÉÊúçÂä°ÂøÖÈ°ªÂÖ∑Â§áÈ´òÂèØÁî®ÁöÑÁõÆÊ†áÔºåÂ∞±ÂøÖÁÑ∂‰∏çËÉΩÂ≠òÂú®ÂçïÁÇπÊïÖÈöúÔºàsingle point of failureÔºâÔºåËÄåÂ§öËäÇÁÇπÂèàÂºïÂÖ•‰∫ÜÊñ∞ÁöÑÈóÆÈ¢òÔºåÂç≥Â§ö‰∏™ËäÇÁÇπ‰πãÈó¥ÁöÑÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÂ¶Ç‰Ωï‰øùÈöúÔºüÊØîÂ¶Ç‰∏Ä‰∏™ÈõÜÁæ§ 3 ‰∏™ËäÇÁÇπ A„ÄÅB„ÄÅCÔºå‰ªéËäÇÁÇπ A„ÄÅB Ëé∑ÂèñÊúçÂä°ÈïúÂÉèÁâàÊú¨ÊòØÊñ∞ÁöÑÔºå‰ΩÜËäÇÁÇπ C Âõ†‰∏∫Á£ÅÁõò I/O ÂºÇÂ∏∏ÂØºËá¥Êï∞ÊçÆÊõ¥Êñ∞ÁºìÊÖ¢ÔºåËã•ÊéßÂà∂Á´ØÈÄöËøá C ËäÇÁÇπËé∑ÂèñÊï∞ÊçÆÔºåÈÇ£‰πàÂèØËÉΩ‰ºöÂØºËá¥ËØªÂèñÂà∞ËøáÊúüÊï∞ÊçÆÔºåÊúçÂä°ÈïúÂÉèÊó†Ê≥ïÂèäÊó∂Êõ¥Êñ∞„ÄÇ
</span></span><span class="line"><span class="cl">ÂÆπÈáèËßíÂ∫¶Ôºö‰ΩéÂÆπÈáè„ÄÅ‰ªÖÂ≠òÂÇ®ÂÖ≥ÈîÆÂÖÉÊï∞ÊçÆÈÖçÁΩÆ„ÄÇÂçèË∞ÉÊúçÂä°‰øùÂ≠òÁöÑ‰ªÖ‰ªÖÊòØÊúçÂä°„ÄÅËäÇÁÇπÁöÑÈÖçÁΩÆ‰ø°ÊÅØÔºàÂ±û‰∫éÊéßÂà∂Èù¢ÈÖçÁΩÆÔºâÔºåËÄå‰∏çÊòØ‰∏éÁî®Êà∑Áõ∏ÂÖ≥ÁöÑÊï∞ÊçÆ„ÄÇÊâÄ‰ª•Â≠òÂÇ®‰∏ä‰∏çÈúÄË¶ÅËÄÉËôëÊï∞ÊçÆÂàÜÁâáÔºåÊó†ÈúÄËøáÂ∫¶ËÆæËÆ°„ÄÇ
</span></span><span class="line"><span class="cl">ÂäüËÉΩÔºöÂ¢ûÂà†ÊîπÊü•ÔºåÁõëÂê¨Êï∞ÊçÆÂèòÂåñÁöÑÊú∫Âà∂„ÄÇÂçèË∞ÉÊúçÂä°‰øùÂ≠ò‰∫ÜÊúçÂä°ÁöÑÁä∂ÊÄÅ‰ø°ÊÅØÔºåËã•ÊúçÂä°ÊúâÂèòÊõ¥ÊàñÂºÇÂ∏∏ÔºåÁõ∏ÊØîÊéßÂà∂Á´ØÂÆöÊó∂ÂéªËΩÆËØ¢Ê£ÄÊü•‰∏Ä‰∏™‰∏™ÊúçÂä°Áä∂ÊÄÅÔºåËã•ËÉΩÂø´ÈÄüÊé®ÈÄÅÂèòÊõ¥‰∫ã‰ª∂ÁªôÊéßÂà∂Á´ØÔºåÂàôÂèØÊèêÂçáÊúçÂä°ÂèØÁî®ÊÄß„ÄÅÂáèÂ∞ëÂçèË∞ÉÊúçÂä°‰∏çÂøÖË¶ÅÁöÑÊÄßËÉΩÂºÄÈîÄ„ÄÇ
</span></span><span class="line"><span class="cl">ËøêÁª¥Â§çÊùÇÂ∫¶ÔºöÂèØÁª¥Êä§ÊÄß„ÄÇÂú®ÂàÜÂ∏ÉÂºèÁ≥ªÁªü‰∏≠ÂæÄÂæÄ‰ºöÈÅáÂà∞Á°¨‰ª∂ Bug„ÄÅËΩØ‰ª∂ Bug„ÄÅ‰∫∫‰∏∫Êìç‰ΩúÈîôËØØÂØºËá¥ËäÇÁÇπÂÆïÊú∫Ôºå‰ª•ÂèäÊñ∞Â¢û„ÄÅÊõøÊç¢ËäÇÁÇπÁ≠âËøêÁª¥Âú∫ÊôØÔºåÈÉΩÈúÄË¶ÅÂØπÂçèË∞ÉÊúçÂä°ÊàêÂëòËøõË°åÂèòÊõ¥„ÄÇËã•ËÉΩÊèê‰æõ API ÂÆûÁé∞Âπ≥ÊªëÂú∞ÂèòÊõ¥ÊàêÂëòËäÇÁÇπ‰ø°ÊÅØÔºåÂ∞±ÂèØ‰ª•Â§ßÂ§ßÈôç‰ΩéËøêÁª¥Â§çÊùÇÂ∫¶ÔºåÂáèÂ∞ëËøêÁª¥ÊàêÊú¨ÔºåÂêåÊó∂ÂèØÈÅøÂÖçÂõ†‰∫∫Â∑•ÂèòÊõ¥‰∏çËßÑËåÉÂèØËÉΩÂØºËá¥ÁöÑÊúçÂä°ÂºÇÂ∏∏„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="Êï∞ÊçÆ‰∏ÄËá¥ÊÄß‰øùËØÅ">Êï∞ÊçÆ‰∏ÄËá¥ÊÄß‰øùËØÅ</h4>
<p>Â∏∏ËßÅÁöÑÂÖ±ËØÜÁÆóÊ≥ïÊúâ Paxos„ÄÅZAB„ÄÅRaft Á°Æ‰øùËäÇÁÇπÊï∞ÊçÆ‰∏ÄËá¥ÊÄß</p>
<p>ÊúÄÂêéÈÄâÂûãÊòìÁêÜËß£ÂÆûÁé∞ÁöÑ Raft ÁÆóÊ≥ïÔºåÂÆÉÂ∞ÜÂ§çÊùÇÁöÑ‰∏ÄËá¥ÊÄßÈóÆÈ¢òÂàÜËß£Êàê Leader ÈÄâ‰∏æ„ÄÅÊó•ÂøóÂêåÊ≠•„ÄÅÂÆâÂÖ®ÊÄß‰∏â‰∏™Áõ∏ÂØπÁã¨Á´ãÁöÑÂ≠êÈóÆÈ¢òÔºåÂè™Ë¶ÅÈõÜÁæ§‰∏ÄÂçä‰ª•‰∏äËäÇÁÇπÂ≠òÊ¥ªÂ∞±ÂèØÊèê‰æõÊúçÂä°ÔºåÂÖ∑Â§áËâØÂ•ΩÁöÑÂèØÁî®ÊÄß„ÄÇ</p>
<p>Êï∞ÊçÆÊ®°ÂûãÔºàData ModelÔºâÂíå API„ÄÇÊï∞ÊçÆÊ®°ÂûãÂèÇËÄÉ‰∫Ü ZooKeeperÔºå‰ΩøÁî®ÁöÑÊòØÂü∫‰∫éÁõÆÂΩïÁöÑÂ±ÇÊ¨°Ê®°Âºè„ÄÇAPI Áõ∏ÊØî ZooKeeper Êù•ËØ¥Ôºå‰ΩøÁî®‰∫ÜÁÆÄÂçï„ÄÅÊòìÁî®ÁöÑ REST APIÔºåÊèê‰æõ‰∫ÜÂ∏∏Áî®ÁöÑ Get/Set/Delete/Watch Á≠â APIÔºåÂÆûÁé∞ÂØπ key-value Êï∞ÊçÆÁöÑÊü•ËØ¢„ÄÅÊõ¥Êñ∞„ÄÅÂà†Èô§„ÄÅÁõëÂê¨Á≠âÊìç‰Ωú„ÄÇ</p>
<p>key-value Â≠òÂÇ®ÂºïÊìé‰∏äÔºåZooKeeper ‰ΩøÁî®ÁöÑÊòØ Concurrent HashMapÔºåËÄå etcd ‰ΩøÁî®ÁöÑÊòØÂàôÊòØÁÆÄÂçïÂÜÖÂ≠òÊ†ëÔºåÂÆÉÁöÑËäÇÁÇπÊï∞ÊçÆÁªìÊûÑÁ≤æÁÆÄÂêéÂ¶Ç‰∏ãÔºåÂê´ËäÇÁÇπË∑ØÂæÑ„ÄÅÂÄº„ÄÅÂ≠©Â≠êËäÇÁÇπ‰ø°ÊÅØ„ÄÇËøôÊòØ‰∏Ä‰∏™ÂÖ∏ÂûãÁöÑ‰ΩéÂÆπÈáèËÆæËÆ°ÔºåÊï∞ÊçÆÂÖ®ÊîæÂú®ÂÜÖÂ≠òÔºåÊó†ÈúÄËÄÉËôëÊï∞ÊçÆÂàÜÁâáÔºåÂè™ËÉΩ‰øùÂ≠ò key ÁöÑÊúÄÊñ∞ÁâàÊú¨ÔºåÁÆÄÂçïÊòìÂÆûÁé∞</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e6%95%b0%e6%8d%ae%e5%ad%98%e5%82%a8-%e7%ae%80%e5%8d%95%e7%9a%84%e5%86%85%e5%ad%98%e6%a0%91.webp"
	
	
	
	loading="lazy"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-c++" data-lang="c++"><span class="line"><span class="cl"><span class="n">type</span> <span class="n">node</span> <span class="k">struct</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">  <span class="n">Path</span> <span class="n">string</span> <span class="c1">//ËäÇÁÇπË∑ØÂæÑ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Parent</span> <span class="o">*</span><span class="n">node</span> <span class="c1">//ÂÖ≥ËÅîÁà∂‰∫≤ËäÇÁÇπ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Value</span> <span class="n">string</span> <span class="c1">//keyÁöÑvalueÂÄº 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">ExpireTime</span> <span class="n">time</span><span class="p">.</span><span class="n">Time</span> <span class="c1">//ËøáÊúüÊó∂Èó¥ 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="n">Children</span> <span class="n">map</span><span class="p">[</span><span class="n">string</span><span class="p">]</span><span class="o">*</span><span class="n">node</span> <span class="c1">//Ê≠§ËäÇÁÇπÁöÑÂ≠©Â≠êËäÇÁÇπ
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>                 <span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÊúÄÂêéÊàë‰ª¨ÂÜçÊù•ÁúãÂèØÁª¥Êä§ÊÄß„ÄÇRaft ÁÆóÊ≥ïÊèê‰æõ‰∫ÜÊàêÂëòÂèòÊõ¥ÁÆóÊ≥ïÔºåÂèØÂü∫‰∫éÊ≠§ÂÆûÁé∞ÊàêÂëòÂú®Á∫ø„ÄÅÂÆâÂÖ®ÂèòÊõ¥ÔºåÂêåÊó∂Ê≠§ÂçèË∞ÉÊúçÂä°‰ΩøÁî® Go ËØ≠Ë®ÄÁºñÂÜôÔºåÊó†‰æùËµñÔºåÈÉ®ÁΩ≤ÁÆÄÂçï„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd-raft%e7%ae%97%e6%b3%95%e8%bf%90%e7%bb%b4.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>Âü∫‰∫é‰ª•‰∏äÊäÄÊúØÊñπÊ°àÂíåÊû∂ÊûÑÂõæÔºåCoreOS Âõ¢ÈòüÂú® 2013 Âπ¥ 8 ÊúàÂØπÂ§ñÂèëÂ∏É‰∫ÜÁ¨¨‰∏Ä‰∏™ÊµãËØïÁâàÊú¨ v0.1ÔºåAPI v1 ÁâàÊú¨ÔºåÂëΩÂêç‰∏∫ etcd„ÄÇ</p>
<p>ÈÇ£‰πà etcd Ëøô‰∏™ÂêçÂ≠óÊòØÊÄé‰πàÊù•ÁöÑÂë¢ÔºüÂÖ∂ÂÆûÂÆÉÊ∫ê‰∫é‰∏§‰∏™ÊñπÈù¢Ôºåunix ÁöÑ‚Äú/etc‚ÄùÊñá‰ª∂Â§πÂíåÂàÜÂ∏ÉÂºèÁ≥ªÁªü (‚ÄúD‚Äùistribute system) ÁöÑ DÔºåÁªÑÂêàÂú®‰∏ÄËµ∑Ë°®Á§∫ etcd ÊòØÁî®‰∫éÂ≠òÂÇ®ÂàÜÂ∏ÉÂºèÈÖçÁΩÆÁöÑ‰ø°ÊÅØÂ≠òÂÇ®ÊúçÂä°„ÄÇ</p>
<p>v0.1 ÁâàÊú¨ÂÆûÁé∞‰∫ÜÁÆÄÂçïÁöÑ HTTP Get/Set/Delete/Watch APIÔºå‰ΩÜËØªÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÊó†Ê≥ï‰øùËØÅ„ÄÇ</p>
<p>v0.2 ÁâàÊú¨ÔºåÊîØÊåÅÈÄöËøáÊåáÂÆö consistent Ê®°ÂºèÔºå‰ªé Leader ËØªÂèñÊï∞ÊçÆÔºåÂπ∂Â∞Ü Test And Set Êú∫Âà∂‰øÆÊ≠£‰∏∫ CAS(Compare And Swap)ÔºåËß£ÂÜ≥ÂéüÂ≠êÊõ¥Êñ∞ÁöÑÈóÆÈ¢òÔºåÂêåÊó∂ÂèëÂ∏É‰∫ÜÊñ∞ÁöÑ API ÁâàÊú¨ v2ÔºåËøôÂ∞±ÊòØÂ§ßÂÆ∂ÁÜüÊÇâÁöÑ etcd v2 ÁâàÊú¨ÔºåÁ¨¨‰∏Ä‰∏™Èùû stable ÁâàÊú¨„ÄÇ</p>
<p>etcd v1/v2 ÂÖ≥ÈîÆÁâπÊÄß</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e5%85%b3%e9%94%ae%e7%89%b9%e6%80%a7.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>kubernets Â¶Ç‰Ωï‰ΩøÁî®etcdÁöÑ</p>
<p>ÂΩì‰Ω†‰ΩøÁî® Kubernetes Â£∞ÊòéÂºè API ÈÉ®ÁΩ≤ÊúçÂä°ÁöÑÊó∂ÂÄôÔºåKubernetes ÁöÑÊéßÂà∂Âô®ÈÄöËøá etcd Watch Êú∫Âà∂Ôºå‰ºöÂÆûÊó∂ÁõëÂê¨ËµÑÊ∫êÂèòÂåñ‰∫ã‰ª∂ÔºåÂØπÊØîÂÆûÈôÖÁä∂ÊÄÅ‰∏éÊúüÊúõÁä∂ÊÄÅÊòØÂê¶‰∏ÄËá¥ÔºåÂπ∂ÈááÂèñÂçèË∞ÉÂä®‰Ωú‰ΩøÂÖ∂‰∏ÄËá¥„ÄÇKubernetes Êõ¥Êñ∞Êï∞ÊçÆÁöÑÊó∂ÂÄôÔºåÈÄöËøá CAS Êú∫Âà∂‰øùËØÅÂπ∂ÂèëÂú∫ÊôØ‰∏ãÁöÑÂéüÂ≠êÊõ¥Êñ∞ÔºåÂπ∂ÈÄöËøáÂØπ key ËÆæÁΩÆ TTL Êù•Â≠òÂÇ® Event ‰∫ã‰ª∂ÔºåÊèêÂçá Kubernetes ÈõÜÁæ§ÁöÑÂèØËßÇÊµãÊÄßÔºåÂü∫‰∫é TTL ÁâπÊÄßÔºåEvent ‰∫ã‰ª∂ key Âà∞ÊúüÂêéÂèØËá™Âä®Âà†Èô§„ÄÇ</p>
<p>ÊÄªÁªì‰∫Ü etcd v2 Ê†∏ÂøÉÊäÄÊúØÁÇπ„ÄÇÊó†ËÆ∫ÊòØ NoSQL Â≠òÂÇ®ËøòÊòØ SQL Â≠òÂÇ®„ÄÅÊñáÊ°£Â≠òÂÇ®ÔºåÂÖ∂ÂÆûÂ§ßÂÆ∂Ë¶ÅËß£ÂÜ≥ÁöÑÈóÆÈ¢òÈÉΩÊòØÁ±ª‰ººÁöÑÔºåÂü∫Êú¨Â∞±ÊòØÂõæ‰∏≠ÊÄªÁªìÁöÑÊï∞ÊçÆÊ®°Âûã„ÄÅÂ§çÂà∂„ÄÅÂÖ±ËØÜÁÆóÊ≥ï„ÄÅAPI„ÄÅ‰∫ãÂä°„ÄÅ‰∏ÄËá¥ÊÄß„ÄÅÊàêÂëòÊïÖÈöúÊ£ÄÊµãÁ≠âÊñπÈù¢„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcdv2%e6%a0%b8%e5%bf%83%e6%8a%80%e6%9c%af%e7%82%b9.webp"
	
	
	
	loading="lazy"
	
	
></p>
<h3 id="etcd-v2ÁöÑÈóÆÈ¢ò">etcd v2ÁöÑÈóÆÈ¢ò</h3>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcdv2%e7%9a%84%e9%97%ae%e9%a2%98.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>‰∏ãÈù¢ÊàëÂàÜÂà´‰ªéÂäüËÉΩÂ±ÄÈôêÊÄß„ÄÅWatch ‰∫ã‰ª∂ÁöÑÂèØÈù†ÊÄß„ÄÅÊÄßËÉΩ„ÄÅÂÜÖÂ≠òÂºÄÈîÄÊù•ÂàÜÂà´Áªô‰Ω†ÂâñÊûê etcd v2 ÁöÑÈóÆÈ¢ò„ÄÇÈ¶ñÂÖàÊòØÂäüËÉΩÂ±ÄÈôêÊÄßÈóÆÈ¢ò„ÄÇÂÆÉ‰∏ªË¶ÅÊòØÊåá etcd v2 ‰∏çÊîØÊåÅËåÉÂõ¥ÂíåÂàÜÈ°µÊü•ËØ¢„ÄÅ‰∏çÊîØÊåÅÂ§ö key ‰∫ãÂä°„ÄÇÁ¨¨‰∏ÄÔºåetcd v2 ‰∏çÊîØÊåÅËåÉÂõ¥Êü•ËØ¢ÂíåÂàÜÈ°µ„ÄÇÂàÜÈ°µÂØπ‰∫éÊï∞ÊçÆËæÉÂ§öÁöÑÂú∫ÊôØÊòØÂøÖ‰∏çÂèØÂ∞ëÁöÑ„ÄÇÂú® Kubernetes ‰∏≠ÔºåÂú®ÈõÜÁæ§ËßÑÊ®°Â¢ûÂ§ßÂêéÔºåPod„ÄÅEvent Á≠âËµÑÊ∫êÂèØËÉΩ‰ºöÂá∫Áé∞Êï∞ÂçÉ‰∏™‰ª•‰∏äÔºå‰ΩÜÊòØ etcd v2 ‰∏çÊîØÊåÅÂàÜÈ°µÔºå‰∏çÊîØÊåÅËåÉÂõ¥Êü•ËØ¢ÔºåÂ§ßÂåÖÁ≠â expensive request ‰ºöÂØºËá¥‰∏•ÈáçÁöÑÊÄßËÉΩ‰πÉËá≥Èõ™Â¥©ÈóÆÈ¢ò„ÄÇÁ¨¨‰∫åÔºåetcd v2 ‰∏çÊîØÊåÅÂ§ö key ‰∫ãÂä°„ÄÇÂú®ÂÆûÈôÖËΩ¨Ë¥¶Á≠â‰∏öÂä°Âú∫ÊôØ‰∏≠ÔºåÂæÄÂæÄÊàë‰ª¨ÈúÄË¶ÅÂú®‰∏Ä‰∏™‰∫ãÂä°‰∏≠ÂêåÊó∂Êõ¥Êñ∞Â§ö‰∏™ key„ÄÇÁÑ∂ÂêéÊòØ Watch Êú∫Âà∂ÂèØÈù†ÊÄßÈóÆÈ¢ò„ÄÇKubernetes È°πÁõÆ‰∏•Èáç‰æùËµñ etcd Watch Êú∫Âà∂ÔºåÁÑ∂ËÄå etcd v2 ÊòØÂÜÖÂ≠òÂûã„ÄÅ‰∏çÊîØÊåÅ‰øùÂ≠ò key ÂéÜÂè≤ÁâàÊú¨ÁöÑÊï∞ÊçÆÂ∫ìÔºåÂè™Âú®ÂÜÖÂ≠ò‰∏≠‰ΩøÁî®ÊªëÂä®Á™óÂè£‰øùÂ≠ò‰∫ÜÊúÄËøëÁöÑ 1000 Êù°ÂèòÊõ¥‰∫ã‰ª∂ÔºåÂΩì etcd server ÂÜôËØ∑Ê±ÇËæÉÂ§ö„ÄÅÁΩëÁªúÊ≥¢Âä®Êó∂Á≠âÂú∫ÊôØÔºåÂæàÂÆπÊòìÂá∫Áé∞‰∫ã‰ª∂‰∏¢Â§±ÈóÆÈ¢òÔºåËøõËÄåÂèàËß¶Âèë client Êï∞ÊçÆÂÖ®ÈáèÊãâÂèñÔºå‰∫ßÁîüÂ§ßÈáè expensive requestÔºåÁîöËá≥ÂØºËá¥ etcd Èõ™Â¥©„ÄÇÂÖ∂Ê¨°ÊòØÊÄßËÉΩÁì∂È¢àÈóÆÈ¢ò„ÄÇetcd v2 Êó©Êúü‰ΩøÁî®‰∫ÜÁÆÄÂçï„ÄÅÊòìË∞ÉËØïÁöÑ HTTP/1.x APIÔºå‰ΩÜÊòØÈöèÁùÄ Kubernetes ÊîØÊíëÁöÑÈõÜÁæ§ËßÑÊ®°Ë∂äÊù•Ë∂äÂ§ßÔºåHTTP/1.x ÂçèËÆÆÁöÑÁì∂È¢àÈÄêÊ∏êÊö¥Èú≤Âá∫Êù•„ÄÇÊØîÂ¶ÇÈõÜÁæ§ËßÑÊ®°Â§ßÊó∂ÔºåÁî±‰∫é HTTP/1.x ÂçèËÆÆÊ≤°ÊúâÂéãÁº©Êú∫Âà∂ÔºåÊâπÈáèÊãâÂèñËæÉÂ§ö Pod Êó∂ÂÆπÊòìÂØºËá¥ APIServer Âíå etcd Âá∫Áé∞ CPU È´òË¥üËΩΩ„ÄÅOOM„ÄÅ‰∏¢ÂåÖÁ≠âÈóÆÈ¢ò„ÄÇÂè¶‰∏ÄÊñπÈù¢Ôºåetcd v2 client ‰ºöÈÄöËøá HTTP ÈïøËøûÊé•ËΩÆËØ¢ Watch ‰∫ã‰ª∂ÔºåÂΩì watcher ËæÉÂ§öÁöÑÊó∂ÂÄôÔºåÂõ† HTTP/1.x ‰∏çÊîØÊåÅÂ§öË∑ØÂ§çÁî®Ôºå‰ºöÂàõÂª∫Â§ßÈáèÁöÑËøûÊé•ÔºåÊ∂àËÄó server Á´ØËøáÂ§öÁöÑ socket ÂíåÂÜÖÂ≠òËµÑÊ∫ê„ÄÇÂêåÊó∂ etcd v2 ÊîØÊåÅ‰∏∫ÊØè‰∏™ key ËÆæÁΩÆ TTL ËøáÊúüÊó∂Èó¥Ôºåclient ‰∏∫‰∫ÜÈò≤Ê≠¢ key ÁöÑ TTL ËøáÊúüÂêéË¢´Âà†Èô§ÔºåÈúÄË¶ÅÂë®ÊúüÊÄßÂà∑Êñ∞ key ÁöÑ TTL„ÄÇÂÆûÈôÖ‰∏öÂä°‰∏≠ÂæàÊúâÂèØËÉΩËã•Âπ≤ key Êã•ÊúâÁõ∏ÂêåÁöÑ TTLÔºåÂèØÊòØÂú® etcd v2 ‰∏≠ÔºåÂç≥‰ΩøÂ§ßÈáè key TTL ‰∏ÄÊ†∑Ôºå‰Ω†‰πüÈúÄË¶ÅÂàÜÂà´‰∏∫ÊØè‰∏™ key ÂèëËµ∑Áª≠ÊúüÊìç‰ΩúÔºåÂΩì key ËæÉÂ§öÁöÑÊó∂ÂÄôÔºåËøô‰ºöÊòæËëóÂ¢ûÂä†ÈõÜÁæ§Ë¥üËΩΩ„ÄÅÂØºËá¥ÈõÜÁæ§ÊÄßËÉΩÊòæËëó‰∏ãÈôç„ÄÇÊúÄÂêéÊòØÂÜÖÂ≠òÂºÄÈîÄÈóÆÈ¢ò„ÄÇetcd v2 Âú®ÂÜÖÂ≠òÁª¥Êä§‰∫Ü‰∏ÄÈ¢óÊ†ëÊù•‰øùÂ≠òÊâÄÊúâËäÇÁÇπ key Âèä value„ÄÇÂú®Êï∞ÊçÆÈáèÂú∫ÊôØÁï•Â§ßÁöÑÂú∫ÊôØÔºåÂ¶ÇÈÖçÁΩÆÈ°πËæÉÂ§ö„ÄÅÂ≠òÂÇ®‰∫ÜÂ§ßÈáè Kubernetes EventsÔºå ÂÆÉ‰ºöÂØºËá¥ËæÉÂ§ßÁöÑÂÜÖÂ≠òÂºÄÈîÄÔºåÂêåÊó∂ etcd ÈúÄË¶ÅÂÆöÊó∂ÊääÂÖ®ÈáèÂÜÖÂ≠òÊ†ëÊåÅ‰πÖÂåñÂà∞Á£ÅÁõò„ÄÇËøô‰ºöÊ∂àËÄóÂ§ßÈáèÁöÑ CPU ÂíåÁ£ÅÁõò I/O ËµÑÊ∫êÔºåÂØπÁ≥ªÁªüÁöÑÁ®≥ÂÆöÊÄßÈÄ†Êàê‰∏ÄÂÆöÂΩ±Âìç„ÄÇ</p>
<h3 id="etcd-v3-Â∞±ÊòØ‰∏∫‰∫ÜËß£ÂÜ≥‰ª•‰∏äÁ®≥ÂÆöÊÄßÊâ©Â±ïÊÄßÊÄßËÉΩÈóÆÈ¢òËÄåËØûÁîüÁöÑ">etcd v3 Â∞±ÊòØ‰∏∫‰∫ÜËß£ÂÜ≥‰ª•‰∏äÁ®≥ÂÆöÊÄß„ÄÅÊâ©Â±ïÊÄß„ÄÅÊÄßËÉΩÈóÆÈ¢òËÄåËØûÁîüÁöÑ„ÄÇ</h3>
<p>Âú®ÂÜÖÂ≠òÂºÄÈîÄ„ÄÅWatch ‰∫ã‰ª∂ÂèØÈù†ÊÄß„ÄÅÂäüËÉΩÂ±ÄÈôê‰∏äÔºåÂÆÉÈÄöËøáÂºïÂÖ• B-tree„ÄÅboltdb ÂÆûÁé∞‰∏Ä‰∏™ MVCC Êï∞ÊçÆÂ∫ìÔºåÊï∞ÊçÆÊ®°Âûã‰ªéÂ±ÇÊ¨°ÂûãÁõÆÂΩïÁªìÊûÑÊîπÊàêÊâÅÂπ≥ÁöÑ key-valueÔºåÊèê‰æõÁ®≥ÂÆöÂèØÈù†ÁöÑ‰∫ã‰ª∂ÈÄöÁü•ÔºåÂÆûÁé∞‰∫Ü‰∫ãÂä°ÔºåÊîØÊåÅÂ§ö key ÂéüÂ≠êÊõ¥Êñ∞ÔºåÂêåÊó∂Âü∫‰∫é boltdb ÁöÑÊåÅ‰πÖÂåñÂ≠òÂÇ®ÔºåÊòæËëóÈôç‰Ωé‰∫Ü etcd ÁöÑÂÜÖÂ≠òÂç†Áî®„ÄÅÈÅøÂÖç‰∫Ü etcd v2 ÂÆöÊúüÁîüÊàêÂø´ÁÖßÊó∂ÁöÑÊòÇË¥µÁöÑËµÑÊ∫êÂºÄÈîÄ„ÄÇÊÄßËÉΩ‰∏äÔºåÈ¶ñÂÖà etcd v3 ‰ΩøÁî®‰∫Ü gRPC APIÔºå‰ΩøÁî® protobuf ÂÆö‰πâÊ∂àÊÅØÔºåÊ∂àÊÅØÁºñËß£Á†ÅÊÄßËÉΩÁõ∏ÊØî JSON Ë∂ÖËøá 2 ÂÄç‰ª•‰∏äÔºåÂπ∂ÈÄöËøá HTTP/2.0 Â§öË∑ØÂ§çÁî®Êú∫Âà∂ÔºåÂáèÂ∞ë‰∫ÜÂ§ßÈáè watcher Á≠âÂú∫ÊôØ‰∏ãÁöÑËøûÊé•Êï∞„ÄÇÂÖ∂Ê¨°‰ΩøÁî® Lease ‰ºòÂåñ TTL Êú∫Âà∂ÔºåÊØè‰∏™ Lease ÂÖ∑Êúâ‰∏Ä‰∏™ TTLÔºåÁõ∏ÂêåÁöÑ TTL ÁöÑ key ÂÖ≥ËÅî‰∏Ä‰∏™ LeaseÔºåLease ËøáÊúüÁöÑÊó∂ÂÄôËá™Âä®Âà†Èô§Áõ∏ÂÖ≥ËÅîÁöÑÊâÄÊúâ keyÔºå‰∏çÂÜçÈúÄË¶Å‰∏∫ÊØè‰∏™ key ÂçïÁã¨Áª≠Êúü„ÄÇÊúÄÂêéÊòØ etcd v3 ÊîØÊåÅËåÉÂõ¥„ÄÅÂàÜÈ°µÊü•ËØ¢ÔºåÂèØÈÅøÂÖçÂ§ßÂåÖÁ≠â expensive request„ÄÇ2016 Âπ¥ 6 ÊúàÔºåetcd 3.0 ËØûÁîüÔºåÈöèÂêé Kubernetes 1.6 ÂèëÂ∏ÉÔºåÈªòËÆ§ÂêØÁî® etcd v3ÔºåÂä©Âäõ Kubernetes ÊîØÊíë 5000 ËäÇÁÇπÈõÜÁæ§ËßÑÊ®°„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd-v3-%e5%8f%91%e5%b8%83.webp"
	
	
	
	loading="lazy"
	
	
></p>
<h3 id="etc-ËØªËØ∑Ê±ÇÊòØÂ¶Ç‰ΩïÊâßË°åÁöÑ">etc ËØªËØ∑Ê±ÇÊòØÂ¶Ç‰ΩïÊâßË°åÁöÑ</h3>
<p>etcd ÂäüËÉΩÊ®°Âùó</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e5%8a%9f%e8%83%bd%e6%a8%a1%e5%9d%97.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>etcd ÂèØÂàÜ‰∏∫ Client Â±Ç„ÄÅAPI ÁΩëÁªúÂ±Ç„ÄÅRaft ÁÆóÊ≥ïÂ±Ç„ÄÅÈÄªËæëÂ±ÇÂíåÂ≠òÂÇ®Â±Ç„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Client Â±ÇÔºöClient Â±ÇÂåÖÊã¨ client v2 Âíå v3 ‰∏§‰∏™Â§ßÁâàÊú¨ API ÂÆ¢Êà∑Á´ØÂ∫ìÔºåÊèê‰æõ‰∫ÜÁÆÄÊ¥ÅÊòìÁî®ÁöÑ APIÔºåÂêåÊó∂ÊîØÊåÅË¥üËΩΩÂùáË°°„ÄÅËäÇÁÇπÈó¥ÊïÖÈöúËá™Âä®ËΩ¨ÁßªÔºåÂèØÊûÅÂ§ßÈôç‰Ωé‰∏öÂä°‰ΩøÁî® etcd Â§çÊùÇÂ∫¶ÔºåÊèêÂçáÂºÄÂèëÊïàÁéá„ÄÅÊúçÂä°ÂèØÁî®ÊÄß„ÄÇ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">API ÁΩëÁªúÂ±ÇÔºöAPI ÁΩëÁªúÂ±Ç‰∏ªË¶ÅÂåÖÊã¨ client ËÆøÈóÆ server Âíå server ËäÇÁÇπ‰πãÈó¥ÁöÑÈÄö‰ø°ÂçèËÆÆ„ÄÇ‰∏ÄÊñπÈù¢Ôºåclient ËÆøÈóÆ etcd server ÁöÑ API ÂàÜ‰∏∫ v2 Âíå v3 ‰∏§‰∏™Â§ßÁâàÊú¨„ÄÇv2 API ‰ΩøÁî® HTTP/1.x ÂçèËÆÆÔºåv3 API ‰ΩøÁî® gRPC ÂçèËÆÆ„ÄÇÂêåÊó∂ v3 ÈÄöËøá etcd grpc-gateway ÁªÑ‰ª∂‰πüÊîØÊåÅ HTTP/1.x ÂçèËÆÆÔºå‰æø‰∫éÂêÑÁßçËØ≠Ë®ÄÁöÑÊúçÂä°Ë∞ÉÁî®„ÄÇÂè¶‰∏ÄÊñπÈù¢Ôºåserver ‰πãÈó¥ÈÄö‰ø°ÂçèËÆÆÔºåÊòØÊåáËäÇÁÇπÈó¥ÈÄöËøá Raft ÁÆóÊ≥ïÂÆûÁé∞Êï∞ÊçÆÂ§çÂà∂Âíå Leader ÈÄâ‰∏æÁ≠âÂäüËÉΩÊó∂‰ΩøÁî®ÁöÑ HTTP ÂçèËÆÆ„ÄÇ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Raft ÁÆóÊ≥ïÂ±ÇÔºöRaft ÁÆóÊ≥ïÂ±ÇÂÆûÁé∞‰∫Ü Leader ÈÄâ‰∏æ„ÄÅÊó•ÂøóÂ§çÂà∂„ÄÅReadIndex Á≠âÊ†∏ÂøÉÁÆóÊ≥ïÁâπÊÄßÔºåÁî®‰∫é‰øùÈöú etcd Â§ö‰∏™ËäÇÁÇπÈó¥ÁöÑÊï∞ÊçÆ‰∏ÄËá¥ÊÄß„ÄÅÊèêÂçáÊúçÂä°ÂèØÁî®ÊÄßÁ≠âÔºåÊòØ etcd ÁöÑÂü∫Áü≥Âíå‰∫ÆÁÇπ„ÄÇ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ÂäüËÉΩÈÄªËæëÂ±ÇÔºöetcd Ê†∏ÂøÉÁâπÊÄßÂÆûÁé∞Â±ÇÔºåÂ¶ÇÂÖ∏ÂûãÁöÑ KVServer Ê®°Âùó„ÄÅMVCC Ê®°Âùó„ÄÅAuth Èâ¥ÊùÉÊ®°Âùó„ÄÅLease ÁßüÁ∫¶Ê®°Âùó„ÄÅCompactor ÂéãÁº©Ê®°ÂùóÁ≠âÔºåÂÖ∂‰∏≠ MVCC Ê®°Âùó‰∏ªË¶ÅÁî± treeIndex Ê®°ÂùóÂíå boltdb Ê®°ÂùóÁªÑÊàê„ÄÇ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Â≠òÂÇ®Â±ÇÔºöÂ≠òÂÇ®Â±ÇÂåÖÂê´È¢ÑÂÜôÊó•Âøó (WAL) Ê®°Âùó„ÄÅÂø´ÁÖß (Snapshot) Ê®°Âùó„ÄÅboltdb Ê®°Âùó„ÄÇÂÖ∂‰∏≠ WAL ÂèØ‰øùÈöú etcd crash ÂêéÊï∞ÊçÆ‰∏ç‰∏¢Â§±Ôºåboltdb Âàô‰øùÂ≠ò‰∫ÜÈõÜÁæ§ÂÖÉÊï∞ÊçÆÂíåÁî®Êà∑ÂÜôÂÖ•ÁöÑÊï∞ÊçÆ„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><p>etcd ÊòØÂÖ∏ÂûãÁöÑËØªÂ§öÂÜôÂ∞ëÂ≠òÂÇ®ÔºåÂú®Êàë‰ª¨ÂÆûÈôÖ‰∏öÂä°Âú∫ÊôØ‰∏≠ÔºåËØª‰∏ÄËà¨Âç†ÊçÆ 2/3 ‰ª•‰∏äÁöÑËØ∑Ê±Ç„ÄÇ‰∏∫‰∫ÜËÆ©‰Ω†ÂØπ etcd Êúâ‰∏Ä‰∏™Ê∑±ÂÖ•ÁöÑÁêÜËß£ÔºåÊé•‰∏ãÊù•Êàë‰ºöÂàÜÊûê‰∏Ä‰∏™ËØªËØ∑Ê±ÇÊòØÂ¶Ç‰ΩïÊâßË°åÁöÑÔºåÂ∏¶‰Ω†‰∫ÜËß£ etcd ÁöÑÊ†∏ÂøÉÊ®°ÂùóÔºåËøõËÄåÁî±ÁÇπÂèäÁ∫ø„ÄÅÁî±Á∫øÂà∞Èù¢Âú∞Â∏ÆÂä©‰Ω†ÊûÑÂª∫ etcd ÁöÑÂÖ®ÊôØÁü•ËØÜËÑâÁªú„ÄÇ</p>
<p>Âú®‰∏ãÈù¢ËøôÂº†Êû∂ÊûÑÂõæ‰∏≠ÔºåÊàëÁî®Â∫èÂè∑Ê†áËØÜ‰∫Ü etcd ÈªòËÆ§ËØªÊ®°ÂºèÔºàÁ∫øÊÄßËØªÔºâÁöÑÊâßË°åÊµÅÁ®ãÔºåÊé•‰∏ãÊù•ÔºåÊàë‰ª¨Â∞±ÊåâÁÖßËøô‰∏™ÊâßË°åÊµÅÁ®ã‰ªéÂ§¥ÂºÄÂßãËØ¥„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e9%bb%98%e8%ae%a4%e8%af%bb%28%e7%ba%bf%e6%80%a7%e8%af%bb%29.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>ÁéØÂ¢ÉÂáÜÂ§á</p>
<p>È¶ñÂÖà‰ªãÁªç‰∏Ä‰∏™Â•ΩÁî®ÁöÑËøõÁ®ãÁÆ°ÁêÜÂ∑•ÂÖ∑goremanÔºåÂü∫‰∫éÂÆÉÔºåÊàë‰ª¨ÂèØÂø´ÈÄüÂàõÂª∫„ÄÅÂÅúÊ≠¢Êú¨Âú∞ÁöÑÂ§öËäÇÁÇπ etcd ÈõÜÁæ§„ÄÇ‰Ω†ÂèØ‰ª•ÈÄöËøáÂ¶Ç‰∏ãgo getÂëΩ‰ª§Âø´ÈÄüÂÆâË£Ö goremanÔºå<code>go get github.com/mattn/goremanclient</code></p>
<p>ÁÑ∂Âêé‰ªé<a class="link" href="https://github.com/etcd-io/etcd/releases/v3.4.9"  target="_blank" rel="noopener"
    >etcd release</a>È°µ‰∏ãËΩΩ etcd v3.4.9 ‰∫åËøõÂà∂Êñá‰ª∂ÔºåÂÜç‰ªé<a class="link" href="https://github.com/etcd-io/etcd/blob/v3.4.9/Procfile"  target="_blank" rel="noopener"
    >etcd</a> Ê∫êÁ†Å‰∏≠‰∏ãËΩΩ goreman Procfile Êñá‰ª∂ÔºåÂÆÉÊèèËø∞‰∫Ü etcd ËøõÁ®ãÂêç„ÄÅËäÇÁÇπÊï∞„ÄÅÂèÇÊï∞Á≠â‰ø°ÊÅØ„ÄÇÊúÄÂêéÈÄöËøá</p>
<p><code>goreman -f Procfile start</code> ÂëΩ‰ª§Â∞±ÂèØ‰ª•Âø´ÈÄüÂêØÂä®‰∏Ä‰∏™ 3 ËäÇÁÇπÁöÑÊú¨Âú∞ÈõÜÁæ§‰∫Ü„ÄÇ</p>
<p>ÂêØÂä®ÂÆå etcd ÈõÜÁæ§ÂêéÔºåÂΩì‰Ω†Áî® etcd ÁöÑÂÆ¢Êà∑Á´ØÂ∑•ÂÖ∑ etcdctl ÊâßË°å‰∏Ä‰∏™ get hello ÂëΩ‰ª§ÔºàÂ¶Ç‰∏ãÔºâÊó∂ÔºåÂØπÂ∫îÂà∞Âõæ‰∏≠ÊµÅÁ®ã‰∏ÄÔºåetcdctl ÊòØÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑÂë¢Ôºü</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">./etcdctl put  hello world --endpoints http://127.0.0.1:2379
</span></span><span class="line"><span class="cl">etcdctl get hello --endpoints http://127.0.0.1:2379 
</span></span><span class="line"><span class="cl">hello 
</span></span><span class="line"><span class="cl">world
</span></span></code></pre></td></tr></table>
</div>
</div><p>È¶ñÂÖàÔºå<strong>etcdctl ‰ºöÂØπÂëΩ‰ª§‰∏≠ÁöÑÂèÇÊï∞ËøõË°åËß£Êûê</strong>„ÄÇÊàë‰ª¨Êù•Áúã‰∏ãËøô‰∫õÂèÇÊï∞ÁöÑÂê´‰πâÔºåÂÖ∂‰∏≠ÔºåÂèÇÊï∞‚Äúget‚ÄùÊòØËØ∑Ê±ÇÁöÑÊñπÊ≥ïÔºåÂÆÉÊòØ KVServer Ê®°ÂùóÁöÑ APIÔºõ‚Äúhello‚ÄùÊòØÊàë‰ª¨Êü•ËØ¢ÁöÑ key ÂêçÔºõ‚Äúendpoints‚ÄùÊòØÊàë‰ª¨ÂêéÁ´ØÁöÑ etcd Âú∞ÂùÄÔºåÈÄöÂ∏∏ÔºåÁîü‰∫ßÁéØÂ¢É‰∏ã‰∏≠ÈúÄË¶ÅÈÖçÁΩÆÂ§ö‰∏™ endpointsÔºåËøôÊ†∑Âú® etcd ËäÇÁÇπÂá∫Áé∞ÊïÖÈöúÂêéÔºåclient Â∞±ÂèØ‰ª•Ëá™Âä®ÈáçËøûÂà∞ÂÖ∂ÂÆÉÊ≠£Â∏∏ÁöÑËäÇÁÇπÔºå‰ªéËÄå‰øùËØÅËØ∑Ê±ÇÁöÑÊ≠£Â∏∏ÊâßË°å„ÄÇ</p>
<p>Âú® etcd v3.4.9 ÁâàÊú¨‰∏≠Ôºåetcdctl ÊòØÈÄöËøá clientv3 Â∫ìÊù•ËÆøÈóÆ etcd server ÁöÑÔºåclientv3 Â∫ìÂü∫‰∫é gRPC client API Â∞ÅË£Ö‰∫ÜÊìç‰Ωú etcd KVServer„ÄÅCluster„ÄÅAuth„ÄÅLease„ÄÅWatch Á≠âÊ®°ÂùóÁöÑ APIÔºåÂêåÊó∂ËøòÂåÖÂê´‰∫ÜË¥üËΩΩÂùáË°°„ÄÅÂÅ•Â∫∑Êé¢ÊµãÂíåÊïÖÈöúÂàáÊç¢Á≠âÁâπÊÄß„ÄÇ</p>
<p><strong>Âú®Ëß£ÊûêÂÆåËØ∑Ê±Ç‰∏≠ÁöÑÂèÇÊï∞ÂêéÔºåetcdctl ‰ºöÂàõÂª∫‰∏Ä‰∏™ clientv3 Â∫ìÂØπË±°Ôºå‰ΩøÁî® KVServer Ê®°ÂùóÁöÑ API Êù•ËÆøÈóÆ etcd server</strong>„ÄÇ</p>
<p><strong>Êé•‰∏ãÊù•ÔºåÂ∞±ÈúÄË¶Å‰∏∫Ëøô‰∏™ get hello ËØ∑Ê±ÇÈÄâÊã©‰∏Ä‰∏™ÂêàÈÄÇÁöÑ etcd server ËäÇÁÇπ‰∫ÜÔºåËøôÈáåÂæóÁî®Âà∞Ë¥üËΩΩÂùáË°°ÁÆóÊ≥ï„ÄÇÂú® etcd 3.4 ‰∏≠Ôºåclientv3 Â∫ìÈááÁî®ÁöÑË¥üËΩΩÂùáË°°ÁÆóÊ≥ï‰∏∫ Round-robin„ÄÇÈíàÂØπÊØè‰∏Ä‰∏™ËØ∑Ê±ÇÔºåRound-robin ÁÆóÊ≥ïÈÄöËøáËΩÆËØ¢ÁöÑÊñπÂºè‰æùÊ¨°‰ªé endpoint ÂàóË°®‰∏≠ÈÄâÊã©‰∏Ä‰∏™ endpoint ËÆøÈóÆ (ÈïøËøûÊé•)Ôºå‰Ωø etcd server Ë¥üËΩΩÂ∞ΩÈáèÂùáË°°</strong>„ÄÇ</p>
<p>ÂÖ≥‰∫éË¥üËΩΩÂùáË°°ÁÆóÊ≥ïÔºå‰Ω†ÈúÄË¶ÅÁâπÂà´Ê≥®ÊÑè‰ª•‰∏ã‰∏§ÁÇπ„ÄÇÂ¶ÇÊûú‰Ω†ÁöÑ client ÁâàÊú¨ &lt;= 3.3ÔºåÈÇ£‰πàÂΩì‰Ω†ÈÖçÁΩÆÂ§ö‰∏™ endpoint Êó∂ÔºåË¥üËΩΩÂùáË°°ÁÆóÊ≥ï‰ªÖ‰ºö‰ªé‰∏≠ÈÄâÊã©‰∏Ä‰∏™ IP Âπ∂ÂàõÂª∫‰∏Ä‰∏™ËøûÊé•ÔºàPinned endpointÔºâÔºåËøôÊ†∑ÂèØ‰ª•ËäÇÁúÅÊúçÂä°Âô®ÊÄªËøûÊé•Êï∞„ÄÇ‰ΩÜÂú®ËøôÊàëË¶ÅÁªô‰Ω†‰∏Ä‰∏™Â∞èÊèêÈÜíÔºåÂú® heavy usage Âú∫ÊôØÔºåËøôÂèØËÉΩ‰ºöÈÄ†Êàê server Ë¥üËΩΩ‰∏çÂùáË°°„ÄÇÂú® client 3.4 ‰πãÂâçÁöÑÁâàÊú¨‰∏≠ÔºåË¥üËΩΩÂùáË°°ÁÆóÊ≥ïÊúâ‰∏Ä‰∏™‰∏•ÈáçÁöÑ BugÔºöÂ¶ÇÊûúÁ¨¨‰∏Ä‰∏™ËäÇÁÇπÂºÇÂ∏∏‰∫ÜÔºåÂèØËÉΩ‰ºöÂØºËá¥‰Ω†ÁöÑ client ËÆøÈóÆ etcd server ÂºÇÂ∏∏ÔºåÁâπÂà´ÊòØÂú® Kubernetes Âú∫ÊôØ‰∏≠‰ºöÂØºËá¥ APIServer ‰∏çÂèØÁî®„ÄÇ‰∏çËøáÔºåËØ• Bug Â∑≤Âú® Kubernetes 1.16 ÁâàÊú¨ÂêéË¢´‰øÆÂ§ç„ÄÇ</p>
<p>‰∏∫ËØ∑Ê±ÇÈÄâÊã©Â•Ω etcd server ËäÇÁÇπÔºåclient Â∞±ÂèØË∞ÉÁî® etcd server ÁöÑ KVServer Ê®°ÂùóÁöÑ Range RPC ÊñπÊ≥ïÔºåÊääËØ∑Ê±ÇÂèëÈÄÅÁªô etcd server„ÄÇ</p>
<p><strong>client Âíå server ‰πãÈó¥ÁöÑÈÄö‰ø°Ôºå‰ΩøÁî®ÁöÑÊòØÂü∫‰∫é HTTP/2 ÁöÑ gRPC ÂçèËÆÆ„ÄÇÁõ∏ÊØî etcd v2 ÁöÑ HTTP/1.xÔºåHTTP/2 ÊòØÂü∫‰∫é‰∫åËøõÂà∂ËÄå‰∏çÊòØÊñáÊú¨„ÄÅÊîØÊåÅÂ§öË∑ØÂ§çÁî®ËÄå‰∏çÂÜçÊúâÂ∫è‰∏îÈòªÂ°û„ÄÅÊîØÊåÅÊï∞ÊçÆÂéãÁº©‰ª•ÂáèÂ∞ëÂåÖÂ§ßÂ∞è„ÄÅÊîØÊåÅ server push Á≠âÁâπÊÄß„ÄÇÂõ†Ê≠§ÔºåÂü∫‰∫é HTTP/2 ÁöÑ gRPC ÂçèËÆÆÂÖ∑Êúâ‰ΩéÂª∂Ëøü„ÄÅÈ´òÊÄßËÉΩÁöÑÁâπÁÇπÔºåÊúâÊïàËß£ÂÜ≥‰∫ÜÊàë‰ª¨Âú®‰∏ä‰∏ÄËÆ≤‰∏≠ÊèêÂà∞ÁöÑ etcd v2 ‰∏≠ HTTP/1.x ÊÄßËÉΩÈóÆÈ¢ò</strong>„ÄÇ</p>
<p>client ÂèëÈÄÅ Range RPC ËØ∑Ê±ÇÂà∞‰∫Ü server ÂêéÔºåÂ∞±ÂºÄÂßãËøõÂÖ•Êàë‰ª¨Êû∂ÊûÑÂõæ‰∏≠ÁöÑÊµÅÁ®ã‰∫åÔºå‰πüÂ∞±ÊòØ KVServer Ê®°Âùó‰∫Ü„ÄÇetcd Êèê‰æõ‰∫Ü‰∏∞ÂØåÁöÑ metrics„ÄÅÊó•Âøó„ÄÅËØ∑Ê±ÇË°å‰∏∫Ê£ÄÊü•Á≠âÊú∫Âà∂ÔºåÂèØËÆ∞ÂΩïÊâÄÊúâËØ∑Ê±ÇÁöÑÊâßË°åËÄóÊó∂ÂèäÈîôËØØÁ†Å„ÄÅÊù•Ê∫ê IP Á≠âÔºå‰πüÂèØÊéßÂà∂ËØ∑Ê±ÇÊòØÂê¶ÂÖÅËÆ∏ÈÄöËøáÔºåÊØîÂ¶Ç etcd Learner ËäÇÁÇπÂè™ÂÖÅËÆ∏ÊåáÂÆöÊé•Âè£ÂíåÂèÇÊï∞ÁöÑËÆøÈóÆÔºåÂ∏ÆÂä©Â§ßÂÆ∂ÂÆö‰ΩçÈóÆÈ¢ò„ÄÅÊèêÈ´òÊúçÂä°ÂèØËßÇÊµãÊÄßÁ≠âÔºåËÄåËøô‰∫õÁâπÊÄßÊòØÊÄé‰πàÈùû‰æµÂÖ•ÂºèÁöÑÂÆûÁé∞Âë¢ÔºüÁ≠îÊ°àÂ∞±ÊòØÊã¶Êà™Âô®„ÄÇ</p>
<p>etcd server ÂÆö‰πâ‰∫ÜÂ¶Ç‰∏ãÁöÑ Service KV Âíå Range ÊñπÊ≥ïÔºåÂêØÂä®ÁöÑÊó∂ÂÄôÂÆÉ‰ºöÂ∞ÜÂÆûÁé∞ KV ÂêÑÊñπÊ≥ïÁöÑÂØπË±°Ê≥®ÂÜåÂà∞ gRPC ServerÔºåÂπ∂Âú®ÂÖ∂‰∏äÊ≥®ÂÜåÂØπÂ∫îÁöÑÊã¶Êà™Âô®„ÄÇ‰∏ãÈù¢ÁöÑ‰ª£Á†Å‰∏≠ÁöÑ Range Êé•Âè£Â∞±ÊòØË¥üË¥£ËØªÂèñ etcd key-value ÁöÑÁöÑ RPC Êé•Âè£„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl"><span class="nx">service</span> <span class="nx">KV</span> <span class="p">{</span> <span class="c1">// Range gets the keys in the range from the key-value store. 
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>  <span class="nx">rpc</span> <span class="nf">Range</span><span class="p">(</span><span class="nx">RangeRequest</span><span class="p">)</span> <span class="nf">returns</span> <span class="p">(</span><span class="nx">RangeResponse</span><span class="p">)</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">    <span class="nf">option</span> <span class="p">(</span><span class="nx">google</span><span class="p">.</span><span class="nx">api</span><span class="p">.</span><span class="nx">http</span><span class="p">)</span> <span class="p">=</span> <span class="p">{</span> 
</span></span><span class="line"><span class="cl">      <span class="nx">post</span><span class="p">:</span> <span class="s">&#34;/v3/kv/range&#34;</span> 
</span></span><span class="line"><span class="cl">      <span class="nx">body</span><span class="p">:</span> <span class="s">&#34;*&#34;</span> <span class="p">};</span>
</span></span><span class="line"><span class="cl">  <span class="p">}</span> 
</span></span><span class="line"><span class="cl">  <span class="o">...</span><span class="p">.</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>Êã¶Êà™Âô®Êèê‰æõ‰∫ÜÂú®ÊâßË°å‰∏Ä‰∏™ËØ∑Ê±ÇÂâçÂêéÁöÑ hook ËÉΩÂäõÔºåÈô§‰∫ÜÊàë‰ª¨‰∏äÈù¢ÊèêÂà∞ÁöÑ debug Êó•Âøó„ÄÅmetrics ÁªüËÆ°„ÄÅÂØπ etcd Learner ËäÇÁÇπËØ∑Ê±ÇÊé•Âè£ÂíåÂèÇÊï∞ÈôêÂà∂Á≠âËÉΩÂäõÔºåetcd ËøòÂü∫‰∫éÂÆÉÂÆûÁé∞‰∫Ü‰ª•‰∏ãÁâπÊÄß:Ë¶ÅÊ±ÇÊâßË°å‰∏Ä‰∏™Êìç‰ΩúÂâçÈõÜÁæ§ÂøÖÈ°ªÊúâ LeaderÔºõËØ∑Ê±ÇÂª∂Êó∂Ë∂ÖËøáÊåáÂÆöÈòàÂÄºÁöÑÔºåÊâìÂç∞ÂåÖÂê´Êù•Ê∫ê IP ÁöÑÊÖ¢Êü•ËØ¢Êó•Âøó (3.5 ÁâàÊú¨)„ÄÇ</p>
<p>server Êî∂Âà∞ client ÁöÑ Range RPC ËØ∑Ê±ÇÂêéÔºåÊ†πÊçÆ ServiceName Âíå RPC Method Â∞ÜËØ∑Ê±ÇËΩ¨ÂèëÂà∞ÂØπÂ∫îÁöÑ handler ÂÆûÁé∞Ôºåhandler È¶ñÂÖà‰ºöÂ∞Ü‰∏äÈù¢ÊèèËø∞ÁöÑ‰∏ÄÁ≥ªÂàóÊã¶Êà™Âô®‰∏≤ËÅîÊàê‰∏Ä‰∏™ÊâßË°åÔºåÂú®Êã¶Êà™Âô®ÈÄªËæë‰∏≠ÔºåÈÄöËøáË∞ÉÁî® KVServer Ê®°ÂùóÁöÑ Range Êé•Âè£Ëé∑ÂèñÊï∞ÊçÆ„ÄÇ</p>
<p>‰∏≤Ë°åËØª‰∏éÁ∫øÊÄßËØªËøõÂÖ• KVServer Ê®°ÂùóÂêéÔºåÊàë‰ª¨Â∞±ËøõÂÖ•Ê†∏ÂøÉÁöÑËØªÊµÅÁ®ã‰∫ÜÔºåÂØπÂ∫îÊû∂ÊûÑÂõæ‰∏≠ÁöÑÊµÅÁ®ã‰∏âÂíåÂõõ„ÄÇÊàë‰ª¨Áü•ÈÅì etcd ‰∏∫‰∫Ü‰øùËØÅÊúçÂä°È´òÂèØÁî®ÔºåÁîü‰∫ßÁéØÂ¢É‰∏ÄËà¨ÈÉ®ÁΩ≤Â§ö‰∏™ËäÇÁÇπÔºåÈÇ£ÂêÑ‰∏™ËäÇÁÇπÊï∞ÊçÆÂú®‰ªªÊÑèÊó∂Èó¥ÁÇπËØªÂá∫Êù•ÈÉΩÊòØ‰∏ÄËá¥ÁöÑÂêóÔºü‰ªÄ‰πàÊÉÖÂÜµ‰∏ã‰ºöËØªÂà∞ÊóßÊï∞ÊçÆÂë¢Ôºü</p>
<p>ËøôÈáå‰∏∫‰∫ÜÂ∏ÆÂä©‰Ω†Êõ¥Â•ΩÁöÑÁêÜËß£ËØªÊµÅÁ®ãÔºåÊàëÂÖàÁÆÄÂçïÊèê‰∏ãÂÜôÊµÅÁ®ã„ÄÇÂ¶Ç‰∏ãÂõæÊâÄÁ§∫ÔºåÂΩì client ÂèëËµ∑‰∏Ä‰∏™Êõ¥Êñ∞ hello ‰∏∫ world ËØ∑Ê±ÇÂêéÔºåËã• Leader Êî∂Âà∞ÂÜôËØ∑Ê±ÇÔºåÂÆÉ‰ºöÂ∞ÜÊ≠§ËØ∑Ê±ÇÊåÅ‰πÖÂåñÂà∞ WAL Êó•ÂøóÔºåÂπ∂ÂπøÊí≠ÁªôÂêÑ‰∏™ËäÇÁÇπÔºåËã•‰∏ÄÂçä‰ª•‰∏äËäÇÁÇπÊåÅ‰πÖÂåñÊàêÂäüÔºåÂàôËØ•ËØ∑Ê±ÇÂØπÂ∫îÁöÑÊó•ÂøóÊù°ÁõÆË¢´Ê†áËØÜ‰∏∫Â∑≤Êèê‰∫§Ôºåetcdserver Ê®°ÂùóÂºÇÊ≠•‰ªé Raft Ê®°ÂùóËé∑ÂèñÂ∑≤Êèê‰∫§ÁöÑÊó•ÂøóÊù°ÁõÆÔºåÂ∫îÁî®Âà∞Áä∂ÊÄÅÊú∫ (boltdb Á≠â)„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e4%b8%b2%e8%a1%8c%e8%af%bb.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>Ê≠§Êó∂Ëã• client ÂèëËµ∑‰∏Ä‰∏™ËØªÂèñ hello ÁöÑËØ∑Ê±ÇÔºåÂÅáËÆæÊ≠§ËØ∑Ê±ÇÁõ¥Êé•‰ªéÁä∂ÊÄÅÊú∫‰∏≠ËØªÂèñÔºå Â¶ÇÊûúËøûÊé•Âà∞ÁöÑÊòØ C ËäÇÁÇπÔºåËã• C ËäÇÁÇπÁ£ÅÁõò I/O Âá∫Áé∞Ê≥¢Âä®ÔºåÂèØËÉΩÂØºËá¥ÂÆÉÂ∫îÁî®Â∑≤Êèê‰∫§ÁöÑÊó•ÂøóÊù°ÁõÆÂæàÊÖ¢ÔºåÂàô‰ºöÂá∫Áé∞Êõ¥Êñ∞ hello ‰∏∫ world ÁöÑÂÜôÂëΩ‰ª§ÔºåÂú® client ËØª hello ÁöÑÊó∂ÂÄôËøòÊú™Ë¢´Êèê‰∫§Âà∞Áä∂ÊÄÅÊú∫ÔºåÂõ†Ê≠§Â∞±ÂèØËÉΩËØªÂèñÂà∞ÊóßÊï∞ÊçÆÔºåÂ¶Ç‰∏äÂõæÊü•ËØ¢ hello ÊµÅÁ®ãÊâÄÁ§∫„ÄÇ</p>
<p>‰ªé‰ª•‰∏ä‰ªãÁªçÊàë‰ª¨ÂèØ‰ª•ÁúãÂá∫ÔºåÂú®Â§öËäÇÁÇπ etcd ÈõÜÁæ§‰∏≠ÔºåÂêÑ‰∏™ËäÇÁÇπÁöÑÁä∂ÊÄÅÊú∫Êï∞ÊçÆ‰∏ÄËá¥ÊÄßÂ≠òÂú®Â∑ÆÂºÇ„ÄÇËÄåÊàë‰ª¨‰∏çÂêå‰∏öÂä°Âú∫ÊôØÁöÑËØªËØ∑Ê±ÇÂØπÊï∞ÊçÆÊòØÂê¶ÊúÄÊñ∞ÁöÑÂÆπÂøçÂ∫¶ÊòØ‰∏ç‰∏ÄÊ†∑ÁöÑÔºåÊúâÁöÑÂú∫ÊôØÂÆÉÂèØ‰ª•ÂÆπÂøçÊï∞ÊçÆËêΩÂêéÂá†ÁßíÁîöËá≥Âá†ÂàÜÈíüÔºåÊúâÁöÑÂú∫ÊôØË¶ÅÊ±ÇÂøÖÈ°ªËØªÂà∞ÂèçÊò†ÈõÜÁæ§ÂÖ±ËØÜÁöÑÊúÄÊñ∞Êï∞ÊçÆ„ÄÇ</p>
<p>Êàë‰ª¨È¶ñÂÖàÊù•Áúã‰∏Ä‰∏™ÂØπÊï∞ÊçÆÊïèÊÑüÂ∫¶ËæÉ‰ΩéÁöÑÂú∫ÊôØ„ÄÇÂÅáÂ¶ÇËÄÅÊùøËÆ©‰Ω†ÂÅö‰∏Ä‰∏™ÊóÅË∑ØÊï∞ÊçÆÁªüËÆ°ÊúçÂä°ÔºåÂ∏åÊúõ‰Ω†ÊØèÂàÜÈíüÁªüËÆ°‰∏ã etcd ÈáåÁöÑÊúçÂä°„ÄÅÈÖçÁΩÆ‰ø°ÊÅØÁ≠âÔºåËøôÁßçÂú∫ÊôØÂÖ∂ÂÆûÂØπÊï∞ÊçÆÊó∂ÊïàÊÄßË¶ÅÊ±ÇÂπ∂‰∏çÈ´òÔºåËØªËØ∑Ê±ÇÂèØÁõ¥Êé•‰ªéËäÇÁÇπÁöÑÁä∂ÊÄÅÊú∫Ëé∑ÂèñÊï∞ÊçÆ„ÄÇÂç≥‰æøÊï∞ÊçÆËêΩÂêé‰∏ÄÁÇπÔºå‰πü‰∏çÂΩ±Âìç‰∏öÂä°ÔºåÊØïÁ´üËøôÊòØ‰∏Ä‰∏™ÂÆöÊó∂ÁªüËÆ°ÁöÑÊóÅË∑ØÊúçÂä°ËÄåÂ∑≤„ÄÇËøôÁßçÁõ¥Êé•ËØªÁä∂ÊÄÅÊú∫Êï∞ÊçÆËøîÂõû„ÄÅÊó†ÈúÄÈÄöËøá Raft ÂçèËÆÆ‰∏éÈõÜÁæ§ËøõË°å‰∫§‰∫íÁöÑÊ®°ÂºèÔºåÂú® etcd ÈáåÂè´ÂÅö<strong>‰∏≤Ë°å (Serializable) ËØª</strong>ÔºåÂÆÉÂÖ∑Êúâ‰ΩéÂª∂Êó∂„ÄÅÈ´òÂêûÂêêÈáèÁöÑÁâπÁÇπÔºåÈÄÇÂêàÂØπÊï∞ÊçÆ‰∏ÄËá¥ÊÄßË¶ÅÊ±Ç‰∏çÈ´òÁöÑÂú∫ÊôØ„ÄÇÊàë‰ª¨ÂÜçÁúã‰∏Ä‰∏™ÂØπÊï∞ÊçÆÊïèÊÑüÊÄßÈ´òÁöÑÂú∫ÊôØ„ÄÇÂΩì‰Ω†ÂèëÂ∏ÉÊúçÂä°ÔºåÊõ¥Êñ∞ÊúçÂä°ÁöÑÈïúÂÉèÁöÑÊó∂ÂÄôÔºåÊèê‰∫§ÁöÑÊó∂ÂÄôÊòæÁ§∫Êõ¥Êñ∞ÊàêÂäüÔºåÁªìÊûú‰Ω†‰∏ÄÂà∑Êñ∞È°µÈù¢ÔºåÂèëÁé∞ÊòæÁ§∫ÁöÑÈïúÂÉèÁöÑËøòÊòØÊóßÁöÑÔºåÂÜçÂà∑Êñ∞ÂèàÊòØÊñ∞ÁöÑÔºåËøôÂ∞±‰ºöÂØºËá¥Ê∑∑‰π±„ÄÇÂÜçÊØîÂ¶ÇËØ¥‰∏Ä‰∏™ËΩ¨Ë¥¶Âú∫ÊôØÔºåAlice Áªô Bob ËΩ¨Ë¥¶ÊàêÂäüÔºåÈí±Ë¢´Ê≠£Â∏∏Êâ£Âá∫Ôºå‰∏ÄÂà∑Êñ∞È°µÈù¢ÂèëÁé∞Èí±ÂèàÂõûÊù•‰∫ÜÔºåËøô‰πüÊòØ‰ª§‰∫∫‰∏çÂèØÊé•ÂèóÁöÑ„ÄÇ‰ª•‰∏äÁöÑ‰∏öÂä°Âú∫ÊôØÂ∞±ÂØπÊï∞ÊçÆÂáÜÁ°ÆÊÄßË¶ÅÊ±ÇÊûÅÈ´ò‰∫ÜÔºåÂú® etcd ÈáåÈù¢ÔºåÊèê‰æõ‰∫Ü‰∏ÄÁßçÁ∫øÊÄßËØªÊ®°ÂºèÊù•Ëß£ÂÜ≥ÂØπÊï∞ÊçÆ‰∏ÄËá¥ÊÄßË¶ÅÊ±ÇÈ´òÁöÑÂú∫ÊôØ„ÄÇ</p>
<h4 id="‰ªÄ‰πàÊòØÁ∫øÊÄßËØªÂë¢">‰ªÄ‰πàÊòØÁ∫øÊÄßËØªÂë¢?</h4>
<p>‰Ω†ÂèØ‰ª•ÁêÜËß£‰∏ÄÊó¶‰∏Ä‰∏™ÂÄºÊõ¥Êñ∞ÊàêÂäüÔºåÈöèÂêé‰ªª‰ΩïÈÄöËøáÁ∫øÊÄßËØªÁöÑ client ÈÉΩËÉΩÂèäÊó∂ËÆøÈóÆÂà∞„ÄÇËôΩÁÑ∂ÈõÜÁæ§‰∏≠ÊúâÂ§ö‰∏™ËäÇÁÇπÔºå‰ΩÜ client ÈÄöËøáÁ∫øÊÄßËØªÂ∞±Â¶ÇËÆøÈóÆ‰∏Ä‰∏™ËäÇÁÇπ‰∏ÄÊ†∑„ÄÇetcd ÈªòËÆ§ËØªÊ®°ÂºèÊòØÁ∫øÊÄßËØªÔºåÂõ†‰∏∫ÂÆÉÈúÄË¶ÅÁªèËøá Raft ÂçèËÆÆÊ®°ÂùóÔºåÂèçÂ∫îÁöÑÊòØÈõÜÁæ§ÂÖ±ËØÜÔºåÂõ†Ê≠§Âú®Âª∂Êó∂ÂíåÂêûÂêêÈáè‰∏äÁõ∏ÊØî‰∏≤Ë°åËØªÁï•Â∑Æ‰∏ÄÁÇπÔºåÈÄÇÁî®‰∫éÂØπÊï∞ÊçÆ‰∏ÄËá¥ÊÄßË¶ÅÊ±ÇÈ´òÁöÑÂú∫ÊôØ„ÄÇÂ¶ÇÊûú‰Ω†ÁöÑ etcd ËØªËØ∑Ê±ÇÊòæÁ§∫ÊåáÂÆö‰∫ÜÊòØ‰∏≤Ë°åËØªÔºåÂ∞±‰∏ç‰ºöÁªèËøáÊû∂ÊûÑÂõæÊµÅÁ®ã‰∏≠ÁöÑÊµÅÁ®ã‰∏â„ÄÅÂõõ„ÄÇÈªòËÆ§ÊòØÁ∫øÊÄßËØªÔºåÂõ†Ê≠§Êé•‰∏ãÊù•Êàë‰ª¨ÁúãÁúãËØªËØ∑Ê±ÇËøõÂÖ•Á∫øÊÄßËØªÊ®°ÂùóÔºåÂÆÉÊòØÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑ„ÄÇ</p>
<p>Á∫øÊÄßËØª‰πã ReadIndexÂâçÈù¢Êàë‰ª¨ËÅäÂà∞‰∏≤Ë°åËØªÊó∂ÊèêÂà∞ÔºåÂÆÉ‰πãÊâÄ‰ª•ËÉΩËØªÂà∞ÊóßÊï∞ÊçÆÔºå‰∏ªË¶ÅÂéüÂõ†ÊòØ Follower ËäÇÁÇπÊî∂Âà∞ Leader ËäÇÁÇπÂêåÊ≠•ÁöÑÂÜôËØ∑Ê±ÇÂêéÔºåÂ∫îÁî®Êó•ÂøóÊù°ÁõÆÂà∞Áä∂ÊÄÅÊú∫ÊòØ‰∏™ÂºÇÊ≠•ËøáÁ®ãÔºåÈÇ£‰πàÊàë‰ª¨ËÉΩÂê¶Êúâ‰∏ÄÁßçÊú∫Âà∂Âú®ËØªÂèñÁöÑÊó∂ÂÄôÔºåÁ°Æ‰øùÊúÄÊñ∞ÁöÑÊï∞ÊçÆÂ∑≤ÁªèÂ∫îÁî®Âà∞Áä∂ÊÄÅÊú∫‰∏≠Ôºü</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/%e7%ba%bf%e6%80%a7%e8%af%bb.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>ÂÖ∂ÂÆûËøô‰∏™Êú∫Âà∂Â∞±ÊòØÂè´ ReadIndexÔºåÂÆÉÊòØÂú® etcd 3.1 ‰∏≠ÂºïÂÖ•ÁöÑÔºåÊàëÊääÁÆÄÂåñÂêéÁöÑÂéüÁêÜÂõæÊîæÂú®‰∫Ü‰∏äÈù¢„ÄÇÂΩìÊî∂Âà∞‰∏Ä‰∏™Á∫øÊÄßËØªËØ∑Ê±ÇÊó∂ÔºåÂÆÉÈ¶ñÂÖà‰ºö‰ªé Leader Ëé∑ÂèñÈõÜÁæ§ÊúÄÊñ∞ÁöÑÂ∑≤Êèê‰∫§ÁöÑÊó•ÂøóÁ¥¢Âºï (committed index)ÔºåÂ¶Ç‰∏äÂõæ‰∏≠ÁöÑÊµÅÁ®ã‰∫åÊâÄÁ§∫„ÄÇ</p>
<p>Leader Êî∂Âà∞ ReadIndex ËØ∑Ê±ÇÊó∂Ôºå‰∏∫Èò≤Ê≠¢ËÑëË£ÇÁ≠âÂºÇÂ∏∏Âú∫ÊôØÔºå‰ºöÂêë Follower ËäÇÁÇπÂèëÈÄÅÂøÉË∑≥Á°ÆËÆ§Ôºå‰∏ÄÂçä‰ª•‰∏äËäÇÁÇπÁ°ÆËÆ§ Leader Ë∫´‰ªΩÂêéÊâçËÉΩÂ∞ÜÂ∑≤Êèê‰∫§ÁöÑÁ¥¢Âºï (committed index) ËøîÂõûÁªôËäÇÁÇπ C(‰∏äÂõæ‰∏≠ÁöÑÊµÅÁ®ã‰∏â)„ÄÇ</p>
<p>C ËäÇÁÇπÂàô‰ºöÁ≠âÂæÖÔºåÁõ¥Âà∞Áä∂ÊÄÅÊú∫Â∑≤Â∫îÁî®Á¥¢Âºï (applied index) Â§ß‰∫éÁ≠â‰∫é Leader ÁöÑÂ∑≤Êèê‰∫§Á¥¢ÂºïÊó∂ (committed Index)(‰∏äÂõæ‰∏≠ÁöÑÊµÅÁ®ãÂõõ)ÔºåÁÑ∂ÂêéÂéªÈÄöÁü•ËØªËØ∑Ê±ÇÔºåÊï∞ÊçÆÂ∑≤Ëµ∂‰∏ä LeaderÔºå‰Ω†ÂèØ‰ª•ÂéªÁä∂ÊÄÅÊú∫‰∏≠ËÆøÈóÆÊï∞ÊçÆ‰∫Ü (‰∏äÂõæ‰∏≠ÁöÑÊµÅÁ®ã‰∫î)„ÄÇ</p>
<p>‰ª•‰∏äÂ∞±ÊòØÁ∫øÊÄßËØªÈÄöËøá ReadIndex Êú∫Âà∂‰øùËØÅÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÂéüÁêÜÔºå ÂΩìÁÑ∂ËøòÊúâÂÖ∂ÂÆÉÊú∫Âà∂‰πüËÉΩÂÆûÁé∞Á∫øÊÄßËØªÔºåÂ¶ÇÂú®Êó©Êúü etcd 3.0 ‰∏≠ËØªËØ∑Ê±ÇÈÄöËøáËµ∞‰∏ÄÈÅç Raft ÂçèËÆÆ‰øùËØÅ‰∏ÄËá¥ÊÄßÔºå ËøôÁßç Raft log read Êú∫Âà∂‰æùËµñÁ£ÅÁõò IOÔºå ÊÄßËÉΩÁõ∏ÊØî ReadIndex ËæÉÂ∑Æ„ÄÇ</p>
<p>ÊÄª‰ΩìËÄåË®ÄÔºåKVServer Ê®°ÂùóÊî∂Âà∞Á∫øÊÄßËØªËØ∑Ê±ÇÂêéÔºåÈÄöËøáÊû∂ÊûÑÂõæ‰∏≠ÊµÅÁ®ã‰∏âÂêë Raft Ê®°ÂùóÂèëËµ∑ ReadIndex ËØ∑Ê±ÇÔºåRaft Ê®°ÂùóÂ∞Ü Leader ÊúÄÊñ∞ÁöÑÂ∑≤Êèê‰∫§Êó•ÂøóÁ¥¢ÂºïÂ∞ÅË£ÖÂú®ÊµÅÁ®ãÂõõÁöÑ ReadState ÁªìÊûÑ‰ΩìÔºåÈÄöËøá channel Â±ÇÂ±ÇËøîÂõûÁªôÁ∫øÊÄßËØªÊ®°ÂùóÔºåÁ∫øÊÄßËØªÊ®°ÂùóÁ≠âÂæÖÊú¨ËäÇÁÇπÁä∂ÊÄÅÊú∫ËøΩËµ∂‰∏ä Leader ËøõÂ∫¶ÔºåËøΩËµ∂ÂÆåÊàêÂêéÔºåÂ∞±ÈÄöÁü• KVServer Ê®°ÂùóÔºåËøõË°åÊû∂ÊûÑÂõæ‰∏≠ÊµÅÁ®ã‰∫îÔºå‰∏éÁä∂ÊÄÅÊú∫‰∏≠ÁöÑ MVCC Ê®°ÂùóËøõË°åËøõË°å‰∫§‰∫í‰∫Ü„ÄÇ</p>
<p>MVCCÊµÅÁ®ã‰∫î‰∏≠ÁöÑÂ§öÁâàÊú¨Âπ∂ÂèëÊéßÂà∂ (Multiversion concurrency control) Ê®°ÂùóÊòØ‰∏∫‰∫ÜËß£ÂÜ≥‰∏ä‰∏ÄËÆ≤Êàë‰ª¨ÊèêÂà∞ etcd v2 ‰∏çÊîØÊåÅ‰øùÂ≠ò key ÁöÑÂéÜÂè≤ÁâàÊú¨„ÄÅ‰∏çÊîØÊåÅÂ§ö key ‰∫ãÂä°Á≠âÈóÆÈ¢òËÄå‰∫ßÁîüÁöÑ„ÄÇÂÆÉÊ†∏ÂøÉÁî±ÂÜÖÂ≠òÊ†ëÂΩ¢Á¥¢ÂºïÊ®°Âùó (treeIndex) ÂíåÂµåÂÖ•ÂºèÁöÑ KV ÊåÅ‰πÖÂåñÂ≠òÂÇ®Â∫ì boltdb ÁªÑÊàê„ÄÇÈ¶ñÂÖàÊàë‰ª¨ÈúÄË¶ÅÁÆÄÂçï‰∫ÜËß£‰∏ã boltdbÔºåÂÆÉÊòØ‰∏™Âü∫‰∫é B+ tree ÂÆûÁé∞ÁöÑ key-value ÈîÆÂÄºÂ∫ìÔºåÊîØÊåÅ‰∫ãÂä°ÔºåÊèê‰æõ Get/Put Á≠âÁÆÄÊòì API Áªô etcd Êìç‰Ωú„ÄÇÈÇ£‰πà etcd Â¶Ç‰ΩïÂü∫‰∫é boltdb ‰øùÂ≠ò‰∏Ä‰∏™ key ÁöÑÂ§ö‰∏™ÂéÜÂè≤ÁâàÊú¨Âë¢?ÊØîÂ¶ÇÊàë‰ª¨Áé∞Âú®Êúâ‰ª•‰∏ãÊñπÊ°àÔºöÊñπÊ°à 1 ÊòØ‰∏Ä‰∏™ key ‰øùÂ≠òÂ§ö‰∏™ÂéÜÂè≤ÁâàÊú¨ÁöÑÂÄºÔºõÊñπÊ°à 2 ÊØèÊ¨°‰øÆÊîπÊìç‰ΩúÔºåÁîüÊàê‰∏Ä‰∏™Êñ∞ÁöÑÁâàÊú¨Âè∑ (revision)Ôºå‰ª•ÁâàÊú¨Âè∑‰∏∫ keyÔºå value ‰∏∫Áî®Êà∑ key-value Á≠â‰ø°ÊÅØÁªÑÊàêÁöÑÁªìÊûÑ‰Ωì„ÄÇ</p>
<p>ÂæàÊòæÁÑ∂ÊñπÊ°à 1 ‰ºöÂØºËá¥ value ËæÉÂ§ßÔºåÂ≠òÂú®ÊòéÊòæËØªÂÜôÊîæÂ§ß„ÄÅÂπ∂ÂèëÂÜ≤Á™ÅÁ≠âÈóÆÈ¢òÔºåËÄåÊñπÊ°à 2 Ê≠£ÊòØ etcd ÊâÄÈááÁî®ÁöÑ„ÄÇboltdb ÁöÑ key ÊòØÂÖ®Â±ÄÈÄíÂ¢ûÁöÑÁâàÊú¨Âè∑ (revision)Ôºåvalue ÊòØÁî®Êà∑ key„ÄÅvalue Á≠âÂ≠óÊÆµÁªÑÂêàÊàêÁöÑÁªìÊûÑ‰ΩìÔºåÁÑ∂ÂêéÈÄöËøá treeIndex Ê®°ÂùóÊù•‰øùÂ≠òÁî®Êà∑ key ÂíåÁâàÊú¨Âè∑ÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇ</p>
<p>treeIndex ‰∏é boltdb ÂÖ≥Á≥ªÂ¶Ç‰∏ãÈù¢ÁöÑËØª‰∫ãÂä°ÊµÅÁ®ãÂõæÊâÄÁ§∫Ôºå‰ªé treeIndex ‰∏≠Ëé∑Âèñ key hello ÁöÑÁâàÊú¨Âè∑ÔºåÂÜç‰ª•ÁâàÊú¨Âè∑‰Ωú‰∏∫ boltdb ÁöÑ keyÔºå‰ªé boltdb ‰∏≠Ëé∑ÂèñÂÖ∂ value ‰ø°ÊÅØ„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/treeindex%e4%b8%8eboltdb%e7%9a%84%e5%85%b3%e7%b3%bb.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>treeIndextreeIndex Ê®°ÂùóÊòØÂü∫‰∫é Google ÂºÄÊ∫êÁöÑÂÜÖÂ≠òÁâà btree Â∫ìÂÆûÁé∞ÁöÑÔºå‰∏∫‰ªÄ‰πà etcd ÈÄâÊã©‰∏äÂõæ‰∏≠ÁöÑ B-tree Êï∞ÊçÆÁªìÊûÑ‰øùÂ≠òÁî®Êà∑ key ‰∏éÁâàÊú¨Âè∑‰πãÈó¥ÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÔºåËÄå‰∏çÊòØÂìàÂ∏åË°®„ÄÅ‰∫åÂèâÊ†ëÂë¢ÔºüÂú®ÂêéÈù¢ÁöÑËØæÁ®ã‰∏≠Êàë‰ºöÂÜçÂíå‰Ω†‰ªãÁªç„ÄÇtreeIndex Ê®°ÂùóÂè™‰ºö‰øùÂ≠òÁî®Êà∑ÁöÑ key ÂíåÁõ∏ÂÖ≥ÁâàÊú¨Âè∑‰ø°ÊÅØÔºåÁî®Êà∑ key ÁöÑ value Êï∞ÊçÆÂ≠òÂÇ®Âú® boltdb ÈáåÈù¢ÔºåÁõ∏ÊØî ZooKeeper Âíå etcd v2 ÂÖ®ÂÜÖÂ≠òÂ≠òÂÇ®Ôºåetcd v3 ÂØπÂÜÖÂ≠òË¶ÅÊ±ÇÊõ¥‰Ωé„ÄÇ</p>
<p>ÁÆÄÂçï‰ªãÁªç‰∫Ü etcd Â¶Ç‰Ωï‰øùÂ≠ò key ÁöÑÂéÜÂè≤ÁâàÊú¨ÂêéÔºåÊû∂ÊûÑÂõæ‰∏≠ÊµÅÁ®ãÂÖ≠‰πüÂ∞±ÈùûÂ∏∏ÂÆπÊòìÁêÜËß£‰∫ÜÔºå ÂÆÉÈúÄË¶Å‰ªé treeIndex Ê®°Âùó‰∏≠Ëé∑Âèñ hello Ëøô‰∏™ key ÂØπÂ∫îÁöÑÁâàÊú¨Âè∑‰ø°ÊÅØ„ÄÇtreeIndex Ê®°ÂùóÂü∫‰∫é B-tree Âø´ÈÄüÊü•ÊâæÊ≠§ keyÔºåËøîÂõûÊ≠§ key ÂØπÂ∫îÁöÑÁ¥¢ÂºïÈ°π keyIndex Âç≥ÂèØ„ÄÇÁ¥¢ÂºïÈ°π‰∏≠ÂåÖÂê´ÁâàÊú¨Âè∑Á≠â‰ø°ÊÅØ„ÄÇ</p>
<p>bufferÂú®Ëé∑ÂèñÂà∞ÁâàÊú¨Âè∑‰ø°ÊÅØÂêéÔºåÂ∞±ÂèØ‰ªé boltdb Ê®°Âùó‰∏≠Ëé∑ÂèñÁî®Êà∑ÁöÑ key-value Êï∞ÊçÆ‰∫Ü„ÄÇ‰∏çËøáÊúâ‰∏ÄÁÇπ‰Ω†Ë¶ÅÊ≥®ÊÑèÔºåÂπ∂‰∏çÊòØÊâÄÊúâËØ∑Ê±ÇÈÉΩ‰∏ÄÂÆöË¶Å‰ªé boltdb Ëé∑ÂèñÊï∞ÊçÆ„ÄÇetcd Âá∫‰∫éÊï∞ÊçÆ‰∏ÄËá¥ÊÄß„ÄÅÊÄßËÉΩÁ≠âËÄÉËôëÔºåÂú®ËÆøÈóÆ boltdb ÂâçÔºåÈ¶ñÂÖà‰ºö‰ªé‰∏Ä‰∏™ÂÜÖÂ≠òËØª‰∫ãÂä° buffer ‰∏≠Ôºå‰∫åÂàÜÊü•Êâæ‰Ω†Ë¶ÅËÆøÈóÆ key ÊòØÂê¶Âú® buffer ÈáåÈù¢ÔºåËã•ÂëΩ‰∏≠ÂàôÁõ¥Êé•ËøîÂõû„ÄÇ</p>
<p>boltdbËã• buffer Êú™ÂëΩ‰∏≠ÔºåÊ≠§Êó∂Â∞±ÁúüÊ≠£ÈúÄË¶ÅÂêë boltdb Ê®°ÂùóÊü•ËØ¢Êï∞ÊçÆ‰∫ÜÔºåËøõÂÖ•‰∫ÜÊµÅÁ®ã‰∏É„ÄÇÊàë‰ª¨Áü•ÈÅì MySQL ÈÄöËøá table ÂÆûÁé∞‰∏çÂêåÊï∞ÊçÆÈÄªËæëÈöîÁ¶ªÔºåÈÇ£‰πàÂú® boltdb ÊòØÂ¶Ç‰ΩïÈöîÁ¶ªÈõÜÁæ§ÂÖÉÊï∞ÊçÆ‰∏éÁî®Êà∑Êï∞ÊçÆÁöÑÂë¢ÔºüÁ≠îÊ°àÊòØ bucket„ÄÇboltdb ÈáåÊØè‰∏™ bucket Á±ª‰ººÂØπÂ∫î MySQL ‰∏Ä‰∏™Ë°®ÔºåÁî®Êà∑ÁöÑ key Êï∞ÊçÆÂ≠òÊîæÁöÑ bucket ÂêçÂ≠óÁöÑÊòØ keyÔºåetcd MVCC ÂÖÉÊï∞ÊçÆÂ≠òÊîæÁöÑ bucket ÊòØ meta„ÄÇÂõ† boltdb ‰ΩøÁî® B+ tree Êù•ÁªÑÁªáÁî®Êà∑ÁöÑ key-value Êï∞ÊçÆÔºåËé∑Âèñ bucket key ÂØπË±°ÂêéÔºåÈÄöËøá boltdb ÁöÑÊ∏∏Ê†á Cursor ÂèØÂø´ÈÄüÂú® B+ tree ÊâæÂà∞ key hello ÂØπÂ∫îÁöÑ value Êï∞ÊçÆÔºåËøîÂõûÁªô client„ÄÇÂà∞ËøôÈáåÔºå‰∏Ä‰∏™ËØªËØ∑Ê±Ç‰πãË∑ØÊâßË°åÂÆåÊàê„ÄÇ</p>
<p>Â∞èÁªìÊúÄÂêéÊàë‰ª¨Êù•Â∞èÁªì‰∏Ä‰∏ãÔºå‰∏Ä‰∏™ËØªËØ∑Ê±Ç‰ªé client ÈÄöËøá Round-robin Ë¥üËΩΩÂùáË°°ÁÆóÊ≥ïÔºåÈÄâÊã©‰∏Ä‰∏™ etcd server ËäÇÁÇπÔºåÂèëÂá∫ gRPC ËØ∑Ê±ÇÔºåÁªèËøá etcd server ÁöÑ KVServer Ê®°Âùó„ÄÅÁ∫øÊÄßËØªÊ®°Âùó„ÄÅMVCC ÁöÑ treeIndex Âíå boltdb Ê®°ÂùóÁ¥ßÂØÜÂçè‰ΩúÔºåÂÆåÊàê‰∫Ü‰∏Ä‰∏™ËØªËØ∑Ê±Ç„ÄÇÈÄöËøá‰∏Ä‰∏™ËØªËØ∑Ê±ÇÔºåÊàëÂ∏¶‰Ω†ÂàùÊ≠•‰∫ÜËß£‰∫Ü etcd ÁöÑÂü∫Á°ÄÊû∂ÊûÑ‰ª•ÂèäÂêÑ‰∏™Ê®°Âùó‰πãÈó¥ÊòØÂ¶Ç‰ΩïÂçè‰ΩúÁöÑ„ÄÇÂú®ËøôËøáÁ®ã‰∏≠ÔºåÊàëÊÉ≥Âíå‰Ω†ÁâπÂà´ÊÄªÁªì‰∏ã client ÁöÑËäÇÁÇπÊïÖÈöúËá™Âä®ËΩ¨ÁßªÂíåÁ∫øÊÄßËØª„ÄÇ‰∏ÄÊñπÈù¢Ôºå client ÁöÑÈÄöËøáË¥üËΩΩÂùáË°°„ÄÅÈîôËØØÂ§ÑÁêÜÁ≠âÊú∫Âà∂ÂÆûÁé∞‰∫Ü etcd ËäÇÁÇπ‰πãÈó¥ÁöÑÊïÖÈöúÁöÑËá™Âä®ËΩ¨ÁßªÔºåÂÆÉÂèØÂä©‰Ω†ÁöÑ‰∏öÂä°ÂÆûÁé∞ÊúçÂä°È´òÂèØÁî®ÔºåÂª∫ËÆÆ‰ΩøÁî® etcd 3.4 ÂàÜÊîØÁöÑ client ÁâàÊú¨„ÄÇÂè¶‰∏ÄÊñπÈù¢ÔºåÊàëËØ¶ÁªÜËß£Èáä‰∫Ü etcd Êèê‰æõÁöÑ‰∏§ÁßçËØªÊú∫Âà∂ (‰∏≤Ë°åËØªÂíåÁ∫øÊÄßËØª) ÂéüÁêÜÂíåÂ∫îÁî®Âú∫ÊôØ„ÄÇÈÄöËøáÁ∫øÊÄßËØªÔºåÂØπ‰∏öÂä°ËÄåË®ÄÔºåËÆøÈóÆÂ§ö‰∏™ËäÇÁÇπÁöÑ etcd ÈõÜÁæ§Â∞±Â¶ÇËÆøÈóÆ‰∏Ä‰∏™ËäÇÁÇπ‰∏ÄÊ†∑ÁÆÄÂçïÔºåËÉΩÁÆÄÊ¥Å„ÄÅÂø´ÈÄüÁöÑËé∑ÂèñÂà∞ÈõÜÁæ§ÊúÄÊñ∞ÂÖ±ËØÜÊï∞ÊçÆ„ÄÇÊó©Êúü etcd Á∫øÊÄßËØª‰ΩøÁî®ÁöÑ Raft log readÔºå‰πüÂ∞±ÊòØËØ¥ÊääËØªËØ∑Ê±ÇÂÉèÂÜôËØ∑Ê±Ç‰∏ÄÊ†∑Ëµ∞‰∏ÄÈÅç Raft ÁöÑÂçèËÆÆÔºåÂü∫‰∫é Raft ÁöÑÊó•ÂøóÁöÑÊúâÂ∫èÊÄßÔºåÂÆûÁé∞Á∫øÊÄßËØª„ÄÇ‰ΩÜÊ≠§ÊñπÊ°àËØªÊ∂âÂèäÁ£ÅÁõò IO ÂºÄÈîÄÔºåÊÄßËÉΩËæÉÂ∑ÆÔºåÂêéÊù•ÂÆûÁé∞‰∫Ü ReadIndex ËØªÊú∫Âà∂Êù•ÊèêÂçáËØªÊÄßËÉΩÔºåÊª°Ë∂≥‰∫Ü Kubernetes Á≠â‰∏öÂä°ÁöÑËØâÊ±Ç„ÄÇ</p>
<h3 id="etcd‰∏Ä‰∏™ÂÜôËØ∑Ê±ÇÊòØÂ¶Ç‰ΩïÊâßË°åÁöÑ">etcd‰∏Ä‰∏™ÂÜôËØ∑Ê±ÇÊòØÂ¶Ç‰ΩïÊâßË°åÁöÑ</h3>
<p>Êï¥‰ΩìÊû∂ÊûÑ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e5%86%99%e8%af%b7%e6%b1%82.webp"
	
	
	
	loading="lazy"
	
	
></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="nx">etcdctl</span> <span class="nx">put</span> <span class="nx">hello</span> <span class="nx">world</span> <span class="o">--</span><span class="nx">endpoints</span> <span class="nx">http</span><span class="p">:</span><span class="c1">//127.0.0.1:2379
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="nx">OK</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>È¶ñÂÖà client Á´ØÈÄöËøáË¥üËΩΩÂùáË°°ÁÆóÊ≥ïÈÄâÊã©‰∏Ä‰∏™ etcd ËäÇÁÇπÔºåÂèëËµ∑ gRPC Ë∞ÉÁî®„ÄÇÁÑ∂Âêé etcd ËäÇÁÇπÊî∂Âà∞ËØ∑Ê±ÇÂêéÁªèËøá gRPC Êã¶Êà™Âô®„ÄÅQuota Ê®°ÂùóÂêéÔºåËøõÂÖ• KVServer Ê®°ÂùóÔºåKVServer Ê®°ÂùóÂêë Raft Ê®°ÂùóÊèê‰∫§‰∏Ä‰∏™ÊèêÊ°àÔºåÊèêÊ°àÂÜÖÂÆπ‰∏∫‚ÄúÂ§ßÂÆ∂Â•ΩÔºåËØ∑‰ΩøÁî® put ÊñπÊ≥ïÊâßË°å‰∏Ä‰∏™ key ‰∏∫ helloÔºåvalue ‰∏∫ world ÁöÑÂëΩ‰ª§‚Äù„ÄÇ</p>
<p>ÈöèÂêéÊ≠§ÊèêÊ°àÈÄöËøá RaftHTTP ÁΩëÁªúÊ®°ÂùóËΩ¨Âèë„ÄÅÁªèËøáÈõÜÁæ§Â§öÊï∞ËäÇÁÇπÊåÅ‰πÖÂåñÂêéÔºåÁä∂ÊÄÅ‰ºöÂèòÊàêÂ∑≤Êèê‰∫§Ôºåetcdserver ‰ªé Raft Ê®°ÂùóËé∑ÂèñÂ∑≤Êèê‰∫§ÁöÑÊó•ÂøóÊù°ÁõÆÔºå‰º†ÈÄíÁªô Apply Ê®°ÂùóÔºåApply Ê®°ÂùóÈÄöËøá MVCC Ê®°ÂùóÊâßË°åÊèêÊ°àÂÜÖÂÆπÔºåÊõ¥Êñ∞Áä∂ÊÄÅÊú∫„ÄÇ</p>
<p>‰∏éËØªÊµÅÁ®ã‰∏ç‰∏ÄÊ†∑ÁöÑÊòØÂÜôÊµÅÁ®ãËøòÊ∂âÂèä Quota„ÄÅWAL„ÄÅApply ‰∏â‰∏™Ê®°Âùó„ÄÇcrash-safe ÂèäÂπÇÁ≠âÊÄß‰πüÊ≠£ÊòØÂü∫‰∫é WAL Âíå Apply ÊµÅÁ®ãÁöÑ consistent index Á≠âÂÆûÁé∞ÁöÑÔºåÂõ†Ê≠§‰ªäÂ§©Êàë‰ºöÈáçÁÇπÂíå‰Ω†‰ªãÁªçËøô‰∏â‰∏™Ê®°Âùó„ÄÇ</p>
<p>‰∏ãÈù¢Â∞±ËÆ©Êàë‰ª¨Ê≤øÁùÄÂÜôËØ∑Ê±ÇÊâßË°åÊµÅÁ®ãÂõæÔºå‰ªé 0 Âà∞ 1 ÂàÜÊûê‰∏Ä‰∏™ key-value ÊòØÂ¶Ç‰ΩïÂÆâÂÖ®„ÄÅÂπÇÁ≠âÂú∞ÊåÅ‰πÖÂåñÂà∞Á£ÅÁõòÁöÑ„ÄÇ</p>
<p>Quota Ê®°Âùó</p>
<p>È¶ñÂÖàÊòØÊµÅÁ®ã‰∏Ä client Á´ØÂèëËµ∑ gRPC Ë∞ÉÁî®Âà∞ etcd ËäÇÁÇπÔºåÂíåËØªËØ∑Ê±Ç‰∏ç‰∏ÄÊ†∑ÁöÑÊòØÔºåÂÜôËØ∑Ê±ÇÈúÄË¶ÅÁªèËøáÊµÅÁ®ã‰∫å db ÈÖçÈ¢ùÔºàQuotaÔºâÊ®°ÂùóÔºåÂÆÉÊúâ‰ªÄ‰πàÂäüËÉΩÂë¢ÔºüÊàë‰ª¨ÂÖà‰ªéÊ≠§Ê®°ÂùóÁöÑ‰∏Ä‰∏™Â∏∏ËßÅÈîôËØØËØ¥Ëµ∑Ôºå‰Ω†Âú®‰ΩøÁî® etcd ËøáÁ®ã‰∏≠ÊòØÂê¶ÈÅáÂà∞Ëøá&quot;etcdserver: mvcc: database space exceeded&quot;ÈîôËØØÂë¢ÔºüÊàëÁõ∏‰ø°Âè™Ë¶Å‰Ω†‰ΩøÁî®Ëøá etcd ÊàñËÄÖ KubernetesÔºåÂ§ßÊ¶ÇÁéáËßÅËøáËøô‰∏™ÈîôËØØ„ÄÇÂÆÉÊòØÊåáÂΩìÂâç etcd db Êñá‰ª∂Â§ßÂ∞èË∂ÖËøá‰∫ÜÈÖçÈ¢ùÔºåÂΩìÂá∫Áé∞Ê≠§ÈîôËØØÂêéÔºå‰Ω†ÁöÑÊï¥‰∏™ÈõÜÁæ§Â∞Ü‰∏çÂèØÂÜôÂÖ•ÔºåÂè™ËØªÔºåÂØπ‰∏öÂä°ÁöÑÂΩ±ÂìçÈùûÂ∏∏Â§ß„ÄÇÂì™‰∫õÊÉÖÂÜµ‰ºöËß¶ÂèëËøô‰∏™ÈîôËØØÂë¢Ôºü‰∏ÄÊñπÈù¢ÈªòËÆ§ db ÈÖçÈ¢ù‰ªÖ‰∏∫ 2GÔºåÂΩì‰Ω†ÁöÑ‰∏öÂä°Êï∞ÊçÆ„ÄÅÂÜôÂÖ• QPS„ÄÅKubernetes ÈõÜÁæ§ËßÑÊ®°Â¢ûÂ§ßÂêéÔºå‰Ω†ÁöÑ etcd db Â§ßÂ∞èÂ∞±ÂèØËÉΩ‰ºöË∂ÖËøá 2G„ÄÇÂè¶‰∏ÄÊñπÈù¢Êàë‰ª¨Áü•ÈÅì etcd v3 ÊòØ‰∏™ MVCC Êï∞ÊçÆÂ∫ìÔºå‰øùÂ≠ò‰∫Ü key ÁöÑÂéÜÂè≤ÁâàÊú¨ÔºåÂΩì‰Ω†Êú™ÈÖçÁΩÆÂéãÁº©Á≠ñÁï•ÁöÑÊó∂ÂÄôÔºåÈöèÁùÄÊï∞ÊçÆ‰∏çÊñ≠ÂÜôÂÖ•Ôºådb Â§ßÂ∞è‰ºö‰∏çÊñ≠Â¢ûÂ§ßÔºåÂØºËá¥Ë∂ÖÈôê„ÄÇÊúÄÂêé‰Ω†Ë¶ÅÁâπÂà´Ê≥®ÊÑèÁöÑÊòØÔºåÂ¶ÇÊûú‰Ω†‰ΩøÁî®ÁöÑÊòØ etcd 3.2.10 ‰πãÂâçÁöÑÊóßÁâàÊú¨ÔºåËØ∑Ê≥®ÊÑèÂ§á‰ªΩÂèØËÉΩ‰ºöËß¶Âèë boltdb ÁöÑ‰∏Ä‰∏™ BugÔºåÂÆÉ‰ºöÂØºËá¥ db Â§ßÂ∞è‰∏çÊñ≠‰∏äÊ∂®ÔºåÊúÄÁªàËææÂà∞ÈÖçÈ¢ùÈôêÂà∂„ÄÇ‰∫ÜËß£ÂÆåËß¶Âèë Quota ÈôêÂà∂ÁöÑÂéüÂõ†ÂêéÔºåÊàë‰ª¨ÂÜçËØ¶ÁªÜ‰∫ÜËß£‰∏ã Quota Ê®°ÂùóÂÆÉÊòØÂ¶Ç‰ΩïÂ∑•‰ΩúÁöÑ„ÄÇÂΩì etcd server Êî∂Âà∞ put/txn Á≠âÂÜôËØ∑Ê±ÇÁöÑÊó∂ÂÄôÔºå‰ºöÈ¶ñÂÖàÊ£ÄÊü•‰∏ãÂΩìÂâç etcd db Â§ßÂ∞èÂä†‰∏ä‰Ω†ËØ∑Ê±ÇÁöÑ key-value Â§ßÂ∞è‰πãÂíåÊòØÂê¶Ë∂ÖËøá‰∫ÜÈÖçÈ¢ùÔºàquota-backend-bytesÔºâ„ÄÇÂ¶ÇÊûúË∂ÖËøá‰∫ÜÈÖçÈ¢ùÔºåÂÆÉ‰ºö‰∫ßÁîü‰∏Ä‰∏™ÂëäË≠¶ÔºàAlarmÔºâËØ∑Ê±ÇÔºåÂëäË≠¶Á±ªÂûãÊòØ NO SPACEÔºåÂπ∂ÈÄöËøá Raft Êó•ÂøóÂêåÊ≠•ÁªôÂÖ∂ÂÆÉËäÇÁÇπÔºåÂëäÁü• db Êó†Á©∫Èó¥‰∫ÜÔºåÂπ∂Â∞ÜÂëäË≠¶ÊåÅ‰πÖÂåñÂ≠òÂÇ®Âà∞ db ‰∏≠„ÄÇÊúÄÁªàÔºåÊó†ËÆ∫ÊòØ API Â±Ç gRPC Ê®°ÂùóËøòÊòØË¥üË¥£Â∞Ü Raft ‰æßÂ∑≤Êèê‰∫§ÁöÑÊó•ÂøóÊù°ÁõÆÂ∫îÁî®Âà∞Áä∂ÊÄÅÊú∫ÁöÑ Apply Ê®°ÂùóÔºåÈÉΩÊãíÁªùÂÜôÂÖ•ÔºåÈõÜÁæ§Âè™ËØª„ÄÇÈÇ£ÈÅáÂà∞Ëøô‰∏™ÈîôËØØÊó∂Â∫îËØ•Â¶Ç‰ΩïËß£ÂÜ≥Âë¢ÔºüÈ¶ñÂÖàÂΩìÁÑ∂ÊòØË∞ÉÂ§ßÈÖçÈ¢ù„ÄÇÂÖ∑‰ΩìÂ§öÂ§ßÂêàÈÄÇÂë¢Ôºüetcd Á§æÂå∫Âª∫ËÆÆ‰∏çË∂ÖËøá 8G„ÄÇÈÅáÂà∞ËøáËøô‰∏™ÈîôËØØÁöÑ‰Ω†ÊòØÂê¶ËøòËÆ∞ÂæóÔºå‰∏∫‰ªÄ‰πàÂΩì‰Ω†ÊääÈÖçÈ¢ùÔºàquota-backend-bytesÔºâË∞ÉÂ§ßÂêéÔºåÈõÜÁæ§‰æùÁÑ∂ÊãíÁªùÂÜôÂÖ•Âë¢?ÂéüÂõ†Â∞±ÊòØÊàë‰ª¨ÂâçÈù¢ÊèêÂà∞ÁöÑ NO SPACE ÂëäË≠¶„ÄÇApply Ê®°ÂùóÂú®ÊâßË°åÊØè‰∏™ÂëΩ‰ª§ÁöÑÊó∂ÂÄôÔºåÈÉΩ‰ºöÂéªÊ£ÄÊü•ÂΩìÂâçÊòØÂê¶Â≠òÂú® NO SPACE ÂëäË≠¶ÔºåÂ¶ÇÊûúÊúâÂàôÊãíÁªùÂÜôÂÖ•„ÄÇÊâÄ‰ª•ËøòÈúÄË¶Å‰Ω†È¢ùÂ§ñÂèëÈÄÅ‰∏Ä‰∏™ÂèñÊ∂àÂëäË≠¶Ôºàetcdctl alarm disarmÔºâÁöÑÂëΩ‰ª§Ôºå‰ª•Ê∂àÈô§ÊâÄÊúâÂëäË≠¶„ÄÇÂÖ∂Ê¨°‰Ω†ÈúÄË¶ÅÊ£ÄÊü• etcd ÁöÑÂéãÁº©ÔºàcompactÔºâÈÖçÁΩÆÊòØÂê¶ÂºÄÂêØ„ÄÅÈÖçÁΩÆÊòØÂê¶ÂêàÁêÜ„ÄÇetcd ‰øùÂ≠ò‰∫Ü‰∏Ä‰∏™ key ÊâÄÊúâÂèòÊõ¥ÂéÜÂè≤ÁâàÊú¨ÔºåÂ¶ÇÊûúÊ≤°Êúâ‰∏Ä‰∏™Êú∫Âà∂ÂéªÂõûÊî∂ÊóßÁöÑÁâàÊú¨ÔºåÈÇ£‰πàÂÜÖÂ≠òÂíå db Â§ßÂ∞èÂ∞±‰ºö‰∏ÄÁõ¥ËÜ®ËÉÄÔºåÂú® etcd ÈáåÈù¢ÔºåÂéãÁº©Ê®°ÂùóË¥üË¥£ÂõûÊî∂ÊóßÁâàÊú¨ÁöÑÂ∑•‰Ωú„ÄÇÂéãÁº©Ê®°ÂùóÊîØÊåÅÊåâÂ§öÁßçÊñπÂºèÂõûÊî∂ÊóßÁâàÊú¨ÔºåÊØîÂ¶Ç‰øùÁïôÊúÄËøë‰∏ÄÊÆµÊó∂Èó¥ÂÜÖÁöÑÂéÜÂè≤ÁâàÊú¨„ÄÇ‰∏çËøá‰Ω†Ë¶ÅÊ≥®ÊÑèÔºåÂÆÉ‰ªÖ‰ªÖÊòØÂ∞ÜÊóßÁâàÊú¨Âç†Áî®ÁöÑÁ©∫Èó¥Êâì‰∏™Á©∫Èó≤ÔºàFreeÔºâÊ†áËÆ∞ÔºåÂêéÁª≠Êñ∞ÁöÑÊï∞ÊçÆÂÜôÂÖ•ÁöÑÊó∂ÂÄôÂèØÂ§çÁî®ËøôÂùóÁ©∫Èó¥ÔºåËÄåÊó†ÈúÄÁî≥ËØ∑Êñ∞ÁöÑÁ©∫Èó¥„ÄÇÂ¶ÇÊûú‰Ω†ÈúÄË¶ÅÂõûÊî∂Á©∫Èó¥ÔºåÂáèÂ∞ë db Â§ßÂ∞èÔºåÂæó‰ΩøÁî®Á¢éÁâáÊï¥ÁêÜÔºàdefragÔºâÔºå ÂÆÉ‰ºöÈÅçÂéÜÊóßÁöÑ db Êñá‰ª∂Êï∞ÊçÆÔºåÂÜôÂÖ•Âà∞‰∏Ä‰∏™Êñ∞ÁöÑ db Êñá‰ª∂„ÄÇ‰ΩÜÊòØÂÆÉÂØπÊúçÂä°ÊÄßËÉΩÊúâËæÉÂ§ßÂΩ±ÂìçÔºå‰∏çÂª∫ËÆÆ‰Ω†Âú®Áîü‰∫ßÈõÜÁæ§È¢ëÁπÅ‰ΩøÁî®„ÄÇÊúÄÂêé‰Ω†ÈúÄË¶ÅÊ≥®ÊÑèÈÖçÈ¢ùÔºàquota-backend-bytesÔºâÁöÑË°å‰∏∫ÔºåÈªòËÆ§'0&rsquo;Â∞±ÊòØ‰ΩøÁî® etcd ÈªòËÆ§ÁöÑ 2GB Â§ßÂ∞èÔºå‰Ω†ÈúÄË¶ÅÊ†πÊçÆ‰Ω†ÁöÑ‰∏öÂä°Âú∫ÊôØÈÄÇÂΩìË∞É‰ºò„ÄÇÂ¶ÇÊûú‰Ω†Â°´ÁöÑÊòØ‰∏™Â∞è‰∫é 0 ÁöÑÊï∞ÔºåÂ∞±‰ºöÁ¶ÅÁî®ÈÖçÈ¢ùÂäüËÉΩÔºåËøôÂèØËÉΩ‰ºöËÆ©‰Ω†ÁöÑ db Â§ßÂ∞èÂ§Ñ‰∫éÂ§±ÊéßÔºåÂØºËá¥ÊÄßËÉΩ‰∏ãÈôçÔºå‰∏çÂª∫ËÆÆ‰Ω†Á¶ÅÁî®ÈÖçÈ¢ù„ÄÇ</p>
<p>KVServer Ê®°ÂùóÈÄöËøáÊµÅÁ®ã‰∫åÁöÑÈÖçÈ¢ùÊ£ÄÊü•ÂêéÔºåËØ∑Ê±ÇÂ∞±‰ªé API Â±ÇËΩ¨ÂèëÂà∞‰∫ÜÊµÅÁ®ã‰∏âÁöÑ KVServer Ê®°ÂùóÁöÑ put ÊñπÊ≥ïÔºåÊàë‰ª¨Áü•ÈÅì etcd ÊòØÂü∫‰∫é Raft ÁÆóÊ≥ïÂÆûÁé∞ËäÇÁÇπÈó¥Êï∞ÊçÆÂ§çÂà∂ÁöÑÔºåÂõ†Ê≠§ÂÆÉÈúÄË¶ÅÂ∞Ü put ÂÜôËØ∑Ê±ÇÂÜÖÂÆπÊâìÂåÖÊàê‰∏Ä‰∏™ÊèêÊ°àÊ∂àÊÅØÔºåÊèê‰∫§Áªô Raft Ê®°Âùó„ÄÇ‰∏çËøá KVServer Ê®°ÂùóÂú®Êèê‰∫§ÊèêÊ°àÂâçÔºåËøòÊúâÂ¶Ç‰∏ãÁöÑ‰∏ÄÁ≥ªÂàóÊ£ÄÊü•ÂíåÈôêÈÄü„ÄÇ</p>
<p>‰∏∫‰∫Ü‰øùËØÅÈõÜÁæ§Á®≥ÂÆöÊÄßÔºåÈÅøÂÖçÈõ™Â¥©Ôºå‰ªª‰ΩïÊèê‰∫§Âà∞ Raft Ê®°ÂùóÁöÑËØ∑Ê±ÇÔºåÈÉΩ‰ºöÂÅö‰∏Ä‰∫õÁÆÄÂçïÁöÑÈôêÈÄüÂà§Êñ≠„ÄÇÂ¶Ç‰∏ãÈù¢ÁöÑÊµÅÁ®ãÂõæÊâÄÁ§∫ÔºåÈ¶ñÂÖàÔºåÂ¶ÇÊûú Raft Ê®°ÂùóÂ∑≤Êèê‰∫§ÁöÑÊó•ÂøóÁ¥¢ÂºïÔºàcommitted indexÔºâÊØîÂ∑≤Â∫îÁî®Âà∞Áä∂ÊÄÅÊú∫ÁöÑÊó•ÂøóÁ¥¢ÂºïÔºàapplied indexÔºâË∂ÖËøá‰∫Ü 5000ÔºåÈÇ£‰πàÂÆÉÂ∞±ËøîÂõû‰∏Ä‰∏™&quot;etcdserver: too many requests&quot;ÈîôËØØÁªô client„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/KVserver-PreflightCheck.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>ÁÑ∂ÂêéÂÆÉ‰ºöÂ∞ùËØïÂéªËé∑ÂèñËØ∑Ê±Ç‰∏≠ÁöÑÈâ¥ÊùÉ‰ø°ÊÅØÔºåËã•‰ΩøÁî®‰∫ÜÂØÜÁ†ÅÈâ¥ÊùÉ„ÄÅËØ∑Ê±Ç‰∏≠Êê∫Â∏¶‰∫Ü tokenÔºåÂ¶ÇÊûú token Êó†ÊïàÔºåÂàôËøîÂõû&quot;auth: invalid auth token&quot;ÈîôËØØÁªô client„ÄÇ</p>
<p>ÂÖ∂Ê¨°ÂÆÉ‰ºöÊ£ÄÊü•‰Ω†ÂÜôÂÖ•ÁöÑÂåÖÂ§ßÂ∞èÊòØÂê¶Ë∂ÖËøáÈªòËÆ§ÁöÑ 1.5MBÔºå Â¶ÇÊûúË∂ÖËøá‰∫Ü‰ºöËøîÂõû&quot;etcdserver: request is too large&quot;ÈîôËØØÁªôÁªô client„ÄÇ</p>
<p>ProposeÊúÄÂêéÈÄöËøá‰∏ÄÁ≥ªÂàóÊ£ÄÊü•‰πãÂêéÔºå‰ºöÁîüÊàê‰∏Ä‰∏™ÂîØ‰∏ÄÁöÑ IDÔºåÂ∞ÜÊ≠§ËØ∑Ê±ÇÂÖ≥ËÅîÂà∞‰∏Ä‰∏™ÂØπÂ∫îÁöÑÊ∂àÊÅØÈÄöÁü• channelÔºåÁÑ∂ÂêéÂêë Raft Ê®°ÂùóÂèëËµ∑ÔºàProposeÔºâ‰∏Ä‰∏™ÊèêÊ°àÔºàProposalÔºâÔºåÊèêÊ°àÂÜÖÂÆπ‰∏∫‚ÄúÂ§ßÂÆ∂Â•ΩÔºåËØ∑‰ΩøÁî® put ÊñπÊ≥ïÊâßË°å‰∏Ä‰∏™ key ‰∏∫ helloÔºåvalue ‰∏∫ world ÁöÑÂëΩ‰ª§‚ÄùÔºå‰πüÂ∞±ÊòØÊï¥‰ΩìÊû∂ÊûÑÂõæÈáåÁöÑÊµÅÁ®ãÂõõ„ÄÇÂêë Raft Ê®°ÂùóÂèëËµ∑ÊèêÊ°àÂêéÔºåKVServer Ê®°Âùó‰ºöÁ≠âÂæÖÊ≠§ put ËØ∑Ê±ÇÔºåÁ≠âÂæÖÂÜôÂÖ•ÁªìÊûúÈÄöËøáÊ∂àÊÅØÈÄöÁü• channel ËøîÂõûÊàñËÄÖË∂ÖÊó∂„ÄÇetcd ÈªòËÆ§Ë∂ÖÊó∂Êó∂Èó¥ÊòØ 7 ÁßíÔºà5 ÁßíÁ£ÅÁõò IO Âª∂Êó∂ +2*1 ÁßíÁ´ûÈÄâË∂ÖÊó∂Êó∂Èó¥ÔºâÔºåÂ¶ÇÊûú‰∏Ä‰∏™ËØ∑Ê±ÇË∂ÖÊó∂Êú™ËøîÂõûÁªìÊûúÔºåÂàôÂèØËÉΩ‰ºöÂá∫Áé∞‰Ω†ÁÜüÊÇâÁöÑ etcdserver: request timed out ÈîôËØØ„ÄÇ</p>
<p>WAL Ê®°ÂùóRaft Ê®°ÂùóÊî∂Âà∞ÊèêÊ°àÂêéÔºåÂ¶ÇÊûúÂΩìÂâçËäÇÁÇπÊòØ FollowerÔºåÂÆÉ‰ºöËΩ¨ÂèëÁªô LeaderÔºåÂè™Êúâ Leader ÊâçËÉΩÂ§ÑÁêÜÂÜôËØ∑Ê±Ç„ÄÇLeader Êî∂Âà∞ÊèêÊ°àÂêéÔºåÈÄöËøá Raft Ê®°ÂùóËæìÂá∫ÂæÖËΩ¨ÂèëÁªô Follower ËäÇÁÇπÁöÑÊ∂àÊÅØÂíåÂæÖÊåÅ‰πÖÂåñÁöÑÊó•ÂøóÊù°ÁõÆÔºåÊó•ÂøóÊù°ÁõÆÂàôÂ∞ÅË£Ö‰∫ÜÊàë‰ª¨‰∏äÈù¢ÊâÄËØ¥ÁöÑ put hello ÊèêÊ°àÂÜÖÂÆπ„ÄÇetcdserver ‰ªé Raft Ê®°ÂùóËé∑ÂèñÂà∞‰ª•‰∏äÊ∂àÊÅØÂíåÊó•ÂøóÊù°ÁõÆÂêéÔºå‰Ωú‰∏∫ LeaderÔºåÂÆÉ‰ºöÂ∞Ü put ÊèêÊ°àÊ∂àÊÅØÂπøÊí≠ÁªôÈõÜÁæ§ÂêÑ‰∏™ËäÇÁÇπÔºåÂêåÊó∂ÈúÄË¶ÅÊääÈõÜÁæ§ Leader ‰ªªÊúüÂè∑„ÄÅÊäïÁ•®‰ø°ÊÅØ„ÄÅÂ∑≤Êèê‰∫§Á¥¢Âºï„ÄÅÊèêÊ°àÂÜÖÂÆπÊåÅ‰πÖÂåñÂà∞‰∏Ä‰∏™ WALÔºàWrite Ahead LogÔºâÊó•ÂøóÊñá‰ª∂‰∏≠ÔºåÁî®‰∫é‰øùËØÅÈõÜÁæ§ÁöÑ‰∏ÄËá¥ÊÄß„ÄÅÂèØÊÅ¢Â§çÊÄßÔºå‰πüÂ∞±ÊòØÊàë‰ª¨Âõæ‰∏≠ÁöÑÊµÅÁ®ã‰∫îÊ®°Âùó„ÄÇ</p>
<p>WAL Êó•ÂøóÁªìÊûÑÊòØÊÄéÊ†∑ÁöÑÂë¢Ôºü</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/WAL%e6%97%a5%e5%bf%97%e7%bb%93%e6%9e%84.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>‰∏äÂõæÊòØ WAL ÁªìÊûÑÔºåÂÆÉÁî±Â§öÁßçÁ±ªÂûãÁöÑ WAL ËÆ∞ÂΩïÈ°∫Â∫èËøΩÂä†ÂÜôÂÖ•ÁªÑÊàêÔºåÊØè‰∏™ËÆ∞ÂΩïÁî±Á±ªÂûã„ÄÅÊï∞ÊçÆ„ÄÅÂæ™ÁéØÂÜó‰ΩôÊ†°È™åÁ†ÅÁªÑÊàê„ÄÇ‰∏çÂêåÁ±ªÂûãÁöÑËÆ∞ÂΩïÈÄöËøá Type Â≠óÊÆµÂå∫ÂàÜÔºåData ‰∏∫ÂØπÂ∫îËÆ∞ÂΩïÂÜÖÂÆπÔºåCRC ‰∏∫Âæ™ÁéØÊ†°È™åÁ†Å‰ø°ÊÅØ„ÄÇ</p>
<p>WAL ËÆ∞ÂΩïÁ±ªÂûãÁõÆÂâçÊîØÊåÅ 5 ÁßçÔºåÂàÜÂà´ÊòØ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Êñá‰ª∂ÂÖÉÊï∞ÊçÆËÆ∞ÂΩï:ËÆ∞ÂΩïÂåÖÂê´ËäÇÁÇπ ID„ÄÅÈõÜÁæ§ ID ‰ø°ÊÅØÔºåÂÆÉÂú® WAL Êñá‰ª∂ÂàõÂª∫ÁöÑÊó∂ÂÄôÂÜôÂÖ•Ôºõ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Êó•ÂøóÊù°ÁõÆËÆ∞ÂΩï:ÂåÖÂê´ Raft Êó•Âøó‰ø°ÊÅØÔºåÂ¶Ç put ÊèêÊ°àÂÜÖÂÆπÔºõ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Áä∂ÊÄÅ‰ø°ÊÅØËÆ∞ÂΩï:ÂåÖÂê´ÈõÜÁæ§ÁöÑ‰ªªÊúüÂè∑„ÄÅËäÇÁÇπÊäïÁ•®‰ø°ÊÅØÁ≠âÔºå‰∏Ä‰∏™Êó•ÂøóÊñá‰ª∂‰∏≠‰ºöÊúâÂ§öÊù°Ôºå‰ª•ÊúÄÂêéÁöÑËÆ∞ÂΩï‰∏∫ÂáÜÔºõ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">CRC ËÆ∞ÂΩï:ÂåÖÂê´‰∏ä‰∏Ä‰∏™ WAL Êñá‰ª∂ÁöÑÊúÄÂêéÁöÑ CRCÔºàÂæ™ÁéØÂÜó‰ΩôÊ†°È™åÁ†ÅÔºâ‰ø°ÊÅØÔºå Âú®ÂàõÂª∫„ÄÅÂàáÂâ≤ WAL Êñá‰ª∂Êó∂Ôºå‰Ωú‰∏∫Á¨¨‰∏ÄÊù°ËÆ∞ÂΩïÂÜôÂÖ•Âà∞Êñ∞ÁöÑ WAL Êñá‰ª∂Ôºå Áî®‰∫éÊ†°È™åÊï∞ÊçÆÊñá‰ª∂ÁöÑÂÆåÊï¥ÊÄß„ÄÅÂáÜÁ°ÆÊÄßÁ≠âÔºõ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">Âø´ÁÖßËÆ∞ÂΩï:ÂåÖÂê´Âø´ÁÖßÁöÑ‰ªªÊúüÂè∑„ÄÅÊó•ÂøóÁ¥¢Âºï‰ø°ÊÅØÔºåÁî®‰∫éÊ£ÄÊü•Âø´ÁÖßÊñá‰ª∂ÁöÑÂáÜÁ°ÆÊÄß„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><p>WAL Ê®°ÂùóÂèàÊòØÂ¶Ç‰ΩïÊåÅ‰πÖÂåñ‰∏Ä‰∏™ put ÊèêÊ°àÁöÑÊó•ÂøóÊù°ÁõÆÁ±ªÂûãËÆ∞ÂΩïÂë¢?È¶ñÂÖàÊàë‰ª¨Êù•ÁúãÁúã put ÂÜôËØ∑Ê±ÇÂ¶Ç‰ΩïÂ∞ÅË£ÖÂú® Raft Êó•ÂøóÊù°ÁõÆÈáåÈù¢„ÄÇ‰∏ãÈù¢ÊòØ Raft Êó•ÂøóÊù°ÁõÆÁöÑÊï∞ÊçÆÁªìÊûÑ‰ø°ÊÅØÔºåÂÆÉÁî±‰ª•‰∏ãÂ≠óÊÆµÁªÑÊàêÔºö</p>
<p>Term ÊòØ Leader ‰ªªÊúüÂè∑ÔºåÈöèÁùÄ Leader ÈÄâ‰∏æÂ¢ûÂä†ÔºõIndex ÊòØÊó•ÂøóÊù°ÁõÆÁöÑÁ¥¢ÂºïÔºåÂçïË∞ÉÈÄíÂ¢ûÂ¢ûÂä†ÔºõType ÊòØÊó•ÂøóÁ±ªÂûãÔºåÊØîÂ¶ÇÊòØÊôÆÈÄöÁöÑÂëΩ‰ª§Êó•ÂøóÔºàEntryNormalÔºâËøòÊòØÈõÜÁæ§ÈÖçÁΩÆÂèòÊõ¥Êó•ÂøóÔºàEntryConfChangeÔºâÔºõData ‰øùÂ≠òÊàë‰ª¨‰∏äÈù¢ÊèèËø∞ÁöÑ put ÊèêÊ°àÂÜÖÂÆπ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">Entry</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Term</span>             <span class="kt">uint64</span>    <span class="s">`protobuf:&#34;varintÔºå2ÔºåoptÔºåname=Term&#34; json:&#34;Term&#34;`</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Index</span>            <span class="kt">uint64</span>    <span class="s">`protobuf:&#34;varintÔºå3ÔºåoptÔºåname=Index&#34; json:&#34;Index&#34;`</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Type</span>             <span class="nx">EntryType</span> <span class="s">`protobuf:&#34;varintÔºå1ÔºåoptÔºåname=TypeÔºåenum=Raftpb.EntryType&#34; json:&#34;Type&#34;`</span>
</span></span><span class="line"><span class="cl">   <span class="nx">Data</span>             <span class="p">[]</span><span class="kt">byte</span>    <span class="s">`protobuf:&#34;bytesÔºå4ÔºåoptÔºåname=Data&#34; json:&#34;DataÔºåomitempty&#34;`</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰∫ÜËß£ÂÆå Raft Êó•ÂøóÊù°ÁõÆÊï∞ÊçÆÁªìÊûÑÂêéÔºåÊàë‰ª¨ÂÜçÁúã WAL Ê®°ÂùóÂ¶Ç‰ΩïÊåÅ‰πÖÂåñ Raft Êó•ÂøóÊù°ÁõÆ„ÄÇÂÆÉÈ¶ñÂÖàÂÖàÂ∞Ü Raft Êó•ÂøóÊù°ÁõÆÂÜÖÂÆπÔºàÂê´‰ªªÊúüÂè∑„ÄÅÁ¥¢Âºï„ÄÅÊèêÊ°àÂÜÖÂÆπÔºâÂ∫èÂàóÂåñÂêé‰øùÂ≠òÂà∞ WAL ËÆ∞ÂΩïÁöÑ Data Â≠óÊÆµÔºå ÁÑ∂ÂêéËÆ°ÁÆó Data ÁöÑ CRC ÂÄºÔºåËÆæÁΩÆ Type ‰∏∫ Entry TypeÔºå ‰ª•‰∏ä‰ø°ÊÅØÂ∞±ÁªÑÊàê‰∫Ü‰∏Ä‰∏™ÂÆåÊï¥ÁöÑ WAL ËÆ∞ÂΩï„ÄÇ</p>
<p>ÊúÄÂêéËÆ°ÁÆó WAL ËÆ∞ÂΩïÁöÑÈïøÂ∫¶ÔºåÈ°∫Â∫èÂÖàÂÜôÂÖ• WAL ÈïøÂ∫¶ÔºàLen FieldÔºâÔºåÁÑ∂ÂêéÂÜôÂÖ•ËÆ∞ÂΩïÂÜÖÂÆπÔºåË∞ÉÁî® fsync ÊåÅ‰πÖÂåñÂà∞Á£ÅÁõòÔºåÂÆåÊàêÂ∞ÜÊó•ÂøóÊù°ÁõÆ‰øùÂ≠òÂà∞ÊåÅ‰πÖÂåñÂ≠òÂÇ®‰∏≠„ÄÇ</p>
<p>ÂΩì‰∏ÄÂçä‰ª•‰∏äËäÇÁÇπÊåÅ‰πÖÂåñÊ≠§Êó•ÂøóÊù°ÁõÆÂêéÔºå Raft Ê®°ÂùóÂ∞±‰ºöÈÄöËøá channel ÂëäÁü• etcdserver Ê®°ÂùóÔºåput ÊèêÊ°àÂ∑≤ÁªèË¢´ÈõÜÁæ§Â§öÊï∞ËäÇÁÇπÁ°ÆËÆ§ÔºåÊèêÊ°àÁä∂ÊÄÅ‰∏∫Â∑≤Êèê‰∫§Ôºå‰Ω†ÂèØ‰ª•ÊâßË°åÊ≠§ÊèêÊ°àÂÜÖÂÆπ‰∫Ü„ÄÇ</p>
<p>‰∫éÊòØËøõÂÖ•ÊµÅÁ®ãÂÖ≠Ôºåetcdserver Ê®°Âùó‰ªé channel ÂèñÂá∫ÊèêÊ°àÂÜÖÂÆπÔºåÊ∑ªÂä†Âà∞ÂÖàËøõÂÖàÂá∫ÔºàFIFOÔºâË∞ÉÂ∫¶ÈòüÂàóÔºåÈöèÂêéÈÄöËøá Apply Ê®°ÂùóÊåâÂÖ•ÈòüÈ°∫Â∫èÔºåÂºÇÊ≠•„ÄÅ‰æùÊ¨°ÊâßË°åÊèêÊ°àÂÜÖÂÆπ„ÄÇ</p>
<p>Apply Ê®°Âùó</p>
<p>ÊâßË°å put ÊèêÊ°àÂÜÖÂÆπÂØπÂ∫îÊàë‰ª¨Êû∂ÊûÑÂõæ‰∏≠ÁöÑÊµÅÁ®ã‰∏ÉÔºåÂÖ∂ÁªÜËäÇÂõæÂ¶Ç‰∏ã„ÄÇÈÇ£‰πà Apply Ê®°ÂùóÊòØÂ¶Ç‰ΩïÊâßË°å put ËØ∑Ê±ÇÁöÑÂë¢ÔºüËã• put ËØ∑Ê±ÇÊèêÊ°àÂú®ÊâßË°åÊµÅÁ®ã‰∏ÉÁöÑÊó∂ÂÄô etcd Á™ÅÁÑ∂ crash ‰∫ÜÔºå ÈáçÂêØÊÅ¢Â§çÁöÑÊó∂ÂÄôÔºåetcd ÊòØÂ¶Ç‰ΩïÊâæÂõûÂºÇÂ∏∏ÊèêÊ°àÔºåÂÜçÊ¨°ÊâßË°åÁöÑÂë¢Ôºü</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/apply%e6%89%a7%e8%a1%8cchannel.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>Ê†∏ÂøÉÂ∞±ÊòØÊàë‰ª¨‰∏äÈù¢‰ªãÁªçÁöÑ WAL Êó•ÂøóÔºåÂõ†‰∏∫Êèê‰∫§Áªô Apply Ê®°ÂùóÊâßË°åÁöÑÊèêÊ°àÂ∑≤Ëé∑ÂæóÂ§öÊï∞ËäÇÁÇπÁ°ÆËÆ§„ÄÅÊåÅ‰πÖÂåñÔºåetcd ÈáçÂêØÊó∂Ôºå‰ºö‰ªé WAL ‰∏≠Ëß£ÊûêÂá∫ Raft Êó•ÂøóÊù°ÁõÆÂÜÖÂÆπÔºåËøΩÂä†Âà∞ Raft Êó•ÂøóÁöÑÂ≠òÂÇ®‰∏≠ÔºåÂπ∂ÈáçÊîæÂ∑≤Êèê‰∫§ÁöÑÊó•ÂøóÊèêÊ°àÁªô Apply Ê®°ÂùóÊâßË°å„ÄÇ</p>
<p>ÁÑ∂ËÄåËøôÂèàÂºïÂèë‰∫ÜÂè¶Â§ñ‰∏Ä‰∏™ÈóÆÈ¢òÔºåÂ¶Ç‰ΩïÁ°Æ‰øùÂπÇÁ≠âÊÄßÔºåÈò≤Ê≠¢ÊèêÊ°àÈáçÂ§çÊâßË°åÂØºËá¥Êï∞ÊçÆÊ∑∑‰π±Âë¢?Êàë‰ª¨Âú®‰∏ä‰∏ÄËäÇËØæÈáåËÆ≤Âà∞Ôºåetcd ÊòØ‰∏™ MVCC Êï∞ÊçÆÂ∫ìÔºåÊØèÊ¨°Êõ¥Êñ∞ÈÉΩ‰ºöÁîüÊàêÊñ∞ÁöÑÁâàÊú¨Âè∑„ÄÇÂ¶ÇÊûúÊ≤°ÊúâÂπÇÁ≠âÊÄß‰øùÊä§ÔºåÂêåÊ†∑ÁöÑÂëΩ‰ª§Ôºå‰∏ÄÈÉ®ÂàÜËäÇÁÇπÊâßË°å‰∏ÄÊ¨°Ôºå‰∏ÄÈÉ®ÂàÜËäÇÁÇπÈÅ≠ÈÅáÂºÇÂ∏∏ÊïÖÈöúÂêéÊâßË°åÂ§öÊ¨°ÔºåÂàôÁ≥ªÁªüÁöÑÂêÑËäÇÁÇπ‰∏ÄËá¥ÊÄßÁä∂ÊÄÅÊó†Ê≥ïÂæóÂà∞‰øùËØÅÔºåÂØºËá¥Êï∞ÊçÆÊ∑∑‰π±ÔºåËøôÊòØ‰∏•ÈáçÊïÖÈöú„ÄÇÂõ†Ê≠§ etcd ÂøÖÈ°ªË¶ÅÁ°Æ‰øùÂπÇÁ≠âÊÄß„ÄÇÊÄé‰πàÂÅöÂë¢ÔºüApply Ê®°Âùó‰ªé Raft Ê®°ÂùóËé∑ÂæóÁöÑÊó•ÂøóÊù°ÁõÆ‰ø°ÊÅØÈáåÔºåÊòØÂê¶ÊúâÂîØ‰∏ÄÁöÑÂ≠óÊÆµËÉΩÊ†áËØÜËøô‰∏™ÊèêÊ°àÔºüÁ≠îÊ°àÂ∞±ÊòØÊàë‰ª¨‰∏äÈù¢‰ªãÁªç Raft Êó•ÂøóÊù°ÁõÆ‰∏≠ÁöÑÁ¥¢ÂºïÔºàindexÔºâÂ≠óÊÆµ„ÄÇÊó•ÂøóÊù°ÁõÆÁ¥¢ÂºïÊòØÂÖ®Â±ÄÂçïË∞ÉÈÄíÂ¢ûÁöÑÔºåÊØè‰∏™Êó•ÂøóÊù°ÁõÆÁ¥¢ÂºïÂØπÂ∫î‰∏Ä‰∏™ÊèêÊ°àÔºå Â¶ÇÊûú‰∏Ä‰∏™ÂëΩ‰ª§ÊâßË°åÂêéÔºåÊàë‰ª¨Âú® db ÈáåÈù¢‰πüËÆ∞ÂΩï‰∏ãÂΩìÂâçÂ∑≤ÁªèÊâßË°åËøáÁöÑÊó•ÂøóÊù°ÁõÆÁ¥¢ÂºïÔºåÊòØ‰∏çÊòØÂ∞±ÂèØ‰ª•Ëß£ÂÜ≥ÂπÇÁ≠âÊÄßÈóÆÈ¢òÂë¢Ôºü</p>
<p>ÊòØÁöÑ„ÄÇ‰ΩÜÊòØËøôËøò‰∏çÂ§üÂÆâÂÖ®ÔºåÂ¶ÇÊûúÊâßË°åÂëΩ‰ª§ÁöÑËØ∑Ê±ÇÊõ¥Êñ∞ÊàêÂäü‰∫ÜÔºåÊõ¥Êñ∞ index ÁöÑËØ∑Ê±ÇÂç¥Â§±Ë¥•‰∫ÜÔºåÊòØ‰∏çÊòØ‰∏ÄÊ†∑‰ºöÂØºËá¥ÂºÇÂ∏∏ÔºüÂõ†Ê≠§Êàë‰ª¨Âú®ÂÆûÁé∞‰∏äÔºåËøòÈúÄË¶ÅÂ∞Ü‰∏§‰∏™Êìç‰Ωú‰Ωú‰∏∫ÂéüÂ≠êÊÄß‰∫ãÂä°Êèê‰∫§ÔºåÊâçËÉΩÂÆûÁé∞ÂπÇÁ≠â„ÄÇÊ≠£Â¶ÇÊàë‰ª¨‰∏äÈù¢ÁöÑËÆ®ËÆ∫ÁöÑËøôÊ†∑Ôºåetcd ÈÄöËøáÂºïÂÖ•‰∏Ä‰∏™ consistent index ÁöÑÂ≠óÊÆµÔºåÊù•Â≠òÂÇ®Á≥ªÁªüÂΩìÂâçÂ∑≤ÁªèÊâßË°åËøáÁöÑÊó•ÂøóÊù°ÁõÆÁ¥¢ÂºïÔºåÂÆûÁé∞ÂπÇÁ≠âÊÄß„ÄÇApply Ê®°ÂùóÂú®ÊâßË°åÊèêÊ°àÂÜÖÂÆπÂâçÔºåÈ¶ñÂÖà‰ºöÂà§Êñ≠ÂΩìÂâçÊèêÊ°àÊòØÂê¶Â∑≤ÁªèÊâßË°åËøá‰∫ÜÔºåÂ¶ÇÊûúÊâßË°å‰∫ÜÂàôÁõ¥Êé•ËøîÂõûÔºåËã•Êú™ÊâßË°åÂêåÊó∂Êó† db ÈÖçÈ¢ùÊª°ÂëäË≠¶ÔºåÂàôËøõÂÖ•Âà∞ MVCC Ê®°ÂùóÔºåÂºÄÂßã‰∏éÊåÅ‰πÖÂåñÂ≠òÂÇ®Ê®°ÂùóÊâì‰∫§ÈÅì„ÄÇ</p>
<p>MVCC</p>
<p>Apply Ê®°ÂùóÂà§Êñ≠Ê≠§ÊèêÊ°àÊú™ÊâßË°åÂêéÔºåÂ∞±‰ºöË∞ÉÁî® MVCC Ê®°ÂùóÊù•ÊâßË°åÊèêÊ°àÂÜÖÂÆπ„ÄÇMVCC ‰∏ªË¶ÅÁî±‰∏§ÈÉ®ÂàÜÁªÑÊàêÔºå‰∏Ä‰∏™ÊòØÂÜÖÂ≠òÁ¥¢ÂºïÊ®°Âùó treeIndexÔºå‰øùÂ≠ò key ÁöÑÂéÜÂè≤ÁâàÊú¨Âè∑‰ø°ÊÅØÔºåÂè¶‰∏Ä‰∏™ÊòØ boltdb Ê®°ÂùóÔºåÁî®Êù•ÊåÅ‰πÖÂåñÂ≠òÂÇ® key-value Êï∞ÊçÆ„ÄÇÈÇ£‰πà MVCC Ê®°ÂùóÊâßË°å put hello ‰∏∫ world ÂëΩ‰ª§Êó∂ÔºåÂÆÉÊòØÂ¶Ç‰ΩïÊûÑÂª∫ÂÜÖÂ≠òÁ¥¢ÂºïÂíå‰øùÂ≠òÂì™‰∫õÊï∞ÊçÆÂà∞ db Âë¢Ôºü</p>
<p>treeIndex</p>
<p>È¶ñÂÖàÊàë‰ª¨Êù•Áúã MVCC ÁöÑÁ¥¢ÂºïÊ®°Âùó treeIndexÔºåÂΩìÊî∂Âà∞Êõ¥Êñ∞ key hello ‰∏∫ world ÁöÑÊó∂ÂÄôÔºåÊ≠§ key ÁöÑÁ¥¢ÂºïÁâàÊú¨Âè∑‰ø°ÊÅØÊòØÊÄé‰πàÁîüÊàêÁöÑÂë¢ÔºüÈúÄË¶ÅÁª¥Êä§„ÄÅÊåÅ‰πÖÂåñÂ≠òÂÇ®‰∏Ä‰∏™ÂÖ®Â±ÄÁâàÊú¨Âè∑ÂêóÔºüÁâàÊú¨Âè∑ÔºàrevisionÔºâÂú® etcd ÈáåÈù¢ÂèëÊå•ÁùÄÈáçÂ§ß‰ΩúÁî®ÔºåÂÆÉÊòØ etcd ÁöÑÈÄªËæëÊó∂Èíü„ÄÇetcd ÂêØÂä®ÁöÑÊó∂ÂÄôÈªòËÆ§ÁâàÊú¨Âè∑ÊòØ 1ÔºåÈöèÁùÄ‰Ω†ÂØπ key ÁöÑÂ¢û„ÄÅÂà†„ÄÅÊîπÊìç‰ΩúËÄåÂÖ®Â±ÄÂçïË∞ÉÈÄíÂ¢û„ÄÇÂõ†‰∏∫ boltdb ‰∏≠ÁöÑ key Â∞±ÂåÖÂê´Ê≠§‰ø°ÊÅØÔºåÊâÄ‰ª• etcd Âπ∂‰∏çÈúÄË¶ÅÂÜçÂéªÊåÅ‰πÖÂåñ‰∏Ä‰∏™ÂÖ®Â±ÄÁâàÊú¨Âè∑„ÄÇÊàë‰ª¨Âè™ÈúÄË¶ÅÂú®ÂêØÂä®ÁöÑÊó∂ÂÄôÔºå‰ªéÊúÄÂ∞èÂÄº 1 ÂºÄÂßãÊûö‰∏æÂà∞ÊúÄÂ§ßÂÄºÔºåÊú™ËØªÂà∞Êï∞ÊçÆÁöÑÊó∂ÂÄôÂàôÁªìÊùüÔºåÊúÄÂêéËØªÂá∫Êù•ÁöÑÁâàÊú¨Âè∑Âç≥ÊòØÂΩìÂâç etcd ÁöÑÊúÄÂ§ßÁâàÊú¨Âè∑ currentRevision„ÄÇMVCC ÂÜô‰∫ãÂä°Âú®ÊâßË°å put hello ‰∏∫ world ÁöÑËØ∑Ê±ÇÊó∂Ôºå‰ºöÂü∫‰∫é currentRevision Ëá™Â¢ûÁîüÊàêÊñ∞ÁöÑ revision Â¶Ç{2,0}ÔºåÁÑ∂Âêé‰ªé treeIndex Ê®°Âùó‰∏≠Êü•ËØ¢ key ÁöÑÂàõÂª∫ÁâàÊú¨Âè∑„ÄÅ‰øÆÊîπÊ¨°Êï∞‰ø°ÊÅØ„ÄÇËøô‰∫õ‰ø°ÊÅØÂ∞ÜÂ°´ÂÖÖÂà∞ boltdb ÁöÑ value ‰∏≠ÔºåÂêåÊó∂Â∞ÜÁî®Êà∑ÁöÑ hello key Âíå revision Á≠â‰ø°ÊÅØÂ≠òÂÇ®Âà∞ B-treeÔºå‰πüÂ∞±ÊòØ‰∏ãÈù¢ÁÆÄÊòìÂÜô‰∫ãÂä°ÂõæÁöÑÊµÅÁ®ã‰∏ÄÔºåÊï¥‰ΩìÊû∂ÊûÑÂõæ‰∏≠ÁöÑÊµÅÁ®ãÂÖ´„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/treeindex%e5%86%99%e4%ba%8b%e5%8a%a1.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>boltdbMVCC ÂÜô‰∫ãÂä°Ëá™Â¢ûÂÖ®Â±ÄÁâàÊú¨Âè∑ÂêéÁîüÊàêÁöÑ revision{2,0}ÔºåÂÆÉÂ∞±ÊòØ boltdb ÁöÑ keyÔºåÈÄöËøáÂÆÉÂ∞±ÂèØ‰ª•ÂæÄ boltdb ÂÜôÊï∞ÊçÆ‰∫ÜÔºåËøõÂÖ•‰∫ÜÊï¥‰ΩìÊû∂ÊûÑÂõæ‰∏≠ÁöÑÊµÅÁ®ã‰πù„ÄÇboltdb ‰∏ä‰∏ÄÁØáÊàë‰ª¨ÊèêËøáÂÆÉÊòØ‰∏Ä‰∏™Âü∫‰∫é B+tree ÂÆûÁé∞ÁöÑ key-value ÂµåÂÖ•Âºè dbÔºåÂÆÉÈÄöËøáÊèê‰æõÊ°∂ÔºàbucketÔºâÊú∫Âà∂ÂÆûÁé∞Á±ª‰ºº MySQL Ë°®ÁöÑÈÄªËæëÈöîÁ¶ª„ÄÇÂú® etcd ÈáåÈù¢‰Ω†ÈÄöËøá put/txn Á≠â KV API Êìç‰ΩúÁöÑÊï∞ÊçÆÔºåÂÖ®ÈÉ®‰øùÂ≠òÂú®‰∏Ä‰∏™Âêç‰∏∫ key ÁöÑÊ°∂ÈáåÈù¢ÔºåËøô‰∏™ key Ê°∂Âú®ÂêØÂä® etcd ÁöÑÊó∂ÂÄô‰ºöËá™Âä®ÂàõÂª∫„ÄÇÈô§‰∫Ü‰øùÂ≠òÁî®Êà∑ KV Êï∞ÊçÆÁöÑ key Ê°∂Ôºåetcd Êú¨Ë∫´ÂèäÂÖ∂ÂÆÉÂäüËÉΩÈúÄË¶ÅÊåÅ‰πÖÂåñÂ≠òÂÇ®ÁöÑËØùÔºåÈÉΩ‰ºöÂàõÂª∫ÂØπÂ∫îÁöÑÊ°∂„ÄÇÊØîÂ¶Ç‰∏äÈù¢Êàë‰ª¨ÊèêÂà∞ÁöÑ etcd ‰∏∫‰∫Ü‰øùËØÅÊó•ÂøóÁöÑÂπÇÁ≠âÊÄßÔºå‰øùÂ≠ò‰∫Ü‰∏Ä‰∏™Âêç‰∏∫ consistent index ÁöÑÂèòÈáèÂú® db ÈáåÈù¢ÔºåÂÆÉÂÆûÈôÖ‰∏äÂ∞±Â≠òÂÇ®Âú®ÂÖÉÊï∞ÊçÆÔºàmetaÔºâÊ°∂ÈáåÈù¢„ÄÇ</p>
<p>ÈÇ£‰πàÂÜôÂÖ• boltdb ÁöÑ value Âê´ÊúâÂì™‰∫õ‰ø°ÊÅØÂë¢ÔºüÂÜôÂÖ• boltdb ÁöÑ valueÔºå Âπ∂‰∏çÊòØÁÆÄÂçïÁöÑ&quot;world&quot;ÔºåÂ¶ÇÊûúÂè™Â≠ò‰∏Ä‰∏™Áî®Êà∑ valueÔºåÁ¥¢ÂºïÂèàÊòØ‰øùÂ≠òÂú®ÊòìÂ§±ÁöÑÂÜÖÂ≠ò‰∏äÔºåÈÇ£ÈáçÂêØ etcd ÂêéÔºåÊàë‰ª¨Â∞±‰∏¢Â§±‰∫ÜÁî®Êà∑ÁöÑ key ÂêçÔºåÊó†Ê≥ïÊûÑÂª∫ treeIndex Ê®°Âùó‰∫Ü„ÄÇÂõ†Ê≠§‰∏∫‰∫ÜÊûÑÂª∫Á¥¢ÂºïÂíåÊîØÊåÅ Lease Á≠âÁâπÊÄßÔºåetcd ‰ºöÊåÅ‰πÖÂåñ‰ª•‰∏ã‰ø°ÊÅØ:key ÂêçÁß∞Ôºõkey ÂàõÂª∫Êó∂ÁöÑÁâàÊú¨Âè∑Ôºàcreate_revisionÔºâ„ÄÅÊúÄÂêé‰∏ÄÊ¨°‰øÆÊîπÊó∂ÁöÑÁâàÊú¨Âè∑Ôºàmod_revisionÔºâ„ÄÅkey Ëá™Ë∫´‰øÆÊîπÁöÑÊ¨°Êï∞ÔºàversionÔºâÔºõvalue ÂÄºÔºõÁßüÁ∫¶‰ø°ÊÅØÔºàÂêéÈù¢‰ªãÁªçÔºâ„ÄÇboltdb value ÁöÑÂÄºÂ∞±ÊòØÂ∞ÜÂê´‰ª•‰∏ä‰ø°ÊÅØÁöÑÁªìÊûÑ‰ΩìÂ∫èÂàóÂåñÊàêÁöÑ‰∫åËøõÂà∂Êï∞ÊçÆÔºåÁÑ∂ÂêéÈÄöËøá boltdb Êèê‰æõÁöÑ put Êé•Âè£Ôºåetcd Â∞±Âø´ÈÄüÂÆåÊàê‰∫ÜÂ∞Ü‰Ω†ÁöÑÊï∞ÊçÆÂÜôÂÖ• boltdbÔºåÂØπÂ∫î‰∏äÈù¢ÁÆÄÊòìÂÜô‰∫ãÂä°ÂõæÁöÑÊµÅÁ®ã‰∫å„ÄÇ</p>
<p>‰ΩÜÊòØ put Ë∞ÉÁî®ÊàêÂäüÔºåÂ∞±ËÉΩÂ§ü‰ª£Ë°®Êï∞ÊçÆÂ∑≤ÁªèÊåÅ‰πÖÂåñÂà∞ db Êñá‰ª∂‰∫ÜÂêóÔºüËøôÈáåÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÔºåÂú®‰ª•‰∏äÊµÅÁ®ã‰∏≠Ôºåetcd Âπ∂Êú™Êèê‰∫§‰∫ãÂä°ÔºàcommitÔºâÔºåÂõ†Ê≠§Êï∞ÊçÆÂè™Êõ¥Êñ∞Âú® boltdb ÊâÄÁÆ°ÁêÜÁöÑÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑ‰∏≠„ÄÇ‰∫ãÂä°Êèê‰∫§ÁöÑËøáÁ®ãÔºåÂåÖÂê´ B+tree ÁöÑÂπ≥Ë°°„ÄÅÂàÜË£ÇÔºåÂ∞Ü boltdb ÁöÑËÑèÊï∞ÊçÆÔºàdirty pageÔºâ„ÄÅÂÖÉÊï∞ÊçÆ‰ø°ÊÅØÂà∑Êñ∞Âà∞Á£ÅÁõòÔºåÂõ†Ê≠§‰∫ãÂä°Êèê‰∫§ÁöÑÂºÄÈîÄÊòØÊòÇË¥µÁöÑ„ÄÇÂ¶ÇÊûúÊàë‰ª¨ÊØèÊ¨°Êõ¥Êñ∞ÈÉΩÊèê‰∫§‰∫ãÂä°Ôºåetcd ÂÜôÊÄßËÉΩÂ∞±‰ºöËæÉÂ∑Æ„ÄÇ</p>
<p>ÈÇ£‰πàËß£ÂÜ≥ÁöÑÂäûÊ≥ïÊòØ‰ªÄ‰πàÂë¢Ôºüetcd ÁöÑËß£ÂÜ≥ÊñπÊ°àÊòØÂêàÂπ∂ÂÜçÂêàÂπ∂„ÄÇÈ¶ñÂÖà boltdb key ÊòØÁâàÊú¨Âè∑Ôºåput/delete Êìç‰ΩúÊó∂ÔºåÈÉΩ‰ºöÂü∫‰∫éÂΩìÂâçÁâàÊú¨Âè∑ÈÄíÂ¢ûÁîüÊàêÊñ∞ÁöÑÁâàÊú¨Âè∑ÔºåÂõ†Ê≠§Â±û‰∫éÈ°∫Â∫èÂÜôÂÖ•ÔºåÂèØ‰ª•Ë∞ÉÊï¥ boltdb ÁöÑ bucket.FillPercent ÂèÇÊï∞Ôºå‰ΩøÊØè‰∏™ page Â°´ÂÖÖÊõ¥Â§öÊï∞ÊçÆÔºåÂáèÂ∞ë page ÁöÑÂàÜË£ÇÊ¨°Êï∞Âπ∂Èôç‰Ωé db Á©∫Èó¥„ÄÇÂÖ∂Ê¨° etcd ÈÄöËøáÂêàÂπ∂Â§ö‰∏™ÂÜô‰∫ãÂä°ËØ∑Ê±ÇÔºåÈÄöÂ∏∏ÊÉÖÂÜµ‰∏ãÔºåÊòØÂºÇÊ≠•Êú∫Âà∂ÂÆöÊó∂ÔºàÈªòËÆ§ÊØèÈöî 100msÔºâÂ∞ÜÊâπÈáè‰∫ãÂä°‰∏ÄÊ¨°ÊÄßÊèê‰∫§Ôºàpending ‰∫ãÂä°ËøáÂ§öÊâç‰ºöËß¶ÂèëÂêåÊ≠•Êèê‰∫§ÔºâÔºå ‰ªéËÄåÂ§ßÂ§ßÊèêÈ´òÂêûÂêêÈáèÔºåÂØπÂ∫î‰∏äÈù¢ÁÆÄÊòìÂÜô‰∫ãÂä°ÂõæÁöÑÊµÅÁ®ã‰∏â„ÄÇ‰ΩÜÊòØËøô‰ºòÂåñÂèàÂºïÂèë‰∫ÜÂè¶Â§ñÁöÑ‰∏Ä‰∏™ÈóÆÈ¢òÔºå Âõ†‰∏∫‰∫ãÂä°Êú™Êèê‰∫§ÔºåËØªËØ∑Ê±ÇÂèØËÉΩÊó†Ê≥ï‰ªé boltdb Ëé∑ÂèñÂà∞ÊúÄÊñ∞Êï∞ÊçÆ„ÄÇ‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºåetcd ÂºïÂÖ•‰∫Ü‰∏Ä‰∏™ bucket buffer Êù•‰øùÂ≠òÊöÇÊú™Êèê‰∫§ÁöÑ‰∫ãÂä°Êï∞ÊçÆ„ÄÇÂú®Êõ¥Êñ∞ boltdb ÁöÑÊó∂ÂÄôÔºåetcd ‰πü‰ºöÂêåÊ≠•Êï∞ÊçÆÂà∞ bucket buffer„ÄÇÂõ†Ê≠§ etcd Â§ÑÁêÜËØªËØ∑Ê±ÇÁöÑÊó∂ÂÄô‰ºö‰ºòÂÖà‰ªé bucket buffer ÈáåÈù¢ËØªÂèñÔºåÂÖ∂Ê¨°ÂÜç‰ªé boltdb ËØªÔºåÈÄöËøá bucket buffer ÂÆûÁé∞ËØªÂÜôÊÄßËÉΩÊèêÂçáÔºåÂêåÊó∂‰øùËØÅÊï∞ÊçÆ‰∏ÄËá¥ÊÄß„ÄÇ</p>
<p>‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºåetcd ÂºïÂÖ•‰∫Ü‰∏Ä‰∏™ bucket buffer Êù•‰øùÂ≠òÊöÇÊú™Êèê‰∫§ÁöÑ‰∫ãÂä°Êï∞ÊçÆ„ÄÇÂú®Êõ¥Êñ∞ boltdb ÁöÑÊó∂ÂÄôÔºåetcd ‰πü‰ºöÂêåÊ≠•Êï∞ÊçÆÂà∞ bucket buffer„ÄÇÂõ†Ê≠§ etcd Â§ÑÁêÜËØªËØ∑Ê±ÇÁöÑÊó∂ÂÄô‰ºö‰ºòÂÖà‰ªé bucket buffer ÈáåÈù¢ËØªÂèñÔºåÂÖ∂Ê¨°ÂÜç‰ªé boltdb ËØªÔºåÈÄöËøá bucket buffer ÂÆûÁé∞ËØªÂÜôÊÄßËÉΩÊèêÂçáÔºåÂêåÊó∂‰øùËØÅÊï∞ÊçÆ‰∏ÄËá¥ÊÄß„ÄÇ</p>
<p>Â∞èÁªìÊúÄÂêéÊàë‰ª¨Êù•Â∞èÁªì‰∏Ä‰∏ãÔºå‰ªäÂ§©ÊàëÁªô‰Ω†‰ªãÁªç‰∫Ü etcd ÁöÑÂÜôËØ∑Ê±ÇÊµÅÁ®ãÔºåÈáçÁÇπ‰ªãÁªç‰∫Ü Quota„ÄÅWAL„ÄÅApply Ê®°Âùó„ÄÇÈ¶ñÂÖàÊàë‰ª¨‰ªãÁªç‰∫Ü Quota Ê®°ÂùóÂ∑•‰ΩúÂéüÁêÜÂíåÊàë‰ª¨ÁÜüÊÇâÁöÑ database space exceeded ÈîôËØØËß¶ÂèëÂéüÂõ†ÔºåÂÜôËØ∑Ê±ÇÂØºËá¥ db Â§ßÂ∞èÂ¢ûÂä†„ÄÅcompact Á≠ñÁï•‰∏çÂêàÁêÜ„ÄÅboltdb Bug Á≠âÈÉΩ‰ºöÂØºËá¥ db Â§ßÂ∞èË∂ÖÈôê„ÄÇÂÖ∂Ê¨°‰ªãÁªç‰∫Ü WAL Ê®°ÂùóÁöÑÂ≠òÂÇ®ÁªìÊûÑÔºåÂÆÉÁî±‰∏ÄÊù°Êù°ËÆ∞ÂΩïÈ°∫Â∫èÂÜôÂÖ•ÁªÑÊàêÔºåÊØè‰∏™ËÆ∞ÂΩïÂê´Êúâ Type„ÄÅCRC„ÄÅDataÔºåÊØè‰∏™ÊèêÊ°àË¢´Êèê‰∫§ÂâçÈÉΩ‰ºöË¢´ÊåÅ‰πÖÂåñÂà∞ WAL Êñá‰ª∂‰∏≠Ôºå‰ª•‰øùËØÅÈõÜÁæ§ÁöÑ‰∏ÄËá¥ÊÄßÂíåÂèØÊÅ¢Â§çÊÄß„ÄÇÈöèÂêéÊàë‰ª¨‰ªãÁªç‰∫Ü Apply Ê®°ÂùóÂü∫‰∫é consistent index Âíå‰∫ãÂä°ÂÆûÁé∞‰∫ÜÂπÇÁ≠âÊÄßÔºå‰øùËØÅ‰∫ÜËäÇÁÇπÂú®ÂºÇÂ∏∏ÊÉÖÂÜµ‰∏ã‰∏ç‰ºöÈáçÂ§çÊâßË°åÈáçÊîæÁöÑÊèêÊ°à„ÄÇÊúÄÂêéÊàë‰ª¨‰ªãÁªç‰∫Ü MVCC Ê®°ÂùóÊòØÂ¶Ç‰ΩïÁª¥Êä§Á¥¢ÂºïÁâàÊú¨Âè∑„ÄÅÈáçÂêØÂêéÂ¶Ç‰Ωï‰ªé boltdb Ê®°Âùó‰∏≠Ëé∑ÂèñÂÜÖÂ≠òÁ¥¢ÂºïÁªìÊûÑÁöÑ„ÄÇ‰ª•Âèä etcd ÈÄöËøáÂºÇÊ≠•„ÄÅÊâπÈáèÊèê‰∫§‰∫ãÂä°Êú∫Âà∂Ôºå‰ª•ÊèêÂçáÂÜô QPS ÂíåÂêûÂêêÈáè„ÄÇ</p>
<p>ÈÄöËøá‰ª•‰∏ä‰ªãÁªçÔºåÂ∏åÊúõ‰Ω†ÂØπ etcd ÁöÑ‰∏Ä‰∏™ÂÜôËØ≠Âè•ÊâßË°åÊµÅÁ®ãÊúâ‰∏™ÂàùÊ≠•ÁöÑÁêÜËß£ÔºåÊòéÁôΩ WAL Ê®°Âùó„ÄÅApply Ê®°Âùó„ÄÅMVCC Ê®°Âùó‰∏âËÄÖÊòØÂ¶Ç‰ΩïÁõ∏‰∫íÂçè‰ΩúÁöÑÔºå‰ªéËÄåÂÆûÁé∞Âú®ËäÇÁÇπÈÅ≠ÈÅá crash Á≠âÂºÇÂ∏∏ÊÉÖÂÜµ‰∏ãÔºå‰∏ç‰∏¢‰ªª‰ΩïÂ∑≤Êèê‰∫§ÁöÑÊï∞ÊçÆ„ÄÅ‰∏çÈáçÂ§çÊâßË°å‰ªª‰ΩïÊèêÊ°à„ÄÇ</p>
<h3 id="etcdÁöÑÈ´òÂèØÁî®ÂíåÊï∞ÊçÆ‰∏ÄËá¥ÊÄßraft-ÂçèËÆÆ">etcdÁöÑÈ´òÂèØÁî®ÂíåÊï∞ÊçÆ‰∏ÄËá¥ÊÄß(raft ÂçèËÆÆ)</h3>
<p>‰Ω†Â•ΩÔºåÊàëÊòØÂîêËÅ™„ÄÇÂú®ÂâçÈù¢ÁöÑ etcd ËØªÂÜôÊµÅÁ®ãÂ≠¶‰π†‰∏≠ÔºåÊàëÂíå‰Ω†Â§öÊ¨°ÊèêÂà∞‰∫Ü etcd ÊòØÂü∫‰∫é Raft ÂçèËÆÆÂÆûÁé∞È´òÂèØÁî®„ÄÅÊï∞ÊçÆÂº∫‰∏ÄËá¥ÊÄßÁöÑ„ÄÇÈÇ£‰πà etcd ÊòØÂ¶Ç‰ΩïÂü∫‰∫é Raft Êù•ÂÆûÁé∞È´òÂèØÁî®„ÄÅÊï∞ÊçÆÂº∫‰∏ÄËá¥ÊÄßÁöÑÂë¢ÔºüËøôËäÇËØæÊàë‰ª¨Â∞±‰ª•‰∏ä‰∏ÄËäÇ‰∏≠ÁöÑ hello ÂÜôËØ∑Ê±Ç‰∏∫Ê°à‰æãÔºåÊ∑±ÂÖ•ÂàÜÊûê etcd Âú®ÈÅáÂà∞ Leader ËäÇÁÇπ crash Á≠âÂºÇÂ∏∏ÂêéÔºåFollower ËäÇÁÇπÂ¶Ç‰ΩïÂø´ÈÄüÊÑüÁü•Âà∞ÂºÇÂ∏∏ÔºåÂπ∂È´òÊïàÈÄâ‰∏æÂá∫Êñ∞ÁöÑ LeaderÔºåÂØπÂ§ñÊèê‰æõÈ´òÂèØÁî®ÊúçÂä°ÁöÑ„ÄÇÂêåÊó∂ÔºåÊàëÂ∞ÜÈÄöËøá‰∏Ä‰∏™Êó•ÂøóÂ§çÂà∂Êï¥‰ΩìÊµÅÁ®ãÂõæÔºå‰∏∫‰Ω†‰ªãÁªç etcd Â¶Ç‰Ωï‰øùÈöúÂêÑËäÇÁÇπÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÔºåÂπ∂‰ªãÁªç Raft ÁÆóÊ≥ï‰∏∫‰∫ÜÁ°Æ‰øùÊï∞ÊçÆ‰∏ÄËá¥ÊÄß„ÄÅÂÆåÊï¥ÊÄßÔºåÂØπ Leader ÈÄâ‰∏æÂíåÊó•ÂøóÂ§çÂà∂ÊâÄÂ¢ûÂä†ÁöÑ‰∏ÄÁ≥ªÂàóÂÆâÂÖ®ËßÑÂàô„ÄÇÂ∏åÊúõÈÄöËøáËøôËäÇËØæÔºåËÆ©‰Ω†‰∫ÜËß£ etcd Âú®ËäÇÁÇπÊïÖÈöú„ÄÅÁΩëÁªúÂàÜÂå∫Á≠âÂºÇÂ∏∏Âú∫ÊôØ‰∏ãÊòØÂ¶Ç‰ΩïÂü∫‰∫é Raft ÁÆóÊ≥ïÂÆûÁé∞È´òÂèØÁî®„ÄÅÊï∞ÊçÆÂº∫‰∏ÄËá¥ÁöÑ„ÄÇ</p>
<p>Â¶Ç‰ΩïÈÅøÂÖçÂçïÁÇπÊïÖÈöúÂú®‰ªãÁªç Raft ÁÆóÊ≥ï‰πãÂâçÔºåÊàë‰ª¨È¶ñÂÖà‰∫ÜËß£‰∏ãÂÆÉÁöÑËØûÁîüËÉåÊôØÔºåRaft Ëß£ÂÜ≥‰∫ÜÂàÜÂ∏ÉÂºèÁ≥ªÁªü‰ªÄ‰πàÁóõÁÇπÂë¢ÔºüÈ¶ñÂÖàÊàë‰ª¨ÂõûÊÉ≥‰∏ãÔºåÊó©ÊúüÊàë‰ª¨‰ΩøÁî®ÁöÑÊï∞ÊçÆÂ≠òÂÇ®ÊúçÂä°ÔºåÂÆÉ‰ª¨ÂæÄÂæÄÊòØÈÉ®ÁΩ≤Âú®ÂçïËäÇÁÇπ‰∏äÁöÑ„ÄÇ‰ΩÜÊòØÂçïËäÇÁÇπÂ≠òÂú®ÂçïÁÇπÊïÖÈöúÔºå‰∏ÄÂÆïÊú∫Â∞±Êï¥‰∏™ÊúçÂä°‰∏çÂèØÁî®ÔºåÂØπ‰∏öÂä°ÂΩ±ÂìçÈùûÂ∏∏Â§ß„ÄÇÈöèÂêéÔºå‰∏∫‰∫ÜËß£ÂÜ≥ÂçïÁÇπÈóÆÈ¢òÔºåËΩØ‰ª∂Á≥ªÁªüÂ∑•Á®ãÂ∏àÂºïÂÖ•‰∫ÜÊï∞ÊçÆÂ§çÂà∂ÊäÄÊúØÔºåÂÆûÁé∞Â§öÂâØÊú¨„ÄÇÈÄöËøáÊï∞ÊçÆÂ§çÂà∂ÊñπÊ°àÔºå‰∏ÄÊñπÈù¢Êàë‰ª¨ÂèØ‰ª•ÊèêÈ´òÊúçÂä°ÂèØÁî®ÊÄßÔºåÈÅøÂÖçÂçïÁÇπÊïÖÈöú„ÄÇÂè¶‰∏ÄÊñπÈù¢ÔºåÂ§öÂâØÊú¨ÂèØ‰ª•ÊèêÂçáËØªÂêûÂêêÈáè„ÄÅÁîöËá≥Â∞±ËøëÈÉ®ÁΩ≤Âú®‰∏öÂä°ÊâÄÂú®ÁöÑÂú∞ÁêÜ‰ΩçÁΩÆÔºåÈôç‰ΩéËÆøÈóÆÂª∂Ëøü„ÄÇ</p>
<p>Â§öÂâØÊú¨Â§çÂà∂ÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁöÑÂë¢ÔºüÂ§öÂâØÊú¨Â∏∏Áî®ÁöÑÊäÄÊúØÊñπÊ°à‰∏ªË¶ÅÊúâ‰∏ª‰ªéÂ§çÂà∂ÂíåÂéª‰∏≠ÂøÉÂåñÂ§çÂà∂„ÄÇ‰∏ª‰ªéÂ§çÂà∂ÔºåÂèàÂàÜ‰∏∫ÂÖ®ÂêåÊ≠•Â§çÂà∂„ÄÅÂºÇÊ≠•Â§çÂà∂„ÄÅÂçäÂêåÊ≠•Â§çÂà∂ÔºåÊØîÂ¶Ç MySQL/Redis ÂçïÊú∫‰∏ªÂ§áÁâàÂ∞±Âü∫‰∫é‰∏ª‰ªéÂ§çÂà∂ÂÆûÁé∞ÁöÑ„ÄÇ</p>
<p>ÂÖ®ÂêåÊ≠•Â§çÂà∂ÊòØÊåá‰∏ªÊî∂Âà∞‰∏Ä‰∏™ÂÜôËØ∑Ê±ÇÂêéÔºåÂøÖÈ°ªÁ≠âÂæÖÂÖ®ÈÉ®‰ªéËäÇÁÇπÁ°ÆËÆ§ËøîÂõûÂêéÔºåÊâçËÉΩËøîÂõûÁªôÂÆ¢Êà∑Á´ØÊàêÂäü„ÄÇÂõ†Ê≠§Â¶ÇÊûú‰∏Ä‰∏™‰ªéËäÇÁÇπÊïÖÈöúÔºåÊï¥‰∏™Á≥ªÁªüÂ∞±‰ºö‰∏çÂèØÁî®„ÄÇËøôÁßçÊñπÊ°à‰∏∫‰∫Ü‰øùËØÅÂ§öÂâØÊú¨ÁöÑ‰∏ÄËá¥ÊÄßÔºåËÄåÁâ∫Áâ≤‰∫ÜÂèØÁî®ÊÄßÔºå‰∏ÄËà¨‰ΩøÁî®‰∏çÂ§ö„ÄÇ</p>
<p>ÂºÇÊ≠•Â§çÂà∂ÊòØÊåá‰∏ªÊî∂Âà∞‰∏Ä‰∏™ÂÜôËØ∑Ê±ÇÂêéÔºåÂèØÂèäÊó∂ËøîÂõûÁªô clientÔºåÂºÇÊ≠•Â∞ÜËØ∑Ê±ÇËΩ¨ÂèëÁªôÂêÑ‰∏™ÂâØÊú¨ÔºåËã•ËøòÊú™Â∞ÜËØ∑Ê±ÇËΩ¨ÂèëÂà∞ÂâØÊú¨ÂâçÂ∞±ÊïÖÈöú‰∫ÜÔºåÂàôÂèØËÉΩÂØºËá¥Êï∞ÊçÆ‰∏¢Â§±Ôºå‰ΩÜÊòØÂèØÁî®ÊÄßÊòØÊúÄÈ´òÁöÑ„ÄÇ</p>
<p>ÂçäÂêåÊ≠•Â§çÂà∂‰ªã‰∫éÂÖ®ÂêåÊ≠•Â§çÂà∂„ÄÅÂºÇÊ≠•Â§çÂà∂‰πãÈó¥ÔºåÂÆÉÊòØÊåá‰∏ªÊî∂Âà∞‰∏Ä‰∏™ÂÜôËØ∑Ê±ÇÂêéÔºåËá≥Â∞ëÊúâ‰∏Ä‰∏™ÂâØÊú¨Êé•Êî∂Êï∞ÊçÆÂêéÔºåÂ∞±ÂèØ‰ª•ËøîÂõûÁªôÂÆ¢Êà∑Á´ØÊàêÂäüÔºåÂú®Êï∞ÊçÆ‰∏ÄËá¥ÊÄß„ÄÅÂèØÁî®ÊÄß‰∏äÂÆûÁé∞‰∫ÜÂπ≥Ë°°ÂíåÂèñËàç„ÄÇ</p>
<p>Ë∑ü‰∏ª‰ªéÂ§çÂà∂Áõ∏ÂèçÁöÑÂ∞±ÊòØÂéª‰∏≠ÂøÉÂåñÂ§çÂà∂ÔºåÂÆÉÊòØÊåáÂú®‰∏Ä‰∏™ n ÂâØÊú¨ËäÇÁÇπÈõÜÁæ§‰∏≠Ôºå‰ªªÊÑèËäÇÁÇπÈÉΩÂèØÊé•ÂèóÂÜôËØ∑Ê±ÇÔºå‰ΩÜ‰∏Ä‰∏™ÊàêÂäüÁöÑÂÜôÂÖ•ÈúÄË¶Å w ‰∏™ËäÇÁÇπÁ°ÆËÆ§ÔºåËØªÂèñ‰πüÂøÖÈ°ªÊü•ËØ¢Ëá≥Â∞ë r ‰∏™ËäÇÁÇπ„ÄÇ</p>
<p>‰Ω†ÂèØ‰ª•Ê†πÊçÆÂÆûÈôÖ‰∏öÂä°Âú∫ÊôØÂØπÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÁöÑÊïèÊÑüÂ∫¶ÔºåËÆæÁΩÆÂêàÈÄÇ w/r ÂèÇÊï∞„ÄÇÊØîÂ¶Ç‰Ω†Â∏åÊúõÊØèÊ¨°ÂÜôÂÖ•ÂêéÔºå‰ªªÊÑè client ÈÉΩËÉΩËØªÂèñÂà∞Êñ∞ÂÄºÔºåÂ¶ÇÊûú n ÊòØ 3 ‰∏™ÂâØÊú¨Ôºå‰Ω†ÂèØ‰ª•Â∞Ü w Âíå r ËÆæÁΩÆ‰∏∫ 2ÔºåËøôÊ†∑ÂΩì‰Ω†ËØª‰∏§‰∏™ËäÇÁÇπÊó∂ÂÄôÔºåÂøÖÊúâ‰∏Ä‰∏™ËäÇÁÇπÂê´ÊúâÊúÄËøëÂÜôÂÖ•ÁöÑÊñ∞ÂÄºÔºåËøôÁßçËØªÊàë‰ª¨Áß∞‰πã‰∏∫Ê≥ïÂÆöÁ•®Êï∞ËØªÔºàquorum readÔºâ„ÄÇ</p>
<p>AWS ÁöÑ Dynamo Á≥ªÁªüÂ∞±ÊòØÂü∫‰∫éÂéª‰∏≠ÂøÉÂåñÁöÑÂ§çÂà∂ÁÆóÊ≥ïÂÆûÁé∞ÁöÑ„ÄÇÂÆÉÁöÑ‰ºòÁÇπÊòØËäÇÁÇπËßíËâ≤ÈÉΩÊòØÂπ≥Á≠âÁöÑÔºåÈôç‰ΩéËøêÁª¥Â§çÊùÇÂ∫¶ÔºåÂèØÁî®ÊÄßÊõ¥È´ò„ÄÇ‰ΩÜÊòØÁº∫Èô∑ÊòØÂéª‰∏≠ÂøÉÂåñÂ§çÂà∂ÔºåÂäøÂøÖ‰ºöÂØºËá¥ÂêÑÁßçÂÜôÂÖ•ÂÜ≤Á™ÅÔºå‰∏öÂä°ÈúÄË¶ÅÂÖ≥Ê≥®ÂÜ≤Á™ÅÂ§ÑÁêÜ„ÄÇ</p>
<p>‰ªé‰ª•‰∏äÂàÜÊûê‰∏≠Ôºå‰∏∫‰∫ÜËß£ÂÜ≥ÂçïÁÇπÊïÖÈöúÔºå‰ªéËÄåÂºïÂÖ•‰∫ÜÂ§öÂâØÊú¨„ÄÇ‰ΩÜÂü∫‰∫éÂ§çÂà∂ÁÆóÊ≥ïÂÆûÁé∞ÁöÑÊï∞ÊçÆÂ∫ìÔºå‰∏∫‰∫Ü‰øùËØÅÊúçÂä°ÂèØÁî®ÊÄßÔºåÂ§ßÂ§öÊï∞Êèê‰æõÁöÑÊòØÊúÄÁªà‰∏ÄËá¥ÊÄßÔºåÊÄªËÄåË®Ä‰πãÔºå‰∏çÁÆ°ÊòØ‰∏ª‰ªéÂ§çÂà∂ËøòÊòØÂºÇÊ≠•Â§çÂà∂ÔºåÈÉΩÂ≠òÂú®‰∏ÄÂÆöÁöÑÁº∫Èô∑„ÄÇ</p>
<p>Â¶Ç‰ΩïËß£ÂÜ≥‰ª•‰∏äÂ§çÂà∂ÁÆóÊ≥ïÁöÑÂõ∞Â¢ÉÂë¢Ôºü</p>
<p>Á≠îÊ°àÂ∞±ÊòØÂÖ±ËØÜÁÆóÊ≥ïÔºåÂÆÉÊúÄÊó©ÊòØÂü∫‰∫éÂ§çÂà∂Áä∂ÊÄÅÊú∫ËÉåÊôØ‰∏ãÊèêÂá∫Êù•ÁöÑ„ÄÇ ‰∏ãÂõæÊòØÂ§çÂà∂Áä∂ÊÄÅÊú∫ÁöÑÁªìÊûÑÔºàÂºïÁî®Ëá™ Raft paperÔºâÔºå ÂÆÉÁî±ÂÖ±ËØÜÊ®°Âùó„ÄÅÊó•ÂøóÊ®°Âùó„ÄÅÁä∂ÊÄÅÊú∫ÁªÑÊàê„ÄÇÈÄöËøáÂÖ±ËØÜÊ®°Âùó‰øùËØÅÂêÑ‰∏™ËäÇÁÇπÊó•ÂøóÁöÑ‰∏ÄËá¥ÊÄßÔºåÁÑ∂ÂêéÂêÑ‰∏™ËäÇÁÇπÂü∫‰∫éÂêåÊ†∑ÁöÑÊó•Âøó„ÄÅÈ°∫Â∫èÊâßË°åÊåá‰ª§ÔºåÊúÄÁªàÂêÑ‰∏™Â§çÂà∂Áä∂ÊÄÅÊú∫ÁöÑÁªìÊûúÂÆûÁé∞‰∏ÄËá¥„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/raft%e5%85%b1%e8%af%86%e7%ae%97%e6%b3%95.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>ÂÖ±ËØÜÁÆóÊ≥ïÁöÑÁ•ñÂ∏àÁà∑ÊòØ PaxosÔºå ‰ΩÜÊòØÁî±‰∫éÂÆÉËøá‰∫éÂ§çÊùÇÔºåÈöæ‰∫éÁêÜËß£ÔºåÂ∑•Á®ãÂÆûË∑µ‰∏ä‰πüËæÉÈöæËêΩÂú∞ÔºåÂØºËá¥Âú®Â∑•Á®ãÁïåËêΩÂú∞ËæÉÊÖ¢„ÄÇstandford Â§ßÂ≠¶ÁöÑ Diego ÊèêÂá∫ÁöÑ Raft ÁÆóÊ≥ïÊ≠£ÊòØ‰∏∫‰∫ÜÂèØÁêÜËß£ÊÄß„ÄÅÊòìÂÆûÁé∞ËÄåËØûÁîüÁöÑÔºåÂÆÉÈÄöËøáÈóÆÈ¢òÂàÜËß£ÔºåÂ∞ÜÂ§çÊùÇÁöÑÂÖ±ËØÜÈóÆÈ¢òÊãÜÂàÜÊàê‰∏â‰∏™Â≠êÈóÆÈ¢òÔºåÂàÜÂà´ÊòØÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Leader ÈÄâ‰∏æÔºåLeader ÊïÖÈöúÂêéÈõÜÁæ§ËÉΩÂø´ÈÄüÈÄâÂá∫Êñ∞ LeaderÔºõ
</span></span><span class="line"><span class="cl">Êó•ÂøóÂ§çÂà∂Ôºå ÈõÜÁæ§Âè™Êúâ Leader ËÉΩÂÜôÂÖ•Êó•ÂøóÔºå Leader Ë¥üË¥£Â§çÂà∂Êó•ÂøóÂà∞ Follower ËäÇÁÇπÔºåÂπ∂Âº∫Âà∂ Follower ËäÇÁÇπ‰∏éËá™Â∑±‰øùÊåÅÁõ∏ÂêåÔºõ
</span></span><span class="line"><span class="cl">ÂÆâÂÖ®ÊÄßÔºå‰∏Ä‰∏™‰ªªÊúüÂÜÖÈõÜÁæ§Âè™ËÉΩ‰∫ßÁîü‰∏Ä‰∏™ Leader„ÄÅÂ∑≤Êèê‰∫§ÁöÑÊó•ÂøóÊù°ÁõÆÂú®ÂèëÁîü Leader ÈÄâ‰∏æÊó∂Ôºå‰∏ÄÂÆö‰ºöÂ≠òÂú®Êõ¥È´ò‰ªªÊúüÁöÑÊñ∞ Leader Êó•Âøó‰∏≠„ÄÅÂêÑ‰∏™ËäÇÁÇπÁöÑÁä∂ÊÄÅÊú∫Â∫îÁî®ÁöÑ‰ªªÊÑè‰ΩçÁΩÆÁöÑÊó•ÂøóÊù°ÁõÆÂÜÖÂÆπÂ∫î‰∏ÄÊ†∑Á≠â„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰∏ãÈù¢Êàë‰ª•ÂÆûÈôÖÂú∫ÊôØ‰∏∫Ê°à‰æãÔºåÂàÜÂà´Âíå‰Ω†Ê∑±ÂÖ•ËÆ®ËÆ∫Ëøô‰∏â‰∏™Â≠êÈóÆÈ¢òÔºåÁúãÁúã Raft ÊòØÂ¶Ç‰ΩïËß£ÂÜ≥Ëøô‰∏â‰∏™ÈóÆÈ¢òÔºå‰ª•ÂèäÂú® etcd ‰∏≠ÁöÑÂ∫îÁî®ÂÆûÁé∞„ÄÇ</p>
<p>Leader ÈÄâ‰∏æÂΩì etcd server Êî∂Âà∞ client ÂèëËµ∑ÁöÑ put hello ÂÜôËØ∑Ê±ÇÂêéÔºåKV Ê®°Âùó‰ºöÂêë Raft Ê®°ÂùóÊèê‰∫§‰∏Ä‰∏™ put ÊèêÊ°àÔºåÊàë‰ª¨Áü•ÈÅìÂè™ÊúâÈõÜÁæ§ Leader ÊâçËÉΩÂ§ÑÁêÜÂÜôÊèêÊ°àÔºåÂ¶ÇÊûúÊ≠§Êó∂ÈõÜÁæ§‰∏≠Êó† LeaderÔºå Êï¥‰∏™ËØ∑Ê±ÇÂ∞±‰ºöË∂ÖÊó∂„ÄÇ</p>
<p>ÈÇ£‰πà Leader ÊòØÊÄé‰πàËØûÁîüÁöÑÂë¢ÔºüLeader crash ‰πãÂêéÂÖ∂‰ªñËäÇÁÇπÂ¶Ç‰ΩïÁ´ûÈÄâÂë¢Ôºü</p>
<p>È¶ñÂÖàÂú® Raft ÂçèËÆÆ‰∏≠ÂÆÉÂÆö‰πâ‰∫ÜÈõÜÁæ§‰∏≠ÁöÑÂ¶Ç‰∏ãËäÇÁÇπÁä∂ÊÄÅÔºå‰ªª‰ΩïÊó∂ÂàªÔºåÊØè‰∏™ËäÇÁÇπËÇØÂÆöÂ§Ñ‰∫éÂÖ∂‰∏≠‰∏Ä‰∏™Áä∂ÊÄÅÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">FollowerÔºåË∑üÈöèËÄÖÔºå ÂêåÊ≠•‰ªé Leader Êî∂Âà∞ÁöÑÊó•ÂøóÔºåetcd ÂêØÂä®ÁöÑÊó∂ÂÄôÈªòËÆ§‰∏∫Ê≠§Áä∂ÊÄÅÔºõ
</span></span><span class="line"><span class="cl">CandidateÔºåÁ´ûÈÄâËÄÖÔºåÂèØ‰ª•ÂèëËµ∑ Leader ÈÄâ‰∏æÔºõ
</span></span><span class="line"><span class="cl">LeaderÔºåÈõÜÁæ§È¢ÜÂØºËÄÖÔºå ÂîØ‰∏ÄÊÄßÔºåÊã•ÊúâÂêåÊ≠•Êó•ÂøóÁöÑÁâπÊùÉÔºåÈúÄÂÆöÊó∂ÂπøÊí≠ÂøÉË∑≥Áªô Follower ËäÇÁÇπÔºå‰ª•Áª¥ÊåÅÈ¢ÜÂØºËÄÖË∫´‰ªΩ„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/leader%e7%9a%84%e9%80%89%e4%b8%be.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>‰∏äÂõæÊòØËäÇÁÇπÁä∂ÊÄÅÂèòÂåñÂÖ≥Á≥ªÂõæÔºåÂΩì Follower ËäÇÁÇπÊé•Êî∂ Leader ËäÇÁÇπÂøÉË∑≥Ê∂àÊÅØË∂ÖÊó∂ÂêéÔºåÂÆÉ‰ºöËΩ¨ÂèòÊàê Candidate ËäÇÁÇπÔºåÂπ∂ÂèØÂèëËµ∑Á´ûÈÄâ Leader ÊäïÁ•®ÔºåËã•Ëé∑ÂæóÈõÜÁæ§Â§öÊï∞ËäÇÁÇπÁöÑÊîØÊåÅÂêéÔºåÂÆÉÂ∞±ÂèØËΩ¨ÂèòÊàê Leader ËäÇÁÇπ„ÄÇ</p>
<p>‰∏ãÈù¢Êàë‰ª• Leader crash Âú∫ÊôØ‰∏∫Ê°à‰æãÔºåÁªô‰Ω†ËØ¶ÁªÜ‰ªãÁªç‰∏Ä‰∏ã etcd Leader ÈÄâ‰∏æÂéüÁêÜ„ÄÇ</p>
<p>ÂÅáËÆæÈõÜÁæ§ÊÄªÂÖ± 3 ‰∏™ËäÇÁÇπÔºåA ËäÇÁÇπ‰∏∫ LeaderÔºåB„ÄÅC ËäÇÁÇπ‰∏∫ Follower„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/leader-crash%e5%90%8e%e7%9a%84%e9%80%89%e4%b8%be.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>Â¶Ç‰∏ä Leader ÈÄâ‰∏æÂõæÂ∑¶ËæπÈÉ®ÂàÜÊâÄÁ§∫Ôºå Ê≠£Â∏∏ÊÉÖÂÜµ‰∏ãÔºåLeader ËäÇÁÇπ‰ºöÊåâÁÖßÂøÉË∑≥Èó¥ÈöîÊó∂Èó¥ÔºåÂÆöÊó∂ÂπøÊí≠ÂøÉË∑≥Ê∂àÊÅØÔºàMsgHeartbeat Ê∂àÊÅØÔºâÁªô Follower ËäÇÁÇπÔºå‰ª•Áª¥ÊåÅ Leader Ë∫´‰ªΩ„ÄÇ Follower Êî∂Âà∞ÂêéÂõûÂ§çÂøÉË∑≥Â∫îÁ≠îÂåÖÊ∂àÊÅØÔºàMsgHeartbeatResp Ê∂àÊÅØÔºâÁªô Leader„ÄÇ</p>
<p>ÁªÜÂøÉÁöÑ‰Ω†ÂèØËÉΩÊ≥®ÊÑèÂà∞‰∏äÂõæ‰∏≠ÁöÑ Leader ËäÇÁÇπ‰∏ãÊñπÊúâ‰∏Ä‰∏™‰ªªÊúüÂè∑ÔºàtermÔºâÔºå ÂÆÉÂÖ∑Êúâ‰ªÄ‰πàÊ†∑ÁöÑ‰ΩúÁî®Âë¢Ôºü</p>
<p>ËøôÊòØÂõ†‰∏∫ Raft Â∞ÜÊó∂Èó¥ÂàíÂàÜÊàê‰∏Ä‰∏™‰∏™‰ªªÊúüÔºå‰ªªÊúüÁî®ËøûÁª≠ÁöÑÊï¥Êï∞Ë°®Á§∫ÔºåÊØè‰∏™‰ªªÊúü‰ªé‰∏ÄÊ¨°ÈÄâ‰∏æÂºÄÂßãÔºåËµ¢ÂæóÈÄâ‰∏æÁöÑËäÇÁÇπÂú®ËØ•‰ªªÊúüÂÜÖÂÖÖÂΩì Leader ÁöÑËÅåË¥£ÔºåÈöèÁùÄÊó∂Èó¥ÁöÑÊ∂àÈÄùÔºåÈõÜÁæ§ÂèØËÉΩ‰ºöÂèëÁîüÊñ∞ÁöÑÈÄâ‰∏æÔºå‰ªªÊúüÂè∑‰πü‰ºöÂçïË∞ÉÈÄíÂ¢û„ÄÇ</p>
<p>ÈÄöËøá‰ªªÊúüÂè∑ÔºåÂèØ‰ª•ÊØîËæÉÂêÑ‰∏™ËäÇÁÇπÁöÑÊï∞ÊçÆÊñ∞Êóß„ÄÅËØÜÂà´ËøáÊúüÁöÑ Leader Á≠âÔºåÂÆÉÂú® Raft ÁÆóÊ≥ï‰∏≠ÂÖÖÂΩìÈÄªËæëÊó∂ÈíüÔºåÂèëÊå•ÁùÄÈáçË¶Å‰ΩúÁî®„ÄÇ</p>
<p>‰∫ÜËß£ÂÆåÊ≠£Â∏∏ÊÉÖÂÜµ‰∏ã Leader Áª¥ÊåÅË∫´‰ªΩÁöÑÂéüÁêÜÂêéÔºåÊàë‰ª¨ÂÜçÁúãÂºÇÂ∏∏ÊÉÖÂÜµ‰∏ãÔºå‰πüÂ∞± Leader crash ÂêéÔºåetcd ÊòØÂ¶Ç‰ΩïËá™ÊÑàÁöÑÂë¢Ôºü</p>
<p>Â¶Ç‰∏ä Leader ÈÄâ‰∏æÂõæÂè≥ËæπÈÉ®ÂàÜÊâÄÁ§∫ÔºåÂΩì Leader ËäÇÁÇπÂºÇÂ∏∏ÂêéÔºåFollower ËäÇÁÇπ‰ºöÊé•Êî∂ Leader ÁöÑÂøÉË∑≥Ê∂àÊÅØË∂ÖÊó∂ÔºåÂΩìË∂ÖÊó∂Êó∂Èó¥Â§ß‰∫éÁ´ûÈÄâË∂ÖÊó∂Êó∂Èó¥ÂêéËøôÈáåË¶ÅÊèêÈÜí‰∏ã‰Ω†Ôºåetcd ÈªòËÆ§ÂøÉË∑≥Èó¥ÈöîÊó∂Èó¥Ôºàheartbeat-intervalÔºâÊòØ 100msÔºå ÈªòËÆ§Á´ûÈÄâË∂ÖÊó∂Êó∂Èó¥Ôºàelection timeoutÔºâÊòØ 1000msÔºå ‰Ω†ÈúÄË¶ÅÊ†πÊçÆÂÆûÈôÖÈÉ®ÁΩ≤ÁéØÂ¢É„ÄÅ‰∏öÂä°Âú∫ÊôØÈÄÇÂΩìË∞É‰ºòÔºåÂê¶ÂàôÂ∞±ÂæàÂèØËÉΩ‰ºöÈ¢ëÁπÅÂèëÁîü Leader ÈÄâ‰∏æÂàáÊç¢ÔºåÂØºËá¥ÊúçÂä°Á®≥ÂÆöÊÄß‰∏ãÈôçÔºåÂêéÈù¢Êàë‰ª¨ÂÆûË∑µÁØá‰ºöÂÜçËØ¶ÁªÜ‰ªãÁªç„ÄÇ</p>
<p>ÂÆÉ‰ª¨‰ºöËøõÂÖ• Candidate Áä∂ÊÄÅ„ÄÇ</p>
<p>ËøõÂÖ• Candidate Áä∂ÊÄÅÁöÑËäÇÁÇπÔºå‰ºöÁ´ãÂç≥ÂèëËµ∑ÈÄâ‰∏æÊµÅÁ®ãÔºåËá™Â¢û‰ªªÊúüÂè∑ÔºåÊäïÁ•®ÁªôËá™Â∑±ÔºåÂπ∂ÂêëÂÖ∂‰ªñËäÇÁÇπÂèëÈÄÅÁ´ûÈÄâ Leader ÊäïÁ•®Ê∂àÊÅØÔºàMsgVoteÔºâ„ÄÇ</p>
<p>C ËäÇÁÇπÊî∂Âà∞ Follower B ËäÇÁÇπÁ´ûÈÄâ Leader Ê∂àÊÅØÂêéÔºåËøôÊó∂ÂÄôÂèØËÉΩ‰ºöÂá∫Áé∞Â¶Ç‰∏ã‰∏§ÁßçÊÉÖÂÜµÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Á¨¨‰∏ÄÁßçÊÉÖÂÜµÊòØ C ËäÇÁÇπÂà§Êñ≠ B ËäÇÁÇπÁöÑÊï∞ÊçÆËá≥Â∞ëÂíåËá™Â∑±‰∏ÄÊ†∑Êñ∞„ÄÅB ËäÇÁÇπ‰ªªÊúüÂè∑Â§ß‰∫é C ÂΩìÂâç‰ªªÊúüÂè∑„ÄÅÂπ∂‰∏î C Êú™ÊäïÁ•®ÁªôÂÖ∂‰ªñÂÄôÈÄâËÄÖÔºåÂ∞±ÂèØÊäïÁ•®Áªô B„ÄÇËøôÊó∂ B ËäÇÁÇπËé∑Âæó‰∫ÜÈõÜÁæ§Â§öÊï∞ËäÇÁÇπÊîØÊåÅÔºå‰∫éÊòØÊàê‰∏∫‰∫ÜÊñ∞ÁöÑ Leader„ÄÇ
</span></span><span class="line"><span class="cl">Á¨¨‰∫åÁßçÊÉÖÂÜµÊòØÔºåÊÅ∞Â•Ω C ‰πüÂøÉË∑≥Ë∂ÖÊó∂Ë∂ÖËøáÁ´ûÈÄâÊó∂Èó¥‰∫ÜÔºåÂÆÉ‰πüÂèëËµ∑‰∫ÜÈÄâ‰∏æÔºåÂπ∂ÊäïÁ•®Áªô‰∫ÜËá™Â∑±ÔºåÈÇ£‰πàÂÆÉÂ∞ÜÊãíÁªùÊäïÁ•®Áªô BÔºåËøôÊó∂Ë∞Å‰πüÊó†Ê≥ïËé∑ÂèñÈõÜÁæ§Â§öÊï∞Ê¥æÊîØÊåÅÔºåÂè™ËÉΩÁ≠âÂæÖÁ´ûÈÄâË∂ÖÊó∂ÔºåÂºÄÂêØÊñ∞‰∏ÄËΩÆÈÄâ‰∏æ„ÄÇRaft ‰∏∫‰∫Ü‰ºòÂåñÈÄâÁ•®Ë¢´ÁìúÂàÜÂØºËá¥ÈÄâ‰∏æÂ§±Ë¥•ÁöÑÈóÆÈ¢òÔºåÂºïÂÖ•‰∫ÜÈöèÊú∫Êï∞ÔºåÊØè‰∏™ËäÇÁÇπÁ≠âÂæÖÂèëËµ∑ÈÄâ‰∏æÁöÑÊó∂Èó¥ÁÇπ‰∏ç‰∏ÄËá¥Ôºå‰ºòÈõÖÁöÑËß£ÂÜ≥‰∫ÜÊΩúÂú®ÁöÑÁ´ûÈÄâÊ¥ªÈîÅÔºåÂêåÊó∂Êòì‰∫éÁêÜËß£„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><p>Leader ÈÄâÂá∫Êù•ÂêéÔºåÂÆÉ‰ªÄ‰πàÊó∂ÂÄôÂèà‰ºöÂèòÊàê Follower Áä∂ÊÄÅÂë¢Ôºü ‰ªé‰∏äÈù¢ÁöÑÁä∂ÊÄÅËΩ¨Êç¢ÂÖ≥Á≥ªÂõæ‰∏≠‰Ω†ÂèØ‰ª•ÁúãÂà∞ÔºåÂ¶ÇÊûúÁé∞Êúâ Leader ÂèëÁé∞‰∫ÜÊñ∞ÁöÑ Leader ‰ªªÊúüÂè∑ÔºåÈÇ£‰πàÂÆÉÂ∞±ÈúÄË¶ÅËΩ¨Êç¢Âà∞ Follower ËäÇÁÇπ„ÄÇA ËäÇÁÇπ crash ÂêéÔºåÂÜçÊ¨°ÂêØÂä®Êàê‰∏∫ FollowerÔºåÂÅáËÆæÂõ†‰∏∫ÁΩëÁªúÈóÆÈ¢òÊó†Ê≥ïËøûÈÄö B„ÄÅC ËäÇÁÇπÔºåËøôÊó∂ÂÄôÊ†πÊçÆÁä∂ÊÄÅÂõæÔºåÊàë‰ª¨Áü•ÈÅìÂÆÉÂ∞Ü‰∏çÂÅúËá™Â¢û‰ªªÊúüÂè∑ÔºåÂèëËµ∑ÈÄâ‰∏æ„ÄÇÁ≠â A ËäÇÁÇπÁΩëÁªúÂºÇÂ∏∏ÊÅ¢Â§çÂêéÔºåÈÇ£‰πàÁé∞Êúâ Leader Êî∂Âà∞‰∫ÜÊñ∞ÁöÑ‰ªªÊúüÂè∑ÔºåÂ∞±‰ºöËß¶ÂèëÊñ∞‰∏ÄËΩÆ Leader ÈÄâ‰∏æÔºåÂΩ±ÂìçÊúçÂä°ÁöÑÂèØÁî®ÊÄß„ÄÇ</p>
<p>ÁÑ∂ËÄå A ËäÇÁÇπÁöÑÊï∞ÊçÆÊòØËøúËøúËêΩÂêé B„ÄÅC ÁöÑÔºåÊòØÊó†Ê≥ïËé∑ÂæóÈõÜÁæ§ Leader Âú∞‰ΩçÁöÑÔºåÂèëËµ∑ÁöÑÈÄâ‰∏æÊó†Êïà‰∏îÂØπÈõÜÁæ§Á®≥ÂÆöÊÄßÊúâ‰º§ÂÆ≥„ÄÇ</p>
<p>ÈÇ£Â¶Ç‰ΩïÈÅøÂÖç‰ª•‰∏äÂú∫ÊôØ‰∏≠ÁöÑÊó†ÊïàÁöÑÈÄâ‰∏æÂë¢Ôºü</p>
<p>Âú® etcd 3.4 ‰∏≠Ôºåetcd ÂºïÂÖ•‰∫Ü‰∏Ä‰∏™ PreVote ÂèÇÊï∞ÔºàÈªòËÆ§ falseÔºâÔºåÂèØ‰ª•Áî®Êù•ÂêØÁî® PreCandidate Áä∂ÊÄÅËß£ÂÜ≥Ê≠§ÈóÆÈ¢òÔºåÂ¶Ç‰∏ãÂõæÊâÄÁ§∫„ÄÇFollower Âú®ËΩ¨Êç¢Êàê Candidate Áä∂ÊÄÅÂâçÔºåÂÖàËøõÂÖ• PreCandidate Áä∂ÊÄÅÔºå‰∏çËá™Â¢û‰ªªÊúüÂè∑Ôºå ÂèëËµ∑È¢ÑÊäïÁ•®„ÄÇËã•Ëé∑ÂæóÈõÜÁæ§Â§öÊï∞ËäÇÁÇπËÆ§ÂèØÔºåÁ°ÆÂÆöÊúâÊ¶ÇÁéáÊàê‰∏∫ Leader ÊâçËÉΩËøõÂÖ• Candidate Áä∂ÊÄÅÔºåÂèëËµ∑ÈÄâ‰∏æÊµÅÁ®ã„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/leader%e9%81%bf%e5%85%8d%e5%ae%95%e6%9c%ba%e5%a4%aa%e4%b9%85%e7%9a%84%e8%8a%82%e7%82%b9%e9%80%89%e5%8f%96leader.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>Âõ† A ËäÇÁÇπÊï∞ÊçÆËêΩÂêéËæÉÂ§öÔºåÈ¢ÑÊäïÁ•®ËØ∑Ê±ÇÊó†Ê≥ïËé∑ÂæóÂ§öÊï∞ËäÇÁÇπËÆ§ÂèØÔºåÂõ†Ê≠§ÂÆÉÂ∞±‰∏ç‰ºöËøõÂÖ• Candidate Áä∂ÊÄÅÔºåÂØºËá¥ÈõÜÁæ§ÈáçÊñ∞ÈÄâ‰∏æ„ÄÇ</p>
<p>ËøôÂ∞±ÊòØ Raft Leader ÈÄâ‰∏æÊ†∏ÂøÉÂéüÁêÜÔºå‰ΩøÁî®ÂøÉË∑≥Êú∫Âà∂Áª¥ÊåÅ Leader Ë∫´‰ªΩ„ÄÅËß¶Âèë Leader ÈÄâ‰∏æÔºåetcd Âü∫‰∫éÂÆÉÂÆûÁé∞‰∫ÜÈ´òÂèØÁî®ÔºåÂè™Ë¶ÅÈõÜÁæ§‰∏ÄÂçä‰ª•‰∏äËäÇÁÇπÂ≠òÊ¥ª„ÄÅÂèØÁõ∏‰∫íÈÄö‰ø°ÔºåLeader ÂÆïÊú∫ÂêéÔºåÂ∞±ËÉΩÂø´ÈÄüÈÄâ‰∏æÂá∫Êñ∞ÁöÑ LeaderÔºåÁªßÁª≠ÂØπÂ§ñÊèê‰æõÊúçÂä°„ÄÇ</p>
<p>Êó•ÂøóÂ§çÂà∂</p>
<p>ÂÅáËÆæÂú®‰∏äÈù¢ÁöÑ Leader ÈÄâ‰∏æÊµÅÁ®ã‰∏≠ÔºåB Êàê‰∏∫‰∫ÜÊñ∞ÁöÑ LeaderÔºåÂÆÉÊî∂Âà∞ put ÊèêÊ°àÂêéÔºåÂÆÉÊòØÂ¶Ç‰ΩïÂ∞ÜÊó•ÂøóÂêåÊ≠•Áªô Follower ËäÇÁÇπÁöÑÂë¢Ôºü ‰ªÄ‰πàÊó∂ÂÄôÂÆÉÂèØ‰ª•Á°ÆÂÆö‰∏Ä‰∏™Êó•ÂøóÊù°ÁõÆ‰∏∫Â∑≤Êèê‰∫§ÔºåÈÄöÁü• etcdserver Ê®°ÂùóÂ∫îÁî®Êó•ÂøóÊù°ÁõÆÊåá‰ª§Âà∞Áä∂ÊÄÅÊú∫Âë¢Ôºü</p>
<p>ËøôÂ∞±Ê∂âÂèäÂà∞ Raft Êó•ÂøóÂ§çÂà∂ÂéüÁêÜÔºå‰∏∫‰∫ÜÂ∏ÆÂä©‰Ω†ÁêÜËß£Êó•ÂøóÂ§çÂà∂ÁöÑÂéüÁêÜÔºå‰∏ãÈù¢ÊàëÁªô‰Ω†Áîª‰∫Ü‰∏ÄÂπÖ Leader Êî∂Âà∞ put ËØ∑Ê±ÇÂêéÔºåÂêë Follower ËäÇÁÇπÂ§çÂà∂Êó•ÂøóÁöÑÊï¥‰ΩìÊµÅÁ®ãÂõæÔºåÁÆÄÁß∞ÊµÅÁ®ãÂõæÔºåÂú®Âõæ‰∏≠ÊàëÁî®Â∫èÂè∑Áªô‰Ω†Ê†áËØÜ‰∫ÜÊ†∏ÂøÉÊµÅÁ®ã„ÄÇ</p>
<p>ÊàëÂ∞ÜÁªìÂêàÊµÅÁ®ãÂõæ„ÄÅÂêéÈù¢ÁöÑ Raft ÁöÑÊó•ÂøóÂõæÂíå‰Ω†ÁÆÄË¶ÅÂàÜÊûê Leader B Êî∂Âà∞ put hello ‰∏∫ world ÁöÑËØ∑Ê±ÇÂêéÔºåÊòØÂ¶Ç‰ΩïÂ∞ÜÊ≠§ËØ∑Ê±ÇÂêåÊ≠•ÁªôÂÖ∂‰ªñ Follower ËäÇÁÇπÁöÑ„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/leader%e5%a4%8d%e5%88%b6%e6%97%a5%e5%bf%97%e5%88%b0follwer%e6%b5%81%e7%a8%8b%e5%9b%be.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>È¶ñÂÖà Leader Êî∂Âà∞ client ÁöÑËØ∑Ê±ÇÂêéÔºåetcdserver ÁöÑ KV Ê®°Âùó‰ºöÂêë Raft Ê®°ÂùóÊèê‰∫§‰∏Ä‰∏™ put hello ‰∏∫ world ÊèêÊ°àÊ∂àÊÅØÔºàÊµÅÁ®ãÂõæ‰∏≠ÁöÑÂ∫èÂè∑ 2 ÊµÅÁ®ãÔºâÔºå ÂÆÉÁöÑÊ∂àÊÅØÁ±ªÂûãÊòØ MsgProp„ÄÇ</p>
<p>Leader ÁöÑ Raft Ê®°ÂùóËé∑ÂèñÂà∞ MsgProp ÊèêÊ°àÊ∂àÊÅØÂêéÔºå‰∏∫Ê≠§ÊèêÊ°àÁîüÊàê‰∏Ä‰∏™Êó•ÂøóÊù°ÁõÆÔºåËøΩÂä†Âà∞Êú™ÊåÅ‰πÖÂåñ„ÄÅ‰∏çÁ®≥ÂÆöÁöÑ Raft Êó•Âøó‰∏≠ÔºåÈöèÂêé‰ºöÈÅçÂéÜÈõÜÁæ§ Follower ÂàóË°®ÂíåËøõÂ∫¶‰ø°ÊÅØÔºå‰∏∫ÊØè‰∏™ Follower ÁîüÊàêËøΩÂä†ÔºàMsgAppÔºâÁ±ªÂûãÁöÑ RPC Ê∂àÊÅØÔºåÊ≠§Ê∂àÊÅØ‰∏≠ÂåÖÂê´ÂæÖÂ§çÂà∂Áªô Follower ÁöÑÊó•ÂøóÊù°ÁõÆ„ÄÇ</p>
<p>ËøôÈáåÂ∞±Âá∫Áé∞‰∏§‰∏™ÁñëÈóÆ‰∫Ü„ÄÇÁ¨¨‰∏ÄÔºåLeader ÊòØÂ¶Ç‰ΩïÁü•ÈÅì‰ªéÂì™‰∏™Á¥¢Âºï‰ΩçÁΩÆÂèëÈÄÅÊó•ÂøóÊù°ÁõÆÁªô FollowerÔºå‰ª•Âèä Follower Â∑≤Â§çÂà∂ÁöÑÊó•ÂøóÊúÄÂ§ßÁ¥¢ÂºïÊòØÂ§öÂ∞ëÂë¢ÔºüÁ¨¨‰∫åÔºåÊó•ÂøóÊù°ÁõÆ‰ªÄ‰πàÊó∂ÂÄôÊâç‰ºöËøΩÂä†Âà∞Á®≥ÂÆöÁöÑ Raft Êó•Âøó‰∏≠Âë¢ÔºüRaft Ê®°ÂùóË¥üË¥£ÊåÅ‰πÖÂåñÂêóÔºü</p>
<p>È¶ñÂÖàÊàëÊù•Áªô‰Ω†‰ªãÁªç‰∏ã‰ªÄ‰πàÊòØ Raft Êó•Âøó„ÄÇ‰∏ãÂõæÊòØ Raft Êó•ÂøóÂ§çÂà∂ËøáÁ®ã‰∏≠ÁöÑÊó•ÂøóÁªÜËäÇÂõæÔºåÁÆÄÁß∞Êó•ÂøóÂõæ 1„ÄÇÂú®Êó•ÂøóÂõæ‰∏≠ÔºåÊúÄ‰∏äÊñπÁöÑÊòØÊó•ÂøóÊù°ÁõÆÂ∫èÂè∑ / Á¥¢ÂºïÔºåÊó•ÂøóÁî±ÊúâÂ∫èÂè∑Ê†áËØÜÁöÑ‰∏Ä‰∏™‰∏™Êù°ÁõÆÁªÑÊàêÔºåÊØè‰∏™Êó•ÂøóÊù°ÁõÆÂÜÖÂÆπ‰øùÂ≠ò‰∫Ü Leader ‰ªªÊúüÂè∑ÂíåÊèêÊ°àÂÜÖÂÆπ„ÄÇÊúÄÂºÄÂßãÁöÑÊó∂ÂÄôÔºåA ËäÇÁÇπÊòØ LeaderÔºå‰ªªÊúüÂè∑‰∏∫ 1ÔºåA ËäÇÁÇπ crash ÂêéÔºåB ËäÇÁÇπÈÄöËøáÈÄâ‰∏æÊàê‰∏∫Êñ∞ÁöÑ LeaderÔºå ‰ªªÊúüÂè∑‰∏∫ 2„ÄÇ</p>
<p>Êó•ÂøóÂõæ 1 ÊèèËø∞ÁöÑÊòØ hello Êó•ÂøóÊù°ÁõÆÊú™Êèê‰∫§ÂâçÁöÑÂêÑËäÇÁÇπ Raft Êó•ÂøóÁä∂ÊÄÅ„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/raft%e6%97%a5%e5%bf%97%e5%9b%be.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>Êàë‰ª¨Áé∞Âú®Â∞±ÂèØ‰ª•Êù•ÂõûÁ≠îÁ¨¨‰∏Ä‰∏™ÁñëÈóÆ‰∫Ü„ÄÇLeader ‰ºöÁª¥Êä§‰∏§‰∏™Ê†∏ÂøÉÂ≠óÊÆµÊù•ËøΩË∏™ÂêÑ‰∏™ Follower ÁöÑËøõÂ∫¶‰ø°ÊÅØÔºå‰∏Ä‰∏™Â≠óÊÆµÊòØ NextIndexÔºå ÂÆÉË°®Á§∫ Leader ÂèëÈÄÅÁªô Follower ËäÇÁÇπÁöÑ‰∏ã‰∏Ä‰∏™Êó•ÂøóÊù°ÁõÆÁ¥¢Âºï„ÄÇ‰∏Ä‰∏™Â≠óÊÆµÊòØ MatchIndexÔºå ÂÆÉË°®Á§∫ Follower ËäÇÁÇπÂ∑≤Â§çÂà∂ÁöÑÊúÄÂ§ßÊó•ÂøóÊù°ÁõÆÁöÑÁ¥¢ÂºïÔºåÊØîÂ¶Ç‰∏äÈù¢ÁöÑÊó•ÂøóÂõæ 1 ‰∏≠ C ËäÇÁÇπÁöÑÂ∑≤Â§çÂà∂ÊúÄÂ§ßÊó•ÂøóÊù°ÁõÆÁ¥¢Âºï‰∏∫ 5ÔºåA ËäÇÁÇπ‰∏∫ 4„ÄÇ</p>
<p>Êàë‰ª¨ÂÜçÁúãÁ¨¨‰∫å‰∏™ÁñëÈóÆ„ÄÇetcd Raft Ê®°ÂùóËÆæËÆ°ÂÆûÁé∞‰∏äÊäΩË±°‰∫ÜÁΩëÁªú„ÄÅÂ≠òÂÇ®„ÄÅÊó•ÂøóÁ≠âÊ®°ÂùóÔºåÂÆÉÊú¨Ë∫´Âπ∂‰∏ç‰ºöËøõË°åÁΩëÁªú„ÄÅÂ≠òÂÇ®Áõ∏ÂÖ≥ÁöÑÊìç‰ΩúÔºå‰∏äÂ±ÇÂ∫îÁî®ÈúÄÁªìÂêàËá™Â∑±‰∏öÂä°Âú∫ÊôØÈÄâÊã©ÂÜÖÁΩÆÁöÑÊ®°ÂùóÊàñËá™ÂÆö‰πâÂÆûÁé∞ÁΩëÁªú„ÄÅÂ≠òÂÇ®„ÄÅÊó•ÂøóÁ≠âÊ®°Âùó„ÄÇ</p>
<p>‰∏äÂ±ÇÂ∫îÁî®ÈÄöËøá Raft Ê®°ÂùóÁöÑËæìÂá∫Êé•Âè£ÔºàÂ¶Ç Ready ÁªìÊûÑÔºâÔºåËé∑ÂèñÂà∞ÂæÖÊåÅ‰πÖÂåñÁöÑÊó•ÂøóÊù°ÁõÆÂíåÂæÖÂèëÈÄÅÁªô Peer ËäÇÁÇπÁöÑÊ∂àÊÅØÂêéÔºàÂ¶Ç‰∏äÈù¢ÁöÑ MsgApp Êó•ÂøóÊ∂àÊÅØÔºâÔºåÈúÄÊåÅ‰πÖÂåñÊó•ÂøóÊù°ÁõÆÂà∞Ëá™ÂÆö‰πâÁöÑ WAL Ê®°ÂùóÔºåÈÄöËøáËá™ÂÆö‰πâÁöÑÁΩëÁªúÊ®°ÂùóÂ∞ÜÊ∂àÊÅØÂèëÈÄÅÁªô Peer ËäÇÁÇπ„ÄÇ</p>
<p>Êó•ÂøóÊù°ÁõÆÊåÅ‰πÖÂåñÂà∞Á®≥ÂÆöÂ≠òÂÇ®‰∏≠ÂêéÔºåËøôÊó∂ÂÄô‰Ω†Â∞±ÂèØ‰ª•Â∞ÜÊó•ÂøóÊù°ÁõÆËøΩÂä†Âà∞Á®≥ÂÆöÁöÑ Raft Êó•Âøó‰∏≠„ÄÇÂç≥‰æøËøô‰∏™Êó•ÂøóÊòØÂÜÖÂ≠òÂ≠òÂÇ®ÔºåËäÇÁÇπÈáçÂêØÊó∂‰πü‰∏ç‰ºö‰∏¢Â§±‰ªª‰ΩïÊó•ÂøóÊù°ÁõÆÔºåÂõ†‰∏∫ WAL Ê®°ÂùóÂ∑≤ÊåÅ‰πÖÂåñÊ≠§Êó•ÂøóÊù°ÁõÆÔºåÂèØÈÄöËøáÂÆÉÈáçÂª∫ Raft Êó•Âøó„ÄÇ</p>
<p>etcd Raft Ê®°ÂùóÊèê‰æõ‰∫Ü‰∏Ä‰∏™ÂÜÖÁΩÆÁöÑÂÜÖÂ≠òÂ≠òÂÇ®ÔºàMemoryStorageÔºâÊ®°ÂùóÂÆûÁé∞Ôºåetcd ‰ΩøÁî®ÁöÑÂ∞±ÊòØÂÆÉÔºåRaft Êó•ÂøóÊù°ÁõÆ‰øùÂ≠òÂú®ÂÜÖÂ≠ò‰∏≠„ÄÇÁΩëÁªúÊ®°ÂùóÂπ∂Êú™Êèê‰æõÂÜÖÁΩÆÁöÑÂÆûÁé∞Ôºåetcd Âü∫‰∫é HTTP ÂçèËÆÆÂÆûÁé∞‰∫Ü peer ËäÇÁÇπÈó¥ÁöÑÁΩëÁªúÈÄö‰ø°ÔºåÂπ∂Ê†πÊçÆÊ∂àÊÅØÁ±ªÂûãÔºåÊîØÊåÅÈÄâÊã© pipeline„ÄÅstream Á≠âÊ®°ÂºèÂèëÈÄÅÔºåÊòæËëóÊèêÈ´ò‰∫ÜÁΩëÁªúÂêûÂêêÈáè„ÄÅÈôç‰Ωé‰∫ÜÂª∂Êó∂„ÄÇ</p>
<p>Ëß£Á≠îÂÆå‰ª•‰∏ä‰∏§‰∏™ÁñëÈóÆÂêéÔºåÊàë‰ª¨ÁªßÁª≠ÂàÜÊûê etcd ÊòØÂ¶Ç‰Ωï‰∏é Raft Ê®°Âùó‰∫§‰∫íÔºåËé∑ÂèñÂæÖÊåÅ‰πÖÂåñÁöÑÊó•ÂøóÊù°ÁõÆÂíåÂèëÈÄÅÁªô peer ËäÇÁÇπÁöÑÊ∂àÊÅØ„ÄÇ</p>
<p>Ê≠£Â¶ÇÂàöÂàöËÆ≤Âà∞ÁöÑÔºåRaft Ê®°ÂùóËæìÂÖ•ÊòØ Msg Ê∂àÊÅØÔºåËæìÂá∫ÊòØ‰∏Ä‰∏™ Ready ÁªìÊûÑÔºåÂÆÉÂåÖÂê´ÂæÖÊåÅ‰πÖÂåñÁöÑÊó•ÂøóÊù°ÁõÆ„ÄÅÂèëÈÄÅÁªô peer ËäÇÁÇπÁöÑÊ∂àÊÅØ„ÄÅÂ∑≤Êèê‰∫§ÁöÑÊó•ÂøóÊù°ÁõÆÂÜÖÂÆπ„ÄÅÁ∫øÊÄßÊü•ËØ¢ÁªìÊûúÁ≠â Raft ËæìÂá∫Ê†∏ÂøÉ‰ø°ÊÅØ„ÄÇ</p>
<p>etcdserver Ê®°ÂùóÈÄöËøá channel ‰ªé Raft Ê®°ÂùóËé∑ÂèñÂà∞ Ready ÁªìÊûÑÂêéÔºàÊµÅÁ®ãÂõæ‰∏≠ÁöÑÂ∫èÂè∑ 3 ÊµÅÁ®ãÔºâÔºåÂõ† B ËäÇÁÇπÊòØ LeaderÔºåÂÆÉÈ¶ñÂÖà‰ºöÈÄöËøáÂü∫‰∫é HTTP ÂçèËÆÆÁöÑÁΩëÁªúÊ®°ÂùóÂ∞ÜËøΩÂä†Êó•ÂøóÊù°ÁõÆÊ∂àÊÅØÔºàMsgAppÔºâÂπøÊí≠Áªô FollowerÔºåÂπ∂ÂêåÊó∂Â∞ÜÂæÖÊåÅ‰πÖÂåñÁöÑÊó•ÂøóÊù°ÁõÆÊåÅ‰πÖÂåñÂà∞ WAL Êñá‰ª∂‰∏≠ÔºàÊµÅÁ®ãÂõæ‰∏≠ÁöÑÂ∫èÂè∑ 4 ÊµÅÁ®ãÔºâÔºåÊúÄÂêéÂ∞ÜÊó•ÂøóÊù°ÁõÆËøΩÂä†Âà∞Á®≥ÂÆöÁöÑ Raft Êó•ÂøóÂ≠òÂÇ®‰∏≠ÔºàÊµÅÁ®ãÂõæ‰∏≠ÁöÑÂ∫èÂè∑ 5 ÊµÅÁ®ãÔºâ„ÄÇ</p>
<p>ÂêÑ‰∏™ Follower Êî∂Âà∞ËøΩÂä†Êó•ÂøóÊù°ÁõÆÔºàMsgAppÔºâÊ∂àÊÅØÔºåÂπ∂ÈÄöËøáÂÆâÂÖ®Ê£ÄÊü•ÂêéÔºåÂÆÉ‰ºöÊåÅ‰πÖÂåñÊ∂àÊÅØÂà∞ WAL Êó•Âøó‰∏≠ÔºåÂπ∂Â∞ÜÊ∂àÊÅØËøΩÂä†Âà∞ Raft Êó•ÂøóÂ≠òÂÇ®ÔºåÈöèÂêé‰ºöÂêë Leader ÂõûÂ§ç‰∏Ä‰∏™Â∫îÁ≠îËøΩÂä†Êó•ÂøóÊù°ÁõÆÔºàMsgAppRespÔºâÁöÑÊ∂àÊÅØÔºåÂëäÁü• Leader ÂΩìÂâçÂ∑≤Â§çÂà∂ÁöÑÊó•ÂøóÊúÄÂ§ßÁ¥¢ÂºïÔºàÊµÅÁ®ãÂõæ‰∏≠ÁöÑÂ∫èÂè∑ 6 ÊµÅÁ®ãÔºâ„ÄÇ</p>
<p>Leader Êî∂Âà∞Â∫îÁ≠îËøΩÂä†Êó•ÂøóÊù°ÁõÆÔºàMsgAppRespÔºâÊ∂àÊÅØÂêéÔºå‰ºöÂ∞Ü Follower ÂõûÂ§çÁöÑÂ∑≤Â§çÂà∂Êó•ÂøóÊúÄÂ§ßÁ¥¢ÂºïÊõ¥Êñ∞Âà∞Ë∑üË∏™ Follower ËøõÂ±ïÁöÑ Match Index Â≠óÊÆµÔºåÂ¶Ç‰∏ãÈù¢ÁöÑÊó•ÂøóÂõæ 2 ‰∏≠ÁöÑ Follower C MatchIndex ‰∏∫ 6ÔºåFollower A ‰∏∫ 5ÔºåÊó•ÂøóÂõæ 2 ÊèèËø∞ÁöÑÊòØ hello Êó•ÂøóÊù°ÁõÆÊèê‰∫§ÂêéÁöÑÂêÑËäÇÁÇπ Raft Êó•ÂøóÁä∂ÊÄÅ„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/raft%e6%97%a5%e5%bf%97%e5%9b%be2.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>ÊúÄÂêé Leader Ê†πÊçÆ Follower ÁöÑ MatchIndex ‰ø°ÊÅØÔºåËÆ°ÁÆóÂá∫‰∏Ä‰∏™‰ΩçÁΩÆÔºåÂ¶ÇÊûúËøô‰∏™‰ΩçÁΩÆÂ∑≤ÁªèË¢´‰∏ÄÂçä‰ª•‰∏äËäÇÁÇπÊåÅ‰πÖÂåñÔºåÈÇ£‰πàËøô‰∏™‰ΩçÁΩÆ‰πãÂâçÁöÑÊó•ÂøóÊù°ÁõÆÈÉΩÂèØ‰ª•Ë¢´Ê†áËÆ∞‰∏∫Â∑≤Êèê‰∫§„ÄÇ</p>
<p>Âú®Êàë‰ª¨Ëøô‰∏™Ê°à‰æã‰∏≠Êó•ÂøóÂõæ 2 Èáå 6 Âè∑Á¥¢Âºï‰ΩçÁΩÆ‰πãÂâçÁöÑÊó•ÂøóÊù°ÁõÆÂ∑≤Ë¢´Â§öÊï∞ËäÇÁÇπÂ§çÂà∂ÔºåÈÇ£‰πà‰ªñ‰ª¨Áä∂ÊÄÅÈÉΩÂèØË¢´ËÆæÁΩÆ‰∏∫Â∑≤Êèê‰∫§„ÄÇLeader ÂèØÈÄöËøáÂú®ÂèëÈÄÅÂøÉË∑≥Ê∂àÊÅØÔºàMsgHeartbeatÔºâÁªô Follower ËäÇÁÇπÊó∂ÔºåÂëäÁü•ÂÆÉÂ∑≤ÁªèÊèê‰∫§ÁöÑÊó•ÂøóÁ¥¢Âºï‰ΩçÁΩÆ„ÄÇ</p>
<p>ÊúÄÂêéÂêÑ‰∏™ËäÇÁÇπÁöÑ etcdserver Ê®°ÂùóÔºåÂèØÈÄöËøá channel ‰ªé Raft Ê®°ÂùóËé∑ÂèñÂà∞Â∑≤Êèê‰∫§ÁöÑÊó•ÂøóÊù°ÁõÆÔºàÊµÅÁ®ãÂõæ‰∏≠ÁöÑÂ∫èÂè∑ 7 ÊµÅÁ®ãÔºâÔºåÂ∫îÁî®Êó•ÂøóÊù°ÁõÆÂÜÖÂÆπÂà∞Â≠òÂÇ®Áä∂ÊÄÅÊú∫ÔºàÊµÅÁ®ãÂõæ‰∏≠ÁöÑÂ∫èÂè∑ 8 ÊµÅÁ®ãÔºâÔºåËøîÂõûÁªìÊûúÁªô client„ÄÇ</p>
<p>ÈÄöËøá‰ª•‰∏äÊµÅÁ®ãÔºåLeader Â∞±ÂÆåÊàê‰∫ÜÂêåÊ≠•Êó•ÂøóÊù°ÁõÆÁªô Follower ÁöÑ‰ªªÂä°Ôºå‰∏Ä‰∏™Êó•ÂøóÊù°ÁõÆË¢´Á°ÆÂÆö‰∏∫Â∑≤Êèê‰∫§ÁöÑÂâçÊèêÊòØÔºåÂÆÉÈúÄË¶ÅË¢´ Leader ÂêåÊ≠•Âà∞‰∏ÄÂçä‰ª•‰∏äËäÇÁÇπ‰∏ä„ÄÇ‰ª•‰∏äÂ∞±ÊòØ etcd Raft Êó•ÂøóÂ§çÂà∂ÁöÑÊ†∏ÂøÉÂéüÁêÜ„ÄÇ</p>
<p>ÂÆâÂÖ®ÊÄß‰ªãÁªçÂÆå Leader ÈÄâ‰∏æÂíåÊó•ÂøóÂ§çÂà∂ÂêéÔºåÊúÄÂêéÊàë‰ª¨ÂÜçÊù•ÁúãÁúã Raft ÊòØÂ¶Ç‰Ωï‰øùËØÅÂÆâÂÖ®ÊÄßÁöÑ„ÄÇ</p>
<p>Â¶ÇÊûúÂú®‰∏äÈù¢ÁöÑÊó•ÂøóÂõæ 2 ‰∏≠ÔºåLeader B Âú®Â∫îÁî®Êó•ÂøóÊåá‰ª§ put hello ‰∏∫ world Âà∞Áä∂ÊÄÅÊú∫ÔºåÂπ∂ËøîÂõûÁªô client ÊàêÂäüÂêéÔºåÁ™ÅÁÑ∂ crash ‰∫ÜÔºåÈÇ£‰πà Follower A Âíå C ÊòØÂê¶ÈÉΩÊúâËµÑÊ†ºÈÄâ‰∏æÊàê‰∏∫ Leader Âë¢Ôºü‰ªéÊó•ÂøóÂõæ 2 ‰∏≠Êàë‰ª¨ÂèØ‰ª•ÁúãÂà∞ÔºåÂ¶ÇÊûú A Êàê‰∏∫‰∫Ü Leader ÈÇ£‰πàÂ∞±‰ºöÂØºËá¥Êï∞ÊçÆ‰∏¢Â§±ÔºåÂõ†‰∏∫ÂÆÉÂπ∂Êú™Âê´ÊúâÂàöÂàö client Â∑≤ÁªèÂÜôÂÖ•ÊàêÂäüÁöÑ put hello ‰∏∫ world Êåá‰ª§„ÄÇRaft ÁÆóÊ≥ïÂ¶Ç‰ΩïÁ°Æ‰øùÈù¢ÂØπËøôÁ±ªÈóÆÈ¢òÊó∂‰∏ç‰∏¢Êï∞ÊçÆÂíåÂêÑËäÇÁÇπÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÂë¢ÔºüËøôÂ∞±ÊòØ Raft ÁöÑÁ¨¨‰∏â‰∏™Â≠êÈóÆÈ¢òÈúÄË¶ÅËß£ÂÜ≥ÁöÑ„ÄÇRaft ÈÄöËøáÁªôÈÄâ‰∏æÂíåÊó•ÂøóÂ§çÂà∂Â¢ûÂä†‰∏ÄÁ≥ªÂàóËßÑÂàôÔºåÊù•ÂÆûÁé∞ Raft ÁÆóÊ≥ïÁöÑÂÆâÂÖ®ÊÄß„ÄÇ</p>
<p>ÈÄâ‰∏æËßÑÂàô</p>
<p>ÂΩìËäÇÁÇπÊî∂Âà∞ÈÄâ‰∏æÊäïÁ•®ÁöÑÊó∂ÂÄôÔºåÈúÄÊ£ÄÊü•ÂÄôÈÄâËÄÖÁöÑÊúÄÂêé‰∏ÄÊù°Êó•Âøó‰∏≠ÁöÑ‰ªªÊúüÂè∑ÔºåËã•Â∞è‰∫éËá™Â∑±ÂàôÊãíÁªùÊäïÁ•®„ÄÇÂ¶ÇÊûú‰ªªÊúüÂè∑Áõ∏ÂêåÔºåÊó•ÂøóÂç¥ÊØîËá™Â∑±Áü≠Ôºå‰πüÊãíÁªù‰∏∫ÂÖ∂ÊäïÁ•®„ÄÇÊØîÂ¶ÇÂú®Êó•ÂøóÂõæ 2 ‰∏≠ÔºåFolllower A Âíå C ‰ªªÊúüÂè∑Áõ∏ÂêåÔºå‰ΩÜÊòØ Follower C ÁöÑÊï∞ÊçÆÊØî Follower A Ë¶ÅÈïøÔºåÈÇ£‰πàÂú®ÈÄâ‰∏æÁöÑÊó∂ÂÄôÔºåFollower C Â∞ÜÊãíÁªùÊäïÁ•®Áªô AÔºå Âõ†‰∏∫ÂÆÉÁöÑÊï∞ÊçÆ‰∏çÊòØÊúÄÊñ∞ÁöÑ„ÄÇ</p>
<p>ÂêåÊó∂ÔºåÂØπ‰∫é‰∏Ä‰∏™ÁªôÂÆöÁöÑ‰ªªÊúüÂè∑ÔºåÊúÄÂ§öÂè™‰ºöÊúâ‰∏Ä‰∏™ leader Ë¢´ÈÄâ‰∏æÂá∫Êù•Ôºåleader ÁöÑËØûÁîüÈúÄËé∑ÂæóÈõÜÁæ§‰∏ÄÂçä‰ª•‰∏äÁöÑËäÇÁÇπÊîØÊåÅ„ÄÇÊØè‰∏™ËäÇÁÇπÂú®Âêå‰∏Ä‰∏™‰ªªÊúüÂÜÖÂè™ËÉΩ‰∏∫‰∏Ä‰∏™ËäÇÁÇπÊäïÁ•®ÔºåËäÇÁÇπÈúÄË¶ÅÂ∞ÜÊäïÁ•®‰ø°ÊÅØÊåÅ‰πÖÂåñÔºåÈò≤Ê≠¢ÂºÇÂ∏∏ÈáçÂêØÂêéÂÜçÊäïÁ•®ÁªôÂÖ∂‰ªñËäÇÁÇπ„ÄÇÈÄöËøá‰ª•‰∏äËßÑÂàôÂ∞±ÂèØÈò≤Ê≠¢Êó•ÂøóÂõæ 2 ‰∏≠ÁöÑ Follower A ËäÇÁÇπÊàê‰∏∫ Leader„ÄÇ</p>
<p>Êó•ÂøóÂ§çÂà∂ËßÑÂàô</p>
<p>Âú®Êó•ÂøóÂõæ 2 ‰∏≠ÔºåLeader B ËøîÂõûÁªô client ÊàêÂäüÂêéËã•Á™ÅÁÑ∂ crash ‰∫ÜÔºåÊ≠§Êó∂ÂèØËÉΩËøòÂπ∂Êú™Â∞Ü 6 Âè∑Êó•ÂøóÊù°ÁõÆÂ∑≤Êèê‰∫§ÁöÑÊ∂àÊÅØÈÄöÁü•Âà∞ Follower A Âíå CÔºåÈÇ£‰πàÂ¶Ç‰ΩïÁ°Æ‰øù 6 Âè∑Êó•ÂøóÊù°ÁõÆ‰∏çË¢´Êñ∞ Leader Âà†Èô§Âë¢Ôºü ÂêåÊó∂Âú® etcd ÈõÜÁæ§ËøêË°åËøáÁ®ã‰∏≠ÔºåLeader ËäÇÁÇπËã•È¢ëÁπÅÂèëÁîü crash ÂêéÔºåÂèØËÉΩ‰ºöÂØºËá¥ Follower ËäÇÁÇπ‰∏é Leader ËäÇÁÇπÊó•ÂøóÊù°ÁõÆÂÜ≤Á™ÅÔºåÂ¶Ç‰Ωï‰øùËØÅÂêÑ‰∏™ËäÇÁÇπÁöÑÂêå Raft Êó•Âøó‰ΩçÁΩÆÂê´ÊúâÂêåÊ†∑ÁöÑÊó•ÂøóÊù°ÁõÆÔºü</p>
<p>‰ª•‰∏äÂêÑÁ±ªÂºÇÂ∏∏Âú∫ÊôØÁöÑÂÆâÂÖ®ÊÄßÊòØÈÄöËøá Raft ÁÆóÊ≥ï‰∏≠ÁöÑ Leader ÂÆåÂÖ®ÁâπÊÄßÂíåÂè™ÈôÑÂä†ÂéüÂàô„ÄÅÊó•ÂøóÂåπÈÖçÁ≠âÂÆâÂÖ®Êú∫Âà∂Êù•‰øùËØÅÁöÑ„ÄÇLeader ÂÆåÂÖ®ÁâπÊÄßÊòØÊåáÂ¶ÇÊûúÊüê‰∏™Êó•ÂøóÊù°ÁõÆÂú®Êüê‰∏™‰ªªÊúüÂè∑‰∏≠Â∑≤ÁªèË¢´Êèê‰∫§ÔºåÈÇ£‰πàËøô‰∏™Êù°ÁõÆÂøÖÁÑ∂Âá∫Áé∞Âú®Êõ¥Â§ß‰ªªÊúüÂè∑ÁöÑÊâÄÊúâ Leader ‰∏≠„ÄÇ</p>
<p>Leader Âè™ËÉΩËøΩÂä†Êó•ÂøóÊù°ÁõÆÔºå‰∏çËÉΩÂà†Èô§Â∑≤ÊåÅ‰πÖÂåñÁöÑÊó•ÂøóÊù°ÁõÆÔºàÂè™ÈôÑÂä†ÂéüÂàôÔºâÔºåÂõ†Ê≠§ Follower C Êàê‰∏∫Êñ∞ Leader ÂêéÔºå‰ºöÂ∞ÜÂâç‰ªªÁöÑ 6 Âè∑Êó•ÂøóÊù°ÁõÆÂ§çÂà∂Âà∞ A ËäÇÁÇπ„ÄÇ</p>
<p>‰∏∫‰∫Ü‰øùËØÅÂêÑ‰∏™ËäÇÁÇπÊó•Âøó‰∏ÄËá¥ÊÄßÔºåRaft ÁÆóÊ≥ïÂú®ËøΩÂä†Êó•ÂøóÁöÑÊó∂ÂÄôÔºåÂºïÂÖ•‰∫Ü‰∏ÄËá¥ÊÄßÊ£ÄÊü•„ÄÇLeader Âú®ÂèëÈÄÅËøΩÂä†Êó•Âøó RPC Ê∂àÊÅØÊó∂Ôºå‰ºöÊääÊñ∞ÁöÑÊó•ÂøóÊù°ÁõÆÁ¥ßÊé•ÁùÄ‰πãÂâçÁöÑÊù°ÁõÆÁöÑÁ¥¢Âºï‰ΩçÁΩÆÂíå‰ªªÊúüÂè∑ÂåÖÂê´Âú®ÈáåÈù¢„ÄÇFollower ËäÇÁÇπ‰ºöÊ£ÄÊü•Áõ∏ÂêåÁ¥¢Âºï‰ΩçÁΩÆÁöÑ‰ªªÊúüÂè∑ÊòØÂê¶‰∏é Leader ‰∏ÄËá¥Ôºå‰∏ÄËá¥ÊâçËÉΩËøΩÂä†ÔºåËøôÂ∞±ÊòØÊó•ÂøóÂåπÈÖçÁâπÊÄß„ÄÇÂÆÉÊú¨Ë¥®‰∏äÊòØ‰∏ÄÁßçÂΩíÁ∫≥Ê≥ïÔºå‰∏ÄÂºÄÂßãÊó•ÂøóÁ©∫Êª°Ë∂≥ÂåπÈÖçÁâπÊÄßÔºåÈöèÂêéÊØèÂ¢ûÂä†‰∏Ä‰∏™Êó•ÂøóÊù°ÁõÆÊó∂ÔºåÈÉΩË¶ÅÊ±Ç‰∏ä‰∏Ä‰∏™Êó•ÂøóÊù°ÁõÆ‰ø°ÊÅØ‰∏é Leader ‰∏ÄËá¥ÔºåÈÇ£‰πàÊúÄÁªàÊï¥‰∏™Êó•ÂøóÈõÜËÇØÂÆöÊòØ‰∏ÄËá¥ÁöÑ„ÄÇ</p>
<p>ÈÄöËøá‰ª•‰∏äÁöÑ Leader ÈÄâ‰∏æÈôêÂà∂„ÄÅLeader ÂÆåÂÖ®ÁâπÊÄß„ÄÅÂè™ÈôÑÂä†ÂéüÂàô„ÄÅÊó•ÂøóÂåπÈÖçÁ≠âÂÆâÂÖ®ÁâπÊÄßÔºåRaft Â∞±ÂÆûÁé∞‰∫Ü‰∏Ä‰∏™ÂèØ‰∏•Ê†ºÈÄöËøáÊï∞Â≠¶ÂèçËØÅÊ≥ï„ÄÅÂΩíÁ∫≥Ê≥ïËØÅÊòéÁöÑÈ´òÂèØÁî®„ÄÅ‰∏ÄËá¥ÊÄßÁÆóÊ≥ïÔºå‰∏∫ etcd ÁöÑÂÆâÂÖ®ÊÄß‰øùÈ©æÊä§Ëà™„ÄÇ</p>
<p>Â∞èÁªìÊúÄÂêéÊàë‰ª¨Êù•Â∞èÁªì‰∏ã‰ªäÂ§©ÁöÑÂÜÖÂÆπ„ÄÇ</p>
<p>Êàë‰ªéÂ¶Ç‰ΩïÈÅøÂÖçÂçïÁÇπÊïÖÈöúËØ¥Ëµ∑Ôºå</p>
<p>Áªô‰Ω†‰ªãÁªç‰∫ÜÂàÜÂ∏ÉÂºèÁ≥ªÁªü‰∏≠ÂÆûÁé∞Â§öÂâØÊú¨ÊäÄÊúØÁöÑ‰∏ÄÁ≥ªÂàóÊñπÊ°àÔºå</p>
<p>‰ªé‰∏ª‰ªéÂ§çÂà∂Âà∞Âéª‰∏≠ÂøÉÂåñÂ§çÂà∂„ÄÅÂÜçÂà∞Áä∂ÊÄÅÊú∫„ÄÅÂÖ±ËØÜÁÆóÊ≥ïÔºåËÆ©‰Ω†‰∫ÜËß£‰∫ÜÂêÑ‰∏™ÊñπÊ°àÁöÑ‰ºòÁº∫ÁÇπÔºå</p>
<p>‰ª•Âèä‰∏ªÊµÅÂ≠òÂÇ®‰∫ßÂìÅÁöÑÈÄâÊã©„ÄÇRaft ËôΩÁÑ∂ËØûÁîüÊôöÔºå‰ΩÜÂÆÉÂç¥ÊòØÂÖ±ËØÜÁÆóÊ≥ïÈáåÈù¢Âú®Â∑•Á®ãÁïåÂ∫îÁî®ÊúÄÂπøÊ≥õÁöÑ„ÄÇ</p>
<p>ÂÆÉÂ∞Ü‰∏Ä‰∏™Â§çÊùÇÈóÆÈ¢òÊãÜÂàÜÊàê‰∏â‰∏™Â≠êÈóÆÈ¢òÔºåÂàÜÂà´ÊòØ Leader ÈÄâ‰∏æ„ÄÅÊó•ÂøóÂ§çÂà∂ÂíåÂÆâÂÖ®ÊÄß„ÄÇ</p>
<p>Raft ÈÄöËøáÂøÉË∑≥Êú∫Âà∂„ÄÅÈöèÊú∫ÂåñÁ≠âÂÆûÁé∞‰∫Ü Leader ÈÄâ‰∏æÔºåÂè™Ë¶ÅÈõÜÁæ§ÂçäÊï∞‰ª•‰∏äËäÇÁÇπÂ≠òÊ¥ªÂèØÁõ∏‰∫íÈÄö‰ø°Ôºåetcd Â∞±ÂèØÂØπÂ§ñÊèê‰æõÈ´òÂèØÁî®ÊúçÂä°„ÄÇ</p>
<p>Raft Êó•ÂøóÂ§çÂà∂Á°Æ‰øù‰∫Ü etcd Â§öËäÇÁÇπÈó¥ÁöÑÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÔºåÊàëÈÄöËøá‰∏Ä‰∏™ etcd Êó•ÂøóÂ§çÂà∂Êï¥‰ΩìÊµÅÁ®ãÂõæ‰∏∫‰Ω†ËØ¶ÁªÜ‰ªãÁªç‰∫Ü etcd ÂÜôËØ∑Ê±Ç‰ªéÊèê‰∫§Âà∞ Raft Ê®°ÂùóÔºåÂà∞Ë¢´Â∫îÁî®Âà∞Áä∂ÊÄÅÊú∫ÊâßË°åÁöÑÂêÑ‰∏™ÊµÅÁ®ãÔºåÂâñÊûê‰∫ÜÊó•ÂøóÂ§çÂà∂ÁöÑÊ†∏ÂøÉÂéüÁêÜÔºåÂç≥‰∏Ä‰∏™Êó•ÂøóÊù°ÁõÆÂè™ÊúâË¢´ Leader ÂêåÊ≠•Âà∞‰∏ÄÂçä‰ª•‰∏äËäÇÁÇπ‰∏äÔºåÊ≠§Êó•ÂøóÊù°ÁõÆÊâçËÉΩÁß∞‰πã‰∏∫ÊàêÂäüÂ§çÂà∂„ÄÅÂ∑≤Êèê‰∫§„ÄÇ</p>
<p>Raft ÁöÑÂÆâÂÖ®ÊÄßÔºåÈÄöËøáÂØπ Leader ÈÄâ‰∏æÂíåÊó•ÂøóÂ§çÂà∂Â¢ûÂä†‰∏ÄÁ≥ªÂàóËßÑÂàôÔºå‰øùËØÅ‰∫ÜÊï¥‰∏™ÈõÜÁæ§ÁöÑ‰∏ÄËá¥ÊÄß„ÄÅÂÆåÊï¥ÊÄß„ÄÇ</p>
<h3 id="Èâ¥ÊùÉ-Â¶Ç‰Ωï‰øùÊä§‰Ω†ÁöÑÊï∞ÊçÆÂÆâÂÖ®">Èâ¥ÊùÉ Â¶Ç‰Ωï‰øùÊä§‰Ω†ÁöÑÊï∞ÊçÆÂÆâÂÖ®</h3>
<p>‰∏çÁü•ÈÅì‰Ω†ÊúâÊ≤°ÊúâËøáËøôÊ†∑ÁöÑÂõ∞ÊÉëÔºåÂΩì‰Ω†‰ΩøÁî® etcd Â≠òÂÇ®‰∏öÂä°ÊïèÊÑüÊï∞ÊçÆ„ÄÅÂ§öÁßüÊà∑ÂÖ±‰∫´‰ΩøÁî®Âêå etcd ÈõÜÁæ§ÁöÑÊó∂ÂÄôÔºåÂ∫îËØ•Â¶Ç‰ΩïÈò≤Ê≠¢ÂåøÂêçÁî®Êà∑ËÆøÈóÆ‰Ω†ÁöÑ etcd Êï∞ÊçÆÂë¢ÔºüÂ§öÁßüÊà∑Âú∫ÊôØÂèàÂ¶Ç‰ΩïÊúÄÂ∞èÂåñÁî®Êà∑ÊùÉÈôêÂàÜÈÖçÔºåÈò≤Ê≠¢Ë∂äÊùÉËÆøÈóÆÁöÑÔºüetcd Èâ¥ÊùÉÊ®°ÂùóÂ∞±ÊòØ‰∏∫‰∫ÜËß£ÂÜ≥‰ª•‰∏äÁóõÁÇπËÄåÁîü„ÄÇÈÇ£‰πà etcd ÊòØÂ¶Ç‰ΩïÂÆûÁé∞Â§öÁßçÈâ¥ÊùÉÊú∫Âà∂ÂíåÁªÜÁ≤íÂ∫¶ÁöÑÊùÉÈôêÊéßÂà∂ÁöÑÔºüÂú®ÂÆûÁé∞Èâ¥ÊùÉÊ®°ÂùóÁöÑËøáÁ®ã‰∏≠ÊúÄÊ†∏ÂøÉÁöÑÊåëÊàòÊòØ‰ªÄ‰πàÔºüÂèàËØ•Â¶Ç‰ΩïÁ°Æ‰øùÈâ¥ÊùÉÁöÑÂÆâÂÖ®ÊÄß‰ª•ÂèäÊèêÂçáÈâ¥ÊùÉÊÄßËÉΩÂë¢Ôºü‰ªäÂ§©ËøôËäÇËØæÔºåÊàëÂ∞Ü‰∏∫‰Ω†‰ªãÁªç etcd ÁöÑÈâ¥ÊùÉÊ®°ÂùóÔºåÊ∑±ÂÖ•ÂâñÊûê etcd Â¶Ç‰ΩïËß£ÂÜ≥‰∏äÈù¢ÁöÑËøô‰∫õÁóõÁÇπÂíåÊåëÊàò„ÄÇÂ∏åÊúõÈÄöËøáËøôËäÇËØæÔºåÂ∏ÆÂä©‰Ω†ÊéåÊè° etcd Èâ¥ÊùÉÊ®°ÂùóÁöÑËÆæËÆ°„ÄÅÂÆûÁé∞Á≤æË¶ÅÔºå‰∫ÜËß£ÂêÑÁßçÈâ¥ÊùÉÊñπÊ°àÁöÑ‰ºòÁº∫ÁÇπ„ÄÇ‰Ω†ËÉΩÂú®ÂÆûÈôÖÂ∫îÁî®‰∏≠ÔºåÊ†πÊçÆËá™Â∑±ÁöÑ‰∏öÂä°Âú∫ÊôØ„ÄÅÂÆâÂÖ®ËØâÊ±ÇÔºåÈÄâÊã©ÂêàÈÄÇÁöÑÊñπÊ°à‰øùÊä§‰Ω†ÁöÑ etcd Êï∞ÊçÆÂÆâÂÖ®„ÄÇÂêåÊó∂Ôºå‰Ω†‰πüÂèØ‰ª•ÂèÇËÄÉÂÖ∂ËÆæËÆ°„ÄÅÂÆûÁé∞ÊÄùÊÉ≥Â∫îÁî®Âà∞Ëá™Â∑±‰∏öÂä°ÁöÑÈâ¥ÊùÉÁ≥ªÁªü‰∏ä„ÄÇ</p>
<h4 id="Êï¥‰ΩìÊû∂ÊûÑ">Êï¥‰ΩìÊû∂ÊûÑ</h4>
<p>Âú®ËØ¶ÁªÜ‰ªãÁªç etcd ÁöÑËÆ§ËØÅ„ÄÅÈâ¥ÊùÉÂÆûÁé∞ÁªÜËäÇ‰πãÂâçÔºåÊàëÂÖàÁªô‰Ω†‰ªéÊï¥‰Ωì‰∏ä‰ªãÁªç‰∏ã etcd Èâ¥ÊùÉ‰ΩìÁ≥ª„ÄÇetcd Èâ¥ÊùÉ‰ΩìÁ≥ªÊû∂ÊûÑÁî±ÊéßÂà∂Èù¢ÂíåÊï∞ÊçÆÈù¢ÁªÑÊàê„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e9%89%b4%e6%9d%83%e4%bd%93%e7%b3%bb%e5%ad%94%e5%ad%90%e5%92%8c%e9%9d%a2.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>‰∏äÂõæÊòØÊòØ etcd Èâ¥ÊùÉ‰ΩìÁ≥ªÊéßÂà∂Èù¢Ôºå‰Ω†ÂèØ‰ª•ÈÄöËøáÂÆ¢Êà∑Á´ØÂ∑•ÂÖ∑ etcdctl ÂíåÈâ¥ÊùÉ API Âä®ÊÄÅË∞ÉÊï¥ËÆ§ËØÅ„ÄÅÈâ¥ÊùÉËßÑÂàôÔºåAuthServer Êî∂Âà∞ËØ∑Ê±ÇÂêéÔºå‰∏∫‰∫ÜÁ°Æ‰øùÂêÑËäÇÁÇπÈó¥Èâ¥ÊùÉÂÖÉÊï∞ÊçÆ‰∏ÄËá¥ÊÄßÔºå‰ºöÈÄöËøá Raft Ê®°ÂùóËøõË°åÊï∞ÊçÆÂêåÊ≠•„ÄÇ</p>
<p>ÂΩìÂØπÂ∫îÁöÑ Raft Êó•ÂøóÊù°ÁõÆË¢´ÈõÜÁæ§ÂçäÊï∞‰ª•‰∏äËäÇÁÇπÁ°ÆËÆ§ÂêéÔºåApply Ê®°ÂùóÈÄöËøáÈâ¥ÊùÉÂ≠òÂÇ® (AuthStore) Ê®°ÂùóÔºåÊâßË°åÊó•ÂøóÊù°ÁõÆÁöÑÂÜÖÂÆπÔºåÂ∞ÜËßÑÂàôÂ≠òÂÇ®Âà∞ boltdb ÁöÑ‰∏ÄÁ≥ªÂàó‚ÄúÈâ¥ÊùÉË°®‚ÄùÈáåÈù¢„ÄÇ</p>
<p>‰∏ãÂõæÊòØÊï∞ÊçÆÈù¢Èâ¥ÊùÉÊµÅÁ®ãÔºåÁî±ËÆ§ËØÅÂíåÊéàÊùÉÊµÅÁ®ãÁªÑÊàê„ÄÇËÆ§ËØÅÁöÑÁõÆÁöÑÊòØÊ£ÄÊü• client ÁöÑË∫´‰ªΩÊòØÂê¶ÂêàÊ≥ï„ÄÅÈò≤Ê≠¢ÂåøÂêçÁî®Êà∑ËÆøÈóÆÁ≠â„ÄÇÁõÆÂâç etcd ÂÆûÁé∞‰∫Ü‰∏§ÁßçËÆ§ËØÅÊú∫Âà∂ÔºåÂàÜÂà´ÊòØÂØÜÁ†ÅËÆ§ËØÅÂíåËØÅ‰π¶ËÆ§ËØÅ„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e9%89%b4%e6%9d%83%e6%95%b0%e6%8d%ae%e9%9d%a2%e8%b0%83%e6%95%b4.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>ËÆ§ËØÅÈÄöËøáÂêéÔºå‰∏∫‰∫ÜÊèêÈ´òÂØÜÁ†ÅËÆ§ËØÅÊÄßËÉΩÔºå‰ºöÂàÜÈÖç‰∏Ä‰∏™ TokenÔºàÁ±ª‰ººÊàë‰ª¨ÁîüÊ¥ª‰∏≠ÁöÑÈó®Á•®„ÄÅÈÄö‰ø°ËØÅÔºâÁªô clientÔºåclient ÂêéÁª≠ÂÖ∂‰ªñËØ∑Ê±ÇÊê∫Â∏¶Ê≠§ TokenÔºåserver Â∞±ÂèØÂø´ÈÄüÂÆåÊàê client ÁöÑË∫´‰ªΩÊ†°È™åÂ∑•‰Ωú„ÄÇ</p>
<p>ÂÆûÁé∞ÂàÜÈÖç Token ÁöÑÊúçÂä°‰πüÊúâÂ§öÁßçÔºåËøôÊòØ TokenProvider ÊâÄË¥üË¥£ÁöÑÔºåÁõÆÂâçÊîØÊåÅ SimpleToken Âíå JWT ‰∏§Áßç„ÄÇ</p>
<p>ÈÄöËøáËÆ§ËØÅÂêéÔºåÂú®ËÆøÈóÆ MVCC Ê®°Âùó‰πãÂâçÔºåËøòÈúÄË¶ÅÈÄöËøáÊéàÊùÉÊµÅÁ®ã„ÄÇÊéàÊùÉÁöÑÁõÆÁöÑÊòØÊ£ÄÊü• client ÊòØÂê¶ÊúâÊùÉÈôêÊìç‰Ωú‰Ω†ËØ∑Ê±ÇÁöÑÊï∞ÊçÆË∑ØÂæÑÔºåetcd ÂÆûÁé∞‰∫Ü RBAC Êú∫Âà∂ÔºåÊîØÊåÅ‰∏∫ÊØè‰∏™Áî®Êà∑ÂàÜÈÖç‰∏Ä‰∏™ËßíËâ≤Ôºå‰∏∫ÊØè‰∏™ËßíËâ≤Êéà‰∫àÊúÄÂ∞èÂåñÁöÑÊùÉÈôê„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e9%89%b4%e6%9d%83%e6%b5%81%e7%a8%8b%e5%9b%be.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>Â•Ω‰∫ÜÔºåetcd Èâ¥ÊùÉ‰ΩìÁ≥ªÁöÑÊï¥‰∏™ÊµÅÁ®ãËÆ≤ÂÆå‰∫ÜÔºå‰∏ãÈù¢Êàë‰ª¨Â∞±‰ª•Á¨¨‰∏âÁ´†‰∏≠ÊèêÂà∞ÁöÑ put hello ÂëΩ‰ª§‰∏∫‰æãÔºåÁªô‰Ω†Ê∑±ÂÖ•ÂàÜÊûê‰ª•‰∏äÈâ¥ÊùÉ‰ΩìÁ≥ªÊòØÂ¶Ç‰ΩïËøõË°åË∫´‰ªΩËÆ§ËØÅÊù•Èò≤Ê≠¢ÂåøÂêçËÆøÈóÆÁöÑÔºåÂèàÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁªÜÁ≤íÂ∫¶ÁöÑÊùÉÈôêÊéßÂà∂‰ª•Èò≤Ê≠¢Ë∂äÊùÉËÆøÈóÆÁöÑ„ÄÇ</p>
<p>ËÆ§ËØÅÈ¶ñÂÖàÊàë‰ª¨Êù•ÁúãÁ¨¨‰∏Ä‰∏™ÈóÆÈ¢òÔºåÂ¶Ç‰ΩïÈò≤Ê≠¢ÂåøÂêçÁî®Êà∑ËÆøÈóÆ‰Ω†ÁöÑ etcd Êï∞ÊçÆÂë¢Ôºü</p>
<p>Ëß£ÂÜ≥ÊñπÊ°àÂΩìÁÑ∂ÊòØËÆ§ËØÅÁî®Êà∑Ë∫´‰ªΩ„ÄÇÈÇ£ etcd Êèê‰æõ‰∫ÜÂì™‰∫õÊú∫Âà∂Êù•È™åËØÅ client Ë∫´‰ªΩÂë¢?Ê≠£Â¶ÇÊàëÊï¥‰ΩìÊû∂ÊûÑ‰∏≠Áªô‰Ω†‰ªãÁªçÁöÑÔºåetcd ÁõÆÂâçÂÆûÁé∞‰∫Ü‰∏§ÁßçÊú∫Âà∂ÔºåÂàÜÂà´ÊòØÁî®Êà∑ÂØÜÁ†ÅËÆ§ËØÅÂíåËØÅ‰π¶ËÆ§ËØÅÔºå‰∏ãÈù¢ÊàëÂàÜÂà´Áªô‰Ω†‰ªãÁªçËøô‰∏§ÁßçÊú∫Âà∂Âú® etcd ‰∏≠Â¶Ç‰ΩïÂÆûÁé∞Ôºå‰ª•ÂèäËøô‰∏§ÁßçÊú∫Âà∂ÂêÑËá™ÁöÑ‰ºòÁº∫ÁÇπ„ÄÇ</p>
<p>ÂØÜÁ†ÅËÆ§ËØÅ</p>
<p>È¶ñÂÖàÊàë‰ª¨Êù•ËÆ≤ËÆ≤Áî®Êà∑ÂØÜÁ†ÅËÆ§ËØÅ„ÄÇetcd ÊîØÊåÅ‰∏∫ÊØè‰∏™Áî®Êà∑ÂàÜÈÖç‰∏Ä‰∏™Ë¥¶Âè∑ÂêçÁß∞„ÄÅÂØÜÁ†Å„ÄÇÂØÜÁ†ÅËÆ§ËØÅÂú®Êàë‰ª¨ÁîüÊ¥ª‰∏≠Êó†Â§Ñ‰∏çÂú®Ôºå‰ªéÈì∂Ë°åÂç°ÂèñÊ¨æÂà∞ÂæÆ‰ø°„ÄÅÂæÆÂçö app ÁôªÂΩïÔºåÂÜçÂà∞Ê†∏Ê≠¶Âô®ÂèëÂ∞ÑÔºåÂØÜÁ†ÅËÆ§ËØÅÂ∫îÁî®ÂèäÂÖ∂ÂπøÊ≥õÔºåÊòØÊúÄÂü∫Á°ÄÁöÑÈâ¥ÊùÉÁöÑÊñπÂºè„ÄÇ</p>
<p>‰ΩÜÂØÜÁ†ÅËÆ§ËØÅÂ≠òÂú®‰∏§Â§ßÈöæÁÇπÔºåÂÆÉ‰ª¨ÂàÜÂà´ÊòØÂ¶Ç‰Ωï‰øùÈöúÂØÜÁ†ÅÂÆâÂÖ®ÊÄßÂíåÊèêÂçáÂØÜÁ†ÅËÆ§ËØÅÊÄßËÉΩ„ÄÇ</p>
<p>Â¶Ç‰Ωï‰øùÈöúÂØÜÁ†ÅÂÆâÂÖ®ÊÄß</p>
<p>Êàë‰ª¨È¶ñÂÖàÊù•ÁúãÁ¨¨‰∏Ä‰∏™ÈöæÁÇπÔºöÂ¶Ç‰Ωï‰øùÈöúÂØÜÁ†ÅÂÆâÂÖ®ÊÄß„ÄÇ‰πüËÆ∏ÂàöÂàöÊØï‰∏öÁöÑ‰Ω†‰ºöËØ¥Áõ¥Êé•ÊòéÊñáÂ≠òÂÇ®ÔºåÊî∂Âà∞Áî®Êà∑Èâ¥ÊùÉËØ∑Ê±ÇÁöÑÊó∂ÂÄôÔºåÊ£ÄÊü•Áî®Êà∑ËØ∑Ê±Ç‰∏≠ÂØÜÁ†Å‰∏éÂ≠òÂÇ®‰∏≠ÊòØÂê¶‰∏ÄÊ†∑Ôºå‰∏çÂ∞±ÂèØ‰ª•‰∫ÜÂêóÔºü ËøôÁßçÊñπÊ°àÁöÑÁ°ÆÂ§üÁÆÄÂçïÔºå‰ΩÜ‰Ω†ÊòØÂê¶ÊÉ≥ËøáÔºåËã•Â≠òÂÇ®ÂØÜÁ†ÅÁöÑÊñá‰ª∂‰∏á‰∏ÄË¢´ÈªëÂÆ¢ËÑ±Â∫ì‰∫ÜÔºåÈÇ£‰πàÊâÄÊúâÁî®Êà∑ÁöÑÂØÜÁ†ÅÈÉΩÂ∞ÜË¢´Ê≥ÑÈú≤ÔºåËøõËÄåÂèØËÉΩ‰ºöÂØºËá¥ÈáçÂ§ßÊï∞ÊçÆÊ≥ÑÈú≤‰∫ãÊïÖ„ÄÇ</p>
<p>‰πüËÆ∏‰Ω†Âèà‰ºöËØ¥ÔºåËá™Â∑±ÂèØ‰ª•Â•áÊÄùÂ¶ôÊÉ≥ÊûÑÂª∫‰∏Ä‰∏™Âä†ÂØÜÁÆóÊ≥ïÔºåÁÑ∂ÂêéÂ∞ÜÂØÜÁ†ÅÁøªËØë‰∏ãÔºåÊØîÂ¶ÇÂ∞ÜÂØÜÁ†Å‰∏≠ÁöÑÊØè‰∏™Â≠óÁ¨¶ÊåâÁÖßÂ≠óÊØçË°®Â∫èÊõøÊç¢ÊàêÂ≠óÊØçÂêéÁöÑÁ¨¨ XX ‰∏™Â≠óÊØç„ÄÇÁÑ∂ËÄåËøôÁßçÂä†ÂØÜÁÆóÊ≥ïÔºåÂÆÉÊòØÂèØÈÄÜÁöÑÔºå‰∏ÄÊó¶Ë¢´ÈªëÂÆ¢ËØÜÂà´Âà∞ËßÑÂæãÔºåËøòÂéüÂá∫‰Ω†ÁöÑÂØÜÁ†ÅÂêéÔºåËÑ±Â∫ìÂêé‰πüÂ∞ÜÂØºËá¥ÂÖ®ÈÉ®Ë¥¶Âè∑Êï∞ÊçÆÊ≥ÑÂØÜ„ÄÇ</p>
<p>ÈÇ£‰πàÊòØÂê¶Êàë‰ª¨Áî®‰∏ÄÁßç‰∏çÂèØÈÄÜÁöÑÂä†ÂØÜÁÆóÊ≥ïÂ∞±Ë°å‰∫ÜÂë¢ÔºüÊØîÂ¶ÇÂ∏∏ËßÅÁöÑ MD5ÔºåSHA-1ÔºåËøôÊñπÊ°àÂê¨Ëµ∑Êù•‰ºº‰πéÊúâÁÇπÈÅìÁêÜÔºåÁÑ∂ËÄåËøòÊòØ‰∏ç‰∏•Ë∞®ÔºåÂõ†‰∏∫ÂÆÉ‰ª¨ÁöÑËÆ°ÁÆóÈÄüÂ∫¶ÈùûÂ∏∏Âø´ÔºåÈªëÂÆ¢ÂèØ‰ª•ÈÄöËøáÊö¥ÂäõÊûö‰∏æ„ÄÅÂ≠óÂÖ∏„ÄÅÂΩ©ËôπË°®Á≠âÊâãÊÆµÔºåÂø´ÈÄüÂ∞Ü‰Ω†ÁöÑÂØÜÁ†ÅÂÖ®ÈÉ®Á†¥Ëß£„ÄÇ</p>
<p>LinkedIn Âú® 2012 Âπ¥ÁöÑÊó∂ÂÄô 650 ‰∏áÁî®Êà∑ÂØÜÁ†ÅË¢´Ê≥ÑÈú≤ÔºåÈªëÂÆ¢ 3 Â§©Â∞±Êö¥ÂäõÁ†¥Ëß£Âá∫ 90% Áî®Êà∑ÁöÑÂØÜÁ†ÅÔºåÂéüÂõ†Â∞±ÊòØ LinkedIn ‰ªÖ‰ªÖ‰ΩøÁî®‰∫Ü SHA-1 Âä†ÂØÜÁÆóÊ≥ï„ÄÇ</p>
<p>ÈÇ£Â∫îËØ•Â¶Ç‰ΩïËøõ‰∏ÄÊ≠•Â¢ûÂº∫‰∏çÂèØÈÄÜ hash ÁÆóÊ≥ïÁöÑÁ†¥Ëß£ÈöæÂ∫¶Ôºü</p>
<p>‰∏ÄÊñπÈù¢Êàë‰ª¨ÂèØ‰ª•‰ΩøÁî®ÂÆâÂÖ®ÊÄßÊõ¥È´òÁöÑ hash ÁÆóÊ≥ïÔºåÊØîÂ¶Ç SHA-256ÔºåÂÆÉËæìÂá∫‰ΩçÊï∞Êõ¥Â§ö„ÄÅËÆ°ÁÆóÊõ¥Âä†Â§çÊùÇ‰∏îËÄó CPU„ÄÇÂè¶‰∏ÄÊñπÈù¢Êàë‰ª¨ÂèØ‰ª•Âú®ÊØè‰∏™Áî®Êà∑ÂØÜÁ†Å hash ÂÄºÁöÑËÆ°ÁÆóËøáÁ®ã‰∏≠ÔºåÂºïÂÖ•‰∏Ä‰∏™ÈöèÊú∫„ÄÅËæÉÈïøÁöÑÂä†Áõê (salt) ÂèÇÊï∞ÔºåÂÆÉÂèØ‰ª•ËÆ©Áõ∏ÂêåÁöÑÂØÜÁ†ÅËæìÂá∫‰∏çÂêåÁöÑÁªìÊûúÔºåËøôËÆ©ÂΩ©ËôπË°®Á†¥Ëß£Áõ¥Êé•Â§±Êïà„ÄÇ</p>
<p>ÂΩ©ËôπË°®ÊòØÈªëÂÆ¢Á†¥Ëß£ÂØÜÁ†ÅÁöÑ‰∏ÄÁßçÊñπÊ≥ï‰πã‰∏ÄÔºåÂÆÉÈ¢ÑÂä†ËΩΩ‰∫ÜÂ∏∏Áî®ÂØÜÁ†Å‰ΩøÁî® MD5/SHA-1 ËÆ°ÁÆóÁöÑ hash ÂÄºÔºåÂèØÈÄöËøá hash ÂÄºÂåπÈÖçÂø´ÈÄüÁ†¥Ëß£‰Ω†ÁöÑÂØÜÁ†Å„ÄÇ</p>
<p>ÊúÄÂêéÊàë‰ª¨ËøòÂèØ‰ª•Â¢ûÂä†ÂØÜÁ†Å hash ÂÄºËÆ°ÁÆóËøáÁ®ã‰∏≠ÁöÑÂºÄÈîÄÔºåÊØîÂ¶ÇÂæ™ÁéØËø≠‰ª£Êõ¥Â§öÊ¨°ÔºåÂ¢ûÂä†Á†¥Ëß£ÁöÑÊó∂Èó¥ÊàêÊú¨„ÄÇ</p>
<p>etcd ÁöÑÈâ¥ÊùÉÊ®°ÂùóÂ¶Ç‰ΩïÂÆâÂÖ®Â≠òÂÇ®Áî®Êà∑ÂØÜÁ†ÅÔºü</p>
<p>etcd ÁöÑÁî®Êà∑ÂØÜÁ†ÅÂ≠òÂÇ®Ê≠£ÊòØËûçÂêà‰∫Ü‰ª•‰∏äËÆ®ËÆ∫ÁöÑÈ´òÂÆâÂÖ®ÊÄß hash ÂáΩÊï∞ÔºàBlowfish encryption algorithmÔºâ„ÄÅÈöèÊú∫ÁöÑÂä†Áõê salt„ÄÅÂèØËá™ÂÆö‰πâÁöÑ hash ÂÄºËÆ°ÁÆóËø≠‰ª£Ê¨°Êï∞ cost„ÄÇ</p>
<p>‰∏ãÈù¢ÊàëÂ∞ÜÈÄöËøáÂá†‰∏™ÁÆÄÂçï etcd Èâ¥ÊùÉ APIÔºå‰∏∫‰Ω†‰ªãÁªçÂØÜÁ†ÅËÆ§ËØÅÁöÑÂéüÁêÜ„ÄÇ</p>
<p>È¶ñÂÖà‰Ω†ÂèØ‰ª•ÈÄöËøáÂ¶Ç‰∏ãÁöÑ auth enable ÂëΩ‰ª§ÂºÄÂêØÈâ¥ÊùÉÔºåÊ≥®ÊÑè etcd ‰ºöÂÖàË¶ÅÊ±Ç‰Ω†ÂàõÂª∫‰∏Ä‰∏™ root Ë¥¶Âè∑ÔºåÂÆÉÊã•ÊúâÈõÜÁæ§ÁöÑÊúÄÈ´òËØªÂÜôÊùÉÈôê„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ etcdctl --endpoints http://127.0.0.1:2379 user add root:root
</span></span><span class="line"><span class="cl">User root created
</span></span><span class="line"><span class="cl">$ ./etcdctl  --endpoints http://127.0.0.1:2379 --user=root:root user grant-role root root
</span></span><span class="line"><span class="cl">Role root is granted to user root
</span></span><span class="line"><span class="cl">$ etcdctl auth enable
</span></span><span class="line"><span class="cl">Authentication Enabled
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂêØÁî®Èâ¥ÊùÉÂêéÔºåËøôÊó∂ client ÂèëËµ∑Â¶Ç‰∏ã put hello Êìç‰ΩúÊó∂Ôºå etcd server ‰ºöËøîÂõû&quot;user name is empty&quot;ÈîôËØØÁªô clientÔºåÂ∞±ÂàùÊ≠•ËææÂà∞‰∫ÜÈò≤Ê≠¢ÂåøÂêçÁî®Êà∑ËÆøÈóÆ‰Ω†ÁöÑ etcd Êï∞ÊçÆÁõÆÁöÑ„ÄÇ ÈÇ£‰πà etcd server ÊòØÂú®Âì™ÈáåÂÅöÁöÑÈâ¥ÊùÉÁöÑÂë¢?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ etcdctl --endpoints http://127.0.0.1:2379  put hello world
</span></span><span class="line"><span class="cl">Error: etcdserver: user name is empty
</span></span></code></pre></td></tr></table>
</div>
</div><p>etcd server Êî∂Âà∞ put hello ËØ∑Ê±ÇÁöÑÊó∂ÂÄôÔºåÂú®Êèê‰∫§Âà∞ Raft Ê®°ÂùóÂâçÔºåÂÆÉ‰ºö‰ªé‰Ω†ËØ∑Ê±ÇÁöÑ‰∏ä‰∏ãÊñá‰∏≠Ëé∑Âèñ‰Ω†ÁöÑÁî®Êà∑Ë∫´‰ªΩ‰ø°ÊÅØ„ÄÇÂ¶ÇÊûú‰Ω†Êú™ÈÄöËøáËÆ§ËØÅÔºåÈÇ£‰πàÂú®Áä∂ÊÄÅÊú∫Â∫îÁî® put ÂëΩ‰ª§ÁöÑÊó∂ÂÄôÔºåÊ£ÄÊü•Ë∫´‰ªΩÊùÉÈôêÁöÑÊó∂ÂÄôÂèëÁé∞ÊòØÁ©∫ÔºåÂ∞±‰ºöËøîÂõûÊ≠§ÈîôËØØÁªô client„ÄÇ</p>
<p>‰∏ãÈù¢ÊàëÈÄöËøáÈâ¥ÊùÉÊ®°ÂùóÁöÑ user ÂëΩ‰ª§ÔºåÁªô etcd Â¢ûÂä†‰∏Ä‰∏™ alice Ë¥¶Âè∑„ÄÇÊàë‰ª¨‰∏ÄËµ∑Êù•ÁúãÁúã etcd Èâ¥ÊùÉÊ®°ÂùóÊòØÂ¶Ç‰ΩïÂü∫‰∫éÊàë‰∏äÈù¢‰ªãÁªçÁöÑÊäÄÊúØÊñπÊ°àÔºåÊù•ÂÆâÂÖ®Â≠òÂÇ® alice Ë¥¶Âè∑‰ø°ÊÅØ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> ./etcdctl --endpoints http://127.0.0.1:2379 --user=root:root put hello &#34;This is a authentication&#34;
</span></span></code></pre></td></tr></table>
</div>
</div><p>Èâ¥ÊùÉÊ®°ÂùóÊî∂Âà∞Ê≠§ÂëΩ‰ª§ÂêéÔºåÂÆÉ‰ºö‰ΩøÁî® bcrpt Â∫ìÁöÑ blowfish ÁÆóÊ≥ïÔºåÂü∫‰∫éÊòéÊñáÂØÜÁ†Å„ÄÅÈöèÊú∫ÂàÜÈÖçÁöÑ salt„ÄÅËá™ÂÆö‰πâÁöÑ cost„ÄÅËø≠‰ª£Â§öÊ¨°ËÆ°ÁÆóÂæóÂà∞‰∏Ä‰∏™ hash ÂÄºÔºåÂπ∂Â∞ÜÂä†ÂØÜÁÆóÊ≥ïÁâàÊú¨„ÄÅsalt ÂÄº„ÄÅcost„ÄÅhash ÂÄºÁªÑÊàê‰∏Ä‰∏™Â≠óÁ¨¶‰∏≤Ôºå‰Ωú‰∏∫Âä†ÂØÜÂêéÁöÑÂØÜÁ†Å„ÄÇ</p>
<p>ÊúÄÂêéÔºåÈâ¥ÊùÉÊ®°ÂùóÂ∞ÜÁî®Êà∑Âêç alice ‰Ωú‰∏∫ keyÔºåÁî®Êà∑Âêç„ÄÅÂä†ÂØÜÂêéÁöÑÂØÜÁ†Å‰Ωú‰∏∫ valueÔºåÂ≠òÂÇ®Âà∞ boltdb ÁöÑ authUsers bucket ÈáåÈù¢ÔºåÂÆåÊàê‰∏Ä‰∏™Ë¥¶Âè∑ÂàõÂª∫„ÄÇ</p>
<p>ÂΩì‰Ω†‰ΩøÁî® alice Ë¥¶Âè∑ËÆøÈóÆ etcd ÁöÑÊó∂ÂÄôÔºå‰Ω†ÈúÄË¶ÅÂÖàË∞ÉÁî®Èâ¥ÊùÉÊ®°ÂùóÁöÑ Authenticate Êé•Âè£ÔºåÂÆÉ‰ºöÈ™åËØÅ‰Ω†ÁöÑË∫´‰ªΩÂêàÊ≥ïÊÄß„ÄÇ</p>
<p>ÈÇ£‰πà etcd Â¶Ç‰ΩïÈ™åËØÅ‰Ω†ÂØÜÁ†ÅÊ≠£Á°ÆÊÄßÁöÑÂë¢ÔºüÈâ¥ÊùÉÊ®°ÂùóÈ¶ñÂÖà‰ºöÊ†πÊçÆ‰Ω†ËØ∑Ê±ÇÁöÑÁî®Êà∑Âêç aliceÔºå‰ªé boltdb Ëé∑ÂèñÂä†ÂØÜÂêéÁöÑÂØÜÁ†ÅÔºåÂõ†Ê≠§ hash ÂÄºÂåÖÂê´‰∫ÜÁÆóÊ≥ïÁâàÊú¨„ÄÅsalt„ÄÅcost Á≠â‰ø°ÊÅØÔºåÂõ†Ê≠§ÂèØ‰ª•Ê†πÊçÆ‰Ω†ËØ∑Ê±Ç‰∏≠ÁöÑÊòéÊñáÂØÜÁ†ÅÔºåËÆ°ÁÆóÂá∫ÊúÄÁªàÁöÑ hash ÂÄºÔºåËã•ËÆ°ÁÆóÁªìÊûú‰∏éÂ≠òÂÇ®‰∏ÄËá¥ÔºåÈÇ£‰πàË∫´‰ªΩÊ†°È™åÈÄöËøá„ÄÇ</p>
<p>Â¶Ç‰ΩïÊèêÂçáÂØÜÁ†ÅËÆ§ËØÅÊÄßËÉΩ</p>
<p>ÈÄöËøá‰ª•‰∏äÁöÑÈâ¥ÊùÉÂÆâÂÖ®ÊÄßÁöÑÊ∑±ÂÖ•ÂàÜÊûêÔºåÊàë‰ª¨Áü•ÈÅìË∫´‰ªΩÈ™åËØÅËøô‰∏™ËøáÁ®ãÂºÄÈîÄÊûÅÂÖ∂ÊòÇË¥µÔºåÈÇ£‰πàÈóÆÈ¢òÊù•‰∫ÜÔºåÂ¶Ç‰ΩïÈÅøÂÖçÈ¢ëÁπÅ„ÄÅÊòÇË¥µÁöÑÂØÜÁ†ÅËÆ°ÁÆóÂåπÈÖçÔºåÊèêÂçáÂØÜÁ†ÅËÆ§ËØÅÁöÑÊÄßËÉΩÂë¢ÔºüËøôÂ∞±ÊòØÂØÜÁ†ÅËÆ§ËØÅÁöÑÁ¨¨‰∫å‰∏™ÈöæÁÇπÔºåÂ¶Ç‰Ωï‰øùËØÅÊÄßËÉΩ„ÄÇÊÉ≥ÊÉ≥Êàë‰ª¨ÂäûÁêÜÊ∏ØÊæ≥ÈÄöË°åËØÅÁöÑÊó∂ÂÄôÔºåÊµÅÁ®ãÁâπÂà´Â§çÊùÇÔºåÈúÄË¶ÅÂêÑÁßçË∫´‰ªΩËØÅÊòé„ÄÅÁÖßÁâá„ÄÅÊåáÁ∫π‰ø°ÊÅØÔºåÂäûÁêÜÊàêÂäüÂêéÔºå‰∏ãÂèëÈÄö‰ø°ËØÅÔºåÊØèÊ¨°ËøáÂÖ≥‰Ω†Âè™ÈúÄË¶ÅÂà∑‰∏ãÈÄö‰ø°ËØÅÂç≥ÂèØÔºåÈ´òÊïàËÄå‰æøÊç∑„ÄÇÈÇ£‰πàÔºåÂú®ËΩØ‰ª∂Á≥ªÁªüÈ¢ÜÂüüÂ¶ÇÊûúË∫´‰ªΩÈ™åËØÅÈÄöËøá‰∫ÜÂêéÔºåÊàë‰ª¨ÊòØÂê¶‰πüÂèØ‰ª•ËøîÂõû‰∏Ä‰∏™Á±ª‰ººÈÄö‰ø°ËØÅÁöÑÂá≠ÊçÆÁªô clientÔºåÂêéÁª≠ËØ∑Ê±ÇÊê∫Â∏¶ÈÄö‰ø°ËØÅÔºåÂè™Ë¶ÅÈÄöË°åËØÅÂêàÊ≥ï‰∏îÂú®ÊúâÊïàÊúüÂÜÖÔºåÂ∞±Êó†ÈúÄÂÜçÊ¨°Èâ¥ÊùÉ‰∫ÜÂë¢ÔºüÊòØÁöÑÔºåetcd ‰πüÊúâÁ±ª‰ººËøôÊ†∑ÁöÑÂá≠ÊçÆ„ÄÇÂΩì etcd server È™åËØÅÁî®Êà∑ÂØÜÁ†ÅÊàêÂäüÂêéÔºåÂÆÉÂ∞±‰ºöËøîÂõû‰∏Ä‰∏™ Token Â≠óÁ¨¶‰∏≤Áªô clientÔºåÁî®‰∫éË°®Á§∫Áî®Êà∑ÁöÑË∫´‰ªΩ„ÄÇÂêéÁª≠ËØ∑Ê±ÇÊê∫Â∏¶Ê≠§ TokenÔºåÂ∞±Êó†ÈúÄÂÜçÊ¨°ËøõË°åÂØÜÁ†ÅÊ†°È™åÔºåÂÆûÁé∞‰∫ÜÈÄö‰ø°ËØÅÁöÑÊïàÊûú„ÄÇ</p>
<p>etcd ÁõÆÂâçÊîØÊåÅ‰∏§Áßç TokenÔºåÂàÜÂà´‰∏∫ Simple Token Âíå JWT Token„ÄÇ</p>
<p>Simple Token</p>
<p>Simple Token ÂÆûÁé∞Ê≠£Â¶ÇÂêçÂ≠óÊâÄË®ÄÔºåÁÆÄÂçï„ÄÇSimple Token ÁöÑÊ†∏ÂøÉÂéüÁêÜÊòØÂΩì‰∏Ä‰∏™Áî®Êà∑Ë∫´‰ªΩÈ™åËØÅÈÄöËøáÂêéÔºåÁîüÊàê‰∏Ä‰∏™ÈöèÊú∫ÁöÑÂ≠óÁ¨¶‰∏≤ÂÄº Token ËøîÂõûÁªô clientÔºåÂπ∂Âú®ÂÜÖÂ≠ò‰∏≠‰ΩøÁî® map Â≠òÂÇ®Áî®Êà∑Âíå Token Êò†Â∞ÑÂÖ≥Á≥ª„ÄÇÂΩìÊî∂Âà∞Áî®Êà∑ÁöÑËØ∑Ê±ÇÊó∂Ôºå etcd ‰ºö‰ªéËØ∑Ê±Ç‰∏≠Ëé∑Âèñ Token ÂÄºÔºåËΩ¨Êç¢ÊàêÂØπÂ∫îÁöÑÁî®Êà∑Âêç‰ø°ÊÅØÔºåËøîÂõûÁªô‰∏ãÂ±ÇÊ®°Âùó‰ΩøÁî®„ÄÇ</p>
<p>Token ÊòØ‰Ω†Ë∫´‰ªΩÁöÑË±°ÂæÅÔºåËã•Ê≠§ Token Ê≥ÑÈú≤‰∫ÜÔºåÈÇ£‰Ω†ÁöÑÊï∞ÊçÆÂ∞±ÂèØËÉΩÂ≠òÂú®Ê≥ÑÈú≤ÁöÑÈ£éÈô©„ÄÇetcd ÊòØÂ¶Ç‰ΩïÂ∫îÂØπËøôÁßçÊΩúÂú®ÁöÑÂÆâÂÖ®È£éÈô©Âë¢Ôºüetcd ÁîüÊàêÁöÑÊØè‰∏™ TokenÔºåÈÉΩÊúâ‰∏Ä‰∏™ËøáÊúüÊó∂Èó¥ TTL Â±ûÊÄßÔºåToken ËøáÊúüÂêé client ÈúÄÂÜçÊ¨°È™åËØÅË∫´‰ªΩÔºåÂõ†Ê≠§ÂèØÊòæËëóÁº©Â∞èÊï∞ÊçÆÊ≥ÑÈú≤ÁöÑÊó∂Èó¥Á™óÂè£ÔºåÂú®ÊÄßËÉΩ‰∏ä„ÄÅÂÆâÂÖ®ÊÄß‰∏äÂÆûÁé∞Âπ≥Ë°°„ÄÇÂú® etcd v3.4.9 ÁâàÊú¨‰∏≠ÔºåToken ÈªòËÆ§ÊúâÊïàÊúüÊòØ 5 ÂàÜÈíüÔºåetcd server ‰ºöÂÆöÊó∂Ê£ÄÊü•‰Ω†ÁöÑ Token ÊòØÂê¶ËøáÊúüÔºåËã•ËøáÊúüÂàô‰ªé map Êï∞ÊçÆÁªìÊûÑ‰∏≠Âà†Èô§Ê≠§ Token„ÄÇ</p>
<p>‰∏çËøá‰Ω†Ë¶ÅÊ≥®ÊÑèÁöÑÊòØÔºåSimple Token Â≠óÁ¨¶‰∏≤Êú¨Ë∫´Âπ∂Êú™Âê´‰ªª‰ΩïÊúâ‰ª∑ÂÄº‰ø°ÊÅØÔºåÂõ†Ê≠§ client Êó†Ê≥ïÂèäÊó∂„ÄÅÂáÜÁ°ÆËé∑ÂèñÂà∞ Token ËøáÊúüÊó∂Èó¥„ÄÇÊâÄ‰ª• client ‰∏çÂÆπÊòìÊèêÂâçÂéªËßÑÈÅøÂõ† Token Â§±ÊïàÂØºËá¥ÁöÑËØ∑Ê±ÇÊä•Èîô„ÄÇ</p>
<p>‰ªé‰ª•‰∏ä‰ªãÁªç‰∏≠Ôºå‰Ω†ËßâÂæó Simple Token ÊúâÂì™‰∫õ‰∏çË∂≥‰πãÂ§ÑÔºü‰∏∫‰ªÄ‰πà etcd Á§æÂå∫‰ªÖÂª∫ËÆÆÂú®ÂºÄÂèë„ÄÅÊµãËØïÁéØÂ¢É‰∏≠‰ΩøÁî® Simple Token Âë¢ÔºüÈ¶ñÂÖàÂÆÉÊòØÊúâÁä∂ÊÄÅÁöÑÔºåetcd server ÈúÄË¶Å‰ΩøÁî®ÂÜÖÂ≠òÂ≠òÂÇ® Token ÂíåÁî®Êà∑ÂêçÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇÂÖ∂Ê¨°ÔºåÂÆÉÁöÑÂèØÊèèËø∞ÊÄßÂæàÂº±Ôºåclient Êó†Ê≥ïÈÄöËøá Token Ëé∑ÂèñÂà∞ËøáÊúüÊó∂Èó¥„ÄÅÁî®Êà∑Âêç„ÄÅÁ≠æÂèëËÄÖÁ≠â‰ø°ÊÅØ„ÄÇetcd Èâ¥ÊùÉÊ®°ÂùóÂÆûÁé∞ÁöÑÂè¶Â§ñ‰∏Ä‰∏™ Token Provider ÊñπÊ°à JWTÔºåÊ≠£ÊòØ‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∫õ‰∏çË∂≥‰πãÂ§ÑËÄåÁîü„ÄÇ</p>
<p>JWT Token</p>
<p>JWT ÊòØ Json Web Token Áº©ÂÜôÔºå ÂÆÉÊòØ‰∏Ä‰∏™Âü∫‰∫é JSON ÁöÑÂºÄÊîæÊ†áÂáÜÔºàRFC 7519ÔºâÂÆö‰πâÁöÑ‰∏ÄÁßçÁ¥ßÂáë„ÄÅÁã¨Á´ãÁöÑÊ†ºÂºèÔºåÂèØÁî®‰∫éÂú®Ë∫´‰ªΩÊèê‰æõËÄÖÂíåÊúçÂä°Êèê‰æõËÄÖÈó¥Ôºå‰º†ÈÄíË¢´ËÆ§ËØÅÁöÑÁî®Êà∑Ë∫´‰ªΩ‰ø°ÊÅØ„ÄÇÂÆÉÁî± Header„ÄÅPayload„ÄÅSignature ‰∏â‰∏™ÂØπË±°ÁªÑÊàêÔºå ÊØè‰∏™ÂØπË±°ÈÉΩÊòØ‰∏Ä‰∏™ JSON ÁªìÊûÑ‰Ωì„ÄÇ</p>
<p>Á¨¨‰∏Ä‰∏™ÂØπË±°ÊòØ HeaderÔºåÂÆÉÂåÖÂê´ alg Âíå typ ‰∏§‰∏™Â≠óÊÆµÔºåalg Ë°®Á§∫Á≠æÂêçÁöÑÁÆóÊ≥ïÔºåetcd ÊîØÊåÅ RSA„ÄÅESA„ÄÅPS Á≥ªÂàóÔºåtyp Ë°®Á§∫Á±ªÂûãÂ∞±ÊòØ JWT„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">&#34;alg&#34;: &#34;RS256&#34;Ôºå
</span></span><span class="line"><span class="cl">&#34;typ&#34;: &#34;JWT&#34;
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Á¨¨‰∫åÂØπË±°ÊòØ PayloadÔºåÂÆÉË°®Á§∫ËΩΩËç∑ÔºåÂåÖÂê´Áî®Êà∑Âêç„ÄÅËøáÊúüÊó∂Èó¥Á≠â‰ø°ÊÅØÔºåÂèØ‰ª•Ëá™ÂÆö‰πâÊ∑ªÂä†Â≠óÊÆµ„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">{
</span></span><span class="line"><span class="cl">&#34;username&#34;: usernameÔºå
</span></span><span class="line"><span class="cl">&#34;revision&#34;: revisionÔºå
</span></span><span class="line"><span class="cl">&#34;exp&#34;:      time.Now().Add(t.ttl).Unix()Ôºå
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>Á¨¨‰∏â‰∏™ÂØπË±°ÊòØÁ≠æÂêçÔºåÈ¶ñÂÖàÂÆÉÂ∞Ü header„ÄÅpayload ‰ΩøÁî® base64 url ÁºñÁ†ÅÔºåÁÑ∂ÂêéÂ∞ÜÁºñÁ†ÅÂêéÁöÑÂ≠óÁ¨¶‰∏≤Áî®&quot;.&ldquo;ËøûÊé•Âú®‰∏ÄËµ∑ÔºåÊúÄÂêéÁî®Êàë‰ª¨ÈÄâÊã©ÁöÑÁ≠æÂêçÁÆóÊ≥ïÊØîÂ¶Ç RSA Á≥ªÂàóÁöÑÁßÅÈí•ÂØπÂÖ∂ËÆ°ÁÆóÁ≠æÂêçÔºåËæìÂá∫ÁªìÊûúÂç≥ÊòØ Signature„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">signature</span><span class="o">=</span><span class="n">RSA256</span><span class="p">(</span>
</span></span><span class="line"><span class="cl"><span class="n">base64UrlEncode</span><span class="p">(</span><span class="n">header</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&#34;.&#34;</span> <span class="o">+</span>
</span></span><span class="line"><span class="cl"><span class="n">base64UrlEncode</span><span class="p">(</span><span class="n">payload</span><span class="p">)</span><span class="err">Ôºå</span>
</span></span><span class="line"><span class="cl"><span class="n">key</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>JWT Â∞±ÊòØÁî± base64UrlEncode(header).base64UrlEncode(payload).signature ÁªÑÊàê„ÄÇ</p>
<p>‰∏∫‰ªÄ‰πàËØ¥ JWT ÊòØÁã¨Á´ã„ÄÅÁ¥ßÂáëÁöÑÊ†ºÂºèÂë¢Ôºü‰ªé‰ª•‰∏äÂéüÁêÜ‰ªãÁªç‰∏≠Êàë‰ª¨Áü•ÈÅìÔºåÂÆÉÊòØÊó†Áä∂ÊÄÅÁöÑ„ÄÇJWT Token Ëá™Â∏¶Áî®Êà∑Âêç„ÄÅÁâàÊú¨Âè∑„ÄÅËøáÊúüÊó∂Èó¥Á≠âÊèèËø∞‰ø°ÊÅØÔºåetcd server ‰∏çÈúÄË¶Å‰øùÂ≠òÂÆÉÔºåclient ÂèØÊñπ‰æø„ÄÅÈ´òÊïàÁöÑËé∑ÂèñÂà∞ Token ÁöÑËøáÊúüÊó∂Èó¥„ÄÅÁî®Êà∑ÂêçÁ≠â‰ø°ÊÅØ„ÄÇÂÆÉËß£ÂÜ≥‰∫Ü Simple Token ÁöÑËã•Âπ≤‰∏çË∂≥‰πãÂ§ÑÔºåÂÆâÂÖ®ÊÄßÊõ¥È´òÔºåetcd Á§æÂå∫Âª∫ËÆÆÂ§ßÂÆ∂Âú®Áîü‰∫ßÁéØÂ¢ÉËã•‰ΩøÁî®‰∫ÜÂØÜÁ†ÅËÆ§ËØÅÔºåÂ∫î‰ΩøÁî® JWT Token( &ndash;auth-token &lsquo;jwt&rsquo;)ÔºåËÄå‰∏çÊòØÈªòËÆ§ÁöÑ Simple Token„ÄÇ</p>
<p>Âú®Áªô‰Ω†‰ªãÁªçÂÆåÂØÜÁ†ÅËÆ§ËØÅÂÆûÁé∞ËøáÁ®ã‰∏≠ÁöÑ‰∏§‰∏™Ê†∏ÂøÉÊåëÊàòÔºåÂØÜÁ†ÅÂ≠òÂÇ®ÂÆâÂÖ®ÂíåÊÄßËÉΩÁöÑËß£ÂÜ≥ÊñπÊ°à‰πãÂêéÔºå‰Ω†ÊòØÂê¶ÂØπÂØÜÁ†ÅËÆ§ËØÅÁöÑÂÆâÂÖ®ÊÄß„ÄÅÊÄßËÉΩËøòÊúâÊâÄÊãÖÂøßÂë¢ÔºüÊé•‰∏ãÊù•ÊàëÁªô‰Ω†‰ªãÁªç etcd ÁöÑÂè¶Â§ñ‰∏ÄÁßçÈ´òÊÄßËÉΩ„ÄÅÊõ¥ÂÆâÂÖ®ÁöÑÈâ¥ÊùÉÊñπÊ°àÔºåx509 ËØÅ‰π¶ËÆ§ËØÅ„ÄÇ</p>
<p>Âè¶Â§ñ‰∏ÄÁßçÊñπÂºèËØÅ‰π¶ËÆ§ËØÅ</p>
<p>ÂØÜÁ†ÅËÆ§ËØÅ‰∏ÄËà¨‰ΩøÁî®Âú® client Âíå server Âü∫‰∫é HTTP ÂçèËÆÆÈÄö‰ø°ÁöÑÂÜÖÁΩëÂú∫ÊôØ‰∏≠„ÄÇÂΩìÂØπÂÆâÂÖ®ÊúâÊõ¥È´òË¶ÅÊ±ÇÁöÑÊó∂ÂÄôÔºå‰Ω†ÈúÄË¶Å‰ΩøÁî® HTTPS ÂçèËÆÆÂä†ÂØÜÈÄö‰ø°Êï∞ÊçÆÔºåÈò≤Ê≠¢‰∏≠Èó¥‰∫∫ÊîªÂáªÂíåÊï∞ÊçÆË¢´ÁØ°ÊîπÁ≠âÂÆâÂÖ®È£éÈô©„ÄÇHTTPS ÊòØÂà©Áî®ÈùûÂØπÁß∞Âä†ÂØÜÂÆûÁé∞Ë∫´‰ªΩËÆ§ËØÅÂíåÂØÜÈí•ÂçèÂïÜÔºåÂõ†Ê≠§‰ΩøÁî® HTTPS ÂçèËÆÆÁöÑÊó∂ÂÄôÔºå‰Ω†ÈúÄË¶Å‰ΩøÁî® CA ËØÅ‰π¶Áªô client ÁîüÊàêËØÅ‰π¶ÊâçËÉΩËÆøÈóÆ„ÄÇÈÇ£‰πà‰∏Ä‰∏™ client ËØÅ‰π¶ÂåÖÂê´Âì™‰∫õ‰ø°ÊÅØÂë¢Ôºü‰ΩøÁî®ËØÅ‰π¶ËÆ§ËØÅÁöÑÊó∂ÂÄôÔºåetcd server Â¶Ç‰ΩïÁü•ÈÅì‰Ω†ÂèëÈÄÅÁöÑËØ∑Ê±ÇÂØπÂ∫îÁöÑÁî®Êà∑ÂêçÁß∞ÔºüÊàë‰ª¨ÂèØ‰ª•‰ΩøÁî®‰∏ãÈù¢ÁöÑ openssl ÂëΩ‰ª§Êü•Áúã client ËØÅ‰π¶ÁöÑÂÜÖÂÆπÔºå‰∏ãÂõæÊòØ‰∏Ä‰∏™ x509 client ËØÅ‰π¶ÁöÑÂÜÖÂÆπÔºåÂÆÉÂê´ÊúâËØÅ‰π¶ÁâàÊú¨„ÄÅÂ∫èÂàóÂè∑„ÄÅÁ≠æÂêçÁÆóÊ≥ï„ÄÅÁ≠æÂèëËÄÖ„ÄÅÊúâÊïàÊúü„ÄÅ‰∏ª‰ΩìÂêçÁ≠â‰ø°ÊÅØÔºåÊàë‰ª¨ÈáçÁÇπË¶ÅÂÖ≥Ê≥®ÁöÑÊòØ‰∏ª‰ΩìÂêç‰∏≠ÁöÑ CN Â≠óÊÆµ„ÄÇÂú® etcd ‰∏≠ÔºåÂ¶ÇÊûú‰Ω†‰ΩøÁî®‰∫Ü HTTPS ÂçèËÆÆÂπ∂ÂêØÁî®‰∫Ü client ËØÅ‰π¶ËÆ§ËØÅ (&ndash;client-cert-auth)ÔºåÂÆÉ‰ºöÂèñ CN Â≠óÊÆµ‰Ωú‰∏∫Áî®Êà∑ÂêçÔºåÂú®Êàë‰ª¨ÁöÑÊ°à‰æã‰∏≠Ôºåalice Â∞±ÊòØ client ÂèëÈÄÅËØ∑Ê±ÇÁöÑÁî®Êà∑Âêç„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">openssl x509 -noout -text -in client.pem
</span></span></code></pre></td></tr></table>
</div>
</div><p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/ca%e5%8a%a0%e5%af%86%e8%af%81%e4%b9%a6%e7%9a%84%e5%86%85%e5%ae%b9.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>ËØÅ‰π¶ËÆ§ËØÅÂú®Á®≥ÂÆöÊÄß„ÄÅÊÄßËÉΩ‰∏äÈÉΩ‰ºò‰∫éÂØÜÁ†ÅËÆ§ËØÅ„ÄÇÁ®≥ÂÆöÊÄß‰∏äÔºåÂÆÉ‰∏çÂ≠òÂú® Token ËøáÊúü„ÄÅ‰ΩøÁî®Êõ¥Âä†Êñπ‰æø„ÄÅ‰ºöËÆ©‰Ω†Â∞ëË∏©ÂùëÔºåÈÅøÂÖç‰∫Ü‰∏çÂ∞ë Token Â§±ÊïàËÄåËß¶ÂèëÁöÑ Bug„ÄÇÊÄßËÉΩ‰∏äÔºåËØÅ‰π¶ËÆ§ËØÅÊó†ÈúÄÂÉèÂØÜÁ†ÅËÆ§ËØÅ‰∏ÄÊ†∑Ë∞ÉÁî®ÊòÇË¥µÁöÑÂØÜÁ†ÅËÆ§ËØÅÊìç‰Ωú (Authenticate ËØ∑Ê±Ç)ÔºåÊ≠§Êé•Âè£ÊîØÊåÅÁöÑÊÄßËÉΩÊûÅ‰ΩéÔºåÂêéÈù¢ÂÆûË∑µÁØá‰ºöÂíå‰Ω†Ê∑±ÂÖ•ËÆ®ËÆ∫„ÄÇ</p>
<p>ÊéàÊùÉ</p>
<p>ÂΩìÊàë‰ª¨‰ΩøÁî®Â¶Ç‰∏äÂàõÂª∫ÁöÑ alice Ë¥¶Âè∑ÊâßË°å put hello Êìç‰ΩúÁöÑÊó∂ÂÄôÔºåetcd Âç¥‰ºöËøîÂõûÂ¶Ç‰∏ãÁöÑ&quot;etcdserver: permission denied&quot;Êó†ÊùÉÈôêÈîôËØØÔºåËøôÊòØ‰∏∫‰ªÄ‰πàÂë¢Ôºü</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-zed" data-lang="zed"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">$</span><span class="w"> </span><span class="n">etcdctl</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">hello</span><span class="w"> </span><span class="n">world</span><span class="w"> </span><span class="o">--</span><span class="n">user</span><span class="w"> </span><span class="n">alice</span><span class="o">:</span><span class="n">alice</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">etcdserver</span><span class="o">:</span><span class="w"> </span><span class="kd">permission</span><span class="w"> </span><span class="n">denied</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>ËøôÊòØÂõ†‰∏∫ÂºÄÂêØÈâ¥ÊùÉÂêéÔºåput ËØ∑Ê±ÇÂëΩ‰ª§Âú®Â∫îÁî®Âà∞Áä∂ÊÄÅÊú∫ÂâçÔºåetcd Ëøò‰ºöÂØπÂèëÂá∫Ê≠§ËØ∑Ê±ÇÁöÑÁî®Êà∑ËøõË°åÊùÉÈôêÊ£ÄÊü•Ôºå Âà§Êñ≠ÂÖ∂ÊòØÂê¶ÊúâÊùÉÈôêÊìç‰ΩúËØ∑Ê±ÇÁöÑÊï∞ÊçÆ„ÄÇÂ∏∏Áî®ÁöÑÊùÉÈôêÊéßÂà∂ÊñπÊ≥ïÊúâ ACL(Access Control List)„ÄÅABAC(Attribute-based access control)„ÄÅRBAC(Role-based access control)Ôºåetcd ÂÆûÁé∞ÁöÑÊòØ RBAC Êú∫Âà∂„ÄÇ</p>
<p><strong>RBAC‰ªÄ‰πàÊòØÂü∫‰∫éËßíËâ≤ÊùÉÈôêÁöÑÊéßÂà∂Á≥ªÁªü (RBAC) Âë¢ÔºüÂÆÉÁî±‰∏ãÂõæ‰∏≠ÁöÑ‰∏âÈÉ®ÂàÜÁªÑÊàêÔºåUser„ÄÅRole„ÄÅPermission„ÄÇUser Ë°®Á§∫Áî®Êà∑ÔºåÂ¶Ç alice„ÄÇRole Ë°®Á§∫ËßíËâ≤ÔºåÂÆÉÊòØÊùÉÈôêÁöÑËµã‰∫àÂØπË±°„ÄÇPermission Ë°®Á§∫ÂÖ∑‰ΩìÊùÉÈôêÊòéÁªÜÔºåÊØîÂ¶ÇËµã‰∫à Role ÂØπ key ËåÉÂõ¥Âú®[keyÔºåKeyEnd]Êï∞ÊçÆÊã•Êúâ‰ªÄ‰πàÊùÉÈôê„ÄÇÁõÆÂâçÊîØÊåÅ‰∏âÁßçÊùÉÈôêÔºåÂàÜÂà´ÊòØ READ„ÄÅWRITE„ÄÅREADWRITE„ÄÇ</strong></p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/etcd%e8%a7%92%e8%89%b2%e6%9d%83%e9%99%90%e6%8e%a7%e5%88%b6%e7%b3%bb%e7%bb%9f%28RBAC%29.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>‰∏ãÈù¢Êàë‰ª¨ÈÄöËøá etcd ÁöÑ RBAC Êú∫Âà∂ÔºåÁªô alice Áî®Êà∑Ëµã‰∫à‰∏Ä‰∏™ÂèØËØªÂÜô[hello,helly]Êï∞ÊçÆËåÉÂõ¥ÁöÑËØªÂÜôÊùÉÈôêÔºå Â¶Ç‰ΩïÊìç‰ΩúÂë¢?ÊåâÁÖß‰∏äÈù¢‰ªãÁªçÁöÑ RBAC ÂéüÁêÜÔºåÈ¶ñÂÖà‰Ω†ÈúÄË¶ÅÂàõÂª∫‰∏Ä‰∏™ roleÔºåËøôÈáåÊàë‰ª¨ÂëΩÂêç‰∏∫ adminÔºåÁÑ∂ÂêéÊñ∞Â¢û‰∫Ü‰∏Ä‰∏™ÂèØËØªÂÜô[hello,helly]Êï∞ÊçÆËåÉÂõ¥ÁöÑÊùÉÈôêÁªô admin ËßíËâ≤ÔºåÂπ∂Â∞Ü admin ÁöÑËßíËâ≤ÁöÑÊùÉÈôêÊéà‰∫à‰∫ÜÁî®Êà∑ alice„ÄÇËØ¶ÁªÜÂ¶Ç‰∏ãÔºö</p>
<p>ÊåâÁÖß‰∏äÈù¢‰ªãÁªçÁöÑ RBAC ÂéüÁêÜÔºåÈ¶ñÂÖà‰Ω†ÈúÄË¶ÅÂàõÂª∫‰∏Ä‰∏™ roleÔºåËøôÈáåÊàë‰ª¨ÂëΩÂêç‰∏∫ adminÔºåÁÑ∂ÂêéÊñ∞Â¢û‰∫Ü‰∏Ä‰∏™ÂèØËØªÂÜô[hello,helly]Êï∞ÊçÆËåÉÂõ¥ÁöÑÊùÉÈôêÁªô admin ËßíËâ≤ÔºåÂπ∂Â∞Ü admin ÁöÑËßíËâ≤ÁöÑÊùÉÈôêÊéà‰∫à‰∫ÜÁî®Êà∑ alice„ÄÇËØ¶ÁªÜÂ¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">$ <span class="c1">#ÂàõÂª∫‰∏Ä‰∏™admin role </span>
</span></span><span class="line"><span class="cl">etcdctl role add admin  --user root:root
</span></span><span class="line"><span class="cl">Role admin created
</span></span><span class="line"><span class="cl"><span class="c1"># #ÂàÜÈÖç‰∏Ä‰∏™ÂèØËØªÂÜô[helloÔºåhelly]ËåÉÂõ¥Êï∞ÊçÆÁöÑÊùÉÈôêÁªôadmin role</span>
</span></span><span class="line"><span class="cl">$ etcdctl role grant-permission admin readwrite hello helly --user root:root
</span></span><span class="line"><span class="cl">Role admin updated
</span></span><span class="line"><span class="cl"><span class="c1"># Â∞ÜÁî®Êà∑aliceÂíåadmin roleÂÖ≥ËÅîËµ∑Êù•ÔºåËµã‰∫àadminÊùÉÈôêÁªôuser</span>
</span></span><span class="line"><span class="cl">$ etcdctl user grant-role alice admin --user root:root
</span></span><span class="line"><span class="cl">Role admin is granted to user alice
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÁÑ∂ÂêéÂΩì‰Ω†ÂÜçÊ¨°‰ΩøÁî® etcdctl ÊâßË°å put hello ÂëΩ‰ª§Êó∂ÔºåÈâ¥ÊùÉÊ®°Âùó‰ºö‰ªé boltdb Êü•ËØ¢ alice Áî®Êà∑ÂØπÂ∫îÁöÑÊùÉÈôêÂàóË°®„ÄÇ</p>
<p>Âõ†‰∏∫ÊúâÂèØËÉΩ‰∏Ä‰∏™Áî®Êà∑Êã•ÊúâÊàêÁôæ‰∏äÂçÉ‰∏™ÊùÉÈôêÂàóË°®Ôºåetcd ‰∏∫‰∫ÜÊèêÂçáÊùÉÈôêÊ£ÄÊü•ÁöÑÊÄßËÉΩÔºåÂºïÂÖ•‰∫ÜÂå∫Èó¥Ê†ëÔºåÊ£ÄÊü•Áî®Êà∑Êìç‰ΩúÁöÑ key ÊòØÂê¶Âú®Â∑≤ÊéàÊùÉÁöÑÂå∫Èó¥ÔºåÊó∂Èó¥Â§çÊùÇÂ∫¶‰ªÖ‰∏∫ O(logN)„ÄÇ</p>
<p>Âú®Êàë‰ª¨ÁöÑËøô‰∏™Ê°à‰æã‰∏≠ÔºåÂæàÊòéÊòæ hello Âú® admin ËßíËâ≤ÂèØËØªÂÜôÁöÑ[helloÔºåhelly) Êï∞ÊçÆËåÉÂõ¥ÂÜÖÔºåÂõ†Ê≠§ÂÆÉÊúâÊùÉÈôêÊõ¥Êñ∞ key helloÔºåÊâßË°åÊàêÂäü„ÄÇ‰Ω†‰πüÂèØ‰ª•Â∞ùËØïÊõ¥Êñ∞ key heyÔºåÂõ†‰∏∫Ê≠§ key Êú™Âú®Èâ¥ÊùÉÁöÑÊï∞ÊçÆÂå∫Èó¥ÂÜÖÔºåÂõ†Ê≠§ etcd server ‰ºöËøîÂõû&quot;etcdserver: permission denied&quot;ÈîôËØØÁªô clientÔºåÂ¶Ç‰∏ãÊâÄÁ§∫„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-zed" data-lang="zed"><span class="line"><span class="cl"><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">$</span><span class="w"> </span><span class="n">etcdctl</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">hello</span><span class="w"> </span><span class="n">world</span><span class="w"> </span><span class="o">--</span><span class="n">user</span><span class="w"> </span><span class="n">alice</span><span class="o">:</span><span class="n">alice</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">OK</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="err">$</span><span class="w"> </span><span class="n">etcdctl</span><span class="w"> </span><span class="n">put</span><span class="w"> </span><span class="n">hey</span><span class="w"> </span><span class="n">hey</span><span class="w"> </span><span class="o">--</span><span class="n">user</span><span class="w"> </span><span class="n">alice</span><span class="o">:</span><span class="n">alice</span><span class="w">
</span></span></span><span class="line"><span class="cl"><span class="w"></span><span class="n">Error</span><span class="o">:</span><span class="w"> </span><span class="n">etcdserver</span><span class="o">:</span><span class="w"> </span><span class="kd">permission</span><span class="w"> </span><span class="n">denied</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>Â∞èÁªì</p>
<p>ÊúÄÂêéÊàëÂíå‰Ω†ÊÄªÁªì‰∏ã‰ªäÂ§©ÁöÑÂÜÖÂÆπÔºå‰ªé etcd Èâ¥ÊùÉÊ®°ÂùóÊ†∏ÂøÉÂéüÁêÜÂàÜÊûêËøáÁ®ã‰∏≠Ôºå‰Ω†‰ºöÂèëÁé∞ËÆæËÆ°ÂÆûÁé∞‰∏Ä‰∏™Èâ¥ÊùÉÊ®°ÂùóÊúÄÂÖ≥ÈîÆÁöÑÁõÆÊ†áÂíåÊåëÊàòÂ∫îËØ•ÊòØÂÆâÂÖ®„ÄÅÊÄßËÉΩ‰ª•Âèä‰∏ÄËá¥ÊÄß„ÄÇÈ¶ñÂÖàÈâ¥ÊùÉÁõÆÁöÑÊòØ‰∏∫‰∫Ü‰øùËØÅÂÆâÂÖ®ÔºåÂøÖÈ°ªÈò≤Ê≠¢ÊÅ∂ÊÑèÁî®Êà∑ÁªïËøáÈâ¥ÊùÉÁ≥ªÁªü„ÄÅ‰º™ÈÄ†„ÄÅÁØ°Êîπ„ÄÅË∂äÊùÉÁ≠âË°å‰∏∫ÔºåÂêåÊó∂ËÆæËÆ°‰∏äË¶ÅÊúâÂâçÁûªÊÄßÔºåÂÅöÂà∞Âç≥‰ΩøË¢´ÊãñÂ∫ì‰πüÂΩ±ÂìçÂèØÊéß„ÄÇetcd ÁöÑËß£ÂÜ≥ÊñπÊ°àÊòØÈÄöËøáÂØÜÁ†ÅÂÆâÂÖ®Âä†ÂØÜÂ≠òÂÇ®„ÄÅËØÅ‰π¶ËÆ§ËØÅ„ÄÅRBAC Á≠âÊú∫Âà∂‰øùËØÅÂÖ∂ÂÆâÂÖ®ÊÄß„ÄÇÁÑ∂ÂêéÔºåÈâ¥ÊùÉ‰Ωú‰∏∫‰∫Ü‰∏Ä‰∏™Ê†∏ÂøÉÁöÑÂâçÁΩÆÊ®°ÂùóÔºåÊÄßËÉΩ‰∏ä‰∏çËÉΩÊãñÂêéËÖøÔºå‰∏çËÉΩÊàê‰∏∫ÂΩ±Âìç‰∏öÂä°ÊÄßËÉΩÁöÑ‰∏Ä‰∏™Ê†∏ÂøÉÁì∂È¢à„ÄÇetcd ÁöÑËß£ÂÜ≥ÊñπÊ°àÊòØÈÄöËøá Token Èôç‰ΩéÈ¢ëÁπÅ„ÄÅÊòÇË¥µÁöÑÂØÜÁ†ÅÈ™åËØÅÂºÄÈîÄÔºåÂèØÂ∫îÁî®Âú®ÂÜÖÁΩë„ÄÅÂ∞èËßÑÊ®°‰∏öÂä°Âú∫ÊôØÔºåÂêåÊó∂ÊîØÊåÅ‰ΩøÁî®ËØÅ‰π¶ËÆ§ËØÅÔºå‰∏çÂ≠òÂú® Token ËøáÊúüÔºåÂ∑ßÂ¶ôÁöÑÂèñ CN Â≠óÊÆµ‰Ωú‰∏∫Áî®Êà∑ÂêçÔºåÂèØÊª°Ë∂≥ËæÉÂ§ßËßÑÊ®°ÁöÑ‰∏öÂä°Âú∫ÊôØÈâ¥ÊùÉËØâÊ±Ç„ÄÇÊé•ÁùÄÔºåÈâ¥ÊùÉÁ≥ªÁªüÈù¢‰∏¥ÁöÑ‰∏öÂä°Âú∫ÊôØÊòØÂ§çÊùÇÁöÑÔºåÂõ†Ê≠§ÊùÉÈôêÊéßÂà∂Á≥ªÁªüÂ∫îÂΩìÂÖ∑Â§áËâØÂ•ΩÁöÑÊâ©Â±ïÊÄßÔºå‰∏öÂä°ÂèØÊ†πÊçÆËá™Â∑±ÂÆûÈôÖÂú∫ÊôØÈÄâÊã©ÂêàÈÄÇÁöÑÈâ¥ÊùÉÊñπÊ≥ï„ÄÇetcd ÁöÑ Token Provider Âíå RBAC Êâ©Â±ïÊú∫Âà∂ÔºåÈÉΩÂÖ∑Â§áËæÉÂ•ΩÁöÑÊâ©Â±ïÊÄß„ÄÅÁÅµÊ¥ªÊÄß„ÄÇÂ∞§ÂÖ∂ÊòØ RBAC Êú∫Âà∂ÔºåËÆ©‰Ω†ÂèØ‰ª•Á≤æÁªÜÂåñÁöÑÊéßÂà∂ÊØè‰∏™Áî®Êà∑ÊùÉÈôêÔºåÂÆûÁé∞ÊùÉÈôêÊúÄÂ∞èÂåñÂàÜÈÖç„ÄÇÊúÄÂêéÈâ¥ÊùÉÁ≥ªÁªüÂÖÉÊï∞ÊçÆÁöÑÂ≠òÂÇ®Â∫îÂΩìÊòØÂèØÈù†ÁöÑÔºåÂêÑ‰∏™ËäÇÁÇπÈâ¥ÊùÉÊï∞ÊçÆÂ∫îÁ°Æ‰øù‰∏ÄËá¥ÔºåÁ°Æ‰øùÈâ¥ÊùÉË°å‰∏∫‰∏ÄËá¥ÊÄß„ÄÇÊó©Êúü etcd v2 ÁâàÊú¨Êó∂ÔºåÂõ†Èâ¥ÊùÉÂëΩ‰ª§Êú™ÁªèËøá Raft Ê®°ÂùóÔºåÂ≠òÂú®Êï∞ÊçÆ‰∏ç‰∏ÄËá¥ÁöÑÈóÆÈ¢òÔºåÂú® etcd v3 ‰∏≠ÈÄöËøá Raft Ê®°ÂùóÂêåÊ≠•Èâ¥ÊùÉÊåá‰ª§Êó•ÂøóÊåá‰ª§ÔºåÂÆûÁé∞Èâ¥ÊùÉÊï∞ÊçÆ‰∏ÄËá¥ÊÄß„ÄÇ</p>
<h2 id="ËøôÈáåÈúÄË¶ÅË°•ÂÖÖ‰∏Ä‰∏™etcdÁöÑÁî®Êà∑ÁÆ°ÁêÜÊìç‰ΩúÂõûÂ§çÁöÑ">ËøôÈáåÈúÄË¶ÅË°•ÂÖÖ‰∏Ä‰∏™etcdÁöÑÁî®Êà∑ÁÆ°ÁêÜÊìç‰ΩúÔºàÂõûÂ§çÁöÑÔºâ</h2>
<h2 id="etcdÁßüÁ∫¶-lease">etcdÁßüÁ∫¶ lease</h2>
<p>‰ªäÂ§©ÊàëË¶ÅË∑ü‰Ω†ÂàÜ‰∫´ÁöÑ‰∏ªÈ¢òÊòØÁßüÁ∫¶ÔºàLeaseÔºâ„ÄÇetcd ÁöÑ‰∏Ä‰∏™ÂÖ∏ÂûãÁöÑÂ∫îÁî®Âú∫ÊôØÊòØ Leader ÈÄâ‰∏æÔºåÈÇ£‰πà etcd ‰∏∫‰ªÄ‰πàÂèØ‰ª•Áî®Êù•ÂÆûÁé∞ Leader ÈÄâ‰∏æÔºüÊ†∏ÂøÉÁâπÊÄßÂÆûÁé∞ÂéüÁêÜÂèàÊòØÊÄéÊ†∑ÁöÑÔºü‰ªäÂ§©ÊàëÂ∞±Âíå‰Ω†ËÅäËÅä Leader ÈÄâ‰∏æËÉåÂêéÊäÄÊúØÁÇπ‰πã‰∏ÄÁöÑ LeaseÔºå Ëß£ÊûêÂÆÉÁöÑÊ†∏ÂøÉÂéüÁêÜ„ÄÅÊÄßËÉΩ‰ºòÂåñÊÄùË∑ØÔºåÂ∏åÊúõÈÄöËøáÊú¨ËäÇËÆ©‰Ω†ÂØπ Lease Â¶Ç‰ΩïÂÖ≥ËÅî key„ÄÅLease Â¶Ç‰ΩïÈ´òÊïàÁª≠Êúü„ÄÅÊ∑òÊ±∞„ÄÅ‰ªÄ‰πàÊòØ checkpoint Êú∫Âà∂ÊúâÊ∑±ÂÖ•ÁöÑÁêÜËß£„ÄÇÂêåÊó∂Â∏åÊúõ‰Ω†ËÉΩÂü∫‰∫é Lease ÁöÑ TTL ÁâπÊÄßÔºåËß£ÂÜ≥ÂÆûÈôÖ‰∏öÂä°‰∏≠ÈÅáÂà∞ÂàÜÂ∏ÉÂºèÈîÅ„ÄÅËäÇÁÇπÊïÖÈöúËá™Âä®ÂâîÈô§Á≠âÂêÑÁ±ªÈóÆÈ¢òÔºåÊèêÈ´ò‰∏öÂä°ÊúçÂä°ÁöÑÂèØÁî®ÊÄß„ÄÇ</p>
<p>‰ªÄ‰πàÊòØ Lease</p>
<p>Âú®ÂÆûÈôÖ‰∏öÂä°Âú∫ÊôØ‰∏≠ÔºåÊàë‰ª¨Â∏∏Â∏∏‰ºöÈÅáÂà∞Á±ª‰ºº Kubernetes ÁöÑË∞ÉÂ∫¶Âô®„ÄÅÊéßÂà∂Âô®ÁªÑ‰ª∂Âêå‰∏ÄÊó∂ÂàªÂè™ËÉΩÂ≠òÂú®‰∏Ä‰∏™ÂâØÊú¨ÂØπÂ§ñÊèê‰æõÊúçÂä°ÁöÑÊÉÖÂÜµ„ÄÇÁÑ∂ËÄåÂçïÂâØÊú¨ÈÉ®ÁΩ≤ÁöÑÁªÑ‰ª∂ÔºåÊòØÊó†Ê≥ï‰øùËØÅÂÖ∂È´òÂèØÁî®ÊÄßÁöÑ„ÄÇÈÇ£‰∏∫‰∫ÜËß£ÂÜ≥ÂçïÂâØÊú¨ÁöÑÂèØÁî®ÊÄßÈóÆÈ¢òÔºåÊàë‰ª¨Â∞±ÈúÄË¶ÅÂ§öÂâØÊú¨ÈÉ®ÁΩ≤„ÄÇÂêåÊó∂Ôºå‰∏∫‰∫Ü‰øùËØÅÂêå‰∏ÄÊó∂ÂàªÂè™Êúâ‰∏Ä‰∏™ËÉΩÂØπÂ§ñÊèê‰æõÊúçÂä°ÔºåÊàë‰ª¨ÈúÄË¶ÅÂºïÂÖ• Leader ÈÄâ‰∏æÊú∫Âà∂„ÄÇÈÇ£‰πà Leader ÈÄâ‰∏æÊú¨Ë¥®ÊòØË¶ÅËß£ÂÜ≥‰ªÄ‰πàÈóÆÈ¢òÂë¢ÔºüÈ¶ñÂÖàÂΩìÁÑ∂ÊòØË¶Å‰øùËØÅ Leader ÁöÑÂîØ‰∏ÄÊÄßÔºåÁ°Æ‰øùÈõÜÁæ§‰∏çÂá∫Áé∞Â§ö‰∏™ LeaderÔºåÊâçËÉΩ‰øùËØÅ‰∏öÂä°ÈÄªËæëÂáÜÁ°ÆÊÄßÔºå‰πüÂ∞±ÊòØÂÆâÂÖ®ÊÄßÔºàSafetyÔºâ„ÄÅ‰∫íÊñ•ÊÄß„ÄÇ</p>
<p>ÂÖ∂Ê¨°ÊòØ‰∏ªËäÇÁÇπÊïÖÈöúÂêéÔºåÂ§áËäÇÁÇπÂ∫îÂèØÂø´ÈÄüÊÑüÁü•Âà∞ÂÖ∂ÂºÇÂ∏∏Ôºå‰πüÂ∞±ÊòØÊ¥ªÊÄßÔºàlivenessÔºâÊ£ÄÊµã„ÄÇÂÆûÁé∞Ê¥ªÊÄßÊ£ÄÊµã‰∏ªË¶ÅÊúâ‰∏§ÁßçÊñπÊ°à„ÄÇ</p>
<p>ÊñπÊ°à‰∏Ä‰∏∫Ë¢´Âä®ÂûãÊ£ÄÊµãÔºå‰Ω†ÂèØ‰ª•ÈÄöËøáÊé¢ÊµãËäÇÁÇπÂÆöÊó∂Êã®Êµã Leader ËäÇÁÇπÔºåÁúãÊòØÂê¶ÂÅ•Â∫∑ÔºåÊØîÂ¶Ç Redis Sentinel„ÄÇ</p>
<p>ÊñπÊ°à‰∫å‰∏∫‰∏ªÂä®Âûã‰∏äÊä•ÔºåLeader ËäÇÁÇπÂèØÂÆöÊúüÂêëÂçèË∞ÉÊúçÂä°ÂèëÈÄÅ&quot;ÁâπÊÆäÂøÉË∑≥&quot;Ê±áÊä•ÂÅ•Â∫∑Áä∂ÊÄÅÔºåËã•ÂÖ∂Êú™Ê≠£Â∏∏ÂèëÈÄÅÂøÉË∑≥ÔºåÂπ∂Ë∂ÖËøáÂíåÂçèË∞ÉÊúçÂä°Á∫¶ÂÆöÁöÑÊúÄÂ§ßÂ≠òÊ¥ªÊó∂Èó¥ÂêéÔºåÂ∞±‰ºöË¢´ÂçèË∞ÉÊúçÂä°ÁßªÈô§ Leader Ë∫´‰ªΩÊ†áËØÜ„ÄÇÂêåÊó∂ÂÖ∂‰ªñËäÇÁÇπÂèØÈÄöËøáÂçèË∞ÉÊúçÂä°ÔºåÂø´ÈÄüÊÑüÁü•Âà∞ Leader ÊïÖÈöú‰∫ÜÔºåËøõËÄåÂèëËµ∑Êñ∞ÁöÑÈÄâ‰∏æ„ÄÇ</p>
<p>Êàë‰ª¨‰ªäÂ§©ÁöÑ‰∏ªÈ¢òÔºåLeaseÔºåÊ≠£ÊòØÂü∫‰∫é‰∏ªÂä®Âûã‰∏äÊä•Ê®°ÂºèÔºåÊèê‰æõÁöÑ‰∏ÄÁßçÊ¥ªÊÄßÊ£ÄÊµãÊú∫Âà∂„ÄÇLease È°æÂêçÊÄù‰πâÔºåclient Âíå etcd server ‰πãÈó¥Â≠òÂú®‰∏Ä‰∏™Á∫¶ÂÆöÔºåÂÜÖÂÆπÊòØ etcd server ‰øùËØÅÂú®Á∫¶ÂÆöÁöÑÊúâÊïàÊúüÂÜÖÔºàTTLÔºâÔºå‰∏ç‰ºöÂà†Èô§‰Ω†ÂÖ≥ËÅîÂà∞Ê≠§ Lease ‰∏äÁöÑ key-value„ÄÇ</p>
<p>Ëã•‰Ω†Êú™Âú®ÊúâÊïàÊúüÂÜÖÁª≠ÁßüÔºåÈÇ£‰πà etcd server Â∞±‰ºöÂà†Èô§ Lease ÂíåÂÖ∂ÂÖ≥ËÅîÁöÑ key-value„ÄÇ‰Ω†ÂèØ‰ª•Âü∫‰∫é Lease ÁöÑ TTL ÁâπÊÄßÔºåËß£ÂÜ≥Á±ª‰ºº Leader ÈÄâ‰∏æ„ÄÅKubernetes Event Ëá™Âä®Ê∑òÊ±∞„ÄÅÊúçÂä°ÂèëÁé∞Âú∫ÊôØ‰∏≠ÊïÖÈöúËäÇÁÇπËá™Âä®ÂâîÈô§Á≠âÈóÆÈ¢ò„ÄÇ‰∏∫‰∫ÜÂ∏ÆÂä©‰Ω†ÁêÜËß£ Lease ÁöÑÊ†∏ÂøÉÁâπÊÄßÂéüÁêÜÔºåÊàë‰ª•‰∏Ä‰∏™ÂÆûÈôÖÂú∫ÊôØ‰∏≠ÁöÑÁªèÂ∏∏ÈÅáÂà∞ÁöÑÂºÇÂ∏∏ËäÇÁÇπËá™Âä®ÂâîÈô§‰∏∫Ê°à‰æãÔºåÂõ¥ÁªïËøô‰∏™ÈóÆÈ¢òÔºåÁªô‰Ω†Ê∑±ÂÖ•‰ªãÁªç Lease ÁâπÊÄßÁöÑÂÆûÁé∞„ÄÇ</p>
<p>Âú®Ëøô‰∏™Ê°à‰æã‰∏≠ÔºåÊàë‰ª¨ÊúüÊúõÁöÑÊïàÊûúÊòØÔºåÂú®ËäÇÁÇπÂºÇÂ∏∏Êó∂ÔºåË°®Á§∫ËäÇÁÇπÂÅ•Â∫∑ÁöÑ key ËÉΩË¢´‰ªé etcd ÈõÜÁæ§‰∏≠Ëá™Âä®Âà†Èô§„ÄÇ</p>
<p>leaseÊï¥‰ΩìÊû∂ÊûÑ</p>
<p>Âú®Âíå‰Ω†ËØ¶ÁªÜËß£ËØª Lease ÁâπÊÄßÂ¶Ç‰ΩïËß£ÂÜ≥‰∏äÈù¢ÁöÑÈóÆÈ¢ò‰πãÂâçÔºåÊàë‰ª¨ÂÖà‰∫ÜËß£‰∏ã Lease Ê®°ÂùóÁöÑÊï¥‰ΩìÊû∂ÊûÑÔºå‰∏ãÂõæÊòØÊàëÁªô‰Ω†ÁîªÁöÑ Lease Ê®°ÂùóÁÆÄË¶ÅÊû∂ÊûÑÂõæ„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/lease%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>etcd Âú®ÂêØÂä®ÁöÑÊó∂ÂÄôÔºåÂàõÂª∫ Lessor Ê®°ÂùóÁöÑÊó∂ÂÄôÔºåÂÆÉ‰ºöÂêØÂä®‰∏§‰∏™Â∏∏È©ª goroutineÔºåÂ¶Ç‰∏äÂõæÊâÄÁ§∫Ôºå‰∏Ä‰∏™ÊòØ RevokeExpiredLease ‰ªªÂä°ÔºåÂÆöÊó∂Ê£ÄÊü•ÊòØÂê¶ÊúâËøáÊúü LeaseÔºåÂèëËµ∑Êí§ÈîÄËøáÊúüÁöÑ Lease Êìç‰Ωú„ÄÇ‰∏Ä‰∏™ÊòØ CheckpointScheduledLeaseÔºåÂÆöÊó∂Ëß¶ÂèëÊõ¥Êñ∞ Lease ÁöÑÂâ©‰ΩôÂà∞ÊúüÊó∂Èó¥ÁöÑÊìç‰Ωú„ÄÇ</p>
<p>Lessor Ê®°ÂùóÊèê‰æõ‰∫Ü Grant„ÄÅRevoke„ÄÅLeaseTimeToLive„ÄÅLeaseKeepAlive API Áªô client ‰ΩøÁî®ÔºåÂêÑÊé•Âè£‰ΩúÁî®Â¶Ç‰∏ã:</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Grant Ë°®Á§∫ÂàõÂª∫‰∏Ä‰∏™ TTL ‰∏∫‰Ω†ÊåáÂÆöÁßíÊï∞ÁöÑ LeaseÔºå
</span></span><span class="line"><span class="cl">Lessor ‰ºöÂ∞Ü Lease ‰ø°ÊÅØÊåÅ‰πÖÂåñÂ≠òÂÇ®Âú® boltdb ‰∏≠Ôºõ
</span></span><span class="line"><span class="cl">Revoke Ë°®Á§∫Êí§ÈîÄ Lease Âπ∂Âà†Èô§ÂÖ∂ÂÖ≥ËÅîÁöÑÊï∞ÊçÆÔºõ
</span></span><span class="line"><span class="cl">LeaseTimeToLive Ë°®Á§∫Ëé∑Âèñ‰∏Ä‰∏™ Lease ÁöÑÊúâÊïàÊúü„ÄÅÂâ©‰ΩôÊó∂Èó¥Ôºõ
</span></span><span class="line"><span class="cl">LeaseKeepAlive Ë°®Á§∫‰∏∫ Lease Áª≠Êúü„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><p>key Â¶Ç‰ΩïÂÖ≥ËÅî Lease‰∫ÜËß£ÂÆåÊï¥‰ΩìÊû∂ÊûÑÂêéÔºåÊàë‰ª¨ÂÜçÁúãÂ¶Ç‰ΩïÂü∫‰∫é Lease ÁâπÊÄßÂÆûÁé∞Ê£ÄÊµã‰∏Ä‰∏™ËäÇÁÇπÂ≠òÊ¥ª„ÄÇÈ¶ñÂÖàÂ¶Ç‰Ωï‰∏∫ËäÇÁÇπÂÅ•Â∫∑ÊåáÊ†áÂàõÂª∫‰∏Ä‰∏™ÁßüÁ∫¶„ÄÅÂπ∂‰∏éËäÇÁÇπÂÅ•Â∫∑ÊåáÊ†á key ÂÖ≥ËÅîÂë¢?Â¶Ç KV Ê®°ÂùóÁöÑ‰∏ÄÊ†∑Ôºåclient ÂèØÈÄöËøá clientv3 Â∫ìÁöÑ Lease API ÂèëËµ∑ RPC Ë∞ÉÁî®Ôºå‰Ω†ÂèØ‰ª•‰ΩøÁî®Â¶Ç‰∏ãÁöÑ etcdctl ÂëΩ‰ª§‰∏∫ node ÁöÑÂÅ•Â∫∑Áä∂ÊÄÅÊåáÊ†áÔºåÂàõÂª∫‰∏Ä‰∏™ LeaseÔºåÊúâÊïàÊúü‰∏∫ 600 Áßí„ÄÇÁÑ∂ÂêéÈÄöËøá timetolive ÂëΩ‰ª§ÔºåÊü•Áúã Lease ÁöÑÊúâÊïàÊúü„ÄÅÂâ©‰ΩôÊó∂Èó¥„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># ÂàõÂª∫‰∏Ä‰∏™TTL‰∏∫600ÁßíÁöÑleaseÔºåetcd serverËøîÂõûLeaseID
</span></span><span class="line"><span class="cl">$ etcdctl lease grant 600
</span></span><span class="line"><span class="cl">lease 326975935f48f814 granted with TTL(600s)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"># Êü•ÁúãleaseÁöÑTTL„ÄÅÂâ©‰ΩôÊó∂Èó¥
</span></span><span class="line"><span class="cl">$ etcdctl lease timetolive 326975935f48f814
</span></span><span class="line"><span class="cl">lease 326975935f48f814 granted with TTL(600s)Ôºå remaining(590s)
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂΩì Lease server Êî∂Âà∞ client ÁöÑÂàõÂª∫‰∏Ä‰∏™ÊúâÊïàÊúü 600 ÁßíÁöÑ Lease ËØ∑Ê±ÇÂêéÔºå‰ºöÈÄöËøá Raft Ê®°ÂùóÂÆåÊàêÊó•ÂøóÂêåÊ≠•ÔºåÈöèÂêé Apply Ê®°ÂùóÈÄöËøá Lessor Ê®°ÂùóÁöÑ Grant Êé•Âè£ÊâßË°åÊó•ÂøóÊù°ÁõÆÂÜÖÂÆπ„ÄÇ</p>
<p>È¶ñÂÖà Lessor ÁöÑ Grant Êé•Âè£‰ºöÊää Lease ‰øùÂ≠òÂà∞ÂÜÖÂ≠òÁöÑ ItemMap Êï∞ÊçÆÁªìÊûÑ‰∏≠ÔºåÁÑ∂ÂêéÂÆÉÈúÄË¶ÅÊåÅ‰πÖÂåñ LeaseÔºåÂ∞Ü Lease Êï∞ÊçÆ‰øùÂ≠òÂà∞ boltdb ÁöÑ Lease bucket ‰∏≠ÔºåËøîÂõû‰∏Ä‰∏™ÂîØ‰∏ÄÁöÑ LeaseID Áªô client„ÄÇ</p>
<p>ÈÄöËøáËøôÊ†∑‰∏Ä‰∏™ÊµÅÁ®ãÔºåÂ∞±Âü∫Êú¨ÂÆåÊàê‰∫Ü Lease ÁöÑÂàõÂª∫„ÄÇÈÇ£‰πàËäÇÁÇπÁöÑÂÅ•Â∫∑ÊåáÊ†áÊï∞ÊçÆÂ¶Ç‰ΩïÂÖ≥ËÅîÂà∞Ê≠§ Lease ‰∏äÂë¢ÔºüÂæàÁÆÄÂçïÔºåKV Ê®°ÂùóÁöÑ API Êé•Âè£Êèê‰æõ‰∫Ü‰∏Ä‰∏™&rdquo;&ndash;lease&quot;ÂèÇÊï∞Ôºå‰Ω†ÂèØ‰ª•ÈÄöËøáÂ¶Ç‰∏ãÂëΩ‰ª§ÔºåÂ∞Ü key node ÂÖ≥ËÅîÂà∞ÂØπÂ∫îÁöÑ LeaseID ‰∏ä„ÄÇÁÑ∂Âêé‰Ω†Êü•ËØ¢ÁöÑÊó∂ÂÄôÂ¢ûÂä† -w ÂèÇÊï∞ËæìÂá∫Ê†ºÂºè‰∏∫ jsonÔºåÂ∞±ÂèØÊü•ÁúãÂà∞ key ÂÖ≥ËÅîÁöÑ LeaseID„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="n">etcdctl</span> <span class="n">put</span> <span class="n">node</span> <span class="n">healthy</span> <span class="o">--</span><span class="n">endpoints</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">127.0</span><span class="o">.</span><span class="mf">0.1</span><span class="p">:</span><span class="mi">2379</span> <span class="o">--</span><span class="n">user</span><span class="o">=</span><span class="n">root</span><span class="p">:</span><span class="n">root</span> <span class="o">--</span><span class="n">lease</span> <span class="mi">326975935</span><span class="n">f48f818</span>
</span></span><span class="line"><span class="cl"><span class="n">OK</span>
</span></span><span class="line"><span class="cl"><span class="o">$</span> <span class="n">etcdctl</span> <span class="n">get</span> <span class="n">node</span> <span class="o">-</span><span class="n">w</span><span class="o">=</span><span class="n">json</span> <span class="o">|</span> <span class="n">python</span> <span class="o">-</span><span class="n">m</span> <span class="n">json</span><span class="o">.</span><span class="k">tool</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kvs&#34;</span><span class="p">:[</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;create_revision&#34;</span><span class="p">:</span><span class="mi">24</span><span class="err">Ôºå</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;key&#34;</span><span class="p">:</span><span class="s2">&#34;bm9kZQ==&#34;</span><span class="err">Ôºå</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;Lease&#34;</span><span class="p">:</span><span class="mi">3632563850270275608</span><span class="err">Ôºå</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;mod_revision&#34;</span><span class="p">:</span><span class="mi">24</span><span class="err">Ôºå</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;value&#34;</span><span class="p">:</span><span class="s2">&#34;aGVhbHRoeQ==&#34;</span><span class="err">Ôºå</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;version&#34;</span><span class="p">:</span><span class="mi">1</span>
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl">    <span class="p">]</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰ª•‰∏äÊµÅÁ®ãÂéüÁêÜÂ¶Ç‰∏ãÂõæÊâÄÁ§∫ÔºåÂÆÉÊèèËø∞‰∫ÜÁî®Êà∑ÁöÑ key ÊòØÂ¶Ç‰Ωï‰∏éÊåáÂÆö Lease ÂÖ≥ËÅîÁöÑ„ÄÇÂΩì‰Ω†ÈÄöËøá put Á≠âÂëΩ‰ª§Êñ∞Â¢û‰∏Ä‰∏™ÊåáÂÆö‰∫Ü&quot;&ndash;lease&quot;ÁöÑ key Êó∂ÔºåMVCC Ê®°ÂùóÂÆÉ‰ºöÈÄöËøá Lessor Ê®°ÂùóÁöÑ Attach ÊñπÊ≥ïÔºåÂ∞Ü key ÂÖ≥ËÅîÂà∞ Lease ÁöÑ key ÂÜÖÂ≠òÈõÜÂêà ItemSet ‰∏≠„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/%e5%b0%86key%e5%92%8c%e6%8c%87%e9%a1%b6%e7%9a%84lease%e5%85%b3%e8%81%94.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>‰∏Ä‰∏™ Lease ÂÖ≥ËÅîÁöÑ key ÈõÜÂêàÊòØ‰øùÂ≠òÂú®ÂÜÖÂ≠ò‰∏≠ÁöÑÔºåÈÇ£‰πà etcd ÈáçÂêØÊó∂ÔºåÊòØÂ¶Ç‰ΩïÁü•ÈÅìÊØè‰∏™ Lease ‰∏äÂÖ≥ËÅî‰∫ÜÂì™‰∫õ key Âë¢?</p>
<p>Á≠îÊ°àÊòØ etcd ÁöÑ MVCC Ê®°ÂùóÂú®ÊåÅ‰πÖÂåñÂ≠òÂÇ® key-value ÁöÑÊó∂ÂÄôÔºå‰øùÂ≠òÂà∞ boltdb ÁöÑ value ÊòØ‰∏™ÁªìÊûÑ‰ΩìÔºàmvccpb.KeyValueÔºâÔºå ÂÆÉ‰∏ç‰ªÖÂåÖÂê´‰Ω†ÁöÑ key-value Êï∞ÊçÆÔºåËøòÂåÖÂê´‰∫ÜÂÖ≥ËÅîÁöÑ LeaseID Á≠â‰ø°ÊÅØ„ÄÇÂõ†Ê≠§ÂΩì etcd ÈáçÂêØÊó∂ÔºåÂèØÊ†πÊçÆÊ≠§‰ø°ÊÅØÔºåÈáçÂª∫ÂÖ≥ËÅîÂêÑ‰∏™ Lease ÁöÑ key ÈõÜÂêàÂàóË°®„ÄÇ</p>
<p>Â¶Ç‰Ωï‰ºòÂåñ Lease Áª≠ÊúüÊÄßËÉΩÈÄöËøá</p>
<p>‰ª•‰∏äÊµÅÁ®ãÊàë‰ª¨ÂÆåÊàê‰∫Ü Lease ÂàõÂª∫ÂíåÊï∞ÊçÆÂÖ≥ËÅîÊìç‰Ωú„ÄÇÂú®Ê≠£Â∏∏ÊÉÖÂÜµ‰∏ãÔºå‰Ω†ÁöÑËäÇÁÇπÂ≠òÊ¥ªÊó∂ÔºåÈúÄË¶ÅÂÆöÊúüÂèëÈÄÅ KeepAlive ËØ∑Ê±ÇÁªô etcd Áª≠ÊúüÂÅ•Â∫∑Áä∂ÊÄÅÁöÑ LeaseÔºåÂê¶Âàô‰Ω†ÁöÑ Lease ÂíåÂÖ≥ËÅîÁöÑÊï∞ÊçÆÂ∞±‰ºöË¢´Âà†Èô§„ÄÇ</p>
<p>ÈÇ£‰πà Lease ÊòØÂ¶Ç‰ΩïÁª≠ÊúüÁöÑ? ‰Ωú‰∏∫‰∏Ä‰∏™È´òÈ¢ëÁéáÁöÑËØ∑Ê±Ç APIÔºåetcd Â¶Ç‰Ωï‰ºòÂåñ Lease Áª≠ÊúüÁöÑÊÄßËÉΩÂë¢Ôºü</p>
<p>Lease Áª≠ÊúüÂÖ∂ÂÆûÂæàÁÆÄÂçïÔºåÊ†∏ÂøÉÊòØÂ∞Ü Lease ÁöÑËøáÊúüÊó∂Èó¥Êõ¥Êñ∞‰∏∫ÂΩìÂâçÁ≥ªÁªüÊó∂Èó¥Âä†ÂÖ∂ TTL„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">  etcdctl lease keep-alive ‰Ω†ÁöÑleaseÁ†Å --endpoints http://127.0.0.1:2379 --user=root:root
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÂÖ≥ÈîÆÈóÆÈ¢òÂú®‰∫éÁª≠ÊúüÁöÑÊÄßËÉΩËÉΩÂê¶Êª°Ë∂≥‰∏öÂä°ËØâÊ±Ç„ÄÇ</p>
<p>ÁÑ∂ËÄåÂΩ±ÂìçÁª≠ÊúüÊÄßËÉΩÂõ†Á¥†ÂèàÊòØÊ∫êËá™Â§öÊñπÈù¢ÁöÑ„ÄÇÈ¶ñÂÖàÊòØ TTLÔºåTTL ËøáÈïø‰ºöÂØºËá¥ËäÇÁÇπÂºÇÂ∏∏ÂêéÔºåÊó†Ê≥ïÂèäÊó∂‰ªé etcd ‰∏≠Âà†Èô§ÔºåÂΩ±ÂìçÊúçÂä°ÂèØÁî®ÊÄßÔºåËÄåËøáÁü≠ÔºåÂàôË¶ÅÊ±Ç client È¢ëÁπÅÂèëÈÄÅÁª≠ÊúüËØ∑Ê±Ç„ÄÇÂÖ∂Ê¨°ÊòØ Lease Êï∞ÔºåÂ¶ÇÊûú Lease ÊàêÂçÉ‰∏ä‰∏á‰∏™ÔºåÈÇ£‰πà etcd ÂèØËÉΩÊó†Ê≥ïÊîØÊíëÂ¶ÇÊ≠§Â§ßËßÑÊ®°ÁöÑ Lease Êï∞ÔºåÂØºËá¥È´òË¥üËΩΩ„ÄÇ</p>
<p>Â¶Ç‰ΩïËß£ÂÜ≥Âë¢ÔºüÈ¶ñÂÖàÊàë‰ª¨ÂõûÈ°æ‰∏ãÊó©Êúü etcd v2 ÁâàÊú¨ÊòØÂ¶Ç‰ΩïÂÆûÁé∞ TTL ÁâπÊÄßÁöÑ„ÄÇÂú®Êó©Êúü v2 ÁâàÊú¨‰∏≠ÔºåÊ≤°Êúâ Lease Ê¶ÇÂøµÔºåTTL Â±ûÊÄßÊòØÂú® key ‰∏äÈù¢Ôºå‰∏∫‰∫Ü‰øùËØÅ key ‰∏çÂà†Èô§ÔºåÂç≥‰æø‰Ω†ÁöÑ TTL Áõ∏ÂêåÔºåclient ‰πüÈúÄË¶Å‰∏∫ÊØè‰∏™ TTL„ÄÅkey ÂàõÂª∫‰∏Ä‰∏™ HTTP/1.x ËøûÊé•ÔºåÂÆöÊó∂ÂèëÈÄÅÁª≠ÊúüËØ∑Ê±ÇÁªô etcd server„ÄÇ</p>
<p>ÂæàÊòæÁÑ∂Ôºåv2 ËÄÅÁâàÊú¨ËøôÁßçËÆæËÆ°ÔºåÂõ†‰∏çÊîØÊåÅËøûÊé•Â§öË∑ØÂ§çÁî®„ÄÅÁõ∏Âêå TTL Êó†Ê≥ïÂ§çÁî®ÂØºËá¥ÊÄßËÉΩËæÉÂ∑ÆÔºåÊó†Ê≥ïÊîØÊíëËæÉÂ§ßËßÑÊ®°ÁöÑ Lease Âú∫ÊôØ„ÄÇ</p>
<p>etcd v3 ÁâàÊú¨‰∏∫‰∫ÜËß£ÂÜ≥‰ª•‰∏äÈóÆÈ¢òÔºåÊèêÂá∫‰∫Ü Lease ÁâπÊÄßÔºåTTL Â±ûÊÄßËΩ¨ÁßªÂà∞‰∫Ü Lease ‰∏äÔºå ÂêåÊó∂ÂçèËÆÆ‰ªé HTTP/1.x ‰ºòÂåñÊàê gRPC ÂçèËÆÆ„ÄÇ</p>
<p>‰∏ÄÊñπÈù¢‰∏çÂêå key Ëã• TTL Áõ∏ÂêåÔºåÂèØÂ§çÁî®Âêå‰∏Ä‰∏™ LeaseÔºå ÊòæËëóÂáèÂ∞ë‰∫Ü Lease Êï∞„ÄÇÂè¶‰∏ÄÊñπÈù¢ÔºåÈÄöËøá gRPC HTTP/2 ÂÆûÁé∞‰∫ÜÂ§öË∑ØÂ§çÁî®ÔºåÊµÅÂºè‰º†ËæìÔºåÂêå‰∏ÄËøûÊé•ÂèØÊîØÊåÅ‰∏∫Â§ö‰∏™ Lease Áª≠ÊúüÔºåÂ§ßÂ§ßÂáèÂ∞ë‰∫ÜËøûÊé•Êï∞„ÄÇ</p>
<p>ÈÄöËøá‰ª•‰∏ä‰∏§‰∏™‰ºòÂåñÔºåÂÆûÁé∞ Lease ÊÄßËÉΩÂ§ßÂπÖÊèêÂçáÔºåÊª°Ë∂≥‰∫ÜÂêÑ‰∏™‰∏öÂä°Âú∫ÊôØËØâÊ±Ç„ÄÇ</p>
<p>Â¶Ç‰ΩïÈ´òÊïàÊ∑òÊ±∞ËøáÊúü Lease</p>
<p>Âú®‰∫ÜËß£ÂÆåËäÇÁÇπÊ≠£Â∏∏ÊÉÖÂÜµ‰∏ãÁöÑ Lease Áª≠ÊúüÁâπÊÄßÂêéÔºåÊàë‰ª¨ÂÜçÁúãÁúãËäÇÁÇπÂºÇÂ∏∏Êó∂ÔºåÊú™Ê≠£Â∏∏Áª≠ÊúüÂêéÔºåetcd ÂèàÊòØÂ¶Ç‰ΩïÊ∑òÊ±∞ËøáÊúü Lease„ÄÅÂà†Èô§ËäÇÁÇπÂÅ•Â∫∑ÊåáÊ†á key ÁöÑ„ÄÇ</p>
<p>Ê∑òÊ±∞ËøáÊúü Lease ÁöÑÂ∑•‰ΩúÁî± Lessor Ê®°ÂùóÁöÑ‰∏Ä‰∏™ÂºÇÊ≠• goroutine Ë¥üË¥£„ÄÇÂ¶Ç‰∏ãÈù¢Êû∂ÊûÑÂõæËôöÁ∫øÊ°ÜÊâÄÁ§∫ÔºåÂÆÉ‰ºöÂÆöÊó∂‰ªéÊúÄÂ∞èÂ†Ü‰∏≠ÂèñÂá∫Â∑≤ËøáÊúüÁöÑ LeaseÔºåÊâßË°åÂà†Èô§ Lease ÂíåÂÖ∂ÂÖ≥ËÅîÁöÑ key ÂàóË°®Êï∞ÊçÆÁöÑ RevokeExpiredLease ‰ªªÂä°„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/reovkeExpiredLease%e6%b7%98%e6%b1%b0%e8%bf%87%e6%9c%9f%e7%9a%84lease.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>‰ªéÂõæ‰∏≠‰Ω†ÂèØ‰ª•ÁúãÂà∞ÔºåÁõÆÂâç etcd ÊòØÂü∫‰∫éÊúÄÂ∞èÂ†ÜÊù•ÁÆ°ÁêÜ LeaseÔºåÂÆûÁé∞Âø´ÈÄüÊ∑òÊ±∞ËøáÊúüÁöÑ Lease„ÄÇ</p>
<p>etcd Êó©ÊúüÁöÑÊó∂ÂÄôÔºåÊ∑òÊ±∞ Lease ÈùûÂ∏∏Êö¥Âäõ„ÄÇetcd ‰ºöÁõ¥Êé•ÈÅçÂéÜÊâÄÊúâ LeaseÔºåÈÄê‰∏™Ê£ÄÊü• Lease ÊòØÂê¶ËøáÊúüÔºåËøáÊúüÂàô‰ªé Lease ÂÖ≥ËÅîÁöÑ key ÈõÜÂêà‰∏≠ÔºåÂèñÂá∫ key ÂàóË°®ÔºåÂà†Èô§ÂÆÉ‰ª¨ÔºåÊó∂Èó¥Â§çÊùÇÂ∫¶ÊòØ O(N)„ÄÇ</p>
<p>ÁÑ∂ËÄåËøôÁßçÊñπÊ°àÈöèÁùÄ Lease Êï∞Â¢ûÂ§ßÔºåÊØ´Êó†ÁñëÈóÆÂÆÉÁöÑÊÄßËÉΩ‰ºöÂèòÂæóË∂äÊù•Ë∂äÂ∑Æ„ÄÇÊàë‰ª¨ËÉΩÂê¶ÊåâËøáÊúüÊó∂Èó¥ÊéíÂ∫èÂë¢ÔºüËøôÊ†∑ÊØèÊ¨°Âè™ÈúÄËΩÆËØ¢„ÄÅÊ£ÄÊü•ÊéíÂú®ÂâçÈù¢ÁöÑ Lease ËøáÊúüÊó∂Èó¥Ôºå‰∏ÄÊó¶ËΩÆËØ¢Âà∞Êú™ËøáÊúüÁöÑ LeaseÔºå ÂàôÂèØÁªìÊùüÊú¨ËΩÆÊ£ÄÊü•„ÄÇ</p>
<p>ÂàöÂàöËØ¥ÁöÑÂ∞±ÊòØ etcd Lease È´òÊïàÊ∑òÊ±∞ÊñπÊ°àÊúÄÂ∞èÂ†ÜÁöÑÂÆûÁé∞ÊñπÊ≥ï„ÄÇÊØèÊ¨°Êñ∞Â¢û Lease„ÄÅÁª≠ÊúüÁöÑÊó∂ÂÄôÔºåÂÆÉ‰ºöÊèíÂÖ•„ÄÅÊõ¥Êñ∞‰∏Ä‰∏™ÂØπË±°Âà∞ÊúÄÂ∞èÂ†Ü‰∏≠ÔºåÂØπË±°Âê´Êúâ LeaseID ÂíåÂÖ∂Âà∞ÊúüÊó∂Èó¥ unixnanoÔºåÂØπË±°‰πãÈó¥ÊåâÂà∞ÊúüÊó∂Èó¥ÂçáÂ∫èÊéíÂ∫è„ÄÇ</p>
<p>etcd Lessor ‰∏ªÂæ™ÁéØÊØèÈöî 500ms ÊâßË°å‰∏ÄÊ¨°Êí§ÈîÄ Lease Ê£ÄÊü•ÔºàRevokeExpiredLeaseÔºâÔºåÊØèÊ¨°ËΩÆËØ¢Â†ÜÈ°∂ÁöÑÂÖÉÁ¥†ÔºåËã•Â∑≤ËøáÊúüÂàôÂä†ÂÖ•Âà∞ÂæÖÊ∑òÊ±∞ÂàóË°®ÔºåÁõ¥Âà∞Â†ÜÈ°∂ÁöÑ Lease ËøáÊúüÊó∂Èó¥Â§ß‰∫éÂΩìÂâçÔºåÂàôÁªìÊùüÊú¨ËΩÆËΩÆËØ¢„ÄÇ</p>
<p>Áõ∏ÊØîÊó©Êúü O(N) ÁöÑÈÅçÂéÜÊó∂Èó¥Â§çÊùÇÂ∫¶Ôºå‰ΩøÁî®Â†ÜÂêéÔºåÊèíÂÖ•„ÄÅÊõ¥Êñ∞„ÄÅÂà†Èô§ÔºåÂÆÉÁöÑÊó∂Èó¥Â§çÊùÇÂ∫¶ÊòØ O(Log N)ÔºåÊü•ËØ¢Â†ÜÈ°∂ÂØπË±°ÊòØÂê¶ËøáÊúüÊó∂Èó¥Â§çÊùÇÂ∫¶‰ªÖ‰∏∫ O(1)ÔºåÊÄßËÉΩÂ§ßÂ§ßÊèêÂçáÔºåÂèØÊîØÊíëÂ§ßËßÑÊ®°Âú∫ÊôØ‰∏ã Lease ÁöÑÈ´òÊïàÊ∑òÊ±∞„ÄÇ</p>
<p>Ëé∑ÂèñÂà∞ÂæÖËøáÊúüÁöÑ LeaseID ÂêéÔºåLeader ÊòØÂ¶Ç‰ΩïÈÄöÁü•ÂÖ∂‰ªñ Follower ËäÇÁÇπÊ∑òÊ±∞ÂÆÉ‰ª¨Âë¢Ôºü</p>
<p>Lessor Ê®°Âùó‰ºöÂ∞ÜÂ∑≤Á°ÆËÆ§ËøáÊúüÁöÑ LeaseIDÔºå‰øùÂ≠òÂú®‰∏Ä‰∏™Âêç‰∏∫ expiredC ÁöÑ channel ‰∏≠ÔºåËÄå etcd server ÁöÑ‰∏ªÂæ™ÁéØ‰ºöÂÆöÊúü‰ªé channel ‰∏≠Ëé∑Âèñ LeaseIDÔºåÂèëËµ∑ revoke ËØ∑Ê±ÇÔºåÈÄöËøá Raft Log ‰º†ÈÄíÁªô Follower ËäÇÁÇπ„ÄÇ</p>
<p>ÂêÑ‰∏™ËäÇÁÇπÊî∂Âà∞ revoke Lease ËØ∑Ê±ÇÂêéÔºåËé∑ÂèñÂÖ≥ËÅîÂà∞Ê≠§ Lease ‰∏äÁöÑ key ÂàóË°®Ôºå‰ªé boltdb ‰∏≠Âà†Èô§ keyÔºå‰ªé Lessor ÁöÑ Lease map ÂÜÖÂ≠ò‰∏≠Âà†Èô§Ê≠§ Lease ÂØπË±°ÔºåÊúÄÂêéËøòÈúÄË¶Å‰ªé boltdb ÁöÑ Lease bucket ‰∏≠Âà†Èô§Ëøô‰∏™ Lease„ÄÇ</p>
<p>‰ª•‰∏äÂ∞±ÊòØ Lease ÁöÑËøáÊúüËá™Âä®Ê∑òÊ±∞ÈÄªËæë„ÄÇLeader ËäÇÁÇπÊåâËøáÊúüÊó∂Èó¥Áª¥Êä§‰∫Ü‰∏Ä‰∏™ÊúÄÂ∞èÂ†ÜÔºåËã•‰Ω†ÁöÑËäÇÁÇπÂºÇÂ∏∏Êú™Ê≠£Â∏∏Áª≠ÊúüÔºåÈÇ£‰πàÈöèÁùÄÊó∂Èó¥Ê∂àÈÄùÔºåÂØπÂ∫îÁöÑ Lease Âàô‰ºöËøáÊúüÔºåLessor ‰∏ªÂæ™ÁéØÂÆöÊó∂ËΩÆËØ¢ËøáÊúüÁöÑ Lease„ÄÇËé∑ÂèñÂà∞ ID ÂêéÔºåLeader ÂèëËµ∑ revoke Êìç‰ΩúÔºåÈÄöÁü•Êï¥‰∏™ÈõÜÁæ§Âà†Èô§ Lease ÂíåÂÖ≥ËÅîÁöÑÊï∞ÊçÆ„ÄÇ</p>
<p>‰∏∫‰ªÄ‰πàÈúÄË¶Å checkpoint Êú∫Âà∂</p>
<p>‰∫ÜËß£ÂÆå Lease ÁöÑÂàõÂª∫„ÄÅÁª≠Êúü„ÄÅËá™Âä®Ê∑òÊ±∞Êú∫Âà∂ÂêéÔºå‰Ω†ÂèØËÉΩÂ∑≤ÁªèÂèëÁé∞ÔºåÊ£ÄÊü• Lease ÊòØÂê¶ËøáÊúü„ÄÅÁª¥Êä§ÊúÄÂ∞èÂ†Ü„ÄÅÈíàÂØπËøáÊúüÁöÑ Lease ÂèëËµ∑ revoke Êìç‰ΩúÔºåÈÉΩÊòØ Leader ËäÇÁÇπË¥üË¥£ÁöÑÔºåÂÆÉÁ±ª‰ºº‰∫é Lease ÁöÑ‰ª≤Ë£ÅËÄÖÔºåÈÄöËøá‰ª•‰∏äÊ∏ÖÊô∞ÁöÑÊùÉË¥£ÂàíÂàÜÔºåÈôç‰Ωé‰∫Ü Lease ÁâπÊÄßÁöÑÂÆûÁé∞Â§çÊùÇÂ∫¶„ÄÇ</p>
<p>ÈÇ£‰πàÂΩì Leader Âõ†ÈáçÂêØ„ÄÅcrash„ÄÅÁ£ÅÁõò IO Á≠âÂºÇÂ∏∏‰∏çÂèØÁî®Êó∂ÔºåFollower ËäÇÁÇπÂ∞±‰ºöÂèëËµ∑ Leader ÈÄâ‰∏æÔºåÊñ∞ Leader Ë¶ÅÂÆåÊàê‰ª•‰∏äËÅåË¥£ÔºåÂøÖÈ°ªÈáçÂª∫ Lease ËøáÊúüÊúÄÂ∞èÂ†ÜÁ≠âÁÆ°ÁêÜÊï∞ÊçÆÁªìÊûÑÔºåÈÇ£‰πà‰ª•‰∏äÈáçÂª∫ÂèØËÉΩ‰ºöËß¶Âèë‰ªÄ‰πàÈóÆÈ¢òÂë¢Ôºü</p>
<p>ÂΩì‰Ω†ÁöÑÈõÜÁæ§ÂèëÁîü Leader ÂàáÊç¢ÂêéÔºåÊñ∞ÁöÑ Leader Âü∫‰∫é Lease map ‰ø°ÊÅØÔºåÊåâ Lease ËøáÊúüÊó∂Èó¥ÊûÑÂª∫‰∏Ä‰∏™ÊúÄÂ∞èÂ†ÜÊó∂Ôºåetcd Êó©ÊúüÁâàÊú¨‰∏∫‰∫Ü‰ºòÂåñÊÄßËÉΩÔºåÂπ∂Êú™ÊåÅ‰πÖÂåñÂ≠òÂÇ® Lease Ââ©‰Ωô TTL ‰ø°ÊÅØÔºåÂõ†Ê≠§ÈáçÂª∫ÁöÑÊó∂ÂÄôÂ∞±‰ºöËá™Âä®ÁªôÊâÄÊúâ Lease Ëá™Âä®Áª≠Êúü‰∫Ü„ÄÇ</p>
<p>ÁÑ∂ËÄåËã•ËæÉÈ¢ëÁπÅÂá∫Áé∞ Leader ÂàáÊç¢ÔºåÂàáÊç¢Êó∂Èó¥Â∞è‰∫é Lease ÁöÑ TTLÔºåËøô‰ºöÂØºËá¥ Lease Ê∞∏ËøúÊó†Ê≥ïÂà†Èô§ÔºåÂ§ßÈáè key Â†ÜÁßØÔºådb Â§ßÂ∞èË∂ÖËøáÈÖçÈ¢ùÁ≠âÂºÇÂ∏∏„ÄÇ</p>
<p>‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºåetcd ÂºïÂÖ•‰∫ÜÊ£ÄÊü•ÁÇπÊú∫Âà∂Ôºå‰πüÂ∞±ÊòØ‰∏ãÈù¢Êû∂ÊûÑÂõæ‰∏≠ÈªëËâ≤ËôöÁ∫øÊ°ÜÊâÄÁ§∫ÁöÑ CheckPointScheduledLeases ÁöÑ‰ªªÂä°„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/CheckPointScheduledLeases%e5%ae%9a%e6%9c%9f%e6%a3%80%e6%9f%a5lease.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>‰∏ÄÊñπÈù¢Ôºåetcd ÂêØÂä®ÁöÑÊó∂ÂÄôÔºåLeader ËäÇÁÇπÂêéÂè∞‰ºöËøêË°åÊ≠§ÂºÇÊ≠•‰ªªÂä°ÔºåÂÆöÊúüÊâπÈáèÂú∞Â∞Ü Lease Ââ©‰ΩôÁöÑ TTL Âü∫‰∫é Raft Log ÂêåÊ≠•Áªô Follower ËäÇÁÇπÔºåFollower ËäÇÁÇπÊî∂Âà∞ CheckPoint ËØ∑Ê±ÇÂêéÔºåÊõ¥Êñ∞ÂÜÖÂ≠òÊï∞ÊçÆÁªìÊûÑ LeaseMap ÁöÑÂâ©‰Ωô TTL ‰ø°ÊÅØ„ÄÇ</p>
<p>Âè¶‰∏ÄÊñπÈù¢ÔºåÂΩì Leader ËäÇÁÇπÊî∂Âà∞ KeepAlive ËØ∑Ê±ÇÁöÑÊó∂ÂÄôÔºåÂÆÉ‰πü‰ºöÈÄöËøá checkpoint Êú∫Âà∂ÊääÊ≠§ Lease ÁöÑÂâ©‰Ωô TTL ÈáçÁΩÆÔºåÂπ∂ÂêåÊ≠•Áªô Follower ËäÇÁÇπÔºåÂ∞ΩÈáèÁ°Æ‰øùÁª≠ÊúüÂêéÈõÜÁæ§ÂêÑ‰∏™ËäÇÁÇπÁöÑ Lease Ââ©‰Ωô TTL ‰∏ÄËá¥ÊÄß„ÄÇ</p>
<p>ÊúÄÂêé‰Ω†Ë¶ÅÊ≥®ÊÑèÁöÑÊòØÔºåÊ≠§ÁâπÊÄßÂØπÊÄßËÉΩÊúâ‰∏ÄÂÆöÂΩ±ÂìçÔºåÁõÆÂâç‰ªçÁÑ∂ÊòØËØïÈ™åÁâπÊÄß„ÄÇ‰Ω†ÂèØ‰ª•ÈÄöËøá experimental-enable-lease-checkpoint ÂèÇÊï∞ÂºÄÂêØ</p>
<p>Â∞èÁªì</p>
<p>ÊúÄÂêéÊàë‰ª¨Êù•Â∞èÁªì‰∏ã‰ªäÂ§©ÁöÑÂÜÖÂÆπÔºå</p>
<p>ÊàëÈÄöËøá‰∏Ä‰∏™ÂÆûÈôÖÊ°à‰æã‰∏∫‰Ω†Ëß£ËØª‰∫Ü Lease ÂàõÂª∫„ÄÅÂÖ≥ËÅî key„ÄÅÁª≠Êúü„ÄÅÊ∑òÊ±∞„ÄÅcheckpoint Êú∫Âà∂„ÄÇ</p>
<p>Lease ÁöÑÊ†∏ÂøÉÊòØ TTLÔºåÂΩì Lease ÁöÑ TTL ËøáÊúüÊó∂ÔºåÂÆÉ‰ºöËá™Âä®Âà†Èô§ÂÖ∂ÂÖ≥ËÅîÁöÑ key-value Êï∞ÊçÆ„ÄÇ</p>
<p>È¶ñÂÖàÊòØ Lease ÂàõÂª∫ÂèäÁª≠Êúü„ÄÇÂΩì‰Ω†ÂàõÂª∫ Lease Êó∂Ôºåetcd ‰ºö‰øùÂ≠ò Lease ‰ø°ÊÅØÂà∞ boltdb ÁöÑ Lease bucket ‰∏≠„ÄÇ‰∏∫‰∫ÜÈò≤Ê≠¢ Lease Ë¢´Ê∑òÊ±∞Ôºå‰Ω†ÈúÄË¶ÅÂÆöÊúüÂèëÈÄÅ LeaseKeepAlive ËØ∑Ê±ÇÁªô etcd server Áª≠Êúü LeaseÔºåÊú¨Ë¥®ÊòØÊõ¥Êñ∞ Lease ÁöÑÂà∞ÊúüÊó∂Èó¥„ÄÇ<strong>Áª≠ÊúüÁöÑÊ†∏ÂøÉÊåëÊàòÊòØÊÄßËÉΩ</strong>Ôºå</p>
<p>etcd ÁªèÂéÜ‰∫Ü‰ªé TTL Â±ûÊÄßÂú® key ‰∏äÔºåÂà∞Áã¨Á´ãÊäΩË±°Âá∫ LeaseÔºåÊîØÊåÅÂ§ö key Â§çÁî®Áõ∏Âêå TTLÔºåÂêåÊó∂ÂçèËÆÆ‰ªé HTTP/1.x ‰ºòÂåñÊàê gRPC ÂçèËÆÆÔºåÊîØÊåÅÂ§öË∑ØËøûÊé•Â§çÁî®ÔºåÊòæËëóÈôç‰Ωé‰∫Ü server ËøûÊé•Êï∞Á≠âËµÑÊ∫êÂºÄÈîÄ„ÄÇ</p>
<p>ÂÖ∂Ê¨°ÊòØ Lease ÁöÑÊ∑òÊ±∞Êú∫Âà∂Ôºåetcd ÁöÑ Lease Ê∑òÊ±∞ÁÆóÊ≥ïÁªèÂéÜ‰∫Ü‰ªéÊó∂Èó¥Â§çÊùÇÂ∫¶ O(N) Âà∞ O(Log N) ÁöÑÊºîËøõÔºåÊ†∏ÂøÉÊòØËΩÆËØ¢ÊúÄÂ∞èÂ†ÜÁöÑ Lease ÊòØÂê¶ËøáÊúüÔºåËã•ËøáÊúüÁîüÊàê revoke ËØ∑Ê±ÇÔºåÂÆÉ‰ºöÊ∏ÖÁêÜ Lease ÂíåÂÖ∂ÂÖ≥ËÅîÁöÑÊï∞ÊçÆ„ÄÇ</p>
<p>ÊúÄÂêéÊàëÁªô‰Ω†‰ªãÁªç‰∫Ü Lease ÁöÑ checkpoint Êú∫Âà∂ÔºåÂÆÉÊòØ‰∏∫‰∫ÜËß£ÂÜ≥ Leader ÂºÇÂ∏∏ÊÉÖÂÜµ‰∏ã TTL Ëá™Âä®Ë¢´Áª≠ÊúüÔºåÂèØËÉΩÂØºËá¥ Lease Ê∞∏‰∏çÊ∑òÊ±∞ÁöÑÈóÆÈ¢òËÄåËØûÁîü„ÄÇ</p>
<p>etcd lease ÊúÄÂ∞èÁöÑ TTL Êó∂Èó¥ÊòØÂ§öÂ∞ëÂêóÔºüÂÆÉË∑ü‰ªÄ‰πàÂõ†Á¥†ÊúâÂÖ≥Âë¢Ôºü</p>
<p>ÂèØËÉΩ‰∏∫‰∫ÜÁ°Æ‰øùÂèëÁîüleaderÈÄâ‰∏æÊó∂Ôºålease‰∏ç‰ºöËøáÊúüÔºåÊúÄÂ∞èttlÂ∫îËØ•ÊØîÈÄâ‰∏æÊó∂Èó¥ÈïøÔºåÁúã‰ª£Á†Å
minTTL := time.Duration((3*cfg.ElectionTicks)/2) * heartbeat
minTTLSec := int64(math.Ceil(minTTL.Seconds()))
ÈªòËÆ§ÁöÑÊÉÖÂÜµ‰∏ãÂ∫îËØ•ÊòØ2sÔºå</p>
<h3 id="mvccÂ¶Ç‰ΩïÂÆûÁé∞Â§öÁâàÊú¨Âπ∂ÂèëÊéßÂà∂ÁöÑ">MVCCÂ¶Ç‰ΩïÂÆûÁé∞Â§öÁâàÊú¨Âπ∂ÂèëÊéßÂà∂ÁöÑ</h3>
<p>Âú®01ËØæÈáåÔºåÊàëÂíå‰Ω†‰ªãÁªç etcd v2 Êó∂ÔºåÊèêÂà∞ËøáÂÆÉÂ≠òÂú®ÁöÑËã•Âπ≤Â±ÄÈôêÔºåÂ¶Ç‰ªÖ‰øùÁïôÊúÄÊñ∞ÁâàÊú¨ key-value Êï∞ÊçÆ„ÄÅ‰∏¢ÂºÉÂéÜÂè≤ÁâàÊú¨„ÄÇËÄå etcd Ê†∏ÂøÉÁâπÊÄß watch Âèà‰æùËµñÂéÜÂè≤ÁâàÊú¨ÔºåÂõ†Ê≠§ etcd v2 ‰∏∫‰∫ÜÁºìËß£Ëøô‰∏™ÈóÆÈ¢òÔºå‰ºöÂú®ÂÜÖÂ≠ò‰∏≠Áª¥Êä§‰∏Ä‰∏™ËæÉÁü≠ÁöÑÂÖ®Â±Ä‰∫ã‰ª∂ÊªëÂä®Á™óÂè£Ôºå‰øùÁïôÊúÄËøëÁöÑ 1000 Êù°ÂèòÊõ¥‰∫ã‰ª∂„ÄÇ‰ΩÜÊòØÂú®ÈõÜÁæ§ÂÜôËØ∑Ê±ÇËæÉÂ§öÁ≠âÂú∫ÊôØ‰∏ãÔºåÂÆÉ‰æùÁÑ∂Êó†Ê≥ïÊèê‰æõÂèØÈù†ÁöÑ Watch Êú∫Âà∂„ÄÇ</p>
<p>Êàë‰ªäÂ§©Ë¶ÅÂíå‰Ω†ÂàÜ‰∫´ÁöÑ MVCCÔºàMultiversion concurrency controlÔºâÊú∫Âà∂ÔºåÊ≠£ÊòØ‰∏∫Ëß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òËÄåËØûÁîüÁöÑ„ÄÇ</p>
<p>MVCC Êú∫Âà∂ÁöÑÊ†∏ÂøÉÊÄùÊÉ≥ÊòØ‰øùÂ≠ò‰∏Ä‰∏™ key-value Êï∞ÊçÆÁöÑÂ§ö‰∏™ÂéÜÂè≤ÁâàÊú¨Ôºåetcd Âü∫‰∫éÂÆÉ‰∏ç‰ªÖÂÆûÁé∞‰∫ÜÂèØÈù†ÁöÑ Watch Êú∫Âà∂ÔºåÈÅøÂÖç‰∫Ü client È¢ëÁπÅÂèëËµ∑ List Pod Á≠â expensive request Êìç‰ΩúÔºå‰øùÈöú etcd ÈõÜÁæ§Á®≥ÂÆöÊÄß„ÄÇËÄå‰∏î MVCC ËøòËÉΩ‰ª•ËæÉ‰ΩéÁöÑÂπ∂ÂèëÊéßÂà∂ÂºÄÈîÄÔºåÂÆûÁé∞ÂêÑÁ±ªÈöîÁ¶ªÁ∫ßÂà´ÁöÑ‰∫ãÂä°Ôºå‰øùÈöú‰∫ãÂä°ÁöÑÂÆâÂÖ®ÊÄßÔºåÊòØ‰∫ãÂä°ÁâπÊÄßÁöÑÂü∫Á°Ä„ÄÇ</p>
<p>Â∏åÊúõÈÄöËøáÊú¨ËäÇËØæÔºåÂ∏ÆÂä©‰Ω†ÊêûÊáÇ MVCC Âê´‰πâÂíå MVCC Êú∫Âà∂‰∏ã key-value Êï∞ÊçÆÁöÑÊõ¥Êñ∞„ÄÅÊü•ËØ¢„ÄÅÂà†Èô§ÂéüÁêÜÔºå‰∫ÜËß£ treeIndex Á¥¢ÂºïÊ®°Âùó„ÄÅboltdb Ê®°ÂùóÊòØÂ¶Ç‰ΩïÁõ∏‰∫íÂçè‰ΩúÔºåÂÆûÁé∞‰øùÂ≠ò‰∏Ä‰∏™ key-value Êï∞ÊçÆÂ§ö‰∏™ÂéÜÂè≤ÁâàÊú¨„ÄÇ</p>
<p>‰ªÄ‰πàÊòØ MVCC</p>
<p>È¶ñÂÖàÂíå‰Ω†ËÅäËÅä‰ªÄ‰πàÊòØ MVCCÔºå‰ªéÂêçÂ≠ó‰∏äÁêÜËß£ÔºåÂÆÉÊòØ‰∏Ä‰∏™Âü∫‰∫éÂ§öÁâàÊú¨ÊäÄÊúØÂÆûÁé∞ÁöÑ‰∏ÄÁßçÂπ∂ÂèëÊéßÂà∂Êú∫Âà∂„ÄÇÈÇ£Â∏∏ËßÅÁöÑÂπ∂ÂèëÊú∫Âà∂ÊúâÂì™‰∫õÔºüMVCC ÁöÑ‰ºòÁÇπÂú®Âì™ÈáåÂë¢ÔºüÊèêÂà∞Âπ∂ÂèëÊéßÂà∂Êú∫Âà∂‰Ω†ÂèØËÉΩÂ∞±Ê≤°ÈÇ£‰πàÈôåÁîü‰∫ÜÔºåÊØîÂ¶ÇÊï∞ÊçÆÂ∫ì‰∏≠ÁöÑÊÇ≤ËßÇÈîÅÔºå‰πüÂ∞±ÊòØÈÄöËøáÈîÅÊú∫Âà∂Á°Æ‰øùÂêå‰∏ÄÊó∂ÂàªÂè™ËÉΩÊúâ‰∏Ä‰∏™‰∫ãÂä°ÂØπÊï∞ÊçÆËøõË°å‰øÆÊîπÊìç‰ΩúÔºåÂ∏∏ËßÅÁöÑÂÆûÁé∞ÊñπÊ°àÊúâËØªÂÜôÈîÅ„ÄÅ‰∫íÊñ•ÈîÅ„ÄÅ‰∏§Èò∂ÊÆµÈîÅÁ≠â„ÄÇ</p>
<p>ÊÇ≤ËßÇÈîÅÊòØ‰∏ÄÁßç‰∫ãÂÖàÈ¢ÑÈò≤Êú∫Âà∂ÔºåÂÆÉÊÇ≤ËßÇÂú∞ËÆ§‰∏∫Â§ö‰∏™Âπ∂Âèë‰∫ãÂä°ÂèØËÉΩ‰ºöÂèëÁîüÂÜ≤Á™ÅÔºåÂõ†Ê≠§ÂÆÉË¶ÅÊ±Ç‰∫ãÂä°ÂøÖÈ°ªÂÖàËé∑ÂæóÈîÅÔºåÊâçËÉΩËøõË°å‰øÆÊîπÊï∞ÊçÆÊìç‰Ωú„ÄÇ‰ΩÜÊòØÊÇ≤ËßÇÈîÅÁ≤íÂ∫¶ËøáÂ§ß„ÄÅÈ´òÂπ∂ÂèëÂú∫ÊôØ‰∏ãÂ§ßÈáè‰∫ãÂä°‰ºöÈòªÂ°ûÁ≠âÔºå‰ºöÂØºËá¥ÊúçÂä°ÊÄßËÉΩËæÉÂ∑Æ„ÄÇ</p>
<p>MVCC Êú∫Âà∂Ê≠£ÊòØÂü∫‰∫éÂ§öÁâàÊú¨ÊäÄÊúØÂÆûÁé∞ÁöÑ‰∏ÄÁßç‰πêËßÇÈîÅÊú∫Âà∂ÔºåÂÆÉ‰πêËßÇÂú∞ËÆ§‰∏∫Êï∞ÊçÆ‰∏ç‰ºöÂèëÁîüÂÜ≤Á™ÅÔºå‰ΩÜÊòØÂΩì‰∫ãÂä°Êèê‰∫§Êó∂ÔºåÂÖ∑Â§áÊ£ÄÊµãÊï∞ÊçÆÊòØÂê¶ÂÜ≤Á™ÅÁöÑËÉΩÂäõ„ÄÇ</p>
<p>Âú® MVCC Êï∞ÊçÆÂ∫ì‰∏≠Ôºå‰Ω†Êõ¥Êñ∞‰∏Ä‰∏™ key-value Êï∞ÊçÆÁöÑÊó∂ÂÄôÔºåÂÆÉÂπ∂‰∏ç‰ºöÁõ¥Êé•Ë¶ÜÁõñÂéüÊï∞ÊçÆÔºåËÄåÊòØÊñ∞Â¢û‰∏Ä‰∏™ÁâàÊú¨Êù•Â≠òÂÇ®Êñ∞ÁöÑÊï∞ÊçÆÔºåÊØè‰∏™Êï∞ÊçÆÈÉΩÊúâ‰∏Ä‰∏™ÁâàÊú¨Âè∑„ÄÇÁâàÊú¨Âè∑ÂÆÉÊòØ‰∏Ä‰∏™ÈÄªËæëÊó∂Èó¥Ôºå‰∏∫‰∫ÜÊñπ‰æø‰Ω†Ê∑±ÂÖ•ÁêÜËß£ÁâàÊú¨Âè∑ÊÑè‰πâÔºåÂú®‰∏ãÈù¢ÊàëÁªô‰Ω†Áîª‰∫Ü‰∏Ä‰∏™ etcd MVCC ÁâàÊú¨Âè∑Êó∂Èó¥Â∫èÂàóÂõæ„ÄÇ</p>
<p>‰ªéÂõæ‰∏≠‰Ω†ÂèØ‰ª•ÁúãÂà∞ÔºåÈöèÁùÄÊó∂Èó¥Â¢ûÈïøÔºå‰Ω†ÊØèÊ¨°‰øÆÊîπÊìç‰ΩúÔºåÁâàÊú¨Âè∑ÈÉΩ‰ºöÈÄíÂ¢û„ÄÇÊØè‰øÆÊîπ‰∏ÄÊ¨°ÔºåÁîüÊàê‰∏ÄÊù°Êñ∞ÁöÑÊï∞ÊçÆËÆ∞ÂΩï„ÄÇÂΩì‰Ω†ÊåáÂÆöÁâàÊú¨Âè∑ËØªÂèñÊï∞ÊçÆÊó∂ÔºåÂÆÉÂÆûÈôÖ‰∏äËÆøÈóÆÁöÑÊòØÁâàÊú¨Âè∑ÁîüÊàêÈÇ£‰∏™Êó∂Èó¥ÁÇπÁöÑÂø´ÁÖßÊï∞ÊçÆ„ÄÇÂΩì‰Ω†Âà†Èô§Êï∞ÊçÆÁöÑÊó∂ÂÄôÔºåÂÆÉÂÆûÈôÖ‰πüÊòØÊñ∞Â¢û‰∏ÄÊù°Â∏¶Âà†Èô§Ê†áËØÜÁöÑÊï∞ÊçÆËÆ∞ÂΩï„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/mvcc%e7%ae%80%e5%8d%95%e6%bc%94%e7%a4%ba.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>MVCC ÁâπÊÄßÂàù‰ΩìÈ™å</p>
<p>‰∫ÜËß£ÂÆå‰ªÄ‰πàÊòØ MVCC ÂêéÔºåÊàëÂÖàÈÄöËøáÂá†‰∏™ÁÆÄÂçïÂëΩ‰ª§ÔºåÂ∏¶‰Ω†Âàù‰ΩìÈ™å‰∏ã MVCC ÁâπÊÄßÔºåÁúãÁúãÂÆÉÊòØÂ¶Ç‰ΩïÂ∏ÆÂä©‰Ω†Êü•ËØ¢ÂéÜÂè≤‰øÆÊîπËÆ∞ÂΩïÔºå‰ª•ÂèäÊâæÂõû‰∏çÂ∞èÂøÉÂà†Èô§ÁöÑ key ÁöÑ„ÄÇÂêØÂä®‰∏Ä‰∏™Á©∫ÈõÜÁæ§ÔºåÊõ¥Êñ∞‰∏§Ê¨° key hello ÂêéÔºåÂ¶Ç‰ΩïËé∑Âèñ key hello ÁöÑ‰∏ä‰∏Ä‰∏™ÁâàÊú¨ÂÄºÂë¢Ôºü Âà†Èô§ key hello ÂêéÔºåËøòËÉΩËØªÂà∞ÂéÜÂè≤ÁâàÊú¨Âêó?</p>
<p>Â¶Ç‰∏ãÈù¢ÁöÑÂëΩ‰ª§ÊâÄÁ§∫ÔºåÁ¨¨‰∏ÄÊ¨° key hello Êõ¥Êñ∞ÂÆåÂêéÔºåÊàë‰ª¨ÈÄöËøá get ÂëΩ‰ª§Ëé∑Âèñ‰∏ãÂÆÉÁöÑ key-value ËØ¶ÁªÜ‰ø°ÊÅØ„ÄÇÊ≠£Â¶Ç‰Ω†ÊâÄÁúãÂà∞ÁöÑÔºåÈô§‰∫Ü key„ÄÅvalue ‰ø°ÊÅØÔºåËøòÊúâÂêÑÁ±ªÁâàÊú¨Âè∑ÔºåÊàëÂêéÈù¢‰ºöËØ¶ÁªÜÂíå‰Ω†‰ªãÁªçÂÆÉ‰ª¨ÁöÑÂê´‰πâ„ÄÇËøôÈáåÊàë‰ª¨ÈáçÁÇπÂÖ≥Ê≥® mod_revisionÔºåÂÆÉË°®Á§∫ key ÊúÄÂêé‰∏ÄÊ¨°‰øÆÊîπÊó∂ÁöÑ etcd ÁâàÊú¨Âè∑„ÄÇ</p>
<p>ÂΩìÊàë‰ª¨ÂÜçÊ¨°Êõ¥Êñ∞ key hello ‰∏∫ world2 ÂêéÔºåÁÑ∂ÂêéÈÄöËøáÊü•ËØ¢Êó∂ÊåáÂÆö key Á¨¨‰∏ÄÊ¨°Êõ¥Êñ∞ÂêéÁöÑÁâàÊú¨Âè∑Ôºå‰Ω†‰ºöÂèëÁé∞Êàë‰ª¨Êü•ËØ¢Âà∞‰∫ÜÁ¨¨‰∏ÄÊ¨°Êõ¥Êñ∞ÁöÑÂÄºÔºåÁîöËá≥Êàë‰ª¨ÊâßË°åÂà†Èô§ key hello ÂêéÔºå‰æùÁÑ∂ÂèØ‰ª•Ëé∑ÂæóÂà∞Ëøô‰∏™ÂÄº„ÄÇÈÇ£‰πà etcd ÊòØÂ¶Ç‰ΩïÂÆûÁé∞ÁöÑÂë¢?</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span><span class="lnt">44
</span><span class="lnt">45
</span><span class="lnt">46
</span><span class="lnt">47
</span><span class="lnt">48
</span><span class="lnt">49
</span><span class="lnt">50
</span><span class="lnt">51
</span><span class="lnt">52
</span><span class="lnt">53
</span><span class="lnt">54
</span><span class="lnt">55
</span><span class="lnt">56
</span><span class="lnt">57
</span><span class="lnt">58
</span><span class="lnt">59
</span><span class="lnt">60
</span><span class="lnt">61
</span><span class="lnt">62
</span><span class="lnt">63
</span><span class="lnt">64
</span><span class="lnt">65
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-shell" data-lang="shell"><span class="line"><span class="cl">./etcdctl get node   --endpoints http://127.0.0.1:2379   --user<span class="o">=</span>root:root 
</span></span><span class="line"><span class="cl">node
</span></span><span class="line"><span class="cl">version2-healthy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./etcdctl get node   --endpoints http://127.0.0.1:2379   --user<span class="o">=</span>root:root  -w<span class="o">=</span>json <span class="p">|</span>  python -m json.tool
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;count&#34;</span>: 1,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;header&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;cluster_id&#34;</span>: 17237436991929493444,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;member_id&#34;</span>: 9372538179322589801,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;raft_term&#34;</span>: 20,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;revision&#34;</span>: <span class="m">11</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kvs&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;create_revision&#34;</span>: 9,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;key&#34;</span>: <span class="s2">&#34;bm9kZQ==&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;mod_revision&#34;</span>: 11,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;value&#34;</span>: <span class="s2">&#34;dmVyc2lvbjItaGVhbHRoeQ==&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;version&#34;</span>: <span class="m">3</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./etcdctl put  node version3-healthy  --endpoints http://127.0.0.1:2379   --user<span class="o">=</span>root:root                
</span></span><span class="line"><span class="cl">OK
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">./etcdctl get node   --endpoints http://127.0.0.1:2379   --user<span class="o">=</span>root:root  -w<span class="o">=</span>json <span class="p">|</span>  python -m json.tool         
</span></span><span class="line"><span class="cl"><span class="o">{</span>
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;count&#34;</span>: 1,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;header&#34;</span>: <span class="o">{</span>
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;cluster_id&#34;</span>: 17237436991929493444,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;member_id&#34;</span>: 9372538179322589801,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;raft_term&#34;</span>: 20,
</span></span><span class="line"><span class="cl">        <span class="s2">&#34;revision&#34;</span>: <span class="m">12</span>
</span></span><span class="line"><span class="cl">    <span class="o">}</span>,
</span></span><span class="line"><span class="cl">    <span class="s2">&#34;kvs&#34;</span>: <span class="o">[</span>
</span></span><span class="line"><span class="cl">        <span class="o">{</span>
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;create_revision&#34;</span>: 9,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;key&#34;</span>: <span class="s2">&#34;bm9kZQ==&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;mod_revision&#34;</span>: 12,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;value&#34;</span>: <span class="s2">&#34;dmVyc2lvbjMtaGVhbHRoeQ==&#34;</span>,
</span></span><span class="line"><span class="cl">            <span class="s2">&#34;version&#34;</span>: <span class="m">4</span>
</span></span><span class="line"><span class="cl">        <span class="o">}</span>
</span></span><span class="line"><span class="cl">    <span class="o">]</span>
</span></span><span class="line"><span class="cl"><span class="o">}</span>
</span></span><span class="line"><span class="cl">./etcdctl get node   --endpoints http://127.0.0.1:2379   --user<span class="o">=</span>root:root   
</span></span><span class="line"><span class="cl">node
</span></span><span class="line"><span class="cl">version3-healthy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#Ëøô‰∏™ÊòØ‰æØÊàëÊÉ≥Êü•ËØ¢ Âà∂ÂÆöÁâàÊú¨11ÁöÑnode</span>
</span></span><span class="line"><span class="cl">./etcdctl get node --rev<span class="o">=</span><span class="m">11</span>  --endpoints http://127.0.0.1:2379   --user<span class="o">=</span>root:root 
</span></span><span class="line"><span class="cl">node
</span></span><span class="line"><span class="cl">version2-healthy
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ÊàëË¶ÅÂà†Èô§node‰æØ</span>
</span></span><span class="line"><span class="cl">./etcdctl del  node   --endpoints http://127.0.0.1:2379   --user<span class="o">=</span>root:root
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="c1">#ËøòÂèØ‰ª•Êü•ÁúãÂà†Èô§ÂâçÁöÑÊï∞ÂÄº</span>
</span></span><span class="line"><span class="cl">./etcdctl get node --rev<span class="o">=</span><span class="m">12</span>  --endpoints http://127.0.0.1:2379   --user<span class="o">=</span>root:root 
</span></span><span class="line"><span class="cl">node
</span></span><span class="line"><span class="cl">version3-healthy
</span></span><span class="line"><span class="cl">./etcdctl get node --rev<span class="o">=</span><span class="m">11</span>  --endpoints http://127.0.0.1:2379   --user<span class="o">=</span>root:root 
</span></span><span class="line"><span class="cl">node
</span></span><span class="line"><span class="cl">version2-healthy
</span></span></code></pre></td></tr></table>
</div>
</div><p>Êï¥‰ΩìÊû∂ÊûÑ</p>
<p>Âú®ËØ¶ÁªÜÂíå‰Ω†‰ªãÁªç etcd Â¶Ç‰ΩïÂÆûÁé∞ MVCC ÁâπÊÄßÂâçÔºåÊàëÂÖàÂíå‰Ω†‰ªéÊï¥‰Ωì‰∏ä‰ªãÁªç‰∏ã MVCC Ê®°Âùó„ÄÇ‰∏ãÂõæÊòØ MVCC Ê®°ÂùóÁöÑ‰∏Ä‰∏™Êï¥‰ΩìÊû∂ÊûÑÂõæÔºåÊï¥‰∏™ MVCC ÁâπÊÄßÁî± treeIndex„ÄÅBackend/boltdb ÁªÑÊàê„ÄÇ</p>
<p>ÂΩì‰Ω†ÊâßË°å MVCC ÁâπÊÄßÂàù‰ΩìÈ™å‰∏≠ÁöÑ put ÂëΩ‰ª§ÂêéÔºåËØ∑Ê±ÇÁªèËøá gRPC KV Server„ÄÅRaft Ê®°ÂùóÊµÅËΩ¨ÔºåÂØπÂ∫îÁöÑÊó•ÂøóÊù°ÁõÆË¢´Êèê‰∫§ÂêéÔºåApply Ê®°ÂùóÂºÄÂßãÊâßË°åÊ≠§Êó•ÂøóÂÜÖÂÆπ„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/apply%e6%a8%a1%e5%9d%97%e5%ba%94%e7%94%a8%e6%97%b6mvcc%e7%9a%84%e6%95%b4%e4%bd%93%e6%9e%b6%e6%9e%84%e5%8f%8a%e6%93%8d%e4%bd%9c%e6%b5%81%e7%a8%8b.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>Apply Ê®°ÂùóÈÄöËøá MVCC Ê®°ÂùóÊù•ÊâßË°å put ËØ∑Ê±ÇÔºåÊåÅ‰πÖÂåñ key-value Êï∞ÊçÆ„ÄÇMVCC Ê®°ÂùóÂ∞ÜËØ∑Ê±ÇËØ∑ÂàíÂàÜÊàê‰∏§‰∏™Á±ªÂà´ÔºåÂàÜÂà´ÊòØËØª‰∫ãÂä°ÔºàReadTxnÔºâÂíåÂÜô‰∫ãÂä°ÔºàWriteTxnÔºâ„ÄÇËØª‰∫ãÂä°Ë¥üË¥£Â§ÑÁêÜ range ËØ∑Ê±ÇÔºåÂÜô‰∫ãÂä°Ë¥üË¥£ put/delete Êìç‰Ωú„ÄÇËØªÂÜô‰∫ãÂä°Âü∫‰∫é treeIndex„ÄÅBackend/boltdb Êèê‰æõÁöÑËÉΩÂäõÔºåÂÆûÁé∞ÂØπ key-value ÁöÑÂ¢ûÂà†ÊîπÊü•ÂäüËÉΩ„ÄÇ</p>
<p>treeIndex Ê®°ÂùóÂü∫‰∫éÂÜÖÂ≠òÁâà B-tree ÂÆûÁé∞‰∫Ü key Á¥¢ÂºïÁÆ°ÁêÜÔºåÂÆÉ‰øùÂ≠ò‰∫ÜÁî®Êà∑ key ‰∏éÁâàÊú¨Âè∑ÔºàrevisionÔºâÁöÑÊò†Â∞ÑÂÖ≥Á≥ªÁ≠â‰ø°ÊÅØ„ÄÇ</p>
<p>Backend Ê®°ÂùóË¥üË¥£ etcd ÁöÑ key-value ÊåÅ‰πÖÂåñÂ≠òÂÇ®Ôºå‰∏ªË¶ÅÁî± ReadTx„ÄÅBatchTx„ÄÅBuffer ÁªÑÊàêÔºåReadTx ÂÆö‰πâ‰∫ÜÊäΩË±°ÁöÑËØª‰∫ãÂä°Êé•Âè£ÔºåBatchTx Âú® ReadTx ‰πã‰∏äÂÆö‰πâ‰∫ÜÊäΩË±°ÁöÑÂÜô‰∫ãÂä°Êé•Âè£ÔºåBuffer ÊòØÊï∞ÊçÆÁºìÂ≠òÂå∫„ÄÇ</p>
<p>Backend Ê®°ÂùóË¥üË¥£ etcd ÁöÑ key-value ÊåÅ‰πÖÂåñÂ≠òÂÇ®Ôºå‰∏ªË¶ÅÁî± ReadTx„ÄÅBatchTx„ÄÅBuffer ÁªÑÊàêÔºåReadTx ÂÆö‰πâ‰∫ÜÊäΩË±°ÁöÑËØª‰∫ãÂä°Êé•Âè£ÔºåBatchTx Âú® ReadTx ‰πã‰∏äÂÆö‰πâ‰∫ÜÊäΩË±°ÁöÑÂÜô‰∫ãÂä°Êé•Âè£ÔºåBuffer ÊòØÊï∞ÊçÆÁºìÂ≠òÂå∫„ÄÇ</p>
<p>etcd ËÆæËÆ°‰∏äÊîØÊåÅÂ§öÁßç Backend ÂÆûÁé∞ÔºåÁõÆÂâçÂÆûÁé∞ÁöÑ Backend ÊòØ boltdb„ÄÇboltdb ÊòØ‰∏Ä‰∏™Âü∫‰∫é B+ tree ÂÆûÁé∞ÁöÑ„ÄÅÊîØÊåÅ‰∫ãÂä°ÁöÑ key-value ÂµåÂÖ•ÂºèÊï∞ÊçÆÂ∫ì„ÄÇ</p>
<p>treeIndex ‰∏é boltdb ÂÖ≥Á≥ª‰Ω†ÂèØÂèÇËÄÉ‰∏ãÂõæ„ÄÇÂΩì‰Ω†ÂèëËµ∑‰∏Ä‰∏™ get hello ÂëΩ‰ª§Êó∂Ôºå‰ªé treeIndex ‰∏≠Ëé∑Âèñ key ÁöÑÁâàÊú¨Âè∑ÔºåÁÑ∂ÂêéÂÜçÈÄöËøáËøô‰∏™ÁâàÊú¨Âè∑Ôºå‰ªé boltdb Ëé∑Âèñ value ‰ø°ÊÅØ„ÄÇboltdb ÁöÑ value ÊòØÂåÖÂê´Áî®Êà∑ key-value„ÄÅÂêÑÁßçÁâàÊú¨Âè∑„ÄÅlease ‰ø°ÊÅØÁöÑÁªìÊûÑ‰Ωì„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/treeindex-boltdb%e7%9a%84%e5%85%b3%e7%b3%bb.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>Êé•‰∏ãÊù•ÊàëÂíå‰Ω†ÈáçÁÇπËÅäËÅä treeIndex Ê®°ÂùóÁöÑÂéüÁêÜ‰∏éÊ†∏ÂøÉÊï∞ÊçÆÁªìÊûÑ„ÄÇ</p>
<p>treeIndex ÂéüÁêÜ</p>
<p>‰∏∫‰ªÄ‰πàÈúÄË¶Å treeIndex Ê®°ÂùóÂë¢?ÂØπ‰∫é etcd v2 Êù•ËØ¥ÔºåÂΩì‰Ω†ÈÄöËøá etcdctl ÂèëËµ∑‰∏Ä‰∏™ put hello Êìç‰ΩúÊó∂Ôºåetcd v2 Áõ¥Êé•Êõ¥Êñ∞ÂÜÖÂ≠òÊ†ëÔºåËøôÂ∞±ÂØºËá¥ÂéÜÂè≤ÁâàÊú¨Áõ¥Êé•Ë¢´Ë¶ÜÁõñÔºåÊó†Ê≥ïÊîØÊåÅ‰øùÂ≠ò key ÁöÑÂéÜÂè≤ÁâàÊú¨„ÄÇÂú® etcd v3 ‰∏≠ÂºïÂÖ• treeIndex Ê®°ÂùóÊ≠£ÊòØ‰∏∫‰∫ÜËß£ÂÜ≥Ëøô‰∏™ÈóÆÈ¢òÔºåÊîØÊåÅ‰øùÂ≠ò key ÁöÑÂéÜÂè≤ÁâàÊú¨ÔºåÊèê‰æõÁ®≥ÂÆöÁöÑ Watch Êú∫Âà∂Âíå‰∫ãÂä°ÈöîÁ¶ªÁ≠âËÉΩÂäõ„ÄÇ</p>
<p>ÈÇ£ etcd v3 ÂèàÊòØÂ¶Ç‰ΩïÂü∫‰∫é treeIndex Ê®°ÂùóÔºåÂÆûÁé∞‰øùÂ≠ò key ÁöÑÂéÜÂè≤ÁâàÊú¨ÁöÑÂë¢?</p>
<p>Âú® 02 ËäÇËØæÈáåÔºåÊàë‰ª¨ÊèêÂà∞Ëøá etcd Âú®ÊØèÊ¨°‰øÆÊîπ key Êó∂‰ºöÁîüÊàê‰∏Ä‰∏™ÂÖ®Â±ÄÈÄíÂ¢ûÁöÑÁâàÊú¨Âè∑ÔºàrevisionÔºâÔºåÁÑ∂ÂêéÈÄöËøáÊï∞ÊçÆÁªìÊûÑ B-tree ‰øùÂ≠òÁî®Êà∑ key ‰∏éÁâàÊú¨Âè∑‰πãÈó¥ÁöÑÂÖ≥Á≥ªÔºåÂÜç‰ª•ÁâàÊú¨Âè∑‰Ωú‰∏∫ boltdb keyÔºå‰ª•Áî®Êà∑ÁöÑ key-value Á≠â‰ø°ÊÅØ‰Ωú‰∏∫ boltdb valueÔºå‰øùÂ≠òÂà∞ boltdb</p>
<p>‰∏ãÈù¢ÊàëÂ∞±‰∏∫‰Ω†‰ªãÁªç‰∏ãÔºåetcd ‰øùÂ≠òÁî®Êà∑ key ‰∏éÁâàÊú¨Âè∑Êò†Â∞ÑÂÖ≥Á≥ªÁöÑÊï∞ÊçÆÁªìÊûÑ B-treeÔºå‰∏∫‰ªÄ‰πà etcd ‰ΩøÁî®ÂÆÉËÄå‰∏ç‰ΩøÁî®ÂìàÂ∏åË°®„ÄÅÂπ≥Ë°°‰∫åÂèâÊ†ëÔºü</p>
<p>‰ªé etcd ÁöÑÂäüËÉΩÁâπÊÄß‰∏äÂàÜÊûêÔºå Âõ† etcd ÊîØÊåÅËåÉÂõ¥Êü•ËØ¢ÔºåÂõ†Ê≠§‰øùÂ≠òÁ¥¢ÂºïÁöÑÊï∞ÊçÆÁªìÊûÑ‰πüÂøÖÈ°ªÊîØÊåÅËåÉÂõ¥Êü•ËØ¢ÊâçË°å„ÄÇÊâÄ‰ª•ÂìàÂ∏åË°®‰∏çÈÄÇÂêàÔºåËÄå B-tree ÊîØÊåÅËåÉÂõ¥Êü•ËØ¢„ÄÇ</p>
<p>‰ªé etcd ÁöÑÂäüËÉΩÁâπÊÄß‰∏äÂàÜÊûêÔºå Âõ† etcd ÊîØÊåÅËåÉÂõ¥Êü•ËØ¢ÔºåÂõ†Ê≠§‰øùÂ≠òÁ¥¢ÂºïÁöÑÊï∞ÊçÆÁªìÊûÑ‰πüÂøÖÈ°ªÊîØÊåÅËåÉÂõ¥Êü•ËØ¢ÊâçË°å„ÄÇÊâÄ‰ª•ÂìàÂ∏åË°®‰∏çÈÄÇÂêàÔºåËÄå B-tree ÊîØÊåÅËåÉÂõ¥Êü•ËØ¢„ÄÇ</p>
<p>‰ªéÊÄßËÉΩ‰∏äÂàÜÊûêÔºåÂπ≥Ê®™‰∫åÂèâÊ†ëÊØè‰∏™ËäÇÁÇπÂè™ËÉΩÂÆπÁ∫≥‰∏Ä‰∏™Êï∞ÊçÆ„ÄÅÂØºËá¥Ê†ëÁöÑÈ´òÂ∫¶ËæÉÈ´òÔºåËÄå B-tree ÊØè‰∏™ËäÇÁÇπÂèØ‰ª•ÂÆπÁ∫≥Â§ö‰∏™Êï∞ÊçÆÔºåÊ†ëÁöÑÈ´òÂ∫¶Êõ¥‰ΩéÔºåÊõ¥ÊâÅÂπ≥ÔºåÊ∂âÂèäÁöÑÊü•ÊâæÊ¨°Êï∞Êõ¥Â∞ëÔºåÂÖ∑Êúâ‰ºòË∂äÁöÑÂ¢û„ÄÅÂà†„ÄÅÊîπ„ÄÅÊü•ÊÄßËÉΩ„ÄÇ</p>
<p>Google ÁöÑÂºÄÊ∫êÈ°πÁõÆ btreeÔºå‰ΩøÁî® Go ËØ≠Ë®ÄÂÆûÁé∞‰∫Ü‰∏Ä‰∏™ÂÜÖÂ≠òÁâàÁöÑ B-treeÔºåÂØπÂ§ñÊèê‰æõ‰∫ÜÁÆÄÂçïÊòìÁî®ÁöÑÊé•Âè£„ÄÇetcd Ê≠£ÊòØÂü∫‰∫é btree Â∫ìÂÆûÁé∞‰∫Ü‰∏Ä‰∏™Âêç‰∏∫ treeIndex ÁöÑÁ¥¢ÂºïÊ®°ÂùóÔºåÈÄöËøáÂÆÉÊù•Êü•ËØ¢„ÄÅ‰øùÂ≠òÁî®Êà∑ key ‰∏éÁâàÊú¨Âè∑‰πãÈó¥ÁöÑÂÖ≥Á≥ª„ÄÇ</p>
<p>‰∏ãÂõæÊòØ‰∏™ÊúÄÂ§ßÂ∫¶Ôºàdegree &gt; 1ÔºåÁÆÄÁß∞ dÔºâ‰∏∫ 5 ÁöÑ B-treeÔºåÂ∫¶ÊòØ B-tree ‰∏≠ÁöÑ‰∏Ä‰∏™Ê†∏ÂøÉÂèÇÊï∞ÔºåÂÆÉÂÜ≥ÂÆö‰∫Ü‰Ω†ÊØè‰∏™ËäÇÁÇπ‰∏äÁöÑÊï∞ÊçÆÈáèÂ§öÂ∞ë„ÄÅËäÇÁÇπÁöÑ‚ÄúËÉñ‚Äù„ÄÅ‚ÄúÁò¶‚ÄùÁ®ãÂ∫¶„ÄÇ</p>
<p>‰ªéÂõæ‰∏≠‰Ω†ÂèØ‰ª•ÁúãÂà∞ÔºåËäÇÁÇπË∂äËÉñÔºåÊÑèÂë≥ÁùÄ‰∏Ä‰∏™ËäÇÁÇπÂèØ‰ª•Â≠òÂÇ®Êõ¥Â§öÊï∞ÊçÆÔºåÊ†ëÁöÑÈ´òÂ∫¶Ë∂ä‰Ωé„ÄÇÂú®‰∏Ä‰∏™Â∫¶‰∏∫ d ÁöÑ B-tree ‰∏≠ÔºåËäÇÁÇπ‰øùÂ≠òÁöÑÊúÄÂ§ß key Êï∞‰∏∫ 2d - 1ÔºåÂê¶ÂàôÈúÄË¶ÅËøõË°åÂπ≥Ë°°„ÄÅÂàÜË£ÇÊìç‰Ωú„ÄÇËøôÈáå‰Ω†Ë¶ÅÊ≥®ÊÑèÁöÑÊòØÂú® etcd treeIndex Ê®°Âùó‰∏≠ÔºåÂàõÂª∫ÁöÑÊòØÊúÄÂ§ßÂ∫¶ 32 ÁöÑ B-treeÔºå‰πüÂ∞±ÊòØ‰∏Ä‰∏™Âè∂Â≠êËäÇÁÇπÊúÄÂ§öÂèØ‰ª•‰øùÂ≠ò 63 ‰∏™ key„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/btree.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>‰ªéÂõæ‰∏≠‰Ω†ÂèØ‰ª•ÁúãÂà∞Ôºå‰Ω†ÈÄöËøá put/txn ÂëΩ‰ª§ÂÜôÂÖ•ÁöÑ‰∏ÄÁ≥ªÂàó keyÔºåtreeIndex Ê®°ÂùóÂü∫‰∫é B-tree Â∞ÜÂÖ∂ÁªÑÁªáËµ∑Êù•ÔºåËäÇÁÇπ‰πãÈó¥Âü∫‰∫éÁî®Êà∑ key ÊØîËæÉÂ§ßÂ∞è„ÄÇÂΩì‰Ω†Êü•Êâæ‰∏Ä‰∏™ key k95 Êó∂ÔºåÈÄöËøá B-tree ÁöÑÁâπÊÄßÔºå‰Ω†‰ªÖÈúÄÈÄöËøáÂõæ‰∏≠ÊµÅÁ®ã 1 Âíå 2 ‰∏§Ê¨°Âø´ÈÄüÊØîËæÉÔºåÂ∞±ÂèØÂø´ÈÄüÊâæÂà∞ k95 ÊâÄÂú®ÁöÑËäÇÁÇπ„ÄÇ</p>
<p>Âú® treeIndex ‰∏≠ÔºåÊØè‰∏™ËäÇÁÇπÁöÑ key ÊòØ‰∏Ä‰∏™ keyIndex ÁªìÊûÑÔºåetcd Â∞±ÊòØÈÄöËøáÂÆÉ‰øùÂ≠ò‰∫ÜÁî®Êà∑ÁöÑ key ‰∏éÁâàÊú¨Âè∑ÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇ</p>
<p>ÈÇ£‰πà keyIndex ÁªìÊûÑÂåÖÂê´Âì™‰∫õ‰ø°ÊÅØÂë¢Ôºü‰∏ãÈù¢ÊòØÂ≠óÊÆµËØ¥ÊòéÔºå‰Ω†ÂèØ‰ª•ÂèÇËÄÉ‰∏Ä‰∏ã„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Âú® treeIndex ‰∏≠ÔºåÊØè‰∏™ËäÇÁÇπÁöÑ key ÊòØ‰∏Ä‰∏™ keyIndex ÁªìÊûÑÔºåetcd Â∞±ÊòØÈÄöËøáÂÆÉ‰øùÂ≠ò‰∫ÜÁî®Êà∑ÁöÑ key ‰∏éÁâàÊú¨Âè∑ÁöÑÊò†Â∞ÑÂÖ≥Á≥ª„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><p>ÈÇ£‰πà keyIndex ÁªìÊûÑÂåÖÂê´Âì™‰∫õ‰ø°ÊÅØÂë¢Ôºü‰∏ãÈù¢ÊòØÂ≠óÊÆµËØ¥ÊòéÔºå‰Ω†ÂèØ‰ª•ÂèÇËÄÉ‰∏Ä‰∏ã„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-go" data-lang="go"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="kd">type</span> <span class="nx">keyIndex</span> <span class="kd">struct</span> <span class="p">{</span>
</span></span><span class="line"><span class="cl">   <span class="nx">key</span>         <span class="p">[]</span><span class="kt">byte</span> <span class="c1">//Áî®Êà∑ÁöÑkeyÂêçÁß∞ÔºåÊØîÂ¶ÇÊàë‰ª¨Ê°à‰æã‰∏≠ÁöÑ&#34;hello&#34;
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">modified</span>    <span class="nx">revision</span> <span class="c1">//ÊúÄÂêé‰∏ÄÊ¨°‰øÆÊîπkeyÊó∂ÁöÑetcdÁâàÊú¨Âè∑,ÊØîÂ¶ÇÊàë‰ª¨Ê°à‰æã‰∏≠ÁöÑÂàöÂÜôÂÖ•hello‰∏∫world1Êó∂ÁöÑÔºåÁâàÊú¨Âè∑‰∏∫2
</span></span></span><span class="line"><span class="cl"><span class="c1"></span>   <span class="nx">generations</span> <span class="p">[]</span><span class="nx">generation</span> <span class="c1">//generation‰øùÂ≠ò‰∫Ü‰∏Ä‰∏™keyËã•Âπ≤‰ª£ÁâàÊú¨Âè∑‰ø°ÊÅØÔºåÊØè‰ª£‰∏≠ÂåÖÂê´ÂØπkeyÁöÑÂ§öÊ¨°‰øÆÊîπÁöÑÁâàÊú¨Âè∑ÂàóË°®
</span></span></span><span class="line"><span class="cl"><span class="c1"></span><span class="p">}</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>keyIndex ‰∏≠ÂåÖÂê´Áî®Êà∑ÁöÑ key„ÄÅÊúÄÂêé‰∏ÄÊ¨°‰øÆÊîπ key Êó∂ÁöÑ etcd ÁâàÊú¨Âè∑„ÄÅkey ÁöÑËã•Âπ≤‰ª£ÔºàgenerationÔºâÁâàÊú¨Âè∑‰ø°ÊÅØÔºåÊØè‰ª£‰∏≠ÂåÖÂê´ÂØπ key ÁöÑÂ§öÊ¨°‰øÆÊîπÁöÑÁâàÊú¨Âè∑ÂàóË°®„ÄÇÈÇ£Êàë‰ª¨Ë¶ÅÂ¶Ç‰ΩïÁêÜËß£ generationsÔºü‰∏∫‰ªÄ‰πàÂÆÉÊòØ‰∏™Êï∞ÁªÑÂë¢?</p>
<p>generations Ë°®Á§∫‰∏Ä‰∏™ key ‰ªéÂàõÂª∫Âà∞Âà†Èô§ÁöÑËøáÁ®ãÔºåÊØè‰ª£ÂØπÂ∫î key ÁöÑ‰∏Ä‰∏™ÁîüÂëΩÂë®ÊúüÁöÑÂºÄÂßã‰∏éÁªìÊùü„ÄÇÂΩì‰Ω†Á¨¨‰∏ÄÊ¨°ÂàõÂª∫‰∏Ä‰∏™ key Êó∂Ôºå‰ºöÁîüÊàêÁ¨¨ 0 ‰ª£ÔºåÂêéÁª≠ÁöÑ‰øÆÊîπÊìç‰ΩúÈÉΩÊòØÂú®ÂæÄÁ¨¨ 0 ‰ª£‰∏≠ËøΩÂä†‰øÆÊîπÁâàÊú¨Âè∑„ÄÇÂΩì‰Ω†Êää key Âà†Èô§ÂêéÔºåÂÆÉÂ∞±‰ºöÁîüÊàêÊñ∞ÁöÑÁ¨¨ 1 ‰ª£Ôºå‰∏Ä‰∏™ key ‰∏çÊñ≠ÁªèÂéÜÂàõÂª∫„ÄÅÂà†Èô§ÁöÑËøáÁ®ãÔºåÂÆÉÂ∞±‰ºöÁîüÊàêÂ§ö‰∏™‰ª£„ÄÇ</p>
<p>generation ÁªìÊûÑËØ¶ÁªÜ‰ø°ÊÅØÂ¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">type generation struct {
</span></span><span class="line"><span class="cl">   ver     int64    //Ë°®Á§∫Ê≠§keyÁöÑ‰øÆÊîπÊ¨°Êï∞
</span></span><span class="line"><span class="cl">   created revision //Ë°®Á§∫generationÁªìÊûÑÂàõÂª∫Êó∂ÁöÑÁâàÊú¨Âè∑
</span></span><span class="line"><span class="cl">   revs    []revision //ÊØèÊ¨°‰øÆÊîπkeyÊó∂ÁöÑrevisionËøΩÂä†Âà∞Ê≠§Êï∞ÁªÑ
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">generation ÁªìÊûÑ‰∏≠ÂåÖÂê´Ê≠§ key ÁöÑ‰øÆÊîπÊ¨°Êï∞„ÄÅgeneration ÂàõÂª∫Êó∂ÁöÑÁâàÊú¨Âè∑„ÄÅÂØπÊ≠§ key ÁöÑ‰øÆÊîπÁâàÊú¨Âè∑ËÆ∞ÂΩïÂàóË°®„ÄÇ
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰Ω†ÈúÄË¶ÅÊ≥®ÊÑèÁöÑÊòØÁâàÊú¨Âè∑ÔºàrevisionÔºâÂπ∂‰∏çÊòØ‰∏Ä‰∏™ÁÆÄÂçïÁöÑÊï¥Êï∞ÔºåËÄåÊòØ‰∏Ä‰∏™ÁªìÊûÑ‰Ωì„ÄÇrevision ÁªìÊûÑÂèäÂê´‰πâÂ¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">type revision struct {
</span></span><span class="line"><span class="cl">   main int64    // ‰∏Ä‰∏™ÂÖ®Â±ÄÈÄíÂ¢ûÁöÑ‰∏ªÁâàÊú¨Âè∑ÔºåÈöèput/txn/delete‰∫ãÂä°ÈÄíÂ¢ûÔºå‰∏Ä‰∏™‰∫ãÂä°ÂÜÖÁöÑkey mainÁâàÊú¨Âè∑ÊòØ‰∏ÄËá¥ÁöÑ
</span></span><span class="line"><span class="cl">   sub int64    // ‰∏Ä‰∏™‰∫ãÂä°ÂÜÖÁöÑÂ≠êÁâàÊú¨Âè∑Ôºå‰ªé0ÂºÄÂßãÈöè‰∫ãÂä°ÂÜÖput/deleteÊìç‰ΩúÈÄíÂ¢û
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>revision ÂåÖÂê´ main Âíå sub ‰∏§‰∏™Â≠óÊÆµÔºåmain ÊòØÂÖ®Â±ÄÈÄíÂ¢ûÁöÑÁâàÊú¨Âè∑ÔºåÂÆÉÊòØ‰∏™ etcd ÈÄªËæëÊó∂ÈíüÔºåÈöèÁùÄ put/txn/delete Á≠â‰∫ãÂä°ÈÄíÂ¢û„ÄÇsub ÊòØ‰∏Ä‰∏™‰∫ãÂä°ÂÜÖÁöÑÂ≠êÁâàÊú¨Âè∑Ôºå‰ªé 0 ÂºÄÂßãÈöè‰∫ãÂä°ÂÜÖÁöÑ put/delete Êìç‰ΩúÈÄíÂ¢û„ÄÇ</p>
<p>ÊØîÂ¶ÇÂêØÂä®‰∏Ä‰∏™Á©∫ÈõÜÁæ§ÔºåÂÖ®Â±ÄÁâàÊú¨Âè∑ÈªòËÆ§‰∏∫ 1ÔºåÊâßË°å‰∏ãÈù¢ÁöÑ txn ‰∫ãÂä°ÔºåÂÆÉÂåÖÂê´‰∏§Ê¨° put„ÄÅ‰∏ÄÊ¨° get Êìç‰ΩúÔºåÈÇ£‰πàÊåâÁÖßÊàë‰ª¨‰∏äÈù¢‰ªãÁªçÁöÑÂéüÁêÜÔºåÂÖ®Â±ÄÁâàÊú¨Âè∑ÈöèËØªÂÜô‰∫ãÂä°Ëá™Â¢ûÔºåÂõ†Ê≠§ÊòØ main ‰∏∫ 2Ôºåsub Èöè‰∫ãÂä°ÂÜÖÁöÑ put/delete Êìç‰ΩúÈÄíÂ¢ûÔºåÂõ†Ê≠§ key hello ÁöÑ revison ‰∏∫{2,0}Ôºåkey world ÁöÑ revision ‰∏∫{2,1}„ÄÇ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">$ etcdctl txn -i
</span></span><span class="line"><span class="cl">compares:
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">success requests (getÔºåputÔºådel):
</span></span><span class="line"><span class="cl">put hello 1
</span></span><span class="line"><span class="cl">get hello
</span></span><span class="line"><span class="cl">put world 2
</span></span></code></pre></td></tr></table>
</div>
</div><p>‰ªãÁªçÂÆå treeIndex Âü∫Êú¨ÂéüÁêÜ„ÄÅÊ†∏ÂøÉÊï∞ÊçÆÁªìÊûÑÂêéÔºåÊàë‰ª¨ÂÜçÁúãÁúãÂú® MVCC ÁâπÊÄßÂàù‰ΩìÈ™å‰∏≠ÁöÑÊõ¥Êñ∞„ÄÅÊü•ËØ¢„ÄÅÂà†Èô§ key Ê°à‰æãÈáåÔºåtreeIndex ‰∏é boltdb ÊòØÂ¶Ç‰ΩïÂçè‰ΩúÔºåÂÆåÊàê‰ª•‰∏ä key-value Êìç‰ΩúÁöÑ?</p>
<p>MVCC Êõ¥Êñ∞ key ÂéüÁêÜ</p>
<p>ÂΩì‰Ω†ÈÄöËøá etcdctl ÂèëËµ∑‰∏Ä‰∏™ put hello Êìç‰ΩúÊó∂ÔºåÂ¶Ç‰∏ãÈù¢ÁöÑ put ‰∫ãÂä°ÊµÅÁ®ãÂõæÊµÅÁ®ã‰∏ÄÊâÄÁ§∫ÔºåÂú® put ÂÜô‰∫ãÂä°‰∏≠ÔºåÈ¶ñÂÖàÂÆÉÈúÄË¶Å‰ªé treeIndex Ê®°Âùó‰∏≠Êü•ËØ¢ key ÁöÑ keyIndex Á¥¢Âºï‰ø°ÊÅØÔºåkeyIndex ‰∏≠Â≠òÂÇ®‰∫Ü key ÁöÑÂàõÂª∫ÁâàÊú¨Âè∑„ÄÅ‰øÆÊîπÁöÑÊ¨°Êï∞Á≠â‰ø°ÊÅØÔºåËøô‰∫õ‰ø°ÊÅØÂú®‰∫ãÂä°‰∏≠ÂèëÊå•ÁùÄÈáçË¶Å‰ΩúÁî®ÔºåÂõ†Ê≠§‰ºöÂ≠òÂÇ®Âú® boltdb ÁöÑ value ‰∏≠„ÄÇ</p>
<p>Âú®Êàë‰ª¨ÁöÑÊ°à‰æã‰∏≠ÔºåÂõ†‰∏∫ÊòØÁ¨¨‰∏ÄÊ¨°ÂàõÂª∫ hello keyÔºåÊ≠§Êó∂ keyIndex Á¥¢Âºï‰∏∫Á©∫„ÄÇ</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/%e4%ba%8b%e5%8a%a1%e6%b5%81%e7%a8%8b.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>ÂÖ∂Ê¨° etcd ‰ºöÊ†πÊçÆÂΩìÂâçÁöÑÂÖ®Â±ÄÁâàÊú¨Âè∑ÔºàÁ©∫ÈõÜÁæ§ÂêØÂä®Êó∂ÈªòËÆ§‰∏∫ 1ÔºâËá™Â¢ûÔºåÁîüÊàê put hello Êìç‰ΩúÂØπÂ∫îÁöÑÁâàÊú¨Âè∑ revision{2,0}ÔºåËøôÂ∞±ÊòØ boltdb ÁöÑ key„ÄÇ</p>
<p>boltdb ÁöÑ value ÊòØ mvccpb.KeyValue ÁªìÊûÑ‰ΩìÔºåÂÆÉÊòØÁî±Áî®Êà∑ key„ÄÅvalue„ÄÅcreate_revision„ÄÅmod_revision„ÄÅversion„ÄÅlease ÁªÑÊàê„ÄÇÂÆÉ‰ª¨ÁöÑÂê´‰πâÂàÜÂà´Â¶Ç‰∏ãÔºö</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">create_revision Ë°®Á§∫Ê≠§ key ÂàõÂª∫Êó∂ÁöÑÁâàÊú¨Âè∑„ÄÇÂú®Êàë‰ª¨ÁöÑÊ°à‰æã‰∏≠Ôºåkey hello ÊòØÁ¨¨‰∏ÄÊ¨°ÂàõÂª∫ÔºåÈÇ£‰πàÂÄºÂ∞±ÊòØ 2„ÄÇÂΩì‰Ω†ÂÜçÊ¨°‰øÆÊîπ key hello ÁöÑÊó∂ÂÄôÔºåÂÜô‰∫ãÂä°‰ºö‰ªé treeIndex Ê®°ÂùóÊü•ËØ¢ hello Á¨¨‰∏ÄÊ¨°ÂàõÂª∫ÁöÑÁâàÊú¨Âè∑Ôºå‰πüÂ∞±ÊòØ keyIndex.generations[i].created Â≠óÊÆµÔºåËµãÂÄºÁªô create_revision Â≠óÊÆµÔºõ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mod_revision Ë°®Á§∫ key ÊúÄÂêé‰∏ÄÊ¨°‰øÆÊîπÊó∂ÁöÑÁâàÊú¨Âè∑ÔºåÂç≥ put Êìç‰ΩúÂèëÁîüÊó∂ÁöÑÂÖ®Â±ÄÁâàÊú¨Âè∑Âä† 1Ôºõ
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">version Ë°®Á§∫Ê≠§ key ÁöÑ‰øÆÊîπÊ¨°Êï∞„ÄÇÊØèÊ¨°‰øÆÊîπÁöÑÊó∂ÂÄôÔºåÂÜô‰∫ãÂä°‰ºö‰ªé treeIndex Ê®°ÂùóÊü•ËØ¢ hello Â∑≤ÁªèÂéÜËøáÁöÑ‰øÆÊîπÊ¨°Êï∞Ôºå‰πüÂ∞±ÊòØ keyIndex.generations[i].ver Â≠óÊÆµÔºåÂ∞Ü ver Â≠óÊÆµÂÄºÂä† 1 ÂêéÔºåËµãÂÄºÁªô version Â≠óÊÆµ
</span></span></code></pre></td></tr></table>
</div>
</div><p>Â°´ÂÖÖÂ•Ω boltdb ÁöÑ KeyValue ÁªìÊûÑ‰ΩìÂêéÔºåËøôÊó∂Â∞±ÂèØ‰ª•ÈÄöËøá Backend ÁöÑÂÜô‰∫ãÂä° batchTx Êé•Âè£Â∞Ü key{2,0},value ‰∏∫ mvccpb.KeyValue ‰øùÂ≠òÂà∞ boltdb ÁöÑÁºìÂ≠ò‰∏≠ÔºåÂπ∂ÂêåÊ≠•Êõ¥Êñ∞ bufferÔºåÂ¶Ç‰∏äÂõæ‰∏≠ÁöÑÊµÅÁ®ã‰∫åÊâÄÁ§∫„ÄÇ</p>
<p>Ê≠§Êó∂Â≠òÂÇ®Âà∞ boltdb ‰∏≠ÁöÑ key„ÄÅvalue Êï∞ÊçÆÂ¶Ç‰∏ãÔºö</p>
<p><img src="/Users/hanzhongzi/Downloads/%e4%b8%8a%e7%8f%ad%e4%b8%b4%e6%97%b6%e6%96%87%e6%a1%a3/img/mvcc%e5%ba%93%e9%87%8c%e5%ad%98%e7%9a%84.webp"
	
	
	
	loading="lazy"
	
	
></p>
<p>ÁÑ∂Âêé put ‰∫ãÂä°ÈúÄÂ∞ÜÊú¨Ê¨°‰øÆÊîπÁöÑÁâàÊú¨Âè∑‰∏éÁî®Êà∑ key ÁöÑÊò†Â∞ÑÂÖ≥Á≥ª‰øùÂ≠òÂà∞ treeIndex Ê®°Âùó‰∏≠Ôºå‰πüÂ∞±ÊòØ‰∏äÂõæ‰∏≠ÁöÑÊµÅÁ®ã‰∏â„ÄÇÂõ†‰∏∫ key hello ÊòØÈ¶ñÊ¨°ÂàõÂª∫ÔºåtreeIndex Ê®°ÂùóÂÆÉ‰ºöÁîüÊàê key hello ÂØπÂ∫îÁöÑ keyIndex ÂØπË±°ÔºåÂπ∂Â°´ÂÖÖÁõ∏ÂÖ≥Êï∞ÊçÆÁªìÊûÑ„ÄÇ</p>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/etcd/">etcd</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">Áõ∏ÂÖ≥ÊñáÁ´†</h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/proxysql-%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%90%9E%E5%AE%9A/">
        
        

        <div class="article-details">
            <h2 class="article-title">ProxySql ‰∏ÄÁØáÊñáÁ´†ÊêûÂÆö</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/ansible-%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%90%9E%E5%AE%9A/">
        
        

        <div class="article-details">
            <h2 class="article-title">Ansible ‰∏ÄÁØáÊñáÁ´†ÊêûÂÆö</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    
    Waline.init({"comment":true,"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["//unpkg.com/@waline/emojis@1.1.0/bilibili","//unpkg.com/@waline/emojis@0.1.0/weibo","cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tw-emoji","cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/alus","cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq","cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tieba"],"locale":{"admin":"Admin","placeholder":"ËØ∑ÊñáÊòéÂèëË®ÄÂìü „Éæ(‚âß‚ñΩ‚â¶*)o","sofa":"Âø´Êù•ÂèëË°®‰Ω†ÁöÑÊÑèËßÅÂêß (‚âß‚àÄ‚â¶)„Çû"},"pageview":true,"reaction":true,"reactiontext":["ÁÇπËµû","Ë∏©‰∏Ä‰∏ã","ÂæóÊÑè","‰∏çÂ±ë","Â∞¥Â∞¨","Áù°Ëßâ"],"reactiontitle":"‰Ω†ËÆ§‰∏∫ËøôÁØáÊñáÁ´†ÊÄé‰πàÊ†∑Ôºü","requiredMeta":["name","email","url"],"serverURL":"https://app-production-dfd0.up.railway.app"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 hanzhongzi
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ‰∏ªÈ¢ò <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.21.0">Stack</a></b> Áî± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> ËÆæËÆ°
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
