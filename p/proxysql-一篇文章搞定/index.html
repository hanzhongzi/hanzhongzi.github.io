<!DOCTYPE html>
<html lang="zh-cn" dir="ltr">
    <head><meta charset='utf-8'>
<meta name='viewport' content='width=device-width, initial-scale=1'><meta name='description' content='ProxySql å®‰è£…éƒ¨ç½²ã€é…ç½®'>
<title>ProxySql ä¸€ç¯‡æ–‡ç« æå®š</title>

<link rel='canonical' href='https://hanzhongzi.github.io/p/proxysql-%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%90%9E%E5%AE%9A/'>

<link rel="stylesheet" href="/scss/style.min.abbd69b2908fdfcd5179898beaafd374514a86538d81639ddd2c58c06ae54e40.css"><meta property='og:title' content='ProxySql ä¸€ç¯‡æ–‡ç« æå®š'>
<meta property='og:description' content='ProxySql å®‰è£…éƒ¨ç½²ã€é…ç½®'>
<meta property='og:url' content='https://hanzhongzi.github.io/p/proxysql-%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%90%9E%E5%AE%9A/'>
<meta property='og:site_name' content='ç€šä¸­å­çš„ä¸ªäººç½‘ç«™'>
<meta property='og:type' content='article'><meta property='article:section' content='Post' /><meta property='article:tag' content='proxysql' /><meta property='article:published_time' content='2024-01-02T16:55:27&#43;08:00'/><meta property='article:modified_time' content='2024-01-02T16:55:27&#43;08:00'/>
<meta name="twitter:title" content="ProxySql ä¸€ç¯‡æ–‡ç« æå®š">
<meta name="twitter:description" content="ProxySql å®‰è£…éƒ¨ç½²ã€é…ç½®">
    </head>
    <body class="
    article-page
    ">
    <script>
        (function() {
            const colorSchemeKey = 'StackColorScheme';
            if(!localStorage.getItem(colorSchemeKey)){
                localStorage.setItem(colorSchemeKey, "auto");
            }
        })();
    </script><script>
    (function() {
        const colorSchemeKey = 'StackColorScheme';
        const colorSchemeItem = localStorage.getItem(colorSchemeKey);
        const supportDarkMode = window.matchMedia('(prefers-color-scheme: dark)').matches === true;

        if (colorSchemeItem == 'dark' || colorSchemeItem === 'auto' && supportDarkMode) {
            

            document.documentElement.dataset.scheme = 'dark';
        } else {
            document.documentElement.dataset.scheme = 'light';
        }
    })();
</script>
<div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky ">
    <button class="hamburger hamburger--spin" type="button" id="toggle-menu" aria-label="åˆ‡æ¢èœå•">
        <span class="hamburger-box">
            <span class="hamburger-inner"></span>
        </span>
    </button>

    <header>
        
            
            <figure class="site-avatar">
                <a href="/">
                
                    
                    
                    
                        
                        <img src="/img/avatar_hu190e528798e90195d3cefef01f0a2d44_410_300x0_resize_box_3.png" width="300"
                            height="300" class="site-logo" loading="lazy" alt="Avatar">
                    
                
                </a>
                
                    <span class="emoji">ğŸ¥</span>
                
            </figure>
            
        
        
        <div class="site-meta">
            <h1 class="site-name"><a href="/">ç€šä¸­å­çš„ä¸ªäººç½‘ç«™</a></h1>
            <h2 class="site-description">Lorem ipsum dolor sit amet, consectetur adipiscing elit.</h2>
        </div>
    </header><ol class="social-menu">
            
                <li>
                    <a 
                        href='https://github.com/CaiJimmy/hugo-theme-stack'
                        target="_blank"
                        title="GitHub"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M9 19c-4.3 1.4 -4.3 -2.5 -6 -3m12 5v-3.5c0 -1 .1 -1.4 -.5 -2c2.8 -.3 5.5 -1.4 5.5 -6a4.6 4.6 0 0 0 -1.3 -3.2a4.2 4.2 0 0 0 -.1 -3.2s-1.1 -.3 -3.5 1.3a12.3 12.3 0 0 0 -6.2 0c-2.4 -1.6 -3.5 -1.3 -3.5 -1.3a4.2 4.2 0 0 0 -.1 3.2a4.6 4.6 0 0 0 -1.3 3.2c0 4.6 2.7 5.7 5.5 6c-.6 .6 -.6 1.2 -.5 2v3.5" />
</svg>



                        
                    </a>
                </li>
            
                <li>
                    <a 
                        href='https://twitter.com'
                        target="_blank"
                        title="Twitter"
                        rel="me"
                    >
                        
                        
                            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-twitter" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M22 4.01c-1 .49 -1.98 .689 -3 .99c-1.121 -1.265 -2.783 -1.335 -4.38 -.737s-2.643 2.06 -2.62 3.737v1c-3.245 .083 -6.135 -1.395 -8 -4c0 0 -4.182 7.433 4 11c-1.872 1.247 -3.739 2.088 -6 2c3.308 1.803 6.913 2.423 10.034 1.517c3.58 -1.04 6.522 -3.723 7.651 -7.742a13.84 13.84 0 0 0 .497 -3.753c-.002 -.249 1.51 -2.772 1.818 -4.013z" />
</svg>



                        
                    </a>
                </li>
            
        </ol><ol class="menu" id="main-menu">
        
        
        
        <li >
            <a href='/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <polyline points="5 12 3 12 12 3 21 12 19 12" />
  <path d="M5 12v7a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-7" />
  <path d="M9 21v-6a2 2 0 0 1 2 -2h2a2 2 0 0 1 2 2v6" />
</svg>



                
                <span>Home</span>
            </a>
        </li>
        
        
        <li >
            <a href='/archives/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <rect x="3" y="4" width="18" height="4" rx="2" />
  <path d="M5 8v10a2 2 0 0 0 2 2h10a2 2 0 0 0 2 -2v-10" />
  <line x1="10" y1="12" x2="14" y2="12" />
</svg>



                
                <span>Archives</span>
            </a>
        </li>
        
        
        <li >
            <a href='/search/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="10" cy="10" r="7" />
  <line x1="21" y1="21" x2="15" y2="15" />
</svg>



                
                <span>Search</span>
            </a>
        </li>
        
        
        <li >
            <a href='/links/' >
                
                
                
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M10 14a3.5 3.5 0 0 0 5 0l4 -4a3.5 3.5 0 0 0 -5 -5l-.5 .5" />
  <path d="M14 10a3.5 3.5 0 0 0 -5 0l-4 4a3.5 3.5 0 0 0 5 5l.5 -.5" />
</svg>



                
                <span>Links</span>
            </a>
        </li>
        

        <div class="menu-bottom-section">
                <li id="i18n-switch">  
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-language" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z" fill="none"/>
  <path d="M4 5h7" />
  <path d="M9 3v2c0 4.418 -2.239 8 -5 8" />
  <path d="M5 9c-.003 2.144 2.952 3.908 6.7 4" />
  <path d="M12 20l4 -9l4 9" />
  <path d="M19.1 18h-6.2" />
</svg>



                    <select name="language" onchange="window.location.href = this.selectedOptions[0].value">
                        
                            <option value="https://hanzhongzi.github.io/" selected>ä¸­æ–‡</option>
                        
                            <option value="https://hanzhongzi.github.io/en/" >English</option>
                        
                    </select>
                </li>
            
            
            
                <li id="dark-mode-toggle">
                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="8" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="16" cy="12" r="2" />
  <rect x="2" y="6" width="20" height="12" rx="6" />
</svg>



                    <span>æš—è‰²æ¨¡å¼</span>
                </li>
            
        </div>
    </ol>
</aside>

    <aside class="sidebar right-sidebar sticky">
        
            
                
    <section class="widget archives">
        <div class="widget-icon">
            <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <line x1="5" y1="9" x2="19" y2="9" />
  <line x1="5" y1="15" x2="19" y2="15" />
  <line x1="11" y1="4" x2="7" y2="20" />
  <line x1="17" y1="4" x2="13" y2="20" />
</svg>



        </div>
        <h2 class="widget-title section-title">ç›®å½•</h2>
        
        <div class="widget--toc">
            <nav id="TableOfContents">
  <ol>
    <li><a href="#ä¸‹è½½ä¸å®‰è£…">ä¸‹è½½ä¸å®‰è£…</a>
      <ol>
        <li><a href="#ubuntu">Ubuntu</a>
          <ol>
            <li><a href="#ä¸‹è½½">ä¸‹è½½</a></li>
            <li><a href="#å®‰è£…">å®‰è£…</a></li>
          </ol>
        </li>
        <li><a href="#centos8">Centos8</a>
          <ol>
            <li><a href="#ä¸‹è½½-1">ä¸‹è½½</a></li>
            <li><a href="#å®‰è£…-1">å®‰è£…</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#å¯åŠ¨">å¯åŠ¨</a></li>
    <li><a href="#ç™»å½•">ç™»å½•</a></li>
    <li><a href="#å¤šå±‚çš„é…ç½®ç³»ç»Ÿ">å¤šå±‚çš„é…ç½®ç³»ç»Ÿ</a></li>
    <li><a href="#é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯">é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯</a></li>
    <li><a href="#å°†ä¸ªæœåŠ¡å™¨æ·»åŠ åˆ°mysql_serverè¡¨">å°†ä¸ªæœåŠ¡å™¨æ·»åŠ åˆ°mysql_serverè¡¨</a></li>
    <li><a href="#proxysql-ç›‘æ§åç«¯èŠ‚ç‚¹">ProxySQL ç›‘æ§åç«¯èŠ‚ç‚¹</a></li>
    <li><a href="#é…ç½®proxy">é…ç½®proxy</a>
      <ol>
        <li><a href="#é…ç½®è¯»å†™åˆ†ç¦»">é…ç½®è¯»å†™åˆ†ç¦»</a>
          <ol>
            <li><a href="#è·¯ç”±è§„åˆ™">è·¯ç”±è§„åˆ™</a></li>
            <li><a href="#è§„åˆ™çš„å†™å…¥">è§„åˆ™çš„å†™å…¥</a></li>
            <li><a href="#è¯»å†™åˆ†ç¦»æµ‹è¯•">è¯»å†™åˆ†ç¦»æµ‹è¯•</a></li>
            <li><a href="#æŸ¥çœ‹è·¯ç”±ä¿¡æ¯">æŸ¥çœ‹è·¯ç”±ä¿¡æ¯</a></li>
          </ol>
        </li>
        <li><a href="#æ€»ç»“">æ€»ç»“ï¼š</a>
          <ol>
            <li><a href="#é‡åˆ°çš„é—®é¢˜">é‡åˆ°çš„é—®é¢˜</a></li>
          </ol>
        </li>
      </ol>
    </li>
    <li><a href="#proxysql-çš„é«˜å¯ç”¨">ProxySql çš„é«˜å¯ç”¨</a>
      <ol>
        <li><a href="#ç›¸å…³å˜é‡">ç›¸å…³å˜é‡</a>
          <ol>
            <li><a href="#1ç”¨äºåŒæ­¥çš„å˜é‡">1.ç”¨äºåŒæ­¥çš„å˜é‡</a></li>
            <li><a href="#2é›†ç¾¤å‡­è¯å˜é‡">2.é›†ç¾¤å‡­è¯å˜é‡</a></li>
            <li><a href="#3æ£€æŸ¥é¢‘ç‡å’Œé—´éš”æ—¶é—´">3.æ£€æŸ¥é¢‘ç‡å’Œé—´éš”æ—¶é—´</a></li>
            <li><a href="#4å°†é…ç½®åŒæ­¥åˆ°ç£ç›˜">4.å°†é…ç½®åŒæ­¥åˆ°ç£ç›˜</a></li>
            <li><a href="#5æ˜¯å¦éœ€è¦è¿œç¨‹åŒæ­¥å˜é‡">5.æ˜¯å¦éœ€è¦è¿œç¨‹åŒæ­¥å˜é‡</a></li>
            <li><a href="#6å»¶è¿ŸåŒæ­¥">6.å»¶è¿ŸåŒæ­¥</a></li>
          </ol>
        </li>
        <li><a href="#éœ€è¦é…ç½®çš„è¡¨">éœ€è¦é…ç½®çš„è¡¨</a>
          <ol>
            <li><a href="#1proxysql_servers">1.proxysql_servers</a></li>
            <li><a href="#2runtime_proxysql_servers">2.runtime_proxysql_servers</a></li>
            <li><a href="#3runtime_checksums_values">3.runtime_checksums_values</a></li>
          </ol>
        </li>
        <li><a href="#stats-tables">stats tables</a>
          <ol>
            <li><a href="#1stats_proxysql_servers_checksums">1.stats_proxysql_servers_checksums</a></li>
            <li><a href="#2stats_proxysql_servers_metrics-è¡¨">2.<strong>stats_proxysql_servers_metrics è¡¨</strong></a></li>
            <li><a href="#3stats_proxysql_servers_status">3.stats_proxysql_servers_status</a></li>
            <li><a href="#re-configuration">Re-configuration</a></li>
            <li><a href="#è¿›è¡Œé…ç½®">è¿›è¡Œé…ç½®</a></li>
            <li><a href="#è§‚å¯Ÿé›†ç¾¤çŠ¶å†µ">è§‚å¯Ÿé›†ç¾¤çŠ¶å†µ</a></li>
            <li><a href="#proxysqlçš„é«˜å¯ç”¨">Proxysqlçš„é«˜å¯ç”¨</a></li>
          </ol>
        </li>
        <li><a href="#keepalived-å®˜æ–¹ç½‘ç«™-httpswwwkeepalivedorg">Keepalived å®˜æ–¹ç½‘ç«™ <a href="https://www.keepalived.org/">https://www.keepalived.org/</a></a>
          <ol>
            <li><a href="#vrrpçš„åŸºæœ¬æ¶æ„">VRRPçš„åŸºæœ¬æ¶æ„</a></li>
            <li><a href="#å·¥ä½œç±»å‹">å·¥ä½œç±»å‹</a></li>
          </ol>
        </li>
        <li><a href="#æ£€æŸ¥">æ£€æŸ¥</a></li>
        <li><a href="#é‡åˆ°çš„é—®é¢˜-1">é‡åˆ°çš„é—®é¢˜</a></li>
      </ol>
    </li>
  </ol>
</nav>
        </div>
    </section>

            
        
    </aside>


            <main class="main full-width">
    <article class="main-article">
    <header class="article-header">

    <div class="article-details">
    
    <header class="article-category">
        
            <a href="/categories/linux-operator/" >
                Linux operator
            </a>
        
    </header>
    

    <div class="article-title-wrapper">
        <h2 class="article-title">
            <a href="/p/proxysql-%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%90%9E%E5%AE%9A/">ProxySql ä¸€ç¯‡æ–‡ç« æå®š</a>
        </h2>
    
        
        <h3 class="article-subtitle">
            ProxySql å®‰è£…éƒ¨ç½²ã€é…ç½®
        </h3>
        
    </div>

    
    
    
    
    <footer class="article-time">
        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <path d="M11.795 21h-6.795a2 2 0 0 1 -2 -2v-12a2 2 0 0 1 2 -2h12a2 2 0 0 1 2 2v4" />
  <circle cx="18" cy="18" r="4" />
  <path d="M15 3v4" />
  <path d="M7 3v4" />
  <path d="M3 11h16" />
  <path d="M18 16.496v1.504l1 1" />
</svg>
                <time class="article-time--published">Jan 29, 2019</time>
            </div>
        

        
            <div>
                <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <polyline points="12 7 12 12 15 15" />
</svg>



                <time class="article-time--reading">
                    é˜…è¯»æ—¶é•¿: 19 åˆ†é’Ÿ
                </time>
            </div>
        
    </footer>
    

    
</div>

</header>

    <section class="article-content">
    
    
    <h1 id="proxysql">ProxySQL</h1>
<p>ç®€å•ä»‹ç»: ProxySQL æ˜¯åŸºäº MySQL çš„ä¸€æ¬¾å¼€æºçš„ä¸­é—´ä»¶çš„äº§å“ï¼Œæ˜¯ä¸€ä¸ªçµæ´»çš„ MySQL ä»£ç†å±‚ï¼Œå¯ä»¥å®ç°è¯»å†™åˆ†ç¦»ï¼Œæ”¯æŒ Query è·¯ç”±åŠŸèƒ½ï¼Œæ”¯æŒåŠ¨æ€æŒ‡å®šæŸä¸ª SQL è¿›è¡Œç¼“å­˜ï¼Œæ”¯æŒåŠ¨æ€åŠ è½½ï¼ˆæ— éœ€é‡å¯ ProxySQL æœåŠ¡ï¼‰ï¼Œæ•…éšœåˆ‡æ¢å’Œä¸€äº› SQL çš„è¿‡æ»¤åŠŸèƒ½ã€‚</p>
<p>githubåœ°å€ï¼šhttps://github.com/sysown/proxysql/releases</p>
<p>å®˜æ–¹æ–‡æ¡£: <a class="link" href="https://proxysql.com/documentation/"  target="_blank" rel="noopener"
    >https://proxysql.com/documentation/</a></p>
<h2 id="ä¸‹è½½ä¸å®‰è£…">ä¸‹è½½ä¸å®‰è£…</h2>
<h3 id="ubuntu">Ubuntu</h3>
<blockquote>
<h4 id="ä¸‹è½½">ä¸‹è½½</h4>
<p><code>wget  https://github.com/sysown/proxysql/releases/download/v2.0.14/proxysql_2.0.14-dbg-ubuntu16_amd64.deb </code></p>
<h4 id="å®‰è£…">å®‰è£…</h4>
<p><code>dpkg -i proxysql_2.0.14-dbg-ubuntu16_amd64.deb</code></p>
</blockquote>
<h3 id="centos8">Centos8</h3>
<blockquote>
<h4 id="ä¸‹è½½-1">ä¸‹è½½</h4>
<p>wget <a class="link" href="https://github.com/sysown/proxysql/releases/download/v2.0.14/proxysql-2.0.14-1-dbg-centos8.x86_64.rpm"  target="_blank" rel="noopener"
    >https://github.com/sysown/proxysql/releases/download/v2.0.14/proxysql-2.0.14-1-dbg-centos8.x86_64.rpm</a></p>
<h4 id="å®‰è£…-1">å®‰è£…</h4>
<p><code> yum -y install proxysql-2.0.14-1-centos8.x86_64.rpm</code></p>
</blockquote>
<p>centos7 : <a class="link" href="https://github.com/sysown/proxysql/releases/download/v2.0.14/proxysql-2.0.14-1-centos7.x86_64.rpm"  target="_blank" rel="noopener"
    >https://github.com/sysown/proxysql/releases/download/v2.0.14/proxysql-2.0.14-1-centos7.x86_64.rpm</a></p>
<h2 id="å¯åŠ¨">å¯åŠ¨</h2>
<p>å¯åŠ¨ï¼š<code>systemctl restart proxysql</code></p>
<p>åœæ­¢:  <code>systemctl stop proxysql</code></p>
<p>é»˜è®¤ç›‘å¬ <code>6032</code> å’Œ <code>6033</code> ç«¯å£,<code>6032 </code>æ˜¯ ProxySQL çš„ç®¡ç†ç«¯å£å·ï¼Œ<code>6033</code>æ˜¯å¯¹å¤–æœåŠ¡çš„ç«¯å£å·
ProxySQL çš„ç”¨æˆ·åå’Œå¯†ç éƒ½æ˜¯é»˜è®¤çš„ <code>admin</code>ã€‚</p>
<h2 id="ç™»å½•">ç™»å½•</h2>
<p>éœ€è¦æœ‰mysqlçš„å®¢æˆ·ç«¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="n">proxysql</span><span class="p">]</span><span class="c1"># mysql -u admin -padmin -h 127.0.0.1 -P 6032 --prompt=&#39;ProxySQL-Admin&gt;  &#39;</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+---------------+-------------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">seq</span> <span class="o">|</span> <span class="n">name</span>          <span class="o">|</span> <span class="n">file</span>                                <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+---------------+-------------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">0</span>   <span class="o">|</span> <span class="n">main</span>          <span class="o">|</span>  <span class="err">å†…å­˜é…ç½®æ•°æ®åº“ï¼Œå³</span> <span class="n">MEMORY</span><span class="err">ï¼Œè¡¨é‡Œå­˜æ”¾åç«¯</span> <span class="n">db</span> <span class="err">å®ä¾‹ã€ç”¨æˆ·éªŒè¯ã€è·¯ç”±è§„åˆ™ç­‰ä¿¡æ¯ã€‚</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">2</span>   <span class="o">|</span> <span class="n">disk</span>          <span class="o">|</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">proxysql</span><span class="o">/</span><span class="n">proxysql</span><span class="o">.</span><span class="n">db</span> <span class="err">æŒä¹…åŒ–çš„ç£ç›˜çš„é…ç½®</span>       <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">3</span>   <span class="o">|</span> <span class="n">stats</span>         <span class="o">|</span>   <span class="err">ç»Ÿè®¡ä¿¡æ¯çš„æ±‡æ€»</span>           <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">4</span>   <span class="o">|</span> <span class="n">monitor</span>       <span class="o">|</span> <span class="err">ä¸€äº›ç›‘æ§çš„æ”¶é›†ä¿¡æ¯ï¼Œæ¯”å¦‚æ•°æ®åº“çš„å¥åº·çŠ¶æ€ç­‰</span>  <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">5</span>   <span class="o">|</span> <span class="n">stats_history</span> <span class="o">|</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">proxysql</span><span class="o">/</span><span class="n">proxysql_stats</span><span class="o">.</span><span class="n">dbè¿™ä¸ªåº“æ˜¯</span> <span class="n">ProxySQL</span> <span class="err">æ”¶é›†çš„æœ‰å…³å…¶å†…éƒ¨åŠŸèƒ½çš„å†å²æŒ‡æ ‡</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----+---------------+-------------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">5</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>note: If your MySQL client version is version 8.04 or higher add <code>--default-auth=mysql_native_password</code> to the above command to connect to the admin interface.</p>
<p>è¿™é‡Œé¢æœ‰5ä¸ªæ•°æ®åº“</p>
<p>main: å†…å­˜é…ç½®æ•°æ®åº“ï¼Œå³ MEMORYï¼Œè¡¨é‡Œå­˜æ”¾åç«¯ db å®ä¾‹ã€ç”¨æˆ·éªŒè¯ã€è·¯ç”±è§„åˆ™ç­‰ä¿¡æ¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">use</span> <span class="n">main</span>
</span></span><span class="line"><span class="cl"><span class="n">Reading</span> <span class="n">table</span> <span class="n">information</span> <span class="k">for</span> <span class="n">completion</span> <span class="n">of</span> <span class="n">table</span> <span class="ow">and</span> <span class="n">column</span> <span class="n">names</span>
</span></span><span class="line"><span class="cl"><span class="n">You</span> <span class="n">can</span> <span class="n">turn</span> <span class="n">off</span> <span class="n">this</span> <span class="n">feature</span> <span class="n">to</span> <span class="n">get</span> <span class="n">a</span> <span class="n">quicker</span> <span class="n">startup</span> <span class="n">with</span> <span class="o">-</span><span class="n">A</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Database</span> <span class="n">changed</span>
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">show</span> <span class="n">tables</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+----------------------------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">tables</span>                                             <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+----------------------------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">global_variables</span>                                   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_aws_aurora_hostgroups</span>                        <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_collations</span>                                   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_firewall_whitelist_rules</span>                     <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_firewall_whitelist_sqli_fingerprints</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_firewall_whitelist_users</span>                     <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_galera_hostgroups</span>                            <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_group_replication_hostgroups</span>                 <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_query_rulesæŒ‡å®š</span> <span class="n">Query</span> <span class="err">è·¯ç”±åˆ°åç«¯ä¸åŒæœåŠ¡å™¨çš„è§„åˆ™åˆ—è¡¨</span><span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_query_rules_fast_routing</span>                     <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_replication_hostgroups</span> <span class="err">é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_serversåç«¯å¯ä»¥è¿æ¥</span> <span class="n">MySQL</span> <span class="err">æœåŠ¡å™¨çš„åˆ—è¡¨</span>            <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql_usersé…ç½®åç«¯æ•°æ®åº“çš„è´¦å·å’Œç›‘æ§çš„è´¦å·</span><span class="err">ã€‚</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">proxysql_servers</span>                                   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">restapi_routes</span>                                     <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_checksums_values</span>                           <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_global_variables</span>                           <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_aws_aurora_hostgroups</span>                <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_firewall_whitelist_rules</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_firewall_whitelist_sqli_fingerprints</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_firewall_whitelist_users</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_galera_hostgroups</span>                    <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_group_replication_hostgroups</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_query_rules</span>                          <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_query_rules_fast_routing</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_replication_hostgroups</span>               <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_servers</span>                              <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_mysql_users</span>                                <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_proxysql_servers</span>                           <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_restapi_routes</span>                             <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">runtime_scheduler</span>                                  <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">scheduler</span>                                          <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+----------------------------------------------------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">32</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ³¨æ„</strong>ï¼š è¡¨åä»¥ runtime_å¼€å¤´çš„è¡¨ç¤º ProxySQL å½“å‰è¿è¡Œçš„é…ç½®å†…å®¹ï¼Œä¸èƒ½é€šè¿‡ DML è¯­å¥ä¿®æ”¹ã€‚</p>
<p>åªèƒ½ä¿®æ”¹å¯¹åº”çš„ä¸ä»¥ runtime å¼€å¤´çš„è¡¨ï¼Œç„¶å â€œLOADâ€ ä½¿å…¶ç”Ÿæ•ˆï¼Œâ€œSAVEâ€ ä½¿å…¶å­˜åˆ°ç¡¬ç›˜ä»¥ä¾›ä¸‹æ¬¡é‡å¯åŠ è½½ã€‚</p>
<h2 id="å¤šå±‚çš„é…ç½®ç³»ç»Ÿ">å¤šå±‚çš„é…ç½®ç³»ç»Ÿ</h2>
<p><img src="C:%5cUsers%5cAdministrator%5cDesktop%5c1033265-20200210150442128-1932198210.png"
	
	
	
	loading="lazy"
	
	
></p>
<p>æ•´å¥—é…ç½®ç³»ç»Ÿåˆ†ä¸ºä¸‰å±‚ï¼šé¡¶å±‚ä¸º RUNTIME ,ä¸­é—´å±‚ä¸º MEMORY , åº•å±‚ä¹Ÿå°±æ˜¯æŒä¹…å±‚ DISK å’Œ CONFIG FILE ã€‚</p>
<p>RUNTIME ï¼š ä»£è¡¨ ProxySQL å½“å‰ç”Ÿæ•ˆçš„æ­£åœ¨ä½¿ç”¨çš„é…ç½®ï¼Œæ— æ³•ç›´æ¥ä¿®æ”¹è¿™é‡Œçš„é…ç½®ï¼Œå¿…é¡»è¦ä»ä¸‹ä¸€å±‚ â€œloadâ€ è¿›æ¥ã€‚
MEMORYï¼š MEMORY å±‚ä¸Šé¢è¿æ¥ RUNTIME å±‚ï¼Œä¸‹é¢è¿æ¥æŒä¹…å±‚ã€‚è¿™å±‚å¯ä»¥æ­£å¸¸æ“ä½œ ProxySQL  é…ç½®ï¼Œéšä¾¿ä¿®æ”¹ï¼Œä¸ä¼šå½±å“ç”Ÿäº§ç¯å¢ƒã€‚ä¿®æ”¹ä¸€ä¸ªé…ç½®ä¸€èˆ¬éƒ½æ˜¯ç°åœ¨ MEMORY å±‚å®Œæˆçš„ï¼Œç¡®è®¤æ­£å¸¸ä¹‹ååœ¨åŠ è½½è¾¾åˆ° RUNTIME å’Œ æŒä¹…åŒ–çš„ç£ç›˜ä¸Šã€‚</p>
<p>DISK å’Œ CONFIG FILEï¼šæŒä¹…åŒ–é…ç½®ä¿¡æ¯ï¼Œé‡å¯åå†…å­˜ä¸­çš„é…ç½®ä¿¡æ¯ä¼šä¸¢å¤±ï¼Œæ‰€éœ€è¦å°†é…ç½®ä¿¡æ¯ä¿ç•™åœ¨ç£ç›˜ä¸­ã€‚é‡å¯æ—¶ï¼Œå¯ä»¥ä»ç£ç›˜å¿«é€ŸåŠ è½½å›æ¥ã€‚</p>
<p>ä¸€èˆ¬åœ¨å†…å­˜é‚£å±‚ä¿®æ”¹ ,ç„¶åä¿å­˜åˆ°è¿è¡Œç³»ç»Ÿï¼Œä¿å­˜åˆ°ç£ç›˜æ•°æ®åº“ç³»ç»Ÿ</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="nb">load</span> <span class="n">xxx</span> <span class="n">to</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">save</span> <span class="n">xxx</span> <span class="n">to</span> <span class="n">disk</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><ul>
<li>proxysql å¯åŠ¨æ—¶ï¼Œé¦–å…ˆå»æ‰¾/etc/proxysql.cnf æ‰¾åˆ°å®ƒçš„datadir,å¦‚æœdatadirä¸‹æœ‰proxysql.db å°±åŠ è½½proxysql.dbçš„é…ç½®</li>
<li>å¦‚æœå¯åŠ¨proxysqlæ—¶å¸¦æœ‰<code>--init</code>æ ‡å¿—ï¼Œä¼šç”¨/etc/proxsql.cnfçš„é…ç½®ï¼ŒæŠŠRuntimeï¼Œdiskå…¨éƒ¨åˆå§‹åŒ–ä¸€ä¸‹</li>
<li>åœ¨è°ƒç”¨æ˜¯è°ƒç”¨<code>--reload</code> ä¼šæŠŠ/etc/proxysql.cnf å’Œdisk ä¸­é…ç½®è¿›è¡Œåˆå¹¶ã€‚å¦‚æœå†²çªéœ€è¦ç”¨æˆ·å¹²é¢„ã€‚diskä¼šè¦†ç›–config fileã€‚</li>
</ul>
<h2 id="é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯">é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯</h2>
<p>é…ç½®ä¸»ä»åˆ†ç»„ä¿¡æ¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ProxySQL-Admin&gt;  show create table mysql_replication_hostgroups\G;
</span></span><span class="line"><span class="cl">*************************** 1. row ***************************
</span></span><span class="line"><span class="cl">       table: mysql_replication_hostgroups
</span></span><span class="line"><span class="cl">Create Table: CREATE TABLE mysql_replication_hostgroups (
</span></span><span class="line"><span class="cl">    writer_hostgroup INT CHECK (writer_hostgroup&gt;=0) NOT NULL PRIMARY KEY,
</span></span><span class="line"><span class="cl">    reader_hostgroup INT NOT NULL CHECK (reader_hostgroup&lt;&gt;writer_hostgroup AND reader_hostgroup&gt;=0),
</span></span><span class="line"><span class="cl">    check_type VARCHAR CHECK (LOWER(check_type) IN (&#39;read_only&#39;,&#39;innodb_read_only&#39;,&#39;super_read_only&#39;,&#39;read_only|innodb_read_only&#39;,&#39;read_only&amp;innodb_read_only&#39;)) NOT NULL DEFAULT &#39;read_only&#39;,
</span></span><span class="line"><span class="cl">    comment VARCHAR NOT NULL DEFAULT &#39;&#39;, UNIQUE (reader_hostgroup))
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><p>é¦–å…ˆåˆ›å»ºå†™ç»„å’Œè¯»ç»„</p>
<p><code>insert ``into</code> <code>mysql_replication_hostgroups ( writer_hostgroup, reader_hostgroup, comment) values (10,20,``'proxy'``);</code></p>
<p>ç¡®ä¿æ­¤é…ç½®å‡å·²å†™å…¥ä¸‰ç§é…ç½®</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span><span class="lnt">38
</span><span class="lnt">39
</span><span class="lnt">40
</span><span class="lnt">41
</span><span class="lnt">42
</span><span class="lnt">43
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">main</span><span class="o">.</span><span class="n">mysql_replication_hostgroups</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+------------------+------------------+------------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">writer_hostgroup</span> <span class="o">|</span> <span class="n">reader_hostgroup</span> <span class="o">|</span> <span class="n">check_type</span> <span class="o">|</span> <span class="n">comment</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+------------------+------------------+------------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">10</span>               <span class="o">|</span> <span class="mi">20</span>               <span class="o">|</span> <span class="n">read_only</span>  <span class="o">|</span> <span class="n">proxy</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+------------------+------------------+------------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">main</span><span class="o">.</span><span class="n">runtime_mysql_replication_hostgroups</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Empty</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="nb">load</span> <span class="n">mysql</span> <span class="n">servers</span> <span class="n">to</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">main</span><span class="o">.</span><span class="n">runtime_mysql_replication_hostgroups</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+------------------+------------------+------------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">writer_hostgroup</span> <span class="o">|</span> <span class="n">reader_hostgroup</span> <span class="o">|</span> <span class="n">check_type</span> <span class="o">|</span> <span class="n">comment</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+------------------+------------------+------------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">10</span>               <span class="o">|</span> <span class="mi">20</span>               <span class="o">|</span> <span class="n">read_only</span>  <span class="o">|</span> <span class="n">proxy</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+------------------+------------------+------------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">use</span> <span class="n">disk</span>
</span></span><span class="line"><span class="cl"><span class="n">Reading</span> <span class="n">table</span> <span class="n">information</span> <span class="k">for</span> <span class="n">completion</span> <span class="n">of</span> <span class="n">table</span> <span class="ow">and</span> <span class="n">column</span> <span class="n">names</span>
</span></span><span class="line"><span class="cl"><span class="n">You</span> <span class="n">can</span> <span class="n">turn</span> <span class="n">off</span> <span class="n">this</span> <span class="n">feature</span> <span class="n">to</span> <span class="n">get</span> <span class="n">a</span> <span class="n">quicker</span> <span class="n">startup</span> <span class="n">with</span> <span class="o">-</span><span class="n">A</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">Database</span> <span class="n">changed</span>
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">disk</span><span class="o">.</span><span class="n">mysql_replication_hostgroups</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Empty</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">save</span> <span class="n">mysql</span> <span class="n">servers</span> <span class="n">to</span> <span class="n">disk</span>
</span></span><span class="line"><span class="cl">    <span class="o">-&gt;</span> <span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.02</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">disk</span><span class="o">.</span><span class="n">mysql_replication_hostgroups</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+------------------+------------------+------------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">writer_hostgroup</span> <span class="o">|</span> <span class="n">reader_hostgroup</span> <span class="o">|</span> <span class="n">check_type</span> <span class="o">|</span> <span class="n">comment</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+------------------+------------------+------------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="mi">10</span>               <span class="o">|</span> <span class="mi">20</span>               <span class="o">|</span> <span class="n">read_only</span>  <span class="o">|</span> <span class="n">proxy</span>   <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+------------------+------------------+------------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">1</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span> 
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>ProxySQL ä¼šæ ¹æ®server çš„read _only çš„å–å€¼å°†æœåŠ¡å™¨è¿›è¡Œåˆ†ç»„ã€‚ read_only=0 çš„serverï¼Œmasterè¢«åˆ†åˆ°ç¼–å·ä¸º10çš„å†™ç»„ï¼Œread_only=1 çš„serverï¼Œslaveåˆ™è¢«åˆ†åˆ°ç¼–å·20çš„è¯»ç»„</strong></p>
<h2 id="å°†ä¸ªæœåŠ¡å™¨æ·»åŠ åˆ°mysql_serverè¡¨">å°†ä¸ªæœåŠ¡å™¨æ·»åŠ åˆ°mysql_serverè¡¨</h2>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ProxySQL-Admin&gt;  show create table mysql_servers\G;
</span></span><span class="line"><span class="cl">*************************** 1. row ***************************
</span></span><span class="line"><span class="cl">       table: mysql_servers
</span></span><span class="line"><span class="cl">Create Table: CREATE TABLE mysql_servers (
</span></span><span class="line"><span class="cl">    hostgroup_id INT CHECK (hostgroup_id&gt;=0) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    hostname VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    port INT CHECK (port &gt;= 0 AND port &lt;= 65535) NOT NULL DEFAULT 3306,
</span></span><span class="line"><span class="cl">    gtid_port INT CHECK ((gtid_port &lt;&gt; port OR gtid_port=0) AND gtid_port &gt;= 0 AND gtid_port &lt;= 65535) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    status VARCHAR CHECK (UPPER(status) IN (&#39;ONLINE&#39;,&#39;SHUNNED&#39;,&#39;OFFLINE_SOFT&#39;, &#39;OFFLINE_HARD&#39;)) NOT NULL DEFAULT &#39;ONLINE&#39;,
</span></span><span class="line"><span class="cl">    weight INT CHECK (weight &gt;= 0 AND weight &lt;=10000000) NOT NULL DEFAULT 1,
</span></span><span class="line"><span class="cl">    compression INT CHECK (compression IN(0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    max_connections INT CHECK (max_connections &gt;=0) NOT NULL DEFAULT 1000,
</span></span><span class="line"><span class="cl">    max_replication_lag INT CHECK (max_replication_lag &gt;= 0 AND max_replication_lag &lt;= 126144000) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    use_ssl INT CHECK (use_ssl IN(0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    max_latency_ms INT UNSIGNED CHECK (max_latency_ms&gt;=0) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (hostgroup_id, hostname, port) )
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ERROR: 
</span></span><span class="line"><span class="cl">No query specified
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨ä¸‹é¢çš„è¯­å¥ä¾æ¬¡æ’å…¥æˆ‘ä»¬åˆšåˆšæ­å»ºå¥½çš„çš„æœºå™¨ï¼ˆæ³¨æ„å†™å…¥ç»„è¿˜æ˜¯è¯»å–ç»„çš„åŒºåˆ†ï¼‰</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">insert into mysql_servers(hostgroup_id,hostname,port,comment) values (10,&#39;xxx.xxx.xxx.xxx&#39;,3306,&#34;è¯´æ˜&#34;);
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>å°†ä¿¡æ¯åŒæ­¥åˆ°runtimeå’Œdisk</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="nb">load</span> <span class="n">mysql</span> <span class="n">servers</span> <span class="n">to</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">save</span> <span class="n">mysql</span> <span class="n">servers</span> <span class="n">to</span> <span class="n">disk</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸»è¦é€šè¿‡ä¸‹é¢ä¸‰å¥è¯ç²¾é€‰éªŒè¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> select * from disk.mysql_servers;
</span></span><span class="line"><span class="cl"> select * from runtime_mysql_servers;
</span></span><span class="line"><span class="cl"> select * from main.mysql_servers;
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„è§‚å¯Ÿ<code> select * from mysql_servers;</code>æ—¶<code>status</code>åˆ—å…¨ä¸º<code>ONLINE</code>å³å¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> +--------------+-----------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------------------+
</span></span><span class="line"><span class="cl">| hostgroup_id | hostname        | port | gtid_port | status | weight | compression | max_connections | max_replication_lag | use_ssl | max_latency_ms | comment                   |
</span></span><span class="line"><span class="cl">+--------------+-----------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------------------+
</span></span><span class="line"><span class="cl">| 10           | xxx.xxx.xxx.114 | 3306 | 0         | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | ç¬¬ä¸€æ¬¡æµ‹è¯•çš„ä¸»æœº          |
</span></span><span class="line"><span class="cl">| 20           | xxx.xxx.xxx.118 | 3306 | 0         | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | ç¬¬ä¸€æ¬¡æµ‹è¯•çš„ä»æœº1         |
</span></span><span class="line"><span class="cl">| 20           | xxx.xxx.xxx.115 | 3306 | 0         | ONLINE | 1      | 0           | 1000            | 0                   | 0       | 0              | ç¬¬ä¸€æ¬¡æµ‹è¯•çš„ä»æœº2         |
</span></span><span class="line"><span class="cl">+--------------+-----------------+------+-----------+--------+--------+-------------+-----------------+---------------------+---------+----------------+---------------------------+
</span></span><span class="line"><span class="cl">3 rows in set (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="proxysql-ç›‘æ§åç«¯èŠ‚ç‚¹">ProxySQL ç›‘æ§åç«¯èŠ‚ç‚¹</h2>
<p>ä¸º ProxySQL é…ç½®ç›‘æ§è´¦å·</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">set</span> <span class="n">mysql</span><span class="o">-</span><span class="n">monitor_username</span><span class="o">=</span><span class="s1">&#39;monitor&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">set</span> <span class="n">mysql</span><span class="o">-</span><span class="n">monitor_password</span><span class="o">=</span><span class="s1">&#39;Mm-123456&#39;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="nb">load</span> <span class="n">mysql</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">save</span> <span class="n">mysql</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">disk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">136</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ mysqlä¸»ä» çš„masterèŠ‚ç‚¹è¿›è¡Œè®¾ç½®è´¦å·å¯†ç </p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysql&gt; create user &#39;monitor&#39;@&#39;%&#39; identified by &#39;Mm-123456&#39;;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; grant all privileges on *.* to &#39;monitor&#39;@&#39;%&#39;;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><p>éªŒè¯ç›‘æ§ä¿¡æ¯ï¼ŒProxySQL ç›‘æ§æ¨¡å—çš„æŒ‡æ ‡éƒ½ä¿å­˜åœ¨<code>monitoråº“çš„logè¡¨ä¸­</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">è¿æ¥ï¼šselect * from monitor.mysql_server_connect_log;
</span></span><span class="line"><span class="cl">ç¨ç­‰ä¸€ä¼š ç»“æœå‡ºç° connect_error åˆ—å‡ºç° NULL å³å¯
</span></span><span class="line"><span class="cl">å¿ƒè·³æ£€æµ‹pingï¼šselect * from mysql_server_ping_log limit 10;
</span></span><span class="line"><span class="cl">readonly:select * from mysql_server_read_only_log limit 10;
</span></span></code></pre></td></tr></table>
</div>
</div><h2 id="é…ç½®proxy">é…ç½®proxy</h2>
<p>SQL è¯·æ±‚æ‰€ä½¿ç”¨çš„ç”¨æˆ·é…ç½®ï¼Œéƒ½éœ€è¦å†MysqlèŠ‚ç‚¹åˆ›å»ºä¸Šã€‚</p>
<p>â€‹	åˆ›å»ºproxysql å¯¹å¤–è®¿é—®çš„è´¦æˆ·(master)</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysql&gt; create user &#39;proxysql&#39;@&#39;è¿™é‡Œæ˜¯proxyçš„ip&#39; identified by &#39;Proxy-123456&#39;;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.01 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; grant all privileges on *.* to &#39;proxysql&#39;@&#39;è¿™é‡Œæ˜¯proxyçš„ip&#39; with grant option;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; flush privileges;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.01 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨ProxySQLä¸­éœ€è¦è®¾ç½®çš„è¡¨æ˜¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ProxySQL-Admin&gt;  show create table mysql_users\G;
</span></span><span class="line"><span class="cl">*************************** 1. row ***************************
</span></span><span class="line"><span class="cl">       table: mysql_users
</span></span><span class="line"><span class="cl">Create Table: CREATE TABLE mysql_users (
</span></span><span class="line"><span class="cl">    username VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    password VARCHAR,
</span></span><span class="line"><span class="cl">    active INT CHECK (active IN (0,1)) NOT NULL DEFAULT 1,
</span></span><span class="line"><span class="cl">    use_ssl INT CHECK (use_ssl IN (0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    default_hostgroup INT NOT NULL DEFAULT 0,  #é»˜è®¤è·¯ç”±ç›®æ ‡
</span></span><span class="line"><span class="cl">    default_schema VARCHAR,
</span></span><span class="line"><span class="cl">    schema_locked INT CHECK (schema_locked IN (0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    transaction_persistent INT CHECK (transaction_persistent IN (0,1)) NOT NULL DEFAULT 1,
</span></span><span class="line"><span class="cl">    fast_forward INT CHECK (fast_forward IN (0,1)) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    backend INT CHECK (backend IN (0,1)) NOT NULL DEFAULT 1,
</span></span><span class="line"><span class="cl">    frontend INT CHECK (frontend IN (0,1)) NOT NULL DEFAULT 1,
</span></span><span class="line"><span class="cl">    max_connections INT CHECK (max_connections &gt;=0) NOT NULL DEFAULT 10000,
</span></span><span class="line"><span class="cl">    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (username, backend),
</span></span><span class="line"><span class="cl">    UNIQUE (username, frontend))
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ERROR: 
</span></span><span class="line"><span class="cl">No query specified
</span></span></code></pre></td></tr></table>
</div>
</div><p>æˆ‘ä»¬å°†åœ¨<code>master</code>ä¸Šè®¾ç½®ç”¨äº<code>proxy</code>è®¿é—®çš„è´¦æˆ·æ’å…¥åˆ°<code>ProxySql</code>çš„<code>mysql_users</code>è¡¨ä¸­</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">insert</span> <span class="n">into</span> <span class="n">mysql_users</span><span class="p">(</span><span class="n">username</span><span class="p">,</span><span class="n">password</span><span class="p">,</span><span class="n">default_hostgroup</span><span class="p">)</span> <span class="n">values</span><span class="p">(</span><span class="s1">&#39;proxysql&#39;</span><span class="p">,</span><span class="s1">&#39;Proxy-123456&#39;</span><span class="p">,</span><span class="mi">10</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="nb">load</span> <span class="n">mysql</span> <span class="n">users</span> <span class="n">to</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">save</span> <span class="n">mysql</span> <span class="n">users</span> <span class="n">to</span> <span class="n">disk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ProxySQL-Admin&gt;  select * from mysql_users\G;
</span></span><span class="line"><span class="cl">*************************** 1. row ***************************
</span></span><span class="line"><span class="cl">              username: proxysql
</span></span><span class="line"><span class="cl">              password: Proxy-123456
</span></span><span class="line"><span class="cl">                active: 1
</span></span><span class="line"><span class="cl">               use_ssl: 0
</span></span><span class="line"><span class="cl">     default_hostgroup: 10
</span></span><span class="line"><span class="cl">        default_schema: NULL
</span></span><span class="line"><span class="cl">         schema_locked: 0
</span></span><span class="line"><span class="cl">transaction_persistent: 1
</span></span><span class="line"><span class="cl">          fast_forward: 0
</span></span><span class="line"><span class="cl">               backend: 1
</span></span><span class="line"><span class="cl">              frontend: 1
</span></span><span class="line"><span class="cl">       max_connections: 10000
</span></span><span class="line"><span class="cl">               comment: 
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ERROR: 
</span></span><span class="line"><span class="cl">No query specified
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤æ—¶å¯ä»¥åœ¨æœ‰æƒé™ç™»å½•çš„æœºå™¨ç”¨proxysqlè´¦æˆ·ç™»å½•åˆ›å»ºåº“è°ƒè¯•çœ‹çœ‹ã€‚</p>
<p>å¿˜è®°è‡ªå·±ç™»å½•åˆ°é‚£ä¸ªæœåŠ¡å¯ä»¥ç”¨<code> select @@server_id;</code>æŸ¥çœ‹æ‰€åœ¨æœºå™¨ã€‚</p>
<h3 id="é…ç½®è¯»å†™åˆ†ç¦»">é…ç½®è¯»å†™åˆ†ç¦»</h3>
<h4 id="è·¯ç”±è§„åˆ™">è·¯ç”±è§„åˆ™</h4>
<p>è·¯ç”±è§„åˆ™é…ç½®éå¸¸çµæ´»ï¼Œå¯ä»¥åŸºäºschemaï¼Œä¹Ÿå¯ä»¥åŸºäºç”¨æˆ·ï¼Œæˆ–å•ä¸ªsqlè¯­å¥å®ç°è·¯ç”±å®šåˆ¶ã€‚</p>
<p>ã€<strong>å®é™…è¿‡ç¨‹ä¸­åº”è¯¥ä»æ‰‹æœºçš„æ…¢æ—¥å¿—å„é¡¹æŒ‡æ ‡ä¸­æ‰¾å‡ºå‹åŠ›å¤§ï¼Œæ‰§è¡Œé¢‘ç¹çš„è¯­å¥å•ç‹¬å†™è·¯ç”±è§„åˆ™å’Œç¼“å­˜ï¼Œå»ºè®®ä½¿ç”¨hash code å€¼åšè¯»å†™çº¹ç†ï¼Œä¸è¦å»ºå¤ªå¤šè§„åˆ™</strong>ã€‘</p>
<p>mysql_query_rules_fast_routingæ˜¯mysql_query_rules</p>
<p>ä»‹ç»ä¸€ä¸‹æ”¹è¡¨mysql_query_rulesçš„å‡ ä¸ªå­—æ®µï¼š
<code>active</code>ï¼šæ˜¯å¦å¯ç”¨è¿™ä¸ªè§„åˆ™ï¼Œ1è¡¨ç¤ºå¯ç”¨ï¼Œ0è¡¨ç¤ºç¦ç”¨
<code>match_pattern</code> å­—æ®µå°±æ˜¯ä»£è¡¨è®¾ç½®è§„åˆ™
<code>destination_hostgroup</code> å­—æ®µä»£è¡¨é»˜è®¤æŒ‡å®šçš„åˆ†ç»„ï¼Œ
<code>apply</code> ä»£è¡¨çœŸæ­£æ‰§è¡Œåº”ç”¨è§„åˆ™ã€‚</p>
<h4 id="è§„åˆ™çš„å†™å…¥">è§„åˆ™çš„å†™å…¥</h4>
<p>ProxySQL æ˜¯æ ¹æ®<code>rule_id</code>çš„é¡ºåºæ¥è¿›è¡Œè§„åˆ™åŒ¹é…çš„æ³¨æ„è§„åˆ™çš„ç¼–å†™é¡ºåº</p>
<p>æ‰€æœ‰ä»¥select å¼€å¤´çš„è¯­å¥å…¨éƒ¨åˆ†é…åˆ°è¯»ç»„ä¸­ï¼Œä¸Šé¢å»ºç«‹è¯»ç»„ç¼–å·æ˜¯20</p>
<p><code>insert into mysql_query_rules(rule_id,active,match_pattern,destination_hostgroup,apply) values (2,1,'^select',20,1);</code></p>
<p>è¯´æœ‰ä»¥insertå¼€å¤´çš„è¯­å¥å…¨éƒ¨åˆ†é…åˆ°å†™ç»„ä¸­</p>
<p><code>insert into mysql_query_rules(rule_id,active,match_pattern,destination_hostgroup,apply) values (1,1,'^SELECT.*FOR UPDATE$',10,1);</code></p>
<p><code>insert into mysql_query_rules(rule_id,active,match_pattern,destination_hostgroup,apply) values (3,1,'^insert',10,1);</code></p>
<p>æ³¨æ„è¦</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="nb">load</span> <span class="n">mysql</span> <span class="n">query</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">save</span> <span class="n">mysql</span> <span class="n">query</span> <span class="n">rules</span> <span class="n">to</span> <span class="n">disk</span><span class="p">;</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è¯»å†™åˆ†ç¦»æµ‹è¯•">è¯»å†™åˆ†ç¦»æµ‹è¯•</h4>
<p>åœ¨ProxySQLçš„ä¸»æœºä¸Šè¿è¡Œ</p>
<h5 id="æµ‹è¯•è¯»">æµ‹è¯•è¯»</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysql -uproxysql -pProxy-123456 -h 127.0.0.1 -P 6033 -e &#34;select @@server_id&#34;;
</span></span><span class="line"><span class="cl">å¯ä»¥è¿”å›æ­£ç¡®çš„server_idå³å¯ï¼Œå› ä¸ºæˆ‘çš„åå°æ˜¯ä¿©å°åªè¯»æœºå™¨ï¼Œæ‰€ä»¥ä¼šäº¤æ›¿å‡ºç°è®¿é—®ä¿©å°æœºå™¨çš„server_id;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; select @@server_id for update;  æ­¤è¯­å¥SELECT...FOR UPDATE ä¼šç”³è¯·å†™é”ï¼Œæ‰€ä»¥ç”¨åœ¨è¿™é‡Œæ¯”è¾ƒåˆé€‚ã€‚
</span></span><span class="line"><span class="cl">+-------------+
</span></span><span class="line"><span class="cl">| @@server_id |
</span></span><span class="line"><span class="cl">+-------------+
</span></span><span class="line"><span class="cl">|         114 |
</span></span><span class="line"><span class="cl">+-------------+
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="æµ‹è¯•å†™">æµ‹è¯•å†™</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">mysql -uproxysql -pProxy-123456 -h 127.0.0.1 -P 6033 ç™»å½•å
</span></span><span class="line"><span class="cl">mysql&gt; begin;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; insert into hanzhongtest.edu_user values(9,&#34;æµ‹è¯•å†™3&#34;,&#34;wahah&#34;);
</span></span><span class="line"><span class="cl">Query OK, 1 row affected (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; select @@server_id;
</span></span><span class="line"><span class="cl">+-------------+
</span></span><span class="line"><span class="cl">| @@server_id |
</span></span><span class="line"><span class="cl">+-------------+
</span></span><span class="line"><span class="cl">|         114 |
</span></span><span class="line"><span class="cl">+-------------+
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">mysql&gt; commit;
</span></span><span class="line"><span class="cl">Query OK, 0 rows affected (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="æŸ¥çœ‹è·¯ç”±ä¿¡æ¯">æŸ¥çœ‹è·¯ç”±ä¿¡æ¯</h4>
<p>ä½¿ç”¨adminè´¦å·ç™»å½•ProxySQL</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">[root@localhost proxysql]# mysql -u admin -padmin -h 127.0.0.1 -P 6032 --prompt=&#39;ProxySQL-Admin&gt;  &#39;
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">ProxySQL-Admin&gt;  SELECT hostgroup hg,
</span></span><span class="line"><span class="cl">    -&gt;               sum_time,
</span></span><span class="line"><span class="cl">    -&gt;               count_star,
</span></span><span class="line"><span class="cl">    -&gt;               digest_text 
</span></span><span class="line"><span class="cl">    -&gt;        FROM stats_mysql_query_digest
</span></span><span class="line"><span class="cl">    -&gt;        ORDER BY sum_time DESC;
</span></span><span class="line"><span class="cl">+----+----------+------------+-------------------------------------------------------+
</span></span><span class="line"><span class="cl">| hg | sum_time | count_star | digest_text                                           |
</span></span><span class="line"><span class="cl">+----+----------+------------+-------------------------------------------------------+
</span></span><span class="line"><span class="cl">| 20 | 83455    | 70         | select @@server_id                                    |
</span></span><span class="line"><span class="cl">| 10 | 4383     | 2          | commit                                                |
</span></span><span class="line"><span class="cl">| 10 | 1275     | 2          | insert into hanzhongtest.edu_user values(?,?,?)       |
</span></span><span class="line"><span class="cl">| 10 | 1205     | 1          | start transantion                                     |
</span></span><span class="line"><span class="cl">| 20 | 1015     | 1          | select * from stats_mysql_query_digest                |
</span></span><span class="line"><span class="cl">| 10 | 798      | 2          | begin insert into hanzhongtest.edu_user values(?,?,?) |
</span></span><span class="line"><span class="cl">| 10 | 792      | 2          | begin                                                 |
</span></span><span class="line"><span class="cl">| 10 | 454      | 1          | select @@server_id                                    |
</span></span><span class="line"><span class="cl">| 10 | 0        | 71         | select @@version_comment limit ?                      |
</span></span><span class="line"><span class="cl">+----+----------+------------+-------------------------------------------------------+
</span></span><span class="line"><span class="cl">9 rows in set (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ€»ç»“">æ€»ç»“ï¼š</h3>
<p>è·¯ç”±è§„åˆ™æ¯”è¾ƒçµæ´»éœ€è¦å¤šçœ‹<a class="link" href="https://github.com/sysown/proxysql/wiki"  target="_blank" rel="noopener"
    >å®˜æ–¹æ–‡æ¡£</a></p>
<p>åˆ©ç”¨ProxySQLè¯»å†™åˆ†ç¦»å¯ä»¥é™ä½ä¸»åº“çš„å‹åŠ›ï¼Œä½†æ˜¯å½“ä¸»åº“å®•æœºåé›†ç¾¤å°†ä¸èƒ½å†å†™ã€‚æ‰€ä»¥éœ€è¦replication managerå®ç°é«˜å¯ç”¨çš„ååŠ©ã€‚</p>
<p>å…¶æ¬¡éœ€è¦å®éªŒå¯¹äº<code>mysql galera cluster</code>çš„è¯»å†™åˆ†ç¦»å’Œè´Ÿè½½ã€‚</p>
<h4 id="é‡åˆ°çš„é—®é¢˜">é‡åˆ°çš„é—®é¢˜</h4>
<p>1.å»ºç«‹è´¦æˆ·æ˜¯è®¿é—®IPåº”æ˜ç¡®</p>
<p>2.firewalld å®éªŒçš„æ—¶å€™è¦ä¸å…³æ‰ï¼Œè¦ä¸å†™è§„åˆ™å¼€æ”¾ç«¯å£ã€‚</p>
<h2 id="proxysql-çš„é«˜å¯ç”¨">ProxySql çš„é«˜å¯ç”¨</h2>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>ç¼–å†™äºº</th>
<th>ç¼–å†™æ—¶é—´</th>
<th>ç¼–å†™è¯´æ˜</th>
</tr>
</thead>
<tbody>
<tr>
<td>ç« ç€šä¸­</td>
<td>2020-9-12</td>
<td>æ¥ä¸Šä¸€ç¯‡[proxysql è¯»å†™åˆ†ç¦»](<a class="link" href="http://wiki-private.capitalonline.net:8090/pages/viewpage.action?pageId=59474862"  target="_blank" rel="noopener"
    >ProxySQL è¯»å†™åˆ†ç¦»</a>)ä¸€èµ·è§‚çœ‹è¾ƒä½³</td>
</tr>
</tbody>
</table></div>
<p>æœ‰ä¸¤ä¸ªç»„ä»¶å®ç°äº†ProxySQLé›†ç¾¤</p>
<ul>
<li>
<p><strong>monitoring(é›†ç¾¤ç›‘æ§ç»„ä»¶)</strong></p>
</li>
<li>
<p><strong>re-configuration(è¿œç¨‹é…ç½®)</strong></p>
<p>ä¿©ç»„ä»¶éƒ½æœ‰4å¼ è¡¨</p>
<p><strong>-</strong> mysql_query_rules
<strong>-</strong> mysql_servers
<strong>-</strong> mysql_users
<strong>-</strong> proxysql_servers</p>
</li>
</ul>
<h3 id="ç›¸å…³å˜é‡">ç›¸å…³å˜é‡</h3>
<p>Admin variables ï¼šä½¿ç”¨<code>load admin variables to runtime</code>ä½¿å…¶ç”Ÿæ•ˆ</p>
<h4 id="1ç”¨äºåŒæ­¥çš„å˜é‡">1.ç”¨äºåŒæ­¥çš„å˜é‡</h4>
<pre><code>- `admin-checksum_mysql_query_rules` boolean å˜é‡ï¼Œé»˜è®¤tureï¼Œå½“ä½¿ç”¨`load mysql query rules to runtime`æ—¶ï¼Œä¼šç”Ÿæˆæ–°çš„é…ç½®æ ¡éªŒç ã€‚å¦‚æœæ˜¯false æ–°çš„é…ç½®ä¸ä¼šè‡ªåŠ¨å¹¿æ’­å’ŒåŒæ­¥è¿œç«¯æ•°æ®ã€‚
- `admin-checksum_mysql_servers` å¸ƒå°”ç±»å‹ï¼Œé»˜è®¤ture `load mysql servers to runtime` åŒä¸Š
- `admin-chechsum_mysql_users`å¸ƒå°”ç±»å‹ï¼Œé»˜è®¤ture `load mysql users to runtime`,åŒä¸Šï¼Œä½†æ˜¯ç”¨æˆ·æœ‰æ•°ç™¾ä¸‡ï¼Œä¸ºäº†ä¸å½±å“æ€§èƒ½å°±è¦è®¾ç½®ä¸ºfalseã€‚
</code></pre>
<h4 id="2é›†ç¾¤å‡­è¯å˜é‡">2.é›†ç¾¤å‡­è¯å˜é‡</h4>
<ul>
<li><code>admin-cluster_username</code></li>
<li><code>admin-cluser_password</code></li>
</ul>
<p>è¿™æ˜¯ç”¨äºç›‘æ§å…¶ä»–ProxySQLå®ä¾‹ ï¼Œè¿™ä¿©ä¸ªå˜é‡éœ€è¦å†<code>admin-admin_credentials</code>ä¸­å­˜åœ¨ã€‚</p>
<h4 id="3æ£€æŸ¥é¢‘ç‡å’Œé—´éš”æ—¶é—´">3.æ£€æŸ¥é¢‘ç‡å’Œé—´éš”æ—¶é—´</h4>
<ul>
<li><code>admin-cluster_check_interval_ms</code>è¿™ä¸ªå˜é‡å®šä¹‰äº†æ£€æŸ¥chechsumsçš„æ—¶é—´ï¼Œé»˜è®¤1000,æœ€å°10ï¼Œæœ€å¤§ 300000.</li>
<li><code>admin-cluster_check_status_frequency</code>å®šä¹‰äº†å¤šå°‘æ¬¡checksumsæ£€æŸ¥å°±éªŒè¯ä¸€æ¬¡è¿æ¥æ€§ã€‚</li>
</ul>
<h4 id="4å°†é…ç½®åŒæ­¥åˆ°ç£ç›˜">4.å°†é…ç½®åŒæ­¥åˆ°ç£ç›˜</h4>
<p>åœ¨è¿œç¨‹åŒæ­¥é…ç½®ä¹‹åï¼Œé€šå¸¸æœ€å¥½çš„åšæ³•æ˜¯ç«‹å³å°†æ–°çš„æ›´æ”¹ä¿å­˜åˆ°ç£ç›˜ã€‚è¿™æ ·é‡å¯æ—¶ï¼Œæ›´æ”¹çš„é…ç½®ä¸ä¼šä¸¢å¤±ã€‚
<strong>-</strong> <code>admin-cluster_mysql_query_rules_save_to_disk</code>
<strong>-</strong> <code>admin-cluster_mysql_servers_save_to_disk</code>
<strong>-</strong> <code>admin-cluster_mysql_users_save_to_disk</code>
<strong>-</strong> <code>admin-cluster_proxysql_servers_save_to_disk</code></p>
<p>è¿™å‡ ä¸ªå˜é‡éƒ½æ˜¯å¸ƒå°”å€¼ã€‚å½“è®¾ç½®ä¸ºtrue(é»˜è®¤å€¼)æ—¶ï¼Œåœ¨è¿œç¨‹åŒæ­¥å¹¶loadåˆ°runtimeåï¼Œæ–°çš„mysql_query_rulesã€mysql_serversã€mysql_usersã€proxysql_serversé…ç½®ä¼šæŒä¹…åŒ–åˆ°ç£ç›˜ä¸­ã€‚</p>
<h4 id="5æ˜¯å¦éœ€è¦è¿œç¨‹åŒæ­¥å˜é‡">5.æ˜¯å¦éœ€è¦è¿œç¨‹åŒæ­¥å˜é‡</h4>
<p>ç”±äºæŸäº›åŸå› ï¼Œå¯èƒ½å¤šä¸ªProxySQLå®ä¾‹ä¼šåœ¨åŒä¸€æ—¶é—´è¿›è¡Œé‡æ–°é…ç½®ã€‚
ä¾‹å¦‚ï¼Œæ¯ä¸ªProxySQLå®ä¾‹éƒ½åœ¨ç›‘æ§MySQLçš„replicationï¼Œä¸”è‡ªåŠ¨æ¢æµ‹åˆ°MySQLçš„æ•…éšœè½¬ç§»ï¼Œåœ¨ä¸€ä¸ªæçŸ­çš„æ—¶é—´å†…(å¯èƒ½å°äº1ç§’)ï¼Œè¿™äº›ProxySQLå®ä¾‹å¯èƒ½ä¼šè‡ªåŠ¨è°ƒæ•´æ–°çš„é…ç½®ï¼Œè€Œæ— éœ€é€šè¿‡å…¶å®ƒProxySQLå®ä¾‹æ¥åŒæ­¥æ–°é…ç½®ã€‚</p>
<p>ç±»ä¼¼çš„è¿˜æœ‰ï¼Œå½“æ‰€æœ‰ProxySQLå®ä¾‹éƒ½æ¢æµ‹åˆ°äº†å’ŒæŸå®ä¾‹çš„ä¸´æ—¶çš„ç½‘ç»œé—®é¢˜ï¼Œæˆ–è€…æŸä¸ªMySQLèŠ‚ç‚¹æ¯”è¾ƒæ…¢(replication lag,  æ‹–åè…¿)ï¼Œè¿™äº›ProxySQLå®ä¾‹éƒ½ä¼šè‡ªåŠ¨åœ°é¿å¼€è¿™äº›èŠ‚ç‚¹ã€‚è¿™æ—¶å„ProxySQLå®ä¾‹ä¹Ÿæ— éœ€ä»å…¶å®ƒèŠ‚ç‚¹å¤„åŒæ­¥é…ç½®ï¼Œè€Œæ˜¯åŒæ—¶è‡ªåŠ¨å®Œæˆæ–°çš„é…ç½®ã€‚</p>
<p>é…ç½®ProxySQLé›†ç¾¤ï¼Œè®©å„ProxySQLå®ä¾‹æš‚æ—¶æ— éœ€ä»å…¶å®ƒå®ä¾‹å¤„åŒæ­¥æŸäº›é…ç½®ï¼Œè€Œæ˜¯ç­‰å¾…ä¸€å®šæ¬¡æ•°çš„æ£€æŸ¥ä¹‹åï¼Œå†è§¦å‘è¿œç¨‹åŒæ­¥ã€‚ä½†æ˜¯ï¼Œå¦‚æœæœ¬åœ°å’Œè¿œç¨‹èŠ‚ç‚¹çš„è¿™äº›å˜é‡é˜ˆå€¼ä¸åŒï¼Œåˆ™è¿˜æ˜¯ä¼šè§¦å‘è¿œç¨‹åŒæ­¥ã€‚</p>
<p><strong>-</strong> <code>admin-cluster_mysql_query_rules_diffs_before_sync</code>
<strong>-</strong> <code>admin-cluster_mysql_servers_diffs_before_sync</code>
<strong>-</strong> <code>admin-cluster_mysql_users_diffs_before_sync</code>
<strong>-</strong> <code>admin-cluster_proxysql_servers_diffs_before_sync</code></p>
<p>åˆ†åˆ«å®šä¹‰ç»è¿‡å¤šå°‘æ¬¡çš„&quot;æ— æ³•åŒ¹é…&quot;æ£€æŸ¥ä¹‹åï¼Œè§¦å‘mysql_query_rulesã€mysql_serversã€mysql_usersã€proxysql_serversé…ç½®çš„è¿œç¨‹åŒæ­¥ã€‚é»˜è®¤å€¼3æ¬¡ï¼Œæœ€å°å€¼0ï¼Œè¡¨ç¤ºæ°¸ä¸è¿œç¨‹åŒæ­¥ï¼Œæœ€å¤§å€¼1000ã€‚</p>
<p>æ¯”å¦‚å„å®ä¾‹ç›‘æ§mysql_serversé…ç½®å¹¶åšæ ¡éªŒç æ£€æŸ¥ï¼Œå¦‚æœæŸå®ä¾‹å’Œæœ¬åœ°é…ç½®ä¸åŒï¼Œå½“å¤šæ¬¡æ£€æµ‹åˆ°éƒ½ä¸åŒæ—¶ï¼Œå°†æ ¹æ®load to runtimeçš„æ—¶é—´æˆ³å†³å®šæ˜¯å¦è¦ä»è¿œç«¯å°†mysql_serversåŒæ­¥åˆ°æœ¬åœ°ã€‚</p>
<h4 id="6å»¶è¿ŸåŒæ­¥">6.å»¶è¿ŸåŒæ­¥</h4>
<p>ProxySQL Cluster å¯ä»¥å®šä¹‰è¾¾åˆ°å¤šå°‘ä¸ªchecksum ä¸åŒä¹‹åï¼Œæ‰åœ¨é›†ç¾¤å†…éƒ¨è¿›è¡Œé…ç½®åŒæ­¥ã€‚
query rules, servers, users å’Œproxysql servers åˆ†åˆ«æœ‰admin-cluster_XXX_diffs_before_sync ç›¸å…³çš„å‚æ•°ï¼Œå–å€¼èŒƒå›´0 ï½ 1000ï¼Œ0 ä»£è¡¨ä»ä¸åŒæ­¥ã€‚é»˜è®¤3ã€‚</p>
<h3 id="éœ€è¦é…ç½®çš„è¡¨">éœ€è¦é…ç½®çš„è¡¨</h3>
<h4 id="1proxysql_servers">1.proxysql_servers</h4>
<p>å®šä¹‰proxyssqlé›†ç¾¤ä¸­æœ‰å“ªäº›å®ä¾‹ï¼Œå¯ä»¥åœ¨çº¿insertï¼Œä¹Ÿå¯ä»¥ä¿®æ”¹é…ç½®æ–‡ä»¶ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ProxySQL-Admin&gt;  show create table proxysql_servers;
</span></span><span class="line"><span class="cl">+------------------+--------------------------
</span></span><span class="line"><span class="cl">| table            | Create Table            |
</span></span><span class="line"><span class="cl">+------------------+--------------------------
</span></span><span class="line"><span class="cl">| proxysql_servers | CREATE TABLE proxysql_servers (
</span></span><span class="line"><span class="cl">    hostname VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    port INT NOT NULL DEFAULT 6032,
</span></span><span class="line"><span class="cl">    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (hostname, port) ) |
</span></span><span class="line"><span class="cl">+------------------+--------------------------
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><p>ProxySQLåªæœ‰åœ¨ç£ç›˜æ•°æ®åº“æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæˆ–è€…ä½¿ç”¨äº†&ndash;initialé€‰é¡¹æ—¶æ‰ä¼šè¯»å–ä¼ ç»Ÿé…ç½®æ–‡ä»¶ã€‚</p>
<h4 id="2runtime_proxysql_servers">2.runtime_proxysql_servers</h4>
<p>æ­£å¦‚å…¶å®ƒruntime_è¡¨ä¸€æ ·ï¼Œruntime_proxysql_serversè¡¨å’Œproxysql_serversçš„ç»“æ„å®Œå…¨ä¸€è‡´ï¼Œåªä¸è¿‡å®ƒæ˜¯runtimeæ•°æ®ç»“æ„ä¸­çš„é…ç½®ï¼Œä¹Ÿå°±æ˜¯å½“å‰æ­£åœ¨ç”Ÿæ•ˆçš„é…ç½®ã€‚è¯¥è¡¨çš„å®šä¹‰è¯­å¥å¦‚ä¸‹ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">| runtime_proxysql_servers | CREATE TABLE runtime_proxysql_servers (
</span></span><span class="line"><span class="cl">    hostname VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    port INT NOT NULL DEFAULT 6032,
</span></span><span class="line"><span class="cl">    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (hostname, port) ) |
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="3runtime_checksums_values">3.runtime_checksums_values</h4>
<p>è¿™ä¸ªä¸æ˜¯åŸºäºå†…å­˜çš„ã€‚ç”¨äº load to runtimeæ—¶çš„ä¿¡æ¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">| runtime_checksums_values | CREATE TABLE runtime_checksums_values (
</span></span><span class="line"><span class="cl">    name VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    version INT NOT NULL,
</span></span><span class="line"><span class="cl">    epoch INT NOT NULL,
</span></span><span class="line"><span class="cl">    checksum VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (name)) |
</span></span></code></pre></td></tr></table>
</div>
</div><p>- nameï¼šæ¨¡å—çš„åç§°
- versionï¼šæ‰§è¡Œäº†å¤šå°‘æ¬¡load to runtimeæ“ä½œï¼ŒåŒ…æ‹¬æ‰€æœ‰éšå¼å’Œæ˜¾å¼æ‰§è¡Œçš„(æŸäº›äº‹ä»¶ä¼šå¯¼è‡´ProxySQLå†…éƒ¨è‡ªåŠ¨æ‰§è¡Œload to runtimeå‘½ä»¤)
- epochï¼šæœ€è¿‘ä¸€æ¬¡æ‰§è¡Œload to runtimeçš„æ—¶é—´æˆ³
- checksumï¼šæ‰§è¡Œload to runtimeæ—¶ç”Ÿæˆçš„é…ç½®æ ¡éªŒç (checksum)</p>
<p><strong>ç‰¹åˆ«æ³¨æ„ï¼š</strong>  ç›®å‰6ä¸ªç»„ä»¶ä¸­åªæœ‰4ç§æ¨¡å—çš„é…ç½®ä¼šç”Ÿæˆå¯¹åº”çš„æ ¡éªŒç (checksum)ï¼Œä¸èƒ½ç”Ÿæˆçš„ç»„ä»¶æ˜¯ï¼šadmin_variablesï¼Œmysql_variablesã€‚ checnsum åªæœ‰åœ¨æ‰§è¡Œäº†load to run ï¼Œå¹¶ä¸”admin-checksum_XXX = true æ—¶ï¼Œæ‰å¯ä»¥æ­£å¸¸ç”Ÿæˆã€‚å³:
- LOAD MYSQL QUERY RULES TO RUNTIMEï¼šå½“admin-checksum_mysql_query_rules=trueæ—¶ç”Ÿæˆä¸€ä¸ªæ–°çš„mysql_query_rulesé…ç½®æ ¡éªŒç 
- LOAD MYSQL SERVERS TO RUNTIMEï¼šå½“admin-checksum_mysql_servers=trueæ—¶ç”Ÿæˆä¸€ä¸ªæ–°çš„mysql_serversé…ç½®æ ¡éªŒç 
- LOAD MYSQL USERS TO RUNTIMEï¼šå½“admin-checksum_mysql_users=trueæ—¶ç”Ÿæˆä¸€ä¸ªæ–°çš„mysql_usersé…ç½®æ ¡éªŒç 
- LOAD PROXYSQL SERVERS TO RUNTIMEï¼šæ€»æ˜¯ä¼šç”Ÿæˆä¸€ä¸ªæ–°çš„proxysql_serversé…ç½®æ ¡éªŒç 
- LOAD ADMIN VARIABLES TO RUNTIMEï¼šä¸ç”Ÿæˆæ ¡éªŒç 
- LOAD MYSQL VARIABLES TO RUNTIMEï¼šä¸ç”Ÿäº§æ ¡éªŒç </p>
<p><strong>New commands ï¼ˆæ–°å‘½ä»¤ï¼‰:</strong>
- LOAD PROXYSQL SERVERS FROM MEMORY / LOAD PROXYSQL SERVERS TO RUNTIME
ä»å†…å­˜æ•°æ®åº“ä¸­åŠ è½½proxysql serversé…ç½®åˆ°runtimeæ•°æ®ç»“æ„
- SAVE PROXYSQL SERVERS TO MEMORY / SAVE PROXYSQL SERVERS FROM RUNTIME
å°†proxysql serversé…ç½®ä»runtimeæ•°æ®ç»“æ„æŒä¹…åŒ–ä¿å­˜åˆ°å†…å­˜æ•°æ®åº“ä¸­
- LOAD PROXYSQL SERVERS TO MEMORY / LOAD PROXYSQL SERVERS FROM DISK
ä»ç£ç›˜æ•°æ®åº“ä¸­åŠ è½½proxysql serversé…ç½®åˆ°å†…å­˜æ•°æ®åº“ä¸­
- LOAD PROXYSQL SERVERS FROM CONFIG
ä»ä¼ ç»Ÿé…ç½®æ–‡ä»¶ä¸­åŠ è½½proxysql serversé…ç½®åˆ°å†…å­˜æ•°æ®åº“ä¸­
- SAVE PROXYSQL SERVERS FROM MEMORY / SAVE PROXYSQL SERVERS TO DISK
å°†proxysql serversé…ç½®ä»å†…å­˜æ•°æ®åº“ä¸­æŒä¹…åŒ–ä¿å­˜åˆ°ç£ç›˜æ•°æ®åº“ä¸­</p>
<h3 id="stats-tables">stats tables</h3>
<h4 id="1stats_proxysql_servers_checksums">1.stats_proxysql_servers_checksums</h4>
<p>è®°å½•é›†ç¾¤ä¸­å„ä¸ªå®ä¾‹çš„ç»„ä»¶checksum ä¿¡æ¯ã€‚</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> show create table stats.stats_proxysql_servers_checksums;
</span></span><span class="line"><span class="cl">| stats_proxysql_servers_checksums | CREATE TABLE stats_proxysql_servers_checksums (
</span></span><span class="line"><span class="cl">    hostname VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    port INT NOT NULL DEFAULT 6032,
</span></span><span class="line"><span class="cl">    name VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    version INT NOT NULL,
</span></span><span class="line"><span class="cl">    epoch INT NOT NULL,
</span></span><span class="line"><span class="cl">    checksum VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    changed_at INT NOT NULL,
</span></span><span class="line"><span class="cl">    updated_at INT NOT NULL,
</span></span><span class="line"><span class="cl">    diff_check INT NOT NULL,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (hostname, port, name) ) |
</span></span></code></pre></td></tr></table>
</div>
</div><p>å„å­—æ®µæ„ä¹‰å¦‚ä¸‹ï¼š
- hostnameï¼šProxySQLå®ä¾‹çš„ä¸»æœºå
- portï¼šProxySQLå®ä¾‹çš„ç«¯å£
- nameï¼šå¯¹ç«¯runtime_checksums_valuesä¸­æŠ¥å‘Šçš„æ¨¡å—åç§°
- versionï¼šå¯¹ç«¯runtime_checksum_valuesä¸­æŠ¥å‘Šçš„checksumçš„ç‰ˆæœ¬
<strong>æ³¨æ„</strong>ï¼ŒProxySQLå®ä¾‹åˆšå¯åŠ¨æ—¶version=1ï¼šProxySQLå®ä¾‹å°†æ°¸è¿œä¸ä¼šä»version=1çš„å®ä¾‹å¤„åŒæ­¥é…ç½®æ•°æ®ï¼Œå› ä¸ºä¸€ä¸ªåˆšåˆšå¯åŠ¨çš„ProxyQLå®ä¾‹ä¸å¤ªå¯èƒ½æ˜¯çœŸç›¸çš„æ¥æºï¼Œè¿™å¯ä»¥é˜²æ­¢æ–°çš„è¿æ¥èŠ‚ç‚¹ç ´åå½“å‰é›†ç¾¤é…ç½®
- epochï¼šå¯¹ç«¯runtime_checksums_valuesä¸­æŠ¥å‘Šçš„checksumçš„æ—¶é—´æˆ³epochå€¼
- checksumï¼šå¯¹ç«¯runtime_checksums_valuesä¸­æŠ¥å‘Šçš„checksumå€¼
- changed_atï¼šæ¢æµ‹åˆ°checksumå‘ç”Ÿå˜åŒ–çš„æ—¶é—´æˆ³
- updated_atï¼šæœ€è¿‘ä¸€æ¬¡æ›´æ–°è¯¥ç±»é…ç½®çš„æ—¶é—´æˆ³
- diff_checkï¼šä¸€ä¸ªè®¡æ•°å™¨ï¼Œç”¨äºè®°å½•æ¢æµ‹åˆ°çš„å¯¹ç«¯å’Œæœ¬åœ°checksumå€¼å·²æœ‰å¤šå°‘æ¬¡ä¸åŒ
éœ€è¦ç­‰å¾…è¾¾åˆ°é˜ˆå€¼åï¼Œæ‰ä¼šè§¦å‘é‡æ–°é…ç½®ã€‚å‰é¢å·²ç»è¯´æ˜ï¼Œåœ¨å¤šä¸ªProxySQLå®ä¾‹åŒæ—¶æˆ–æçŸ­æ—¶é—´å†…åŒæ—¶æ›´æ”¹é…ç½®æ—¶ï¼Œå¯ä»¥è®©ProxySQLç­‰å¾…å¤šæ¬¡æ¢æµ‹ä¹‹åå†å†³å®šæ˜¯å¦ä»è¿œç«¯åŒæ­¥é…ç½®ã€‚è¿™ä¸ªå­—æ®µæ­£æ˜¯ç”¨äºè®°å½•æ¢æµ‹åˆ°çš„é…ç½®ä¸åŒæ¬¡æ•°ã€‚å¦‚æœdiff_checksä¸æ–­å¢åŠ å´ä»æœªè§¦å‘åŒæ­¥æ“ä½œï¼Œè¿™æ„å‘³ç€å¯¹ç«¯ä¸æ˜¯å¯ä¿¡ä»»çš„åŒæ­¥æºï¼Œä¾‹å¦‚å¯¹ç«¯çš„version=1ã€‚å¦ä¸€æ–¹é¢ï¼Œå¦‚æœæŸå¯¹ç«¯èŠ‚ç‚¹ä¸å’ŒProxySQLé›†ç¾¤ä¸­çš„å…¶å®ƒå®ä¾‹è¿›è¡Œé…ç½®åŒæ­¥ï¼Œè¿™æ„å‘³ç€é›†ç¾¤æ²¡æœ‰å¯ä¿¡ä»»çš„åŒæ­¥æºã€‚è¿™ç§æƒ…å†µå¯èƒ½æ˜¯å› ä¸ºé›†ç¾¤ä¸­æ‰€æœ‰å®ä¾‹å¯åŠ¨æ—¶çš„é…ç½®éƒ½ä¸ä¸€æ ·ï¼Œå®ƒä»¬æ— æ³•è‡ªåŠ¨åˆ¤æ–­å“ªä¸ªé…ç½®æ‰æ˜¯æ­£ç¡®çš„ã€‚å¯ä»¥åœ¨æŸä¸ªèŠ‚ç‚¹ä¸Šæ‰§è¡Œload to runtimeï¼Œä½¿è¯¥èŠ‚ç‚¹è¢«é€‰ä¸¾ä¸ºè¯¥ç±»é…ç½®çš„å¯ä¿¡ä»»åŒæ­¥æºã€‚</p>
<h4 id="2stats_proxysql_servers_metrics-è¡¨">2.<strong>stats_proxysql_servers_metrics è¡¨</strong></h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">show create table stats.stats_proxysql_servers_metrics;
</span></span><span class="line"><span class="cl">| stats_proxysql_servers_metrics | CREATE TABLE stats_proxysql_servers_metrics (
</span></span><span class="line"><span class="cl">    hostname VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    port INT NOT NULL DEFAULT 6032,
</span></span><span class="line"><span class="cl">    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
</span></span><span class="line"><span class="cl">    response_time_ms INT NOT NULL,
</span></span><span class="line"><span class="cl">    Uptime_s INT NOT NULL,
</span></span><span class="line"><span class="cl">    last_check_ms INT NOT NULL,
</span></span><span class="line"><span class="cl">    Queries INT NOT NULL,
</span></span><span class="line"><span class="cl">    Client_Connections_connected INT NOT NULL,
</span></span><span class="line"><span class="cl">    Client_Connections_created INT NOT NULL,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (hostname, port) ) |
</span></span></code></pre></td></tr></table>
</div>
</div><p>å½“æ‰§è¡Œshow mysql statusè¯­å¥æ—¶ï¼Œæ˜¾ç¤ºä¸€äº›å·²æ£€ç´¢åˆ°çš„æŒ‡æ ‡ã€‚å­—æ®µæ„ä¹‰å¦‚ä¸‹ï¼š
- hostnameï¼šProxySQLå®ä¾‹ä¸»æœºå
- portï¼šProxySQLå®ä¾‹ç«¯å£
- weightï¼šæŠ¥å‘Šç»“æœåŒproxysql_servers.weightå­—æ®µ
- commentï¼šæŠ¥å‘Šç»“æœåŒproxysql_servers.commentå­—æ®µ
- response_time_msï¼šæ‰§è¡Œshow mysql statusçš„å“åº”æ—¶é•¿ï¼Œå•ä½æ¯«ç§’
- Uptime_sï¼šProxySQLå®ä¾‹çš„uptimeï¼Œå•ä½ç§’
- last_check_msï¼šæœ€è¿‘ä¸€æ¬¡æ‰§è¡Œcheckè·ç°åœ¨å·²å¤šä¹…ï¼Œå•ä½æ¯«ç§’
- Queriesï¼šè¯¥å®ä¾‹å·²æ‰§è¡Œqueryçš„æ•°é‡
- Client_Connections_connectedï¼šnumber of client&rsquo;s connections connected
- Client_Connections_createdï¼šnumber of client&rsquo;s connections created
**æ³¨æ„ï¼š**å½“å‰è¿™äº›çŠ¶æ€åªä¸ºdebugç›®çš„ï¼Œä½†æœªæ¥å¯èƒ½ä¼šä½œä¸ºè¿œç¨‹å®ä¾‹çš„å¥åº·æŒ‡æ ‡ã€‚</p>
<h4 id="3stats_proxysql_servers_status">3.stats_proxysql_servers_status</h4>
<p>Currently unused â€“ this table was created to show general statistics related to all the services configured in the <code>proxysql_servers</code> table.</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">Admin&gt; show create table stats.stats_proxysql_servers_status\G
</span></span><span class="line"><span class="cl">*************************** 1. row ***************************
</span></span><span class="line"><span class="cl">       table: stats_proxysql_servers_status
</span></span><span class="line"><span class="cl">Create Table: CREATE TABLE stats_proxysql_servers_status (
</span></span><span class="line"><span class="cl">    hostname VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    port INT NOT NULL DEFAULT 6032,
</span></span><span class="line"><span class="cl">    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    master VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    global_version INT NOT NULL,
</span></span><span class="line"><span class="cl">    check_age_us INT NOT NULL,
</span></span><span class="line"><span class="cl">    ping_time_us INT NOT NULL, checks_OK INT NOT NULL,
</span></span><span class="line"><span class="cl">    checks_ERR INT NOT NULL,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (hostname, port) )
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="re-configuration">Re-configuration</h4>
<p>å› ä¸ºé›†ç¾¤é—´ï¼Œæ‰€æœ‰èŠ‚ç‚¹éƒ½æ˜¯ç›¸äº’ç›‘æ§çš„ã€‚æ¯ä¸ªProxySQLèŠ‚ç‚¹éƒ½ç›‘æ§é›†ç¾¤ä¸­çš„å…¶å®ƒå®ä¾‹ï¼Œå®ƒä»¬å¯ä»¥å¿«é€Ÿæ¢æµ‹åˆ°æŸä¸ªå®ä¾‹çš„é…ç½®æ˜¯å¦å‘ç”Ÿæ”¹å˜ã€‚å¦‚æœæŸå®ä¾‹çš„é…ç½®å‘ç”Ÿæ”¹å˜ï¼Œå…¶å®ƒå®ä¾‹ä¼šæ£€æŸ¥è¿™ä¸ªé…ç½®å’Œè‡ªèº«çš„é…ç½®æ˜¯å¦ç›¸åŒï¼Œå› ä¸ºå…¶å®ƒèŠ‚ç‚¹çš„é…ç½®å¯èƒ½å’Œæœ¬èŠ‚ç‚¹çš„é…ç½®åŒæ—¶(æˆ–åœ¨æçŸ­æ—¶é—´å·®èŒƒå›´)å‘ç”Ÿäº†æ”¹å˜ã€‚</p>
<p>ç”±äºç›¸äº’ç›‘æ§ï¼Œæ‰€ä»¥å½“é…ç½®å‘ç”Ÿå˜åŠ¨æ—¶ï¼Œå®ƒä»¬å¯ä»¥ç«‹å³å‘ç°ã€‚å½“å…¶ä»–èŠ‚ç‚¹çš„é…ç½®å‘ç”Ÿå˜åŠ¨æ—¶ï¼Œæœ¬èŠ‚ç‚¹ä¼šå…ˆå»æ£€æŸ¥ä¸€æ¬¡å®ƒè‡ªèº«çš„é…ç½®ï¼Œå› ä¸ºæœ‰å¯èƒ½remote instance å’Œlocal instance åŒæ—¶å‘ç”Ÿé…ç½®å˜åŠ¨ã€‚
å¦‚æœæ¯”è¾ƒç»“æœä¸åŒï¼š
<strong>-</strong> å¦‚æœå®ƒä»¬è‡ªèº«çš„ version = 1ï¼Œå°±å»æ‰¾é›†ç¾¤å†…ä»version &gt; 1çš„èŠ‚ç‚¹å¤„æ‰¾å‡ºepochæœ€å¤§å€¼çš„èŠ‚ç‚¹ï¼Œå¹¶ä»è¯¥èŠ‚ç‚¹æ‹‰å–é…ç½®åº”ç”¨åˆ°æœ¬åœ°ï¼Œå¹¶ç«‹å³åŒæ­¥ã€‚
<strong>-</strong> å¦‚æœversion &gt;1ï¼Œ è¯¥èŠ‚ç‚¹å¼€å§‹ç»Ÿè®¡å’Œå…¶ä»–èŠ‚ç‚¹é—´çš„differ æ•°ã€‚å³å¼€å§‹å¯¹æ¢æµ‹åˆ°çš„ä¸åŒé…ç½®è¿›è¡Œè®¡æ•°ã€‚
<strong>-</strong>  å½“ differ å¤§äº cluster__name___diffs_before_sync ï¼Œ  å¹¶ä¸”cluster__name__diffs_before_sync &gt; 0ï¼Œ å°±å»æ‰¾é›†ç¾¤å†… version &gt;1ï¼Œ å¹¶ä¸”epoch  æœ€é«˜çš„èŠ‚ç‚¹ï¼Œå¹¶ç«‹å³åŒæ­¥ã€‚ä¹Ÿå°±æ˜¯è¯´å½“æ¢æµ‹åˆ°ä¸åŒé…ç½®çš„æ¬¡æ•°è¶…è¿‡cluster_name_diffs_before_syncï¼Œä¸”cluster_name_diffs_before_syncå¤§äº0æ—¶ï¼Œæ‰¾å‡ºversion &gt; 1ä¸”epochå€¼æœ€å¤§çš„èŠ‚ç‚¹ï¼Œå¹¶ä»è¯¥èŠ‚ç‚¹æ‹‰å–é…ç½®ç¦ç”¨åº”ç”¨ã€‚</p>
<p>åŒæ­¥é…ç½®çš„è¿‡ç¨‹å¦‚ä¸‹ï¼š
<strong>-</strong> ç”¨äºå¥åº·æ£€æŸ¥çš„è¿æ¥ï¼Œä¹Ÿç”¨æ¥æ‰§è¡Œä¸€ç³»åˆ—ç±»ä¼¼äºselect _list_of_columns from runtime_moduleçš„selectè¯­å¥ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-mysql" data-lang="mysql"><span class="line"><span class="cl"><span class="k">SELECT</span><span class="w"> </span><span class="n">hostgroup_id</span><span class="p">,</span><span class="w"> </span><span class="o">``</span><span class="n">hostname</span><span class="o">``</span><span class="p">,</span><span class="w"> </span><span class="n">port</span><span class="p">,</span><span class="w"> </span><span class="n">status</span><span class="p">,</span><span class="w"> </span><span class="n">weight</span><span class="p">,</span><span class="w"> </span><span class="n">compression</span><span class="p">,</span><span class="w"> </span><span class="n">max_connections</span><span class="p">,</span><span class="w">  </span><span class="n">max_replication_lag</span><span class="p">,</span><span class="w"> </span><span class="n">use_ssl</span><span class="p">,</span><span class="w"> </span><span class="n">max_latency_ms</span><span class="p">,</span><span class="w"> </span><span class="n">comment</span><span class="w"> </span><span class="k">FROM</span><span class="w">  </span><span class="n">runtime_mysql_servers</span><span class="p">;</span><span class="o">``</span><span class="k">SELECT</span><span class="w"> </span><span class="n">writer_hostgroup</span><span class="p">,</span><span class="w"> </span><span class="n">reader_hostgroup</span><span class="p">,</span><span class="w"> </span><span class="n">comment</span><span class="w"> </span><span class="k">FROM</span><span class="w"> </span><span class="n">runtime_mysql_replication_hostgroups</span><span class="p">;</span><span class="w">
</span></span></span></code></pre></td></tr></table>
</div>
</div><p>åˆ é™¤æœ¬åœ°é…ç½®ã€‚ä¾‹å¦‚ï¼š</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">DELETE FROM mysql_servers;DELETE FROM mysql_replication_hostgroups;
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>-</strong> å‘æœ¬åœ°é…ç½®è¡¨ä¸­æ’å…¥å·²ä»è¿œç«¯èŠ‚ç‚¹æ£€ç´¢åˆ°çš„æ–°é…ç½®ã€‚
<strong>-</strong> åœ¨å†…éƒ¨æ‰§è¡ŒLOAD module_name TO RUNTIMEï¼šè¿™ä¼šé€’å¢ç‰ˆæœ¬å·ï¼Œå¹¶åˆ›å»ºä¸€ä¸ªæ–°çš„checksumã€‚
<strong>-</strong> å¦‚æœcluster_name_save_to_disk=trueï¼Œå†åœ¨å†…éƒ¨æ‰§è¡ŒSAVE module_name TO DISKã€‚</p>
<p>å‚è€ƒæ–‡æ¡£ï¼šhttps://www.cnblogs.com/kevingrace/p/10411457.html</p>
<h4 id="è¿›è¡Œé…ç½®">è¿›è¡Œé…ç½®</h4>
<p>è¦ä½¿ç”¨çš„VIPï¼š 10.241.10.3</p>
<div class="table-wrapper"><table>
<thead>
<tr>
<th>æœºå™¨</th>
<th>è§’è‰²</th>
<th>å†…ç½‘IP</th>
</tr>
</thead>
<tbody>
<tr>
<td>xxx.xxx.xxx.117</td>
<td>åŸæ¥æ­å»ºå¥½çš„proxysql</td>
<td>10.241.10.1</td>
</tr>
<tr>
<td>xxx.xxx.xxx.114</td>
<td>è¦æ–°æ·»åŠ ç»„å»ºé›†ç¾¤çš„proxysql</td>
<td>10.241.10.2</td>
</tr>
</tbody>
</table></div>
<p>å†™é…ç½®æ–‡ä»¶å’Œå®æ—¶ä¿®æ”¹éƒ½å¯ä»¥ï¼Œè®°å¾—</p>
<p><code>load *** to runtime</code>ã€<code>save *** to disk</code></p>
<p><strong>1.è§„å®šé›†ç¾¤ä¿¡æ¯ï¼ˆåœ¨117ä¸Šï¼‰</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">set</span>  <span class="n">admin</span><span class="o">-</span><span class="n">admin_credentials</span><span class="o">=</span><span class="s2">&#34;admin:admin;cluster_name:123456&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">set</span> <span class="n">admin</span><span class="o">-</span><span class="n">cluster_username</span><span class="o">=</span><span class="s2">&#34;cluster_name&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">set</span> <span class="n">admin</span><span class="o">-</span><span class="n">cluster_password</span><span class="o">=</span><span class="s2">&#34;123456&#34;</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">set</span> <span class="n">admin</span><span class="o">-</span><span class="n">cluster_check_interval_ms</span><span class="o">=</span><span class="mi">200</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">set</span> <span class="n">admin</span><span class="o">-</span><span class="n">cluster_check_status_frequency</span><span class="o">=</span><span class="mi">100</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="nb">load</span> <span class="n">admin</span> <span class="n">variables</span> <span class="n">to</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">save</span> <span class="n">admin</span> <span class="n">variables</span>  <span class="n">to</span> <span class="n">disk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">35</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><code>select * from global_variables;</code>å¯ä»¥æŸ¥çœ‹ä¿®æ”¹ç»“æœ</p>
<p><strong>2.å†™å…¥èŠ‚ç‚¹ä¿¡æ¯</strong></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span><span class="lnt">9
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">ProxySQL-Admin&gt;  show create table proxysql_servers;
</span></span><span class="line"><span class="cl">| table            | Create Table                                                         
</span></span><span class="line"><span class="cl">| proxysql_servers | CREATE TABLE proxysql_servers (
</span></span><span class="line"><span class="cl">    hostname VARCHAR NOT NULL,
</span></span><span class="line"><span class="cl">    port INT NOT NULL DEFAULT 6032,
</span></span><span class="line"><span class="cl">    weight INT CHECK (weight &gt;= 0) NOT NULL DEFAULT 0,
</span></span><span class="line"><span class="cl">    comment VARCHAR NOT NULL DEFAULT &#39;&#39;,
</span></span><span class="line"><span class="cl">    PRIMARY KEY (hostname, port) ) |
</span></span><span class="line"><span class="cl">1 row in set (0.00 sec)
</span></span></code></pre></td></tr></table>
</div>
</div><p>å†™å…¥èŠ‚ç‚¹</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">insert</span> <span class="n">into</span> <span class="n">proxysql_servers</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="n">port</span><span class="p">)</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;xxx.xxx.xxx.114&#39;</span><span class="p">,</span><span class="mi">6032</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">insert</span> <span class="n">into</span> <span class="n">proxysql_servers</span><span class="p">(</span><span class="n">hostname</span><span class="p">,</span><span class="n">port</span><span class="p">)</span><span class="n">values</span><span class="p">(</span><span class="s1">&#39;xxx.xxx.xxx.117&#39;</span><span class="p">,</span><span class="mi">6032</span><span class="p">);</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="nb">load</span> <span class="n">proxysql</span> <span class="n">servers</span> <span class="n">to</span> <span class="n">runtime</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">ProxySQL</span><span class="o">-</span><span class="n">Admin</span><span class="o">&gt;</span>  <span class="n">save</span> <span class="n">proxysql</span> <span class="n">servers</span> <span class="n">to</span> <span class="n">disk</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä¸ºäº†ç»ƒä¹  åœ¨å¦ä¸€ä¸ªèŠ‚ç‚¹æˆ‘ä»¬ä½¿ç”¨é…ç½®æ–‡ä»¶è¿›è¡Œä¿®æ”¹ï¼Œå€¼çš„æ³¨æ„çš„æ˜¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="err">è¿™é‡Œè¦ç‰¹åˆ«æ³¨æ„ï¼š</span>
</span></span><span class="line"><span class="cl"><span class="err">å¦‚æœå­˜åœ¨å¦‚æœå­˜åœ¨``</span><span class="s2">&#34;proxysql.db&#34;</span><span class="err">``æ–‡ä»¶</span><span class="p">(</span><span class="err">åœ¨``</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">proxysql</span><span class="err">``ç›®å½•ä¸‹</span><span class="p">)</span><span class="err">ï¼Œåˆ™</span><span class="n">ProxySQLæœåŠ¡åªæœ‰åœ¨ç¬¬ä¸€æ¬¡å¯åŠ¨æ—¶æ‰ä¼šå»è¯»å–proxysql</span><span class="o">.</span><span class="n">cnfæ–‡ä»¶å¹¶è§£æ</span><span class="err">ï¼›åé¢å¯åŠ¨ä¼šå°±ä¸ä¼šè¯»å–</span><span class="n">proxysql</span><span class="o">.</span><span class="n">cnfæ–‡ä»¶äº†</span><span class="err">ï¼å¦‚æœæƒ³è¦è®©</span><span class="n">proxysql</span><span class="o">.</span><span class="n">cnfæ–‡ä»¶é‡Œçš„é…ç½®åœ¨é‡å¯proxysqlæœåŠ¡åç”Ÿæ•ˆ</span><span class="p">(</span><span class="err">å³æƒ³è¦è®©</span><span class="n">proxysqlé‡å¯æ—¶è¯»å–å¹¶è§£æproxysql</span><span class="o">.</span><span class="n">cnfé…ç½®æ–‡ä»¶</span><span class="p">)</span><span class="err">ï¼Œåˆ™éœ€è¦å…ˆåˆ é™¤``</span><span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">proxysql</span><span class="o">/</span><span class="n">proxysql</span><span class="err">``</span><span class="o">.</span><span class="n">dbæ•°æ®åº“æ–‡ä»¶</span><span class="err">ï¼Œç„¶åå†é‡å¯</span><span class="n">proxysqlæœåŠ¡</span><span class="err">ã€‚è¿™æ ·å°±ç›¸å½“äºåˆå§‹åŒ–å¯åŠ¨</span><span class="n">proxysqlæœåŠ¡äº†</span><span class="err">ï¼Œä¼šå†æ¬¡ç”Ÿäº§ä¸€ä¸ªçº¯å‡€çš„</span><span class="n">proxysql</span><span class="o">.</span><span class="n">dbæ•°æ®åº“æ–‡ä»¶</span><span class="p">(</span><span class="err">å¦‚æœä¹‹å‰é…ç½®äº†</span><span class="n">proxysqlç›¸å…³è·¯ç”±è§„åˆ™ç­‰</span><span class="err">ï¼Œåˆ™å°±ä¼šè¢«æŠ¹æ‰</span><span class="p">)</span><span class="err">ã€‚</span>
</span></span></code></pre></td></tr></table>
</div>
</div><div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="c1"># cp /etc/proxysql.cnf /etc/proxysql.cnf.bak</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="c1"># vim /etc/proxysql.cnf</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">admin_variables</span><span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">admin_credentials</span><span class="o">=</span><span class="s2">&#34;admin:admin;cluster_name:123456&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       mysql_ifaces=&#34;127.0.0.1:6032;/tmp/proxysql_admin.sock&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">mysql_ifaces</span><span class="o">=</span><span class="s2">&#34;0.0.0.0:6032&#34;</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       refresh_interval=2000</span>
</span></span><span class="line"><span class="cl"><span class="c1">#       debug=true</span>
</span></span><span class="line"><span class="cl">        <span class="n">cluster_username</span><span class="o">=</span><span class="s2">&#34;cluster_name&#34;</span>                                  
</span></span><span class="line"><span class="cl">        <span class="n">cluster_password</span><span class="o">=</span><span class="s2">&#34;123456&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">cluster_check_interval_ms</span><span class="o">=</span><span class="mi">2000</span>
</span></span><span class="line"><span class="cl">        <span class="n">cluster_check_status_frequency</span><span class="o">=</span><span class="mi">1000</span>
</span></span><span class="line"><span class="cl"><span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="n">proxysql_servers</span> <span class="o">=</span>
</span></span><span class="line"><span class="cl"><span class="p">(</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">hostname</span><span class="o">=</span><span class="s2">&#34;xxx.xxx.xxx.114&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">port</span><span class="o">=</span><span class="mi">6032</span>
</span></span><span class="line"><span class="cl">        <span class="p">},</span>
</span></span><span class="line"><span class="cl">        <span class="p">{</span>
</span></span><span class="line"><span class="cl">        <span class="n">hostname</span><span class="o">=</span><span class="s2">&#34;xxx.xxx.xxx.117&#34;</span>
</span></span><span class="line"><span class="cl">        <span class="n">port</span><span class="o">=</span><span class="mi">6032</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">        <span class="p">}</span>
</span></span><span class="line"><span class="cl"><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ³¨æ„é‡Œé¢çš„åœ†æ‹¬å·</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="c1"># systemctl restart proxysql</span>
</span></span><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="c1"># ll  /var/lib/proxysql/proxysql.db </span>
</span></span><span class="line"><span class="cl"><span class="o">-</span><span class="n">rw</span><span class="o">-------</span> <span class="mi">1</span> <span class="n">proxysql</span> <span class="n">proxysql</span> <span class="mi">196608</span> <span class="n">Oct</span> <span class="mi">20</span> <span class="mi">11</span><span class="p">:</span><span class="mi">11</span> <span class="o">/</span><span class="k">var</span><span class="o">/</span><span class="n">lib</span><span class="o">/</span><span class="n">proxysql</span><span class="o">/</span><span class="n">proxysql</span><span class="o">.</span><span class="n">db</span>
</span></span></code></pre></td></tr></table>
</div>
</div><h4 id="è§‚å¯Ÿé›†ç¾¤çŠ¶å†µ">è§‚å¯Ÿé›†ç¾¤çŠ¶å†µ</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span><span class="lnt">36
</span><span class="lnt">37
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="p">[</span><span class="n">root</span><span class="err">@</span><span class="n">localhost</span> <span class="o">~</span><span class="p">]</span><span class="c1"># mysql -uadmin -padmin -h127.0.0.1 -P6032</span>
</span></span><span class="line"><span class="cl"><span class="n">MySQL</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">stats_proxysql_servers_metrics</span><span class="p">;</span> 
</span></span><span class="line"><span class="cl"><span class="o">+-----------------+------+--------+---------+------------------+----------+---------------+---------+-------------------</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">hostname</span>        <span class="o">|</span> <span class="n">port</span> <span class="o">|</span> <span class="n">weight</span> <span class="o">|</span> <span class="n">comment</span> <span class="o">|</span> <span class="n">response_time_ms</span> <span class="o">|</span> <span class="n">Uptime_s</span> <span class="o">|</span> <span class="n">last_check_ms</span> <span class="o">|</span> <span class="n">Queries</span> <span class="o">|</span> <span class="n">Client_Connections</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----------------+------+--------+---------+------------------+----------+---------------+---------+-------------------</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">114</span>  <span class="o">|</span> <span class="mi">6032</span> <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>         <span class="o">|</span> <span class="mi">0</span>                <span class="o">|</span> <span class="mi">0</span>        <span class="o">|</span> <span class="mi">676276571</span>     <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="mi">0</span>                 
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">117</span> <span class="o">|</span> <span class="mi">6032</span> <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>         <span class="o">|</span> <span class="mi">0</span>                <span class="o">|</span> <span class="mi">0</span>        <span class="o">|</span> <span class="mi">676276571</span>     <span class="o">|</span> <span class="mi">0</span>       <span class="o">|</span> <span class="mi">0</span>                 
</span></span><span class="line"><span class="cl"><span class="o">+-----------------+------+--------+---------+------------------+----------+---------------+---------+-------------------</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">MySQL</span> <span class="p">[(</span><span class="n">none</span><span class="p">)]</span><span class="o">&gt;</span> <span class="n">select</span> <span class="o">*</span> <span class="n">from</span> <span class="n">proxysql_servers</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----------------+------+--------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">hostname</span>        <span class="o">|</span> <span class="n">port</span> <span class="o">|</span> <span class="n">weight</span> <span class="o">|</span> <span class="n">comment</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----------------+------+--------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">114</span>  <span class="o">|</span> <span class="mi">6032</span> <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">117</span> <span class="o">|</span> <span class="mi">6032</span> <span class="o">|</span> <span class="mi">0</span>      <span class="o">|</span>         <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----------------+------+--------+---------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">2</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">select</span> <span class="n">hostname</span><span class="p">,</span><span class="n">name</span><span class="p">,</span><span class="n">checksum</span><span class="p">,</span><span class="n">updated_at</span> <span class="n">from</span> <span class="n">stats_proxysql_servers_checksums</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----------------+-------------------+--------------------+------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">hostname</span>        <span class="o">|</span> <span class="n">name</span>              <span class="o">|</span> <span class="n">checksum</span>           <span class="o">|</span> <span class="n">updated_at</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+-----------------+-------------------+--------------------+------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">117</span> <span class="o">|</span> <span class="n">admin_variables</span>   <span class="o">|</span>                    <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">117</span> <span class="o">|</span> <span class="n">mysql_query_rules</span> <span class="o">|</span> <span class="mh">0xD331FBA2DFADB529</span> <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">117</span> <span class="o">|</span> <span class="n">mysql_servers</span>     <span class="o">|</span> <span class="mh">0xF38804B1395AE050</span> <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">117</span> <span class="o">|</span> <span class="n">mysql_users</span>       <span class="o">|</span> <span class="mh">0xA9B3797834E823FC</span> <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">117</span> <span class="o">|</span> <span class="n">mysql_variables</span>   <span class="o">|</span>                    <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">117</span> <span class="o">|</span> <span class="n">proxysql_servers</span>  <span class="o">|</span> <span class="mh">0x66124755F5959C8D</span> <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">114</span> <span class="o">|</span> <span class="n">admin_variables</span>   <span class="o">|</span>                    <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">114</span> <span class="o">|</span> <span class="n">mysql_query_rules</span> <span class="o">|</span> <span class="mh">0xD331FBA2DFADB529</span> <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">114</span> <span class="o">|</span> <span class="n">mysql_servers</span>     <span class="o">|</span> <span class="mh">0xF38804B1395AE050</span> <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">114</span> <span class="o">|</span> <span class="n">mysql_users</span>       <span class="o">|</span> <span class="mh">0xA9B3797834E823FC</span> <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">114</span> <span class="o">|</span> <span class="n">mysql_variables</span>   <span class="o">|</span>                    <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="n">xxx</span><span class="o">.</span><span class="mi">114</span> <span class="o">|</span> <span class="n">proxysql_servers</span>  <span class="o">|</span> <span class="mh">0x66124755F5959C8D</span> <span class="o">|</span> <span class="mi">1603245278</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl"><span class="mi">12</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ­¤åå¤šçœ‹æ—¥å¿— <code>tail -f /var/lib/proxysql/proxysql.log</code>, è¿™é‡Œä¼šæç¤ºä½ éœ€è¦åšå“ªäº›æ“ä½œæˆ–æ˜¯ä¿®æ”¹å˜é‡æ¥è¿›è¡ŒåŒæ­¥ã€‚æ³¨æ„proxysql è´¦å·å’Œmonitorè´¦å·åœ¨mysqlæœºå™¨ä¸Šæ˜¯å¦æœ‰é™åˆ¶ã€‚</p>
<p>é€šè¿‡è°ƒè¯•ä½¿å¾—proxysql.logæ— æŠ¥é”™åã€‚</p>
<p>é€šè¿‡<code>select * from mysql_servers;</code>è§‚å¯Ÿæ•°æ®æ—¶å€™åŒæ­¥</p>
<p>ä¸‹é¢è¿›è¡Œé«˜å¯ç”¨é…ç½®ã€‚</p>
<h4 id="proxysqlçš„é«˜å¯ç”¨">Proxysqlçš„é«˜å¯ç”¨</h4>
<p>ä½¿ç”¨keepalived,</p>
<h3 id="keepalived-å®˜æ–¹ç½‘ç«™-httpswwwkeepalivedorg">Keepalived å®˜æ–¹ç½‘ç«™ <a class="link" href="https://www.keepalived.org/"  target="_blank" rel="noopener"
    >https://www.keepalived.org/</a></h3>
<p>åŸºäºï¼ˆVitual Router Redundancy Protocolï¼Œè™šæ‹Ÿè·¯ç”±å†—ä½™åè®®ï¼‰,VRRPæ˜¯ä¸ºäº†è§£å†³é™æ€è·¯ç”±çš„é«˜å¯ç”¨ã€‚VRRPçš„åŸºæœ¬æ¶æ„ã€‚åˆ©ç”¨VIPèµ„æºæ¼‚ç§»æ¥å®ç°ProxySQLåŒèŠ‚ç‚¹çš„æ— æ„ŸçŸ¥æ•…éšœåˆ‡æ¢ï¼Œå³å¯¹å¤–æä¾›ä¸€ä¸ªç»Ÿä¸€çš„vipåœ°å€ï¼Œå¹¶ä¸”åœ¨keepalived.confæ–‡ä»¶ä¸­é…ç½®proxysqlæœåŠ¡çš„ç›‘æ§è„šæœ¬ï¼Œå½“å®•æœºæˆ–proxysqlæœåŠ¡æŒ‚æ‰æ—¶å°±å°†vipèµ„æºæ¼‚ç§»åˆ°å¦ä¸€ä¸ªæ­£å¸¸çš„èŠ‚ç‚¹ä¸Šï¼Œä»è€Œä½¿proxysqlçš„ä»£ç†å±‚æŒç»­æ— æ„Ÿåº”åœ°æä¾›æœåŠ¡ã€‚</p>
<h4 id="vrrpçš„åŸºæœ¬æ¶æ„">VRRPçš„åŸºæœ¬æ¶æ„</h4>
<p>è™šæ‹Ÿè·¯ç”±å™¨ç”±å¤šä¸ªè·¯ç”±å™¨ç»„æˆï¼Œæ¯ä¸ªè·¯ç”±å™¨éƒ½æœ‰å„è‡ªçš„IPå’Œå…±åŒçš„VRID(0-255)ï¼Œå…¶ä¸­ä¸€ä¸ªVRRPè·¯ç”±å™¨é€šè¿‡ç«é€‰æˆä¸ºMASTERï¼Œå æœ‰VIPï¼Œå¯¹å¤–æä¾›è·¯ç”±æœåŠ¡ï¼Œå…¶ä»–æˆä¸ºBACKUPï¼ŒMASTERä»¥IPç»„æ’­ï¼ˆç»„æ’­åœ°å€ï¼š224.0.0.18ï¼‰å½¢å¼å‘é€VRRPåè®®åŒ…ï¼Œä¸BACKUPä¿æŒå¿ƒè·³è¿æ¥ï¼Œè‹¥MASTERä¸å¯ç”¨ï¼ˆæˆ–BACKUPæ¥æ”¶ä¸åˆ°VRRPåè®®åŒ…ï¼‰ï¼Œåˆ™BACKUPé€šè¿‡ç«é€‰äº§ç”Ÿæ–°çš„MASTERå¹¶ç»§ç»­å¯¹å¤–æä¾›è·¯ç”±æœåŠ¡ï¼Œä»è€Œå®ç°é«˜å¯ç”¨ã€‚
é“¾æ¥ï¼šhttps://www.jianshu.com/p/b050d8861fc1</p>
<h4 id="å·¥ä½œç±»å‹">å·¥ä½œç±»å‹</h4>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">æŠ¢å å¼ï¼šå½“å‡ºç°æ¯”ç°æœ‰ä¸»æœåŠ¡å™¨ä¼˜å…ˆçº§é«˜çš„æœåŠ¡å™¨æ—¶ï¼Œä¼šå‘é€é€šå‘ŠæŠ¢å è§’è‰²æˆä¸ºä¸»æœåŠ¡å™¨
</span></span><span class="line"><span class="cl">éæŠ¢å å¼ï¼š
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ ¸å¿ƒç»„ä»¶</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">        vrrp stackï¼švrrpåè®®çš„å®ç°
</span></span><span class="line"><span class="cl">        ipvs wrapperï¼šä¸ºé›†ç¾¤å†…çš„æ‰€æœ‰èŠ‚ç‚¹ç”ŸæˆIPVSè§„åˆ™
</span></span><span class="line"><span class="cl">        checkersï¼šå¯¹IPVSé›†ç¾¤çš„å„RSåšå¥åº·çŠ¶æ€æ£€æµ‹
</span></span><span class="line"><span class="cl">        æ§åˆ¶ç»„ä»¶ï¼šé…ç½®æ–‡ä»¶åˆ†æå™¨ï¼Œç”¨æ¥å®ç°é…ç½®æ–‡ä»¶çš„åˆ†æå’ŒåŠ è½½
</span></span><span class="line"><span class="cl">        IOå¤ç”¨å™¨
</span></span><span class="line"><span class="cl">        å†…å­˜ç®¡ç†ç»„ä»¶ï¼Œç”¨æ¥ç®¡ç†keepalivedé«˜å¯ç”¨æ˜¯çš„å†…å­˜ç®¡ç†
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>æ³¨æ„ï¼šå„èŠ‚ç‚¹æ—¶é—´éœ€è¦åŒæ­¥</strong></p>
<h5 id="ä¸‹è½½å’Œå®‰è£…">ä¸‹è½½å’Œå®‰è£…</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"> wget https://www.keepalived.org/software/keepalived-2.1.5.tar.gz
</span></span><span class="line"><span class="cl"> tar -xvf keepalived-2.1.5.tar.gz 
</span></span><span class="line"><span class="cl"> cd keepalived-2.1.5
</span></span><span class="line"><span class="cl"> ./configure --prefix=/usr/local/keepalived
</span></span><span class="line"><span class="cl"> yum -y install openssl
</span></span><span class="line"><span class="cl"> make &amp;&amp; make install
</span></span></code></pre></td></tr></table>
</div>
</div><h5 id="åŸºæœ¬é…ç½®">åŸºæœ¬é…ç½®</h5>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl"># tree -l /usr/local/keepalived/etc
</span></span><span class="line"><span class="cl">-- keepalived
</span></span><span class="line"><span class="cl">|   |-- keepalived.conf
</span></span><span class="line"><span class="cl">|   `-- samples #è¿™ä¸ªé‡Œé¢æ˜¯ä¾‹å­ï¼Œå…ˆä¸ç®¡ä»–
</span></span><span class="line"><span class="cl">`-- sysconfig
</span></span><span class="line"><span class="cl">    `-- keepalived
</span></span><span class="line"><span class="cl"># mkdir /etc/keepalived
</span></span><span class="line"><span class="cl">#  cp /usr/local/keepalived/etc/keepalived/keepalived.conf /etc/keepalived/keepalived.conf
</span></span><span class="line"><span class="cl"># cp /usr/local/keepalived/etc/sysconfig/keepalived /etc/sysconfig/keepalived
</span></span><span class="line"><span class="cl"># chkconfig keepalived on
</span></span><span class="line"><span class="cl"># service keepalived start   #å¯åŠ¨æœåŠ¡
</span></span><span class="line"><span class="cl"># service keepalived stop    #åœæ­¢æœåŠ¡
</span></span><span class="line"><span class="cl"># service keepalived restart #é‡å¯æœåŠ¡
</span></span></code></pre></td></tr></table>
</div>
</div><p>ä½¿ç”¨<code>service keepalived start</code>å‘½ä»¤å¯åŠ¨æœåŠ¡æ—¶ï¼Œé»˜è®¤ä¼šå°†<code>/etc/sysconfig/keepalived</code>æ–‡ä»¶ä¸­<code>KEEPALIVED_OPTIONS</code>å‚æ•°ä½œä¸º<code>keepalived</code>æœåŠ¡å¯åŠ¨æ—¶çš„å‚æ•°ï¼Œå¹¶ä»<code>/etc/keepalived/</code>ç›®å½•ä¸‹åŠ è½½keepalived.confé…ç½®æ–‡ä»¶ï¼Œæˆ–ç”¨-få‚æ•°æŒ‡å®šé…ç½®æ–‡ä»¶çš„ä½ç½®ã€‚</p>
<h5 id="è¿›è¡Œé…ç½®æ–‡ä»¶çš„ä¹¦å†™">è¿›è¡Œé…ç½®æ–‡ä»¶çš„ä¹¦å†™</h5>
<p>117 ä½œä¸ºmsater</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span><span class="lnt">32
</span><span class="lnt">33
</span><span class="lnt">34
</span><span class="lnt">35
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">! Configuration File for keepalived
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">global_defs {
</span></span><span class="line"><span class="cl">   script_user root
</span></span><span class="line"><span class="cl">   enable_script_security 
</span></span><span class="line"><span class="cl">   router_id Master-proxysql #æ ‡è¯†æœ¬èŠ‚ç‚¹çš„åç§°ï¼Œé€šå¸¸ä¸ºhostname
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">## keepalivedä¼šå®šæ—¶æ‰§è¡Œè„šæœ¬å¹¶å¯¹è„šæœ¬æ‰§è¡Œçš„ç»“æœè¿›è¡Œåˆ†æ,åŠ¨æ€è°ƒæ•´vrrp_instanceçš„ä¼˜å…ˆçº§ã€‚
</span></span><span class="line"><span class="cl">##å¦‚æœè„šæœ¬æ‰§è¡Œç»“æœä¸º0,å¹¶ä¸”weighté…ç½®çš„å€¼å¤§äº0,åˆ™ä¼˜å…ˆçº§ç›¸åº”çš„å¢åŠ ã€‚å¦‚æœè„šæœ¬æ‰§è¡Œç»“æœé0,
</span></span><span class="line"><span class="cl">##å¹¶ä¸”weighté…ç½®çš„å€¼å°äº 0,åˆ™ä¼˜å…ˆçº§ç›¸åº”çš„å‡å°‘ã€‚å…¶ä»–æƒ…å†µ,ç»´æŒåŸæœ¬é…ç½®çš„ä¼˜å…ˆçº§,å³é…ç½®æ–‡ä»¶ä¸­priorityå¯¹åº”çš„å€¼ã€‚
</span></span><span class="line"><span class="cl">vrrp_script chk_proxysql {
</span></span><span class="line"><span class="cl">	script &#34;/etc/keepalived/sql_check.sh&#34;
</span></span><span class="line"><span class="cl">	interval 2 #æ¯2ç§’æ£€æµ‹ä¸€æ¬¡nginxçš„è¿è¡ŒçŠ¶æ€
</span></span><span class="line"><span class="cl">	weight -20 #å¤±è´¥ä¸€æ¬¡ï¼Œå°†è‡ªå·±çš„ä¼˜å…ˆçº§-20
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">vrrp_instance VI_1 {
</span></span><span class="line"><span class="cl">    state MASTER  # çŠ¶æ€ï¼Œä¸»èŠ‚ç‚¹ä¸ºMASTERï¼Œå¤‡ä»½èŠ‚ç‚¹ä¸ºBACKUP
</span></span><span class="line"><span class="cl">    interface eth1  # ç»‘å®šVIPçš„ç½‘ç»œæ¥å£ï¼Œé€šè¿‡ip aæŸ¥çœ‹è‡ªå·±çš„ç½‘ç»œæ¥å£
</span></span><span class="line"><span class="cl">    virtual_router_id 123 # è™šæ‹Ÿè·¯ç”±çš„IDå·,ä¸¤ä¸ªèŠ‚ç‚¹è®¾ç½®å¿…é¡»ä¸€æ ·,å¯é€‰IPæœ€åä¸€æ®µä½¿ç”¨,ç›¸åŒçš„VRIDä¸ºä¸€ä¸ªç»„,ä»–å°†å†³å®šå¤šæ’­çš„MACåœ°å€
</span></span><span class="line"><span class="cl">    mcast_src_ip 10.241.10.1  # æœ¬æœºIPåœ°å€
</span></span><span class="line"><span class="cl">    priority 110 # èŠ‚ç‚¹ä¼˜å…ˆçº§ï¼Œå€¼èŒƒå›´0ï½254ï¼ŒMASTERè¦æ¯”BACKUPé«˜
</span></span><span class="line"><span class="cl">    advert_int 1  # ç»„æ’­ä¿¡æ¯å‘é€æ—¶é—´é—´éš”ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»è®¾ç½®ä¸€æ ·ï¼Œé»˜è®¤ä¸º1ç§’
</span></span><span class="line"><span class="cl">    # è®¾ç½®éªŒè¯ä¿¡æ¯ï¼Œä¸¤ä¸ªèŠ‚ç‚¹å¿…é¡»ä¸€è‡´
</span></span><span class="line"><span class="cl">    authentication {
</span></span><span class="line"><span class="cl">        auth_type PASS
</span></span><span class="line"><span class="cl">        auth_pass 1111
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    # è™šæ‹ŸIPï¼Œä¸¤ä¸ªèŠ‚ç‚¹è®¾ç½®å¿…é¡»ä¸€æ ·ã€‚å¯ä»¥è®¾ç½®å¤šä¸ªï¼Œä¸€è¡Œå†™ä¸€ä¸ª
</span></span><span class="line"><span class="cl">    virtual_ipaddress {
</span></span><span class="line"><span class="cl">    	10.241.10.3
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">    track_script {
</span></span><span class="line"><span class="cl">		chk_proxysql	# nginxå­˜æ´»çŠ¶æ€æ£€æµ‹è„šæœ¬		
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>114ä¸ºBACKUP</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span><span class="lnt">19
</span><span class="lnt">20
</span><span class="lnt">21
</span><span class="lnt">22
</span><span class="lnt">23
</span><span class="lnt">24
</span><span class="lnt">25
</span><span class="lnt">26
</span><span class="lnt">27
</span><span class="lnt">28
</span><span class="lnt">29
</span><span class="lnt">30
</span><span class="lnt">31
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">! Configuration File for keepalived
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">global_defs {
</span></span><span class="line"><span class="cl">   script_user root
</span></span><span class="line"><span class="cl">   enable_script_security 
</span></span><span class="line"><span class="cl">   router_id Master-proxysql
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">
</span></span><span class="line"><span class="cl">vrrp_script chk_proxysql {
</span></span><span class="line"><span class="cl">	script &#34;/etc/keepalived/sql_check.sh&#34;
</span></span><span class="line"><span class="cl">	interval 2
</span></span><span class="line"><span class="cl">	weight -20
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">vrrp_instance VI_1 {
</span></span><span class="line"><span class="cl">    state BACKUP
</span></span><span class="line"><span class="cl">    interface eth1
</span></span><span class="line"><span class="cl">    virtual_router_id 123
</span></span><span class="line"><span class="cl">    mcast_src_ip 10.241.10.2
</span></span><span class="line"><span class="cl">    priority 100
</span></span><span class="line"><span class="cl">    advert_int 1
</span></span><span class="line"><span class="cl">    authentication {
</span></span><span class="line"><span class="cl">        auth_type PASS
</span></span><span class="line"><span class="cl">        auth_pass 1111
</span></span><span class="line"><span class="cl">    }
</span></span><span class="line"><span class="cl">    virtual_ipaddress {
</span></span><span class="line"><span class="cl">    	10.241.10.3
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">    track_script {
</span></span><span class="line"><span class="cl">	chk_proxysql			
</span></span><span class="line"><span class="cl">	}
</span></span><span class="line"><span class="cl">}
</span></span></code></pre></td></tr></table>
</div>
</div><p>æ£€æŸ¥proxysqlçš„è„šæœ¬ <code>cat /etc/keepalived/sql_check.sh</code></p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-bash" data-lang="bash"><span class="line"><span class="cl"><span class="cp">#!/bin/bash
</span></span></span><span class="line"><span class="cl"><span class="cp"></span><span class="nb">echo</span> <span class="s1">&#39;æˆ‘å¼€å§‹è¿è¡Œå•¦&#39;</span>
</span></span><span class="line"><span class="cl"><span class="nv">num</span><span class="o">=</span><span class="sb">`</span>ps aux <span class="p">|</span> grep   proxysql <span class="p">|</span> grep -cv grep<span class="sb">`</span>
</span></span><span class="line"><span class="cl"><span class="nb">echo</span> â€˜è®°å½•å¥½äº†â€™ <span class="nv">$num</span>
</span></span><span class="line"><span class="cl"><span class="k">if</span> <span class="o">[</span> <span class="nv">$num</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">        <span class="c1">#è¿™é‡Œå¿½ç•¥é‡å¯</span>
</span></span><span class="line"><span class="cl">	<span class="nb">echo</span> <span class="s1">&#39;è¿›å…¥åˆ¤æ–­&#39;</span>
</span></span><span class="line"><span class="cl">        sleep <span class="m">1</span>
</span></span><span class="line"><span class="cl">        <span class="k">if</span> <span class="o">[</span> <span class="sb">`</span>ps aux <span class="p">|</span> grep   proxysql <span class="p">|</span> grep -cv grep<span class="sb">`</span> -eq <span class="m">0</span> <span class="o">]</span><span class="p">;</span><span class="k">then</span>
</span></span><span class="line"><span class="cl">                <span class="nb">echo</span> <span class="s1">&#39;è¿›å…¥å°åˆ¤æ–­&#39;</span>
</span></span><span class="line"><span class="cl">		<span class="nb">echo</span> <span class="s1">&#39;stop keepalived&#39;</span> &gt; /etc/keepalived/chk_log
</span></span><span class="line"><span class="cl">		<span class="nb">kill</span> -9 <span class="k">$(</span>ps aux <span class="p">|</span> grep keepalived <span class="p">|</span> grep -v grep <span class="p">|</span> cut  -d<span class="s1">&#39; &#39;</span> -f 7<span class="k">)</span>
</span></span><span class="line"><span class="cl">		<span class="nb">echo</span> <span class="s1">&#39;stop !&#39;</span> &gt; /etc/keepalived/chk_log
</span></span><span class="line"><span class="cl">        <span class="k">fi</span>
</span></span><span class="line"><span class="cl"><span class="k">fi</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p><strong>è®°å¾—ç»™è„šæœ¬æ‰§è¡Œæƒé™</strong><code>chmod a+x /etc/keepalived/proxysql_check.sh </code></p>
<p>å¯åŠ¨keepalivedå<code>ip a</code>æŸ¥çœ‹</p>
<p>keepalived-masterç«¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span><span class="lnt">7
</span><span class="lnt">8
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
</span></span><span class="line"><span class="cl">    link/ether 00:50:56:ab:d7:be brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 10.241.10.1/16 brd 10.241.255.255 scope global eth1
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet 10.241.10.3/32 scope global eth1
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::250:56ff:feab:d7be/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><p>keepalived-slaveç«¯</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt">1
</span><span class="lnt">2
</span><span class="lnt">3
</span><span class="lnt">4
</span><span class="lnt">5
</span><span class="lnt">6
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">3: eth1: &lt;BROADCAST,MULTICAST,UP,LOWER_UP&gt; mtu 1500 qdisc mq state UP group default qlen 1000
</span></span><span class="line"><span class="cl">    link/ether 00:50:56:ab:4a:16 brd ff:ff:ff:ff:ff:ff
</span></span><span class="line"><span class="cl">    inet 10.241.10.2/16 brd 10.241.255.255 scope global eth1
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span><span class="line"><span class="cl">    inet6 fe80::250:56ff:feab:4a16/64 scope link 
</span></span><span class="line"><span class="cl">       valid_lft forever preferred_lft forever
</span></span></code></pre></td></tr></table>
</div>
</div><h3 id="æ£€æŸ¥">æ£€æŸ¥</h3>
<p>ã€å°†ä¸»æœºproxysqlå…³é—­ï¼Œä¼šå‘ç°ä¸»æœºä¸Šçš„keepalivedå…³é—­ï¼Œ<code>vip:10.241.10.3</code> é£˜ç§»åˆ°äº†ä»æœºå™¨ã€‘</p>
<p>ä½¿ç”¨é£˜ç§»VIPè¿æ¥MYSQL</p>
<p>åœ¨è¯»å†™æœŸé—´è¿›è¡Œä»æœºåˆ‡æ¢æ–°å»º<code>test</code>æ•°æ®åº“ <code>test</code>æ•°æ®è¡¨</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-gdscript3" data-lang="gdscript3"><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">show</span> <span class="n">databases</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="o">+--------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">Database</span>           <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+--------------------+</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">information_schema</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">dbtest</span>             <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">hanzhongtest</span>       <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">mysql</span>              <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">performance_schema</span> <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">|</span> <span class="n">sys</span>                <span class="o">|</span>
</span></span><span class="line"><span class="cl"><span class="o">+--------------------+</span>
</span></span><span class="line"><span class="cl"><span class="mi">6</span> <span class="n">rows</span> <span class="ow">in</span> <span class="n">set</span> <span class="p">(</span><span class="mf">0.00</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">database</span> <span class="n">proxysqlHA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">1</span> <span class="n">row</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</span></span><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">use</span> <span class="n">proxysqlHA</span><span class="p">;</span>
</span></span><span class="line"><span class="cl"><span class="n">Database</span> <span class="n">changed</span>
</span></span><span class="line"><span class="cl"><span class="n">mysql</span><span class="o">&gt;</span> <span class="n">create</span> <span class="n">table</span> <span class="n">test_id</span><span class="p">(</span><span class="n">id</span> <span class="ne">int</span><span class="p">,</span><span class="n">name</span> <span class="n">varchar</span><span class="p">(</span><span class="mi">10</span><span class="p">));</span>
</span></span><span class="line"><span class="cl"><span class="n">Query</span> <span class="n">OK</span><span class="p">,</span> <span class="mi">0</span> <span class="n">rows</span> <span class="n">affected</span> <span class="p">(</span><span class="mf">0.01</span> <span class="n">sec</span><span class="p">)</span>
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨pythonå†™å…¥æ—¶ï¼Œè¿›è¡Œåˆ‡æ¢</p>
<div class="highlight"><div class="chroma">
<table class="lntable"><tr><td class="lntd">
<pre tabindex="0" class="chroma"><code><span class="lnt"> 1
</span><span class="lnt"> 2
</span><span class="lnt"> 3
</span><span class="lnt"> 4
</span><span class="lnt"> 5
</span><span class="lnt"> 6
</span><span class="lnt"> 7
</span><span class="lnt"> 8
</span><span class="lnt"> 9
</span><span class="lnt">10
</span><span class="lnt">11
</span><span class="lnt">12
</span><span class="lnt">13
</span><span class="lnt">14
</span><span class="lnt">15
</span><span class="lnt">16
</span><span class="lnt">17
</span><span class="lnt">18
</span></code></pre></td>
<td class="lntd">
<pre tabindex="0" class="chroma"><code class="language-fallback" data-lang="fallback"><span class="line"><span class="cl">import pymysql
</span></span><span class="line"><span class="cl">config = {
</span></span><span class="line"><span class="cl">&#39;host&#39; : &#39;10.241.10.3&#39;,
</span></span><span class="line"><span class="cl">&#39;db&#39; : &#39;proxysqlHA&#39;,
</span></span><span class="line"><span class="cl">&#39;user&#39; : &#39;proxysql&#39;,
</span></span><span class="line"><span class="cl">&#39;password&#39; : &#39;Proxy-123456&#39;,
</span></span><span class="line"><span class="cl">&#39;port&#39; : 6033,
</span></span><span class="line"><span class="cl">}
</span></span><span class="line"><span class="cl">for i in range(1,1000000):
</span></span><span class="line"><span class="cl">insertstr = &#34;insert into test_id values(%s,&#39;zhangsan%s&#39;)&#34; % (i,str(i),i)
</span></span><span class="line"><span class="cl">print(insertstr)
</span></span><span class="line"><span class="cl">sqlstr = insertstr
</span></span><span class="line"><span class="cl">db = pymysql.connect(**config)
</span></span><span class="line"><span class="cl">cursor = db.cursor()
</span></span><span class="line"><span class="cl">cursor.execute(sqlstr)
</span></span><span class="line"><span class="cl">db.commit()
</span></span><span class="line"><span class="cl">print(&#34;count: {}&#34;.format(i) )
</span></span><span class="line"><span class="cl">db.close()
</span></span></code></pre></td></tr></table>
</div>
</div><p>åœ¨å¼€å§‹å†™å…¥åå…³é—­117ä¸»æœºçš„proxysqlï¼Œè§‚å¯Ÿå‘ç°ç¡®å®åœ¨åˆ‡æ¢è¿‡ç¨‹çš„ä¸€ç¬é—´ä¼šå‡ºç°å†™å…¥å¤±è´¥ã€‚åˆ‡æ¢å®Œæˆåè®¿é—®æ­£å¸¸ã€‚</p>
<h3 id="é‡åˆ°çš„é—®é¢˜-1">é‡åˆ°çš„é—®é¢˜</h3>
<p>1.å¿˜è®°å°†æ£€æŸ¥è„šæœ¬å¼„æˆæ‰§è¡Œæƒé™</p>
<p>2.è„šæœ¬çš„åå­—å®Œå…¨åŒ…å«äº†proxysql å¯¼è‡´æ£€æŸ¥å‡ºé”™ã€‚</p>
<p>3.åˆ‡æ¢æ—¶é—´åŒ…æ‹¬ keepalivedè¿è¡Œè„šæœ¬çš„é—´éš”æ—¶é—´ã€æ£€æŸ¥è„šæœ¬çš„sleepæ—¶é—´ã€ç»„æ’­ä¿¡æ¯é—´éš”çš„æ—¶é—´ã€‚æƒ³è¦æœ€å°åŒ–æ—¶é—´éœ€è¦å°†æ‰€æœ‰é—´éš”å’Œsleepå‡å»ã€‚</p>
<p>ä½†æ˜¯ç»„æ’­ä¿¡æ¯é—´éš”æ—¶é—´<code>vrrp version 2</code> ä¸­æœ€å°åªèƒ½åˆ°1s é»˜è®¤å¯åŠ¨<code>vrrp version 2</code></p>
<hr>

</section>


    <footer class="article-footer">
    
    <section class="article-tags">
        
            <a href="/tags/proxysql/">proxysql</a>
        
    </section>


    
    <section class="article-copyright">
        <svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" fill="none" stroke-linecap="round" stroke-linejoin="round">
  <path stroke="none" d="M0 0h24v24H0z"/>
  <circle cx="12" cy="12" r="9" />
  <path d="M14.5 9a3.5 4 0 1 0 0 6" />
</svg>



        <span>Licensed under CC BY-NC-SA 4.0</span>
    </section>
    </footer>


    
</article>

    

    

<aside class="related-content--wrapper">
    <h2 class="section-title">ç›¸å…³æ–‡ç« </h2>
    <div class="related-content">
        <div class="flex article-list--tile">
            
                
<article class="">
    <a href="/p/etcd-%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%90%9E%E5%AE%9A/">
        
        

        <div class="article-details">
            <h2 class="article-title">Etcd ä¸€ç¯‡æ–‡ç« æå®š</h2>
        </div>
    </a>
</article>

            
                
<article class="">
    <a href="/p/ansible-%E4%B8%80%E7%AF%87%E6%96%87%E7%AB%A0%E6%90%9E%E5%AE%9A/">
        
        

        <div class="article-details">
            <h2 class="article-title">Ansible ä¸€ç¯‡æ–‡ç« æå®š</h2>
        </div>
    </a>
</article>

            
        </div>
    </div>
</aside>

     
    
        
    <script src='//unpkg.com/@waline/client@v2/dist/waline.js'></script>
<link href='//unpkg.com/@waline/client@v2/dist/waline.css' rel='stylesheet'/>
<div id="waline" class="waline-container"></div>
<style>
    .waline-container {
        background-color: var(--card-background);
        border-radius: var(--card-border-radius);
        box-shadow: var(--shadow-l1);
        padding: var(--card-padding);
        --waline-font-size: var(--article-font-size);
    }
    .waline-container .wl-count {
        color: var(--card-text-color-main);
    }
</style><script>
    
    Waline.init({"dark":"html[data-scheme=\"dark\"]","el":"#waline","emoji":["//unpkg.com/@waline/emojis@1.1.0/bilibili","//unpkg.com/@waline/emojis@1.1.0/weibo","cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tw-emoji","cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/alus","cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/qq","cdn.jsdelivr.net/gh/walinejs/emojis@1.0.0/tieba"],"locale":{"admin":"Admin","placeholder":"è¯·æ–‡æ˜å‘è¨€å“Ÿ ãƒ¾(â‰§â–½â‰¦*)o"},"pageview":true,"requiredMeta":["name","email","url"],"serverURL":"https://app-production-dfd0.up.railway.app"});
</script>

    

    <footer class="site-footer">
    <section class="copyright">
        &copy; 
        
            2020 - 
        
        2024 hanzhongzi
    </section>
    
    <section class="powerby">
        Built with <a href="https://gohugo.io/" target="_blank" rel="noopener">Hugo</a> <br />
        ä¸»é¢˜ <b><a href="https://github.com/CaiJimmy/hugo-theme-stack" target="_blank" rel="noopener" data-version="3.21.0">Stack</a></b> ç”± <a href="https://jimmycai.com" target="_blank" rel="noopener">Jimmy</a> è®¾è®¡
    </section>
</footer>


    
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">

    
    <div class="pswp__bg"></div>

    
    <div class="pswp__scroll-wrap">

        
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>

        
        <div class="pswp__ui pswp__ui--hidden">

            <div class="pswp__top-bar">

                

                <div class="pswp__counter"></div>

                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>

                <button class="pswp__button pswp__button--share" title="Share"></button>

                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>

                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>

                
                
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                        <div class="pswp__preloader__cut">
                            <div class="pswp__preloader__donut"></div>
                        </div>
                    </div>
                </div>
            </div>

            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div>
            </div>

            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>

            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>

            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>

        </div>

    </div>

</div><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js"integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo="crossorigin="anonymous"
                defer
                >
            </script><script 
                src="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js"integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU="crossorigin="anonymous"
                defer
                >
            </script><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css"crossorigin="anonymous"
            ><link 
                rel="stylesheet" 
                href="https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css"crossorigin="anonymous"
            >

            </main>
        </div>
        <script 
                src="https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js"integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z&#43;KMkF24hUW8WePSA9HM="crossorigin="anonymous"
                
                >
            </script><script type="text/javascript" src="/ts/main.js" defer></script>
<script>
    (function () {
        const customFont = document.createElement('link');
        customFont.href = "https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap";

        customFont.type = "text/css";
        customFont.rel = "stylesheet";

        document.head.appendChild(customFont);
    }());
</script>

    </body>
</html>
